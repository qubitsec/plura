# MSA 개발을 위한 사전 설명 문서

## 13일차 – 개념 이해

**날짜: 6월 27일**

---

## 주제

# **13. 데이터 일관성의 현실: 트랜잭션과 SAGA**

> “MSA에서는 ‘완벽한 즉시 일관성’보다 ‘운영 가능한 일관성’을 선택한다”

---

## 1️⃣ 왜 MSA에서는 트랜잭션이 문제가 되는가

모놀리식에서는 비교적 단순했습니다.

* 하나의 DB
* 하나의 트랜잭션
* 성공 또는 롤백

하지만 MSA에서는 상황이 달라집니다.

* 서비스마다 DB가 다름
* 네트워크 호출이 개입됨
* 일부 성공 / 일부 실패가 정상적으로 발생

**하나의 트랜잭션으로 묶을 수 없는 구조**가 됩니다.

---

## 2️⃣ 분산 트랜잭션(2PC)을 쓰면 안 되는 이유

이론적으로는 **2PC(Two-Phase Commit)** 가 있습니다.
하지만 실무 MSA에서는 거의 쓰지 않습니다.

### 2PC의 현실적 문제

* 구현·운영 복잡도 매우 높음
* 하나의 서비스 지연이 전체를 묶음
* 장애 시 복구가 극도로 어려움
* 클라우드/쿠버네티스 환경과 부적합

결론

> **2PC는 ‘이론적으로 가능’하지만
> ‘운영에서는 재앙’이 되기 쉽다**

---

## 3️⃣ MSA가 선택한 방향: Eventual Consistency

MSA에서는 다음을 받아들입니다.

> **모든 데이터가 즉시 일치하지 않아도 된다**
> **결국(Eventually) 일치하면 된다**

이를 **최종적 일관성(Eventual Consistency)** 이라고 합니다.

---

## 4️⃣ SAGA 패턴이란 무엇인가

**SAGA 패턴**은
하나의 큰 트랜잭션을
**여러 개의 로컬 트랜잭션**으로 나누고,
실패 시 **보상(Compensation)** 으로 되돌리는 방식입니다.

---

### 예시: 주문 흐름

1. 주문 생성 (Order Service)
2. 결제 처리 (Payment Service)
3. 배송 요청 (Delivery Service)

#### 정상 흐름

```
OrderCreated → PaymentCompleted → DeliveryRequested
```

#### 실패 흐름

```
OrderCreated → PaymentFailed
→ 주문 취소(보상 트랜잭션)
```

“모두 롤백”이 아니라
“업무적으로 되돌림”

---

## 5️⃣ SAGA 구현 방식 2가지

### ✅ 1) Choreography (이벤트 기반)

* 중앙 제어자 없음
* 각 서비스가 이벤트를 보고 반응

```
OrderCreated
 → Payment Service 처리
   → PaymentCompleted 이벤트
     → Delivery Service 처리
```

#### 장점

* 결합도 낮음
* 확장성 좋음

#### 단점

* 전체 흐름 파악이 어려움
* 복잡해질수록 디버깅 난이도 증가

---

### ✅ 2) Orchestration (중앙 제어)

* SAGA Orchestrator가 흐름 제어
* 각 서비스는 명령(Command)을 수행

```
Orchestrator
 → 결제 요청
 → 배송 요청
 → 실패 시 보상 명령
```

#### 장점

* 흐름 가시성 좋음
* 오류 처리 명확

#### 단점

* 중앙 컴포넌트 의존
* 오케스트레이터 설계가 중요

---

## 6️⃣ 보상 트랜잭션(Compensation)의 현실

보상 트랜잭션은 **완전한 롤백이 아닙니다.**

예:

* 결제 취소
* 주문 상태 변경
* 포인트 차감 취소

주의할 점

* “되돌릴 수 없는 작업” 존재

  * 이메일 발송
  * 외부 시스템 호출

이런 작업은 **최대한 뒤로 미루거나**
“취소 이벤트”를 별도로 설계해야 합니다.

---

## 7️⃣ SAGA 설계 시 필수 고려사항

### ✅ 멱등성(Idempotency)

* 같은 이벤트/명령이 여러 번 와도 안전해야 함

### ✅ 상태 관리

* 현재 SAGA 단계가 어디인지 기록 필요

### ✅ 관측성

* SAGA 흐름 추적 가능해야 함
* 로그/트레이싱 필수

### ✅ 실패를 전제로 한 UX

* “처리 중”
* “잠시 후 반영”
* “일부 기능 제한”

---

## 8️⃣ 언제 SAGA를 써야 하는가

### ✅ SAGA가 적합한 경우

* 여러 서비스에 걸친 업무 흐름
* 즉시 일관성이 필수가 아님
* 실패를 업무적으로 보상할 수 있음

### SAGA가 부적합한 경우

* 즉시 강한 정합성이 필수
* 되돌릴 수 없는 작업이 많음

---

## 9️⃣ 결론: 데이터 일관성은 ‘기술’이 아니라 ‘선택’이다

MSA에서의 선택은 명확합니다.

* 즉시 일관성 + 단순함
* ✅ 최종적 일관성 + 독립성 + 확장성

> **SAGA는 타협이 아니라
> 분산 시스템에서 살아남기 위한 선택**입니다.

---

## ✅ 오늘의 핵심 요약

* MSA에서는 단일 트랜잭션이 불가능하다.
* 2PC는 운영 현실과 맞지 않는다.
* 최종적 일관성을 받아들여야 한다.
* SAGA는 로컬 트랜잭션 + 보상 트랜잭션이다.
* Choreography와 Orchestration은 상황에 맞게 선택한다.

---
