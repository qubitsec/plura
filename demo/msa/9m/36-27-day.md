# 필상 시스템 — Day 36 Kubernetes 플랫폼 운영 · 보안 · 업그레이드

1. **날짜**

* 2024-09-27

2. **목표**

* **KR/JP 멀티-리전 K8s** 운영 표준(보안·격리·업그레이드·용량)을 확정
* **무중단 업그레이드(노드 단위)**, **테넌트 격리**, **이미지 공급망 보안**을 기본선으로 설정

---

3. **내용**

### A. 클러스터 토폴로지 & 네임스페이스

* **리전별 전용 클러스터**(교차 리전 워크로드 금지), **AZ≥2** 컨트롤·워커 분리
* 네임스페이스 구조

  * `platform/*`(search, mq, meta-db 프록시, observability)
  * `apps/*`(ingestor, incident-svc, ticketing, console)
  * `tenant/*`(고객 전용 리소스가 필요한 경우에 한해 발급—기본은 멀티테넌시)
* **Quota/Limits**: `LimitRange`(컨테이너 기본 `requests/limits`) + `ResourceQuota`(CPU/RAM/객체 수)

### B. 네트워크·격리

* **NetworkPolicy 기본 거부**: 같은 네임스페이스 내 라벨 기반 허용, 외부는 게이트웨이만
* **mTLS(SPIRE)**: 서비스 아이덴티티(SPIFFE ID)로 상호 TLS
* Egress는 **공급자 화이트리스트**(TI/메일/SMS), DNS는 내부 캐시 우선

### C. 워크로드 보안(PSA/Admission)

* **Pod Security Admission**: `enforce=baseline`, `warn=restricted`(6주 후 enforce)
* 필수 설정: `runAsNonRoot`, `readOnlyRootFilesystem`, `seccompProfile=RuntimeDefault`, `capDrop=ALL`
* **OPA Gatekeeper** 정책:

  * 다운로드 엔드포인트 → **서명 URL만** 허용
  * `hostPath` 금지, `hostNetwork` 제한, `privileged` 금지
  * 라벨/어노테이션 표준(`svc, team, region, release_id`)

### D. 이미지·공급망(Supply Chain)

* **레지스트리**: 사설 OCI(리전 로컬) + 미러
* **서명/검증**: `cosign sign/verify`, Admission에서 서명·SBOM 검사
* **스캔**: `trivy image` CI 게이트(High+ 0건), 베이스 이미지 월 1회 롤링

### E. 스케일 & 용량

* **HPA/VPA** 혼합: HPA는 QPS/지연 지표, VPA는 권고 모드
* **클러스터 오토스케일러**: 버스트 대비 노드 그룹 2배수 버퍼(야간 축소)
* **스토리지**: 검색/메타는 전용 스토리지 클래스(고IOPS), 객체는 외부 S3/MinIO

### F. 업그레이드 & 패치(무중단 원칙)

* **Node Pool Blue/Green**: 새 풀 생성 → **PDB**로 드레인(동시 1 Pod) → 카나리 노드 10% → 전체 전환
* **K8s 마이너 업**: 분기 1회, **API 변경 감지**(kubent) → 사전 리허설(stg) 1주
* **핫픽스**: 커널/컨테이너 런타임 CVE는 **24h 내** 노드 교체
* **검증 게이트**: 업그레이드 단계마다 합성 시나리오(Ingest→Incident→Notify) 통과

### G. 관측·감사

* **OTel** DaemonSet + `kube-state-metrics` + `node-exporter`
* 대시: `sched_latency`, `pod_pending`, `evictions`, `container_restart_rate`, `image_pull_time`
* **감사 로그**: K8s Audit → 별도 인덱스(해시체인), `who/verb/resource/trace_id`

### H. 백업/복구

* **etcd 스냅샷**: 6h 간격, 14일 보존
* **리소스 원장**: GitOps(ArgoCD/Flux), `helm/kustomize` 선언형
* 복구 순서: Control Plane → CoreDNS/Ingress → 플랫폼(검색/큐) → 애플리케이션

### I. 런북(핵심 시나리오)

* **노드 불안정**: `cordon → drain → replace`(PDB 준수), 영향 서비스 타일 확인
* **이미지 풀 지연**: 레지스트리 헬스/캐시 확인 → 사전 프리풀(Job) 실행
* **OOM/스로틀링**: VPA 권고 적용, 쿼터 상향 또는 파이프라인 샘플링 모드 전환

---

4. **예시 설명 (KR 클러스터 마이너 업그레이드—무중단 70분)**

1) `v1.28 → v1.29` Blue 노드풀 생성, 카나리 노드 10%에 **ingestor/incident-svc** 배치.
2) 합성 시나리오 정상(p95 지연 0.8s 유지) → 드레인 속도 1Pod씩, PDB 준수 확인.
3) 중간에 `console` 이미지 풀 지연 감지 → 프리풀 잡 실행 후 재개(지연 +4분).
4) 전환 완료 후 HPA 재보정, Pod 재시작률 정상, 감사 인덱스에 **업그레이드 타임라인** 고정.
   → 결과: **Blue/Green 노드풀 + PDB + 합성 검증**으로 **무중단** 업그레이드 달성, 보안 패치와 성능 안정성을 동시에 확보.
