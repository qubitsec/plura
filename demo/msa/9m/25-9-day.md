# 필상 시스템 — Day 25 리포트/대시보드 & Saved Query 카탈로그

1. **날짜**

* 2024-09-09

2. **목표**

* **분석 리포트·대시보드·Saved Query**의 정의·승인·배포를 표준화
* **3클릭 내 증거 시각화**, **스케줄 리포트 자동 발행**, **감사/보안 일관성** 확보

---

3. **내용**

### A. 개념·범위

* **Saved Query**: 파라미터화된 검색 템플릿(보안 필터/RLS 내장)
* **Dashboard**: 타일(카드/차트/표) 구성, 전역 필터(tenant/region/time) 연동
* **Report**: 대시보드/쿼리를 스냅샷한 **PDF/CSV/HTML** 산출물(서명 해시 포함)

### B. 데이터 모델(요약)

* `SavedQuery(id, key, title, scope{role|tenant}, params[], solr_template, version, owner, reviewed_by, created_at)`
* `Dashboard(id, title, tiles[], default_filters, owner, version)`
* `ReportJob(id, source{dashboard|query}, format{pdf|csv|html}, schedule{cron}, recipients, locale, signed:true, status)`
* `Visualization(type{timeseries|bar|table|facet}, data_source{query:key}, options{unit,axis,limit})`

### C. Saved Query 표준(보안 내장)

* **필수 필터**: `fq=tenant_id:{token.tenant}` 자동 주입, 권한별 필드 마스킹
* **파라미터 규칙**: 타입·검증·기본값 명시(예: `time_range`, `dst_host`, `rule_id`)
* **버전/리뷰**: `reviewed_by` 필수(2인 승인), 변경 시 **회귀 성능 테스트(p95 ≤ 800ms)**

**예시 — FP 의심 점검**

```yaml
key: q.fp_suspect
params:
  - {name: time_range, type: duration, default: "NOW-24HOURS TO NOW"}
  - {name: host, type: string, required: true}
template: |
  q=*
  fq=tenant_id:{TENANT} AND dst_host:${host} AND ts:[${time_range}]
  json.facet={
    codes:{ type:terms, field:status, limit:5 },
    blocked:{ type:terms, field:blocked, limit:2 }
  }
rows=0
```

### D. 대시보드 타일 가이드

* **Overview(기본)**: 인입/차단 추세(시계열), 사건 심각도 분포(도넛), FP/Missed 비율(게이지), DLQ 크기(수치)
* **Detection**: 룰 히트 Top-N(막대), 파라미터 시그니처 Top-N(표), TI 점수 분포(히스토그램)
* **Search Ops**: 저장 쿼리 실행 시간 p95/캐시율, 핫샤드 경고
* **SLO**: 인입→사건/사건→알림 지연 p50/p95, 에러버짓 소모율
* **보안감사**: 다운로드 이벤트/목적(purpose) 비중, 관리자 행위 추세

### E. 리포트 스케줄링·배포

* **형식**: `PDF(서명 해시)`, `CSV(표 전용)`, `HTML(링크 포함)`
* **스케줄**: 크론(예: `0 9 * * 1`—월 09:00), 타임존 **테넌트 기준**(Asia/Seoul, Asia/Tokyo)
* **수신자**: 역할/개별 이메일/웹훅(서명 HMAC)
* **보안**: 링크는 **서명 URL+10분 만료**, PDF 워터마크(tenant/actor/time)

### F. 성능·신뢰성

* 쿼리 캐시: 템플릿 키+파라미터 해시 기반 **15~120s** TTL
* **SLO**: 대시 타일 로드 p95 ≤ **1.0s**, 리포트 렌더 p95 ≤ **60s**(타일 ≤ 10개)
* 장애 시 재시도: 10s→1m→5m, 실패는 **report.dlq**로 이동(재생 가능)

### G. 승인·감사

* 신규/변경 Saved Query·Dashboard는 **PR+2인 승인**
* 감사 로그: `who, what(key/ver), diff, why, when, evidence_uri, prev_hash`—해시체인
* **템플릿 임베드 금지**: 개인 식별자/원본 링크 직접 포함 금지(서명 URL만)

### H. API(발췌)

* `GET /v1/search/saved?role=ANALYST` — 쿼리 목록(권한 필터링)
* `POST /v1/dashboards/{id}:render?format=pdf&locale=ja` — 렌더 요청
* `POST /v1/reports` — 스케줄 생성/수정
* `GET /v1/reports/{id}` — 상태/서명 해시/다운로드 링크
* `POST /v1/search/saved/{key}:execute` — 파라미터 평가·실행(성능 로그 포함)

### I. UX 세부 규칙

* **3-클릭 규칙**: (1) 목록 → (2) 템플릿 선택 → (3) 파라미터 입력/실행
* **상호작용**: 타일 클릭 시 **해당 Saved Query**로 딥링크, 글로벌 필터 동기화
* **다국어**: 타이틀/축/범례는 i18n 키 사용(ko/ja/en), 숫자 **tabular-nums**
* **접근성**: 키보드 포커스 흐름/ARIA 라벨·대체 텍스트 필수

### J. 운영 체크리스트

* [ ] 상위 10 템플릿 **p95** 모니터링 & 캐시 적중률 ≥ 60%
* [ ] 매월 템플릿 재검토(FP/Missed 상관, 불필요 쿼리 정리)
* [ ] 리포트 수신자·권한 주기 점검(퇴사/조직 변경 반영)
* [ ] CSV 내 **민감 필드 제거** 규칙 검증, 외부 전송은 목적 바인딩 확인
* [ ] 대시 변경 시 **시각 회귀 테스트**(Storybook/Chromatic) 통과

---

4. **예시 설명 (주간 CSIRT 리포트—자동 발행 09:00)**

1) **Dashboard `CSIRT-Weekly`**: *사건 추세/FP 비율/TI 상위 레이블/규칙 변경 영향* 타일 8개
2) **ReportJob**: 월요일 09:00 KST, 형식 **PDF+CSV**, 언어 **ja**(JP 고객사 공용)
3) 실행 시 Saved Query 6종을 파라미터화(`time_range=LAST_7D`, `tenant=acme-jp`) → 캐시 선적중
4) PDF는 **워터마크·서명 해시** 포함, CSV는 **마스킹 뷰**(IP /24, 이메일 해시)로 생성
5) 메일+웹훅 동시 발송(HMAC 서명), 콘솔에는 동일 리포트가 **증거 링크**로 연결
   → 결과: 분석가는 **3클릭**으로 근거 중심 시각화를 확보하고, 경영·고객 커뮤니케이션은 **정시 자동 보고**로 표준화된다.
