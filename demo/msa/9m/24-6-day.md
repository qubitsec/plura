# 필상 시스템 — Day 24 포렌식(Forensic) 아티팩트 설계 · 증거 보존 · 재현

1. **날짜**

* 2024-09-06

2. **목표**

* 사건 단위 **포렌식 아티팩트**의 수집·보존(무결성)·전달·재현 절차 표준화
* **체인 오브 커스터디(CoC)**, **서명·해시체인**, **재현 도구/포맷**을 규정하여 **법적 효력**과 **운영 실용성** 동시 확보

---

3. **내용**

### A. 범위 & 원칙

* **범위**: 원로그(원본/정규화), 패킷/메모리(선택), 시스템 스냅샷, 탐지 특징량, TI 스냅샷, 콘솔/알림 타임라인
* **원칙**: 최소수집(PII 최소화), **불변 저장(WORM)**, **재현 가능성(Reproducibility)**, **리전 내 보관(주권)**

### B. 아티팩트 타입 & 식별

* `LOG_RAW`(원본 NDJSON/Syslog), `LOG_NORM`(정규화 JSON), `PCAP`(pcapng), `MEM_DUMP`(ELF/RAW),
  `SYS_SNAPSHOT`(정책/설정/export), `FEATURES`(탐지 특징량), `TI_SNAPSHOT`, `SCREENSHOT`, `REPORT_HTML/PDF`
* **URI 규격**: `s3://evidence/{region}/{tenant}/{incident_id}/{type}/{ulid}.{ext}`
* 메타: `sha256`, `size`, `created_at`, `created_by`, `purpose`, `pii_level(P0~P3)`

### C. 무결성 & 체인 오브 커스터디(CoC)

* **해시체인**: 아티팩트 등록 순서대로 `prev_hash` 연결 → `root_hash`(일 1회 고정)
* **서명**: 시스템 서명(서비스 키) + 사람 서명(승인자 키) **이중 서명**
* **CoC 이벤트 스키마(발췌)**

```json
{
  "incident_id":"01JC…",
  "artifact_uri":"s3://…/LOG_RAW/01K…ndjson",
  "action":"COLLECT|TRANSFER|ACCESS|EXPORT|DELETE",
  "actor":"svc_ingestor|analyst:alice",
  "purpose":"investigation|audit",
  "ts":"2025-09-06T02:34:56Z",
  "hash":"sha256:…",
  "prev_hash":"sha256:…",
  "signature":"pgp:…"
}
```

### D. 저장·보존 정책

* **Object Storage(WORM+Versioning)**: AES-256-GCM, KMS 지역 키, **법적 보존(legal_hold)** 플래그 지원
* **보존 기간**: LOG/FEATURES 1년, PCAP/MEM 90일(옵션), REPORT 3년, CoC/감사 3년
* **삭제/파기**: 만료 배치가 **키 파기→객체 삭제** 순서 수행, 파기 보고서 자동 생성

### E. 패키징 & 재현 포맷

* **Evidence Package (EPKG v1)**:

  * `manifest.json`(목록/메타/해시/루트해시), `artifacts/…`(링크 또는 포함), `report.html`(요약)
  * 크기 절감: 원본 대용량은 **서명 URL(10분)** 링크로 제공
* **재현 도구**: `plura-epkg verify|replay`

  * `verify`: 해시/서명/CoC 검증, 누락 검사
  * `replay`: 규칙/모델 버전 지정 → **오프라인 판정 재실행**(회귀 테스트)

### F. 수집 트리거 & 자동화

* 사건 **열림(open)** 시 최소 세트 자동 수집: `LOG_NORM(윈도우±5m)`, `FEATURES`, `TI_SNAPSHOT`, `REPORT_HTML`
* **고심각(T0/T1)**: `LOG_RAW`, `PCAP(±2m)` 수집 시도, 실패 시 재시도·대체(넷플로우 요약)
* **사용자 수집**: 콘솔에서 *“추가 증거 수집”* → 대상/윈도우/타입 지정, CoC 자동 생성

### G. 프라이버시·마스킹

* 콘솔/리포트는 **마스킹 뷰** 기본(`ip_trunc`, `email_hash`)—원본 열람은 권한+2인 승인
* **다운로드**: 서명 URL + 워터마크(테넌트/행위자/시간), 10분 만료

### H. API(발췌)

* `POST /v1/evidence/collect { incident_id, type, window }` — 수집 요청
* `GET /v1/evidence/{incident_id}` — 목록/해시/CoC/서명 상태
* `POST /v1/evidence/package { incident_id }` — EPKG 생성(옵션: 포함/링크)
* `POST /v1/evidence/replay { incident_id, ruleset, model_ver }` — 재현 실행
* `POST /v1/evidence/legal_hold { incident_id, enable }` — 법적 보존 토글

### I. 관측·SLO

* SLI: `collect_success_rate`, `epkg_build_time_p95`, `verify_success_rate`, `replay_latency_p95`
* 목표: **EPKG 생성 p95 ≤ 90s**, 재현 p95 ≤ 30s(샘플 1k 기준), 검증 성공률 99.9%

### J. 운영 체크리스트

* [ ] 사건 개시 5분 내 **최소 세트** 수집 확인
* [ ] CoC 루트 해시 **일 1회 고정** 및 외부 타임스탬프 앵커(예: TSA)
* [ ] 서명 키 **90일 로테이션**, 만료 전 교체 테스트
* [ ] 재현 파이프라인 **룰/모델 버전 고정** + 결과 비교 리포트
* [ ] 법적 보존 시 **삭제/키 파기 중단** 검증

---

4. **예시 설명 (T1 사건—‘오탐’ 재현·종결 흐름)**

1) `WAF-941100`로 **T1 사건** 발생 → 자동 수집: `LOG_NORM`, `FEATURES`, `TI_SNAPSHOT` → EPKG 생성
2) 분석가가 **추가 수집**으로 `LOG_RAW(±5m)` 요청, CoC에 `COLLECT` 이벤트 기록
3) `replay`를 **룰 v8-beta**로 실행 → 결과 **allow**(오탐)로 재현 일치, `diff` 리포트 생성
4) IC 승인 후 **사건 종결(resolved)**, EPKG에 **최종 리포트** 첨부, 고객에 서명 URL 제공(10분)
5) 30일 후 자동 **법적 보존 해제**, 보존 정책에 따라 만료 시 **키 파기→객체 삭제** 수행, 파기 보고서가 감사 인덱스에 연결

> 결과: 수집→무결성→재현→종결까지 **증거 중심** 절차가 자동화되어, 법적 요구와 운영 효율을 모두 충족하며 **오탐·미탐 판단의 재현성**을 보장.
