# 필상 시스템 — Day 21 외부 TI 연동 & 평판 캐시(TI Cache/RAG Explain)

1. **날짜**

* 2024-09-03

2. **목표**

* **외부 Threat Intelligence(TI)** 소스(예: VirusTotal, AbuseIPDB, MalwareBazaar 등) 연동 표준 확정
* **평판 점수화→캐시→정책 반영** 파이프라인과 **설명(Explain/RAG)** 출력을 200ms 내 제공

---

3. **내용**

### A. 아키텍처 개요

* **TI Fetcher**: 외부 TI API 어댑터(소스별 키/쿼터 관리, 재시도/백오프)
* **TI Normalizer**: 소스별 결과를 **공통 스키마**로 변환(신뢰도·증거 링크 포함)
* **TI Cache(Region-local)**: `ti_cache_{region}`(Solr/Key-Value 혼합), TTL 단축 정책
* **TI Policy**: 점수→액션 매핑(allow/review/block, 가중치), **DBV360**와 연동
* **Explain(RAG)**: 캐시·증거 문장·룰/사건 로그를 **요약 템플릿**으로 설명(콘솔 노출)

### B. 데이터 스키마(핵심)

```json
{
  "key": "ip:203.0.113.10",            // ip: / hash: / url:
  "first_seen": "2025-09-03T01:02:03Z",
  "last_seen": "2025-09-03T02:45:00Z",
  "score": 72,                          // 0~100 (높을수록 위험)
  "labels": ["bruteforce","botnet"],
  "sources": [
    {"name":"abuseipdb","score":55,"confidence":0.7,"evidence_uri":"…"},
    {"name":"virustotal","score":80,"confidence":0.9,"evidence_uri":"…"}
  ],
  "meta": {"asn":"AS12345","country":"KR","samples":12}
}
```

* **스코어 규칙**: `score = Σ(w_source * normalized_source_score) + context_boost`

  * 기본 가중치: VT 0.5, AbuseIPDB 0.3, MB 0.2 (테넌트 델타 허용)
  * **Context Boost**: 동일 IP의 최근 10분 `blocked:1` 비율, `asn_country_mismatch` 등

### C. 쿼리/캐시 정책

* **동기 조회**: 판정 경로 SLA 50ms(캐시 히트), **미스 시 비동기 보강**(즉시 판정은 캐시만)
* **TTL**: 고위험(score≥80) 30분, 중간 2시간, 저위험 6시간, **부정확 소스는 짧게**
* **지역성**: **리전 로컬 캐시만 사용**(데이터 주권), 외부 API 호출도 리전 경유
* **Pre-Warm**: 유입 상위 IP/AS를 1분 간격 프리워밍(버짓 내)

### D. 정책 매핑(예)

| Score | 액션     | 설명                         |
| ----- | ------ | -------------------------- |
| ≥ 90  | block  | 즉시 차단 + 알림(crit) + 룰 강화 후보 |
| 70–89 | review | 판정 가중 + DBV360 샘플 확장       |
| 40–69 | allow  | 증거 보강(라벨/AS/국가), 의심 태깅     |
| < 40  | allow  | 영향 없음(로그만)                 |

* **화이트/블랙리스트**: 테넌트/글로벌 오버라이드 우선(감사 로그 필수)

### E. 보안·컴플라이언스

* **데이터 최소화**: 외부로 **원본 로그 전송 금지**, 해시/요약치만 사용
* **키 보호**: TI API Key는 **KMS**(90일 로테이션), 호출 로그는 마스킹 저장
* **계약**: 처리위탁 레지스터 유지, 저장/보관 지역 제한 조항 확인

### F. 장애·쿼터 보호

* **레이트 리밋**: 소스별 쿼터 추적(토큰 버킷), 초과 시 **폴백=캐시 전용**
* **헬스 체크**: 5xx↑/타임아웃↑ 시 **서킷 브레이커** 오픈(1–5분), 실패율 대시보드
* **중앙 플래그**: `ti.fetcher.enable=false`로 Kill-Switch, 캐시 모드 유지

### G. Explain(RAG) 출력(분석가용)

* 입력: 사건의 `src_ip`, 최근 24h 히트, 룰/특징량, `ti_cache` 문서
* 템플릿:

  * **요약**: “IP는 최근 24h 동안 VT 악성 판정 N/70, AbuseIPDB 신고 M회. 동일 IP의 200 응답 비율 X%로 FP 가능성 {낮음/중간/높음}.”
  * **근거**: 상위 소스 3개, 라벨·샘플 링크, 내부 샘플 쿼리(저장 템플릿)
  * **권고**: “차단 유지/검토/허용” + 룰 델타 제안(있으면)

### H. 메트릭/대시보드

* `ti_hit_rate`, `ti_lookup_latency_p95`, `ti_cache_ttl_age`, `ti_source_error_rate`, `score_distribution`
* 상위 위험 AS/국가, **오탐·정탐 상관**(DBV360 라벨과 코릴레이션)

### I. API(발췌)

* `GET /v1/ti/{key}` — 캐시 조회(캐시 상태/TTL/소스별 세부 포함)
* `POST /v1/ti/refresh { key }` — 비동기 갱신 트리거(권한 필요)
* `POST /v1/ti/override` — 수동 오버라이드(사유, 만료 시각)
* `GET /v1/ti/explain?incident_id=…` — RAG 기반 요약(콘솔 카드)

### J. 운영 체크리스트

* [ ] 소스별 키/쿼터 등록, 서킷 브레이커 임계치 설정
* [ ] 캐시 TTL/가중치 테넌트 오버레이 검토
* [ ] Explain 템플릿 ko/ja/en 번역, 링크 안전성(서명 URL) 확인
* [ ] 월간 **정탐/오탐 상관 분석** 리포트 자동 발행
* [ ] TI 소스 변경 시 **컨트랙트 테스트** 실행

---

4. **예시 설명 (혼합 신호—오탐 방지 판정 흐름)**

1) `src_ip=203.0.113.10` 사건 발생, 캐시 **HIT**(score=68, 라벨 `scanner`) — 정책상 **allow**
2) 그러나 최근 30분 **406/Blocked:1** 급증 → Context Boost +10, **review** 구간 진입
3) **DBV360**가 동일 IP의 **200 응답 10건** 확보, VT·AbuseIPDB 증거 링크는 **낡은 샘플**(30일↑)
4) Explain 카드: “최근 증거 부족, 정상 트래픽 혼재 → FP 가능성 높음” 제시
5) 분석가가 **allow** 확정 → TI 오버라이드(만료 24h) 저장, 룰 델타(한국어 검색 파라미터 화이트리스트) 자동 제안
   → 결과: 외부 TI 의존 과다를 피하고 **현행 트래픽 문맥**과 결합해 **정확도↑·오탐↓**, 응답 시간과 주권을 모두 만족.
