# 필상 시스템 — Day 27 테스트 전략 & 품질 보증(QA·자동화·회귀)

1. **날짜**

* 2024-09-11

2. **목표**

* **테스트 피라미드**·**계약(Contract)·회귀·보안 테스트** 표준 확정
* **플레이북化**하여 PR→릴리스까지 **품질 게이트** 통과를 자동화(플레이키스 방지 포함)

---

3. **내용**

### A. 테스트 피라미드(표준 커버리지)

* **단위(Unit)**: 함수/핵심 로직(룰 DSL, 파서, 특징량) — **행 70%·브랜치 60%** 이상
* **계약(Contract)**: Producer/Consumer, OpenAPI/AsyncAPI 스키마 **파괴 변경 탐지**
* **통합(Integration)**: DB/Redis/S3/솔라 단일 의존성 조합, **Idempotency** 검증
* **E2E(시나리오)**: Ingest→Detect→Incident→Notify(샘플 3세트)
* **혼합(Chaos/Perf 스모크)**: 리더 교체·네트워크 지연 50–200ms 주입

### B. 테스트 데이터 정책

* **피처 픽스처**: 한국어 URL 인코딩, 대용량 헤더, 희귀 UA, 공격 페이로드 1k 세트
* **합성 로그 팩**: 30/90일 분량(표본), **PII 마스킹**·랜덤화, 해시로 재현성 보장
* **TI/외부**: Mock 서버(HMAC 검증) 기본, 라이브 호출은 **리전별 키·쿼터 제한** 하 샌드박스만

### C. 계약(Contract) & 스키마 테스트

* 원천: `openapi.yaml` `asyncapi.yaml`
* **프로듀서**는 샘플 페이로드를 **스키마 밸리데이션** 후 발행
* **컨슈머**는 **버전 범위** 선언(`supports: 1.2–1.4`), CI에서 **호환 매트릭스** 실행
* **브레이킹 체커**: 필드 삭제/타입 변경/제약 강화 → PR **차단**

### D. 회귀·리플레이(Replay)

* **DBV360/탐지**: 7·30·90일 리플레이 스위트(정탐/오탐·미탐 케이스)
* **성능 회귀**: 상위 5 쿼리 템플릿 p95 비교(허용 편차 +10% 이내)
* **릴리스 전** E2E 30분 내구성(저부하) 통과 시에만 배포 가능

### E. 보안 테스트(Shift-left)

* **SAST**(코어/웹), **DAST**(콘솔/API), **IAST**(선택), **Fuzz**(파서/정규화)
* **비밀 탐지**: `gitleaks` + 커밋 훅, 실패 시 **즉시 차단**
* **웹훅 서명/재생 방지**: 타임스탬프 윈도우·nonce 캐시 **부정 테스트**

### F. 신뢰성·플레이키스(Flaky) 관리

* **표식**: `@flaky` 라벨 + 격리 워크플로우(메인 게이트 비참여)
* **3회 연속 성공** 시 해제, 2주 경과 시 소유자에게 리마인드
* **시드 고정**: 무작위 테스트는 시드/ULID 프리픽스 고정으로 재현

### G. 품질 게이트(파이프라인 단계별)

1. **pre-commit**: lint/format/secret 0 실패
2. **unit**: 커버리지 기준 충족, **Mutation Score ≥ 40%**(룰/파서 모듈)
3. **contract**: 스키마 회귀 0건, SDK 재생성 정상
4. **integration**: Idempotency/트랜잭션 경계 테스트 통과
5. **e2e**: 핵심 시나리오 성공, SLO 스모크(p95 지연 한계 내)
6. **security**: SAST/DAST/CVE 게이트(High+ 0건)
7. **perf-smoke**: 검색 p95 ≤ 1.0s, 인입 drop ≤ 0.1%
   → 어느 한 단계 실패 시 **릴리스 중단 & 티켓 자동 생성**

### H. 환경·도구 표준

* **테스트 러너**: Jest/Vitest(웹·노드), Pytest(파이썬), Go test, K6(성능), Chaos Mesh(카오스)
* **테스트 네임스페이스**: `env=test` 전용(격리 DB/인덱스/버킷)
* **컨테이너 픽스처**: `docker compose -f docker-compose.test.yml up -d`
* **시각 회귀**: Storybook + Chromatic(콘솔 컴포넌트)

### I. 리포팅·관측

* **JUnit/Allure** 결과 수집, 실패 Top-N 트렌드 대시보드
* **테스트 커버리지 지도**(모듈·파일·라인), **결함 밀도**와 릴리스 상관
* 실패 샘플 **EPKG 라이트**(입력/출력/로그) 자동 첨부—재현 시간 단축

### J. 운영 체크리스트

* [ ] 새 룰/파서 PR에 **리플레이 케이스 3건 이상** 포함
* [ ] 외부 통합(Mock)·실계 키 분리, 실계 호출은 **야간 배치**로만
* [ ] Flaky 격리 목록 주간 비우기 목표(0→N 감소 추적)
* [ ] 실패 테스트는 **RCA 코멘트** 없이는 재시도 금지
* [ ] 성능 예산 초과는 코드/스키마/튜닝 중 최소 1개 변경 커밋 동반

---

4. **예시 설명 (룰 변경으로 인한 미탐 회귀 사전 차단)**

1) `WAF-941100-tuned v9` PR: 한국어 검색어 화이트리스트 범위 확대 제안
2) CI **contract** 정상이나, replay(30일)에서 특정 SQLi 우회 케이스 **정탐→미탐** 회귀 감지
3) 파서 특징량 `param_sig` 가중치 변화가 원인으로 식별 → 룰 델타 수정(`sig whitelist`를 더 좁힘)
4) 재실행에서 정탐 회복, 성능·E2E 스모크 통과 → **승인/배포**
   → 결과: **리플레이·계약·성능 게이트**가 결합되어 배포 전에 **미탐 회귀**를 차단, 운영 리스크를 체계적으로 축소.
