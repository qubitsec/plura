# 필상 시스템 — Day 26 API 거버넌스(버저닝·계약·호환성)

1. **날짜**

* 2024-09-10

2. **목표**

* 공용/내부 API의 **버저닝·계약(Contract)·호환성** 원칙 확정
* **Idempotency·에러 규격·감사·폐기(Deprecation)** 절차 표준화 및 **SDK 자동생성** 체계 구축

---

3. **내용**

### A. API 포트폴리오 구분

* **Public API**: 고객/파트너용(읽기 중심 + 제한적 쓰기), 안정 주기 길게
* **Private API**: 콘솔·내부 서비스 간(성능/실험 플래그 허용)
* **Admin API**: 운영자만(고위험 액션—킬스위치, 오버라이드 등)

### B. 네이밍·버저닝

* 경로 버전: `/v{n}`(주버전), **하위 호환 변경은 마이너**(헤더 `X-API-Version: 1.3`)
* **수명주기**: `experimental → beta → stable → deprecated → sunset`
* **Sunset 정책**: Deprecation 공지 ≥ **90일 전**, 대체 경로/마이그 가이드 필수

### C. 계약(Contract) 관리

* 단일 원천: `openapi.yaml`(REST), `asyncapi.yaml`(이벤트)
* CI 게이트: **스키마-회귀 검사**(Breaking Change 탐지), 샘플 페이로드 유효성
* **소스 코드 생성**: SDK(Typescript/Python/Go)·서버 스텁 자동 갱신 & 태깅

### D. 표준 응답·에러 규격

```json
// 성공
{ "data": {...}, "meta": {"cursor":"...","asOf":"2025-09-10T00:00:00Z"} }
// 에러
{ "error": { "code":"INC_40401", "message":"Incident not found",
             "details":[{"pointer":"/incident_id","reason":"invalid"}],
             "trace_id":"8f2c..." } }
```

* 코드 체계: `AUTH_*`, `VAL_422xx`, `INC_*`, `RULE_*`, `SYS_*`
* **추적성**: 모든 응답에 `trace_id`(OTel 연동) 포함

### E. 페이징·정렬·필터

* **Cursor 기반**(권장), `limit ≤ 200`
* **정렬**: `sort=ts:desc,severity:asc`
* **필터**: RLS 강제(`tenant_id` 자동 주입), 시간필터 RFC3339 범위

### F. Idempotency & 멱등 키

* 쓰기/변경 API에 `Idempotency-Key` 헤더(ULID) 필수
* 서버는 **24h 윈도우** 캐시·중복 차단(상태/응답 재돌려줌)
* 재시도 가능 액션 구분: `create`(O), `transition`(O), `delete`(주의—soft delete 권장)

### G. 보안·권한

* **인증**: OIDC Bearer + mTLS(서비스 간)
* **인가**: Scope(`incidents:read`, `rules:write`) + **ABAC**(tenant/region/purpose)
* **요청 서명**(웹훅 수신/관리형 엔드포인트): `X-Plura-Signature: v1=HMAC-SHA256`

### H. 속도 제한·오남용 방지

* **레이트리밋**: 토큰/IP/테넌트 단위(버스트/지속), 초과 시 `429` + `Retry-After`
* **쿼리 가드**: 저장된 템플릿만 허용(검색), 비정상 패턴 자동 차단·감사

### I. 감사지표·버전 호환

* **Capability 협상**: `GET /v1/capabilities`(서버가 기능 플래그·제약 노출)
* **호환성 매트릭스**: SDK 버전 ↔ API 최소/최대 지원을 메타데이터로 제공
* **감사**: `who/what/why/when/trace_id` 해시체인 기록(다운로드/변경 포함)

### J. 예제 스니펫(OpenAPI 발췌)

```yaml
openapi: "3.1.0"
info: { title: "Incident API", version: "1.3.0" }
paths:
  /v1/incidents:
    get:
      parameters:
        - { in: query, name: tenant_id, required: true, schema: { type: string } }
        - { in: query, name: cursor, schema: { type: string } }
        - { in: query, name: severity, schema: { enum: [low,med,high,crit] } }
      responses:
        "200": { $ref: "#/components/responses/IncidentList" }
        "401": { $ref: "#/components/responses/AuthError" }
  /v1/incidents/{id}:transition:
    post:
      parameters:
        - { in: header, name: Idempotency-Key, required: true, schema: { type: string } }
```

---

4. **예시 설명 (Deprecated → Sunset 전환 시나리오)**

1) `GET /v1/search/raw`가 성능/보안 문제로 **Deprecated** 공지(대체: `POST /v1/search/saved/{key}:execute`)
2) 콘솔·SDK에 **경고 배너/로그** 노출, 사용량 메트릭 추적 및 상위 고객사 안내
3) 90일 윈도우 동안 두 경로 **동시 제공** + 결과 동등성 테스트(계약 테스트)
4) 남은 호출이 5% 미만이 되면 **Sunset** 배포: 요청 시 `410 Gone` + 마이그 가이드 링크 반환
5) 릴리스 노트/감사 인덱스에 **폐기 타임라인**과 영향 범위를 기록, CSM이 마이그 완료 체크

> 결과: 단일 스키마 원천과 자동 회귀·멱등·감사 체계를 통해 **안정적 진화**와 **고객 영향 최소화**를 동시에 달성.
