# 필상 시스템 — Day 22 사용량 계량(Metering) · 과금(Billing) · 라이선스

1. **날짜**

* 2024-09-04

2. **목표**

* **테넌트별 사용량 계량→정산→청구** 파이프라인과 데이터 모델 확정
* **플랜/한도/할인/리셀러 정산** 규칙 표준화, **결제·세금(KR/JP)** 대응

---

3. **내용**

### A. 범위 & 원칙

* **측정 단위**: 인입건수(Records), 저장용량(GB·월), 인덱스 문서수, 알림 전송(건), 사용자석(Seat)
* **신뢰성**: 멱등 이벤트 기반 집계(Exactly-once 효과), **서명된 집계 스냅샷** 보관
* **투명성**: 콘솔 **Usage & Billing**에서 **일일 집계**와 **예상 청구액** 실시간 제공
* **지역/통화**: KR(₩, 부가세), JP(¥, 소비세). 환율은 **청구 시점 고정**(일일 기준)

### B. 데이터 모델(핵심)

* `UsageEvent(id, tenantId, metric, quantity, occurredAt, source, signature)`
* `UsageBucket(tenantId, metric, window:{hour|day|month}, value, updatedAt)`
* `Plan(id, name, region, included:{records, gb, alerts, seats}, overage:{metric, price})`
* `Discount(id, type:{percent|amount|tier|reseller}, scope:{tenant|partner}, term)`
* `Invoice(id, tenantId, period, currency, lines[], tax, total, status)`
* `Partner(id, name, share_percent, settlement_cycle)`

### C. 계량 파이프라인

1. **프로듀서**: 인입/알림/스토리지 등 각 서비스가 `usage.event.v1` 발행
2. **정규화**: `metric, quantity, tenant_id, occurred_at` 검증(부호/단위)
3. **집계기**: 시간 창(`H/D/M`)으로 **증분 집계** → `UsageBucket` 업데이트
4. **스냅샷**: 일 1회 **서명 스냅샷**(테넌트별 합계) 생성·보관(Object Storage, WORM)
5. **역계산 방지**: 이벤트 원본은 **해시만** 저장(개인정보 노출 최소화)

.  

### D. 플랜/한도/오버리지

* **STD**: 인입 6억건/월, 저장 500GB, 알림 5만건, 좌석 50 포함
* **ENT**: 커스텀 한도 + 전용 샤드/지원, 계약 단가(오버리지 단가 낮음)
* **한도 초과**: 소프트 스로틀 + 콘솔 경고 + CSM 알림 → **오버리지 과금** 또는 업그레이드
* **버스트 정책**: 24h 내 일시 초과는 **허용**(누적 5%까지), 이후 정상 요율 적용

### E. 할인/리셀러/프로모션

* **기간 할인**: 선결제/장기 약정(연간) % 할인
* **티어 할인**: 사용량 구간별 단가 자동 하향
* **리셀러 정산**: `partner.share_percent`에 따라 **역청구(월말+10영업일)**
* **프로모션 코드**: 시작 월 오버리지 면제 등(기간·메트릭·상한 지정)

### F. 청구 & 세무

* **주기**: 월 단위(UTC 말일 기준) / **미드사이클 승급 시 일할 계산**(Proration)
* **세금**: KR 부가세 10%, JP 소비세 10%—**과세 대상 항목만** 적용
* **송장 확정**: 매월 **영업일 4일 내** 발행, 콘솔·메일 발송(PDF+CSV 라인아이템)
* **결제**: 카드/세금계산서(후불) 지원—미수 30일 경과 시 자동 알림·일시 제한(읽기 전용)

### G. 관측·정합성

* SLI: `usage_lag_p95 ≤ 2m`, 스냅샷 생성 성공률 99.9%
* **3중 대사**: (1) 이벤트 합계 = (2) 버킷 합계 = (3) 인보이스 합계(±0.1% 이내)
* **감사**: 모든 요율·할인·환율 변경은 **플래그/PR**로 관리, 해시체인 기록

### H. 콘솔 UX(요약)

* **Usage 대시**: 메트릭별 월 누적/한도/예상 청구액, 오버리지 예측
* **플랜 관리**: 업/다운그레이드, 약정/리셀러 설정, 프로모션 코드 적용
* **다운로드**: 인보이스 PDF, 라인아이템 CSV, **서명 스냅샷 해시** 제공

### I. 실패·예외 처리

* 이벤트 지연/유실: 재전송 토픽 + 멱등키(`event_id`)로 **중복 방지**
* 요율 변경 중 청구: **컷오버 시각** 기준 전/후 분리 계산
* 환불/크레딧: 티켓 승인 후 **크레딧 노트** 발행, 다음 청구에 자동 차감

---

4. **예시 설명 (STD 테넌트—한도 초과/업그레이드 흐름)**

1) 월 중순 인입이 급증, **예상 오버리지 14만건** 표시 → 콘솔 경고 + CSM 알림
2) 고객이 **ENT로 업그레이드**(즉시 적용, 남은 기간 **일할 계산**), 오버리지 단가 ↓
3) 월말 집계: `records(7.14억)` 중 STD 포함 6억 + 오버리지 1.14억 × 단가(ENT 기준)
4) 할인(연간 약정 15%)과 JP 소비세 10% 적용 → **송장 확정**(영업일 3일 차)
5) 라인아이템 CSV에는 **메트릭·단가·구간·할인·세금**이 분리 표기, 서명 스냅샷 해시로 정합성 검증
   → 결과: 실시간 가시성·일할/오버리지 자동화·지역 세금 대응으로 **분쟁 최소화**, 파이프라인은 **멱등·감사 가능**하게 운영.
