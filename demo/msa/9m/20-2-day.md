# 필상 시스템 — Day 20 구성·피처 플래그(Config · Feature Flags)

1. **날짜**

* 2024-09-02

2. **목표**

* **안전한 런타임 구성 변경**과 **점진적 기능 롤아웃** 표준 확정
* **롤백/킬스위치 5분 이내**, **전파 지연 p95 ≤ 3s**, **감사 100%** 보장

---

3. **내용**

### A. 원칙(Design Goals)

* **불변 아티팩트 + 가변 구성**: 이미지는 동일, 행위는 **Config/Flag**로 제어
* **기본 안전(Default-Safe)**: 미평가/오류 시 **기본값=보수적**
* **작은 폭발 반경**: 타겟팅·퍼센트 롤아웃으로 단계적 적용
* **전파 보장**: 캐시 TTL ≤ 2s, 스트리밍 변경 알림(폴백: 폴링 1s)

### B. 구성 스토어(스키마/계층)

```
/configs/{env}/{region}/{service}/{version}.yaml
/flags/{env}/{region}/{service}.json   # 실시간
```

* **환경**: `dev | stg | prod`, **리전**: `kr | jp`
* **검증**: JSON Schema + CI 컨트랙트 테스트(`config lint`)
* **버전**: Config는 **SemVer**, Flags는 **서버 타임스탬프**(ULID)

#### Config 예(발췌)

```yaml
# configs/prod/kr/ingestor/1.4.0.yaml
ingest:
  max_body_kb: 256
  parser_timeout_ms: 200
  enrich_ti_timeout_ms: 50
  sampling:
    features_only_threshold: 0.85   # 큐 적체율 기준
```

### C. 플래그 타입 & 평가

* **Boolean**: on/off (예: `beta_ui_console`)
* **Percentage**: 5%→25%→100% 롤아웃(해시 키: `tenant_id|user_id`)
* **Multivariate**: A/B/n(값: `algo=v1|v2|v3`)
* **Kill-Switch**: 위험 경로 즉시 차단(파서/룰/웹훅) — **우선순위 최고**
* **타겟팅 규칙**(우선순위)

  1. **테넌트/리전/플랜**: `tenant in ["acme-kr"] AND region=="kr" AND plan=="ent"`
  2. **역할/스코프**: `role=="ADMIN"`
  3. **퍼센트 롤아웃**: `rollout=25%`
  4. **기본값**: `default=false`

#### Flag 예(발췌)

```json
{
  "beta_ui_console": {
    "default": false,
    "rules": [
      {"if":"region=='kr' && role=='ADMIN'","then":true},
      {"if":"region=='kr'","then":{"percentage":25}}
    ]
  },
  "parser_waf_sig_compat": { "default": true, "kill_switch": true }
}
```

### D. 전달 방식 & 일관성

* **SDK/Sidecar**: gRPC 스트림(변경 푸시), 폴백 HTTP `ETag` 캐시
* **일관성**: 강/약 선택 — 제어면(Config) **강한 일관성**, 플래그 **최종 일관성(p95 ≤ 3s)**
* **부하 보호**: 백오프·지수 재시도, 지역 캐시 장애 시 **보수적 기본값** 유지

### E. 보안·권한·감사

* **RBAC**: `config:edit`, `flags:edit`, `flags:approve` 분리
* **2인 승인**: Kill-Switch 비활성/대규모 퍼센트 증가(>25%)는 **승인 2명** 필요
* **감사 로그**: `who, what(key→value), why(purpose), when(ts), issue/PR, release_id`—해시체인
* **시크릿 분리**: Flag/Config에 **비밀값 저장 금지**(KMS 연동 값만 참조)

### F. 모니터링·가드레일

* 노출(Impression)·결과(Event) **코릴레이션**: `flag_key, variant, release_id` 라벨
* **가드레일 규칙**

  * 변경 후 15분 **SLO 게이트** 위반 시 **자동 롤백**
  * 오류율↑/지연↑ 감지 시 퍼센트 **자동 하향**(25→5→0)
* **KPI**: 전파 지연, 롤백 시간, Kill-Switch 활성 빈도, 변경 실패율

### G. 배포 연동(릴리스와 분리)

* 릴리스는 **기능 비활성** 상태로 배포 → 플래그로 순차 활성
* **캐패빌리티 네고**: 클라이언트가 지원 기능을 서버에 보고 → 서버가 호환 플래그만 전송
* **런북**: “플래그 롤아웃 계획서” 템플릿(대상·단계·되돌리기 조건 포함)

### H. API(발췌)

* `GET /v1/flags?service=console&region=kr` — 클라이언트 페치
* `POST /v1/flags/{key}:evaluate` — 규칙 디버그(조건·해시·타겟 매칭)
* `POST /v1/flags/{key}` — 생성/수정(승인 플로우 연동)
* `POST /v1/flags/{key}:rollback` — 이전 스냅샷으로 복귀
* `GET /v1/configs/{service}/effective?env=prod&region=kr` — 합성 결과 조회

### I. 실패·복구 시나리오

* **구성 서비스 장애**: SDK 캐시 TTL 만료 전에는 **현 상태 유지**, 만료 후 **보수적 기본값**
* **오배포/오설정**: `rollback` API로 **스냅샷 복귀**, 상태페이지에 변경 이력 자동 게시
* **드리프트 방지**: IaC 원장과 실시간 값 **양방향 드리프트 알림**

### J. 운영 체크리스트

* [ ] 모든 신규 기능은 **플래그 기본 OFF**, 롤아웃 계획서 첨부
* [ ] Kill-Switch는 **테스트 주기적 수행**(월 1회)
* [ ] 플래그 만료일(End-of-Life) 지정·청소 배치 활성
* [ ] 변경 후 **관측 대시** 링크 공유(SLO 게이트 포함)
* [ ] 감사지표(누가/왜/언제) 100% 수집 확인

---

4. **예시 설명 (파서 성능 이슈—즉시 Kill-Switch & 안전 롤백)**

1) 배포 후 **KR** 일부 테넌트에서 `normalize_latency_p95` 급등 → **SLO 게이트** 경보
2) 온콜이 `parser_waf_sig_compat` 플래그(**Kill-Switch**)를 **kr 리전**에 한해 **즉시 OFF**

   * 전파 p95 1.8s 내 적용, 인입 지연 12s → **7.1s** 회복
3) 원인 분석 중, `beta_ui_console` 25% 롤아웃은 자동 하향 5%로 안전 모드 전환
4) 패치 완료 후 **퍼센트 롤아웃**: 5%→25%→100% 승격, 15분 관찰 **무이상**
5) 감사 인덱스에 **플래그 변경 타임라인**(행위자/사유/증거) 기록, 릴리스 노트 자동 갱신

> 결과: **이미지 불변·구성/플래그 가변** 원칙으로 위험을 격리하고, **수 초 내 킬스위치**와 **자동 가드레일**로 서비스 안정성과 배포 민첩성을 동시에 확보.
