# 필상 시스템 — Day 33 테넌트 오프보딩(계약 종료) · 데이터 이행(Export) · 삭제(Erasure)

1. **날짜**

* 2024-09-24

2. **목표**

* **계약 종료/해지/이전** 상황에서의 **데이터 내보내기(Export)·삭제(Erasure)·증거 보존** 절차 표준화
* **데이터 주권·프라이버시·감사**를 준수하며 **30일 내 완결**, 요청형 삭제는 **7일 내** 처리

---

3. **내용**

### A. 범위 & 원칙

* **범위**: 인덱스(Solr), 메타-DB(Postgres), 객체 증거(MinIO/S3), 티켓/알림/감사, 설정/룰/플래그
* **원칙**: **리전 내 처리**, **최소 데이터 전송**, **무결성 증명(해시/서명)**, **가역성 최소(삭제는 최종적)**

### B. 종료 유형 & 타임라인(기본)

| 유형         | 예시             | T0       | T+7d       | T+14d    | T+30d |
| ---------- | -------------- | -------- | ---------- | -------- | ----- |
| **계약만료**   | 기간 종료          | 통지/동결    | Export 윈도우 | 고객 확인    | 삭제/폐기 |
| **중도해지**   | 조기 종료          | 동결/청구정산  | Export     | 확인       | 삭제/폐기 |
| **테넌트 이전** | KR→KR 내 파트너 변경 | 동결/계약 갱신 | Export·검증  | 새 테넌트 이관 | 잔여 삭제 |

> **법적 보존(legal_hold=true)** 시 삭제/키 파기 보류, 모두 **감사 인덱스** 기록.

### C. 동결(Freeze) & 접근

* T0: 테넌트 상태를 `frozen`으로 전환(쓰기 금지, 읽기/Export만).
* API 키·Webhook 비활성, 알림/티켓 생성 중지.
* 콘솔 배너로 일정·담당자·Export 가이드 표시.

### D. Export 사양

* **형식**:

  * 인덱스: `ndjson` 스냅샷 + 스키마(`schema.json`)
  * 메타-DB: `pg_dump --schema=tenant_x`(민감 컬럼 마스킹 선택)
  * 객체: **서명 URL** 목록(manifest) + 선택적 아카이브
* **패키지(EPKG-X)**: `manifest.json`(총량/해시/개수), `checksums.txt`, `evidence.html`
* **전송**: 고객 소유 버킷(S3·KMS) 또는 사내 게이트웨이(전송 중 TLS, 목적 바인딩)

### E. 삭제(Erasure) & 파기

* **순서**: 인덱스 삭제 → 메타-DB 스키마 드롭 → 객체 **키 파기 후** 삭제(WORM 예외 처리)
* **키/비밀**: Ingest/Webhook/Client Secret **폐기**(KMS 기록), 접근 롤·바인딩 제거
* **리포트**: `erasure-report.json`(개수/바이트/해시/시간/서명자/예외 목록)

### F. 예외/보존

* **Legal Hold**: 사건/증거/감사 레코드 보존, Export는 요약치/서명 링크만 제공
* **공유 룰·모델**: 테넌트 델타만 삭제, **글로벌 룰**은 유지(참조 링크 제거)

### G. 관측·SLO

* **Export 착수 ≤ 48h**, **Export 완료 p95 ≤ 5일**(데이터 3TB 기준), **Erasure 완료 p95 ≤ 24h**
* 지표: `export_bytes`, `export_errors`, `erasure_objects`, `kms_destroy_count`, `audit_gap=0`

### H. 보안·컴플라이언스

* **주권**: 교차 리전 전송 금지(계약/서면 동의 제외).
* **무결성**: 모든 아티팩트 **sha256** 및 **루트 해시** 제공, 담당자 **이중 서명**.
* **감사**: `who/what/why/when/trace_id` 전 과정 해시체인, PDF 요약(서명) 동봉.

### I. API(발췌)

* `POST /v1/tenants/{id}:freeze` — 동결 전환
* `POST /v1/tenants/{id}:export { scope, window, pii_mask }` — Export 생성
* `GET /v1/tenants/{id}/exports/{export_id}` — 상태/다운로드/해시
* `POST /v1/tenants/{id}:erasure` — 삭제 실행(승인 2인)
* `GET /v1/tenants/{id}/erasure/{job_id}` — 리포트 조회

### J. 체크리스트

* [ ] 계약/정산 종료 확인, 플랜/리셀러 정산 반영
* [ ] `legal_hold`/규제 데이터 여부 확인
* [ ] Export 범위·마스킹 정책 합의(ko/ja/en 안내)
* [ ] 서명 키/접근권한 회수, API/Webhook 비활성
* [ ] Erasure 리포트·감사 스냅샷 보관(3년)

---

4. **예시 설명 (ENT 테넌트—KR 오프보딩 & 데이터 이행 21일 내 완료)**

1) **T0**: `tenant=acme-kr` 계약만료 → 상태 `frozen`, 키·웹훅 비활성, 일정 안내.
2) **Export**: 고객 S3(KMS)로 `EPKG-X` 전송(인덱스 1.8TB, 객체 420GB), 루트 해시·서명 제공.
3) **검증**: 고객이 해시 일치 확인 → **수령 확인서** 서명(전자).
4) **Erasure**: 키 파기 → 인덱스/메타·객체 삭제, `erasure-report.json` 발행.
5) **종결**: 감사 해시체인 스냅샷, 상태 `terminated`, FinOps/청구 마감.
   → 결과: **주권·무결성·감사**를 보장한 표준 오프보딩으로 분쟁을 줄이고, 고객의 **데이터 이행**을 안전하게 완결.
