# 필상 시스템 — Day 31 정책 코드화(Policy-as-Code) · OPA/Rego · 드리프트 감지

1. **날짜**

* 2024-09-20

2. **목표**

* **운영·보안·데이터 주권** 규칙을 **Policy-as-Code(OPA/Rego)**로 일원화
* **구성 드리프트 감지→차단/완화→증거화**를 표준화(평균 탐지 ≤ 60s, 자동 교정 ≤ 5분)

---

3. **내용**

### A. 아키텍처(개요)

* **Policy Registry**: `policies/{domain}/{id}/vN.rego`(서명·태깅)
* **OPA Sidecar/Agent**: 각 서비스 Pod에 배치(핫 리로드), 게이트웨이는 **External OPA** 캐시
* **Decision Log**: `policy.decision.v1` 이벤트로 중앙 수집(감사 해시체인)
* **Drift Watcher**: 실제 상태(K8s/NGINX/Solr/DB/KMS) 스냅샷 ↔ 선언적 원장(IaC/Config) **차이** 계산

### B. 정책 도메인(초안)

* **Access**: RBAC/ABAC, 목적 구속(`purpose`) 필수, 다운로드는 서명 URL만
* **Network/Egress**: 허용 도메인/AS 화이트리스트, 웹훅 **HMAC 서명** 강제
* **Data Sovereignty**: `region == resource.region` 미일치 차단, 교차 리전 인덱스 금지
* **Config Safety**: 플래그/레이트리밋 상한, 위험 옵션(로그 원문 노출 등) 금지
* **Change Window**: L2/L3 변경은 허용 시간대·승인자 요건 충족 시에만 통과

### C. 배포·번들링

```
/policies
  /access/tenant_rls.rego
  /egress/webhook_sign.rego
  /sovereignty/region_isolation.rego
  /config/flags_safety.rego
  bundle.manifest.json  # 해시·버전·서명
```

* **번들**: 주버전(파괴적 변경) + 마이너(규칙 추가) 구분, **리전별 델타** 지원
* **전파**: 변경 이벤트 → OPA Pull(ETag) ≤ 3s, 실패 시 **이전 버전 유지**

### D. 평가 지점(Enforcement Points)

* **API Gateway**: 요청 전 `allow/deny`(레이트리밋·CORS·서명 검증 포함)
* **Service Ingress**: RLS 필터 주입 검증(`tenant_id`)
* **Background Jobs**: 리포트/증거 패키지 생성 시 데이터 등급·목적 검사
* **Change Mgmt**: 배포 봇이 **CAB 승인·창구 시간** 정책 평가 후 진행

### E. 드리프트 감지(표준)

* 비교 원천: **Desired(State)**=IaC/Config/Flags vs **Actual**=K8s/NGINX/DB/Solr/KMS
* **규칙**: 차등 임계(중요 자원 즉시 ALARM, 경미 10분 윈도우)
* **액션**: `auto_repair(on/off)`·`freeze(flag)`·`rollback(config)` 중 정책에 내장

### F. SLO/지표

* `policy_eval_latency_p95 ≤ 5ms`(로컬 캐시), `drift_detect_time_avg ≤ 60s`
* `deny_rate`, `false_deny_rate`, `auto_repair_success_rate`, `decision_log_ingest_lag`

### G. 예시 정책(Rego 발췌)

**1) 데이터 주권**

```rego
package sovereignty

default allow = false
allow {
  input.request.tenant.region == input.resource.region
}
deny[msg] {
  not allow
  msg := sprintf("region mismatch: tenant=%v resource=%v",
    [input.request.tenant.region, input.resource.region])
}
```

**2) 웹훅 서명·재생 방지**

```rego
package egress

valid {
  startswith(input.headers["x-plura-signature"], "v1=")
  time.now_ns() - input.headers["x-plura-timestamp_ns"] < 5 * 60 * 1e9
  input.signature_ok == true   # 게이트웨이 HMAC 프리체크 결과
}
deny[msg] {
  not valid
  msg := "webhook signature/timestamp invalid"
}
```

**3) 변경 창/승인**

```rego
package change

default allow = false
allow {
  input.change.risk in {"L1","L2"}
  time.weekday(time.now_ns()) in {"Mon","Tue","Wed","Thu","Fri"}
  input.change.window in {"09:00-18:00"}
  input.change.approvals >= required[input.change.risk]
}
required := {"L1":1,"L2":2,"L3":3}
```

### H. 운영 가드레일

* **실패 시 기본 보수적**: OPA 오류/타임아웃 ⇒ `deny`(다운로드 등 고위험만), 읽기 요청은 `read-only degrade`
* **샌드박스 모드**: 신규 규칙은 `warn-only` 48시간 → 영향 분석 후 `enforce` 전환
* **우회 절차**: IC 승인 하 30분 **임시 `bypass` 토큰**(감사·만료 필수)

### I. API/툴링

* `POST /v1/policy/validate` — 번들 사전 검증(샘플 입력 케이스 포함)
* `GET /v1/policy/decisions?since=…` — 최근 결정 로그 스트림(감사·탐지)
* `POST /v1/drift/reconcile` — 감지 항목 일괄 교정(승인 필요)
* CLI: `plura policy push|diff|dry-run`, `plura drift status|fix`

---

4. **예시 설명 (JP 리전—웹훅 미서명 드리프트 자동 교정)**

1) Drift Watcher가 **Nginx 업스트림 새 노드**에 웹훅 서명 필터 누락 탐지(Actual≠Desired) → `drift_detect_time=34s`
2) OPA `egress/webhook_sign`가 **deny** 평가, 게이트웨이가 해당 업스트림을 **격리(freeze)**
3) `auto_repair` 정책에 의해 템플릿 적용 → 서명 필터 복구, 헬스 통과 후 재편입(총 4분)
4) `decision_log`와 `drift.fix` 이벤트가 **감사 해시체인**에 기록, 관련 인시던트 **미발생**
   → 결과: **정책 코드화 + 드리프트 자동 교정**으로 보안·주권·운영 기준을 **일관**되게 강제하면서, 장애 없이 빠르게 복원.
