# 필상 시스템 — Day 14 테넌트 온보딩 & 프로비저닝

1. **날짜**

* 2024-08-23

2. **목표**

* 신규 고객(테넌트)의 **계약→프로비저닝→로그 인입→권한 설정**을 **30분 내** 완료
* **자동화**(워크플로우/API)와 **보안/감사** 기준을 확정

---

3. **내용**

### A. 온보딩 플로우(요약)

1. **계약 승인** → 2) **테넌트 생성** → 3) **IDP 연동/OIDC** → 4) **수집 파이프라인 등록**
2. **권한·정책 셋업** → 6) **검증 시나리오 실행** → 7) **운영 전환 & 교육**

### B. 역할·책임(RACI)

* **Sales/CSM**: 계약·플랜·과금 항목 입력(R)
* **Provisioning Bot**: 테넌트/리소스 생성(A)
* **SRE**: 네임스페이스/자원 한도 검수(C)
* **Security**: RBAC/ABAC·감사 정책 승인(A)
* **Customer Admin**: SSO·사용자/그룹 매핑(R)

### C. 데이터 모델(핵심)

* `Tenant(id, name, region, plan, status, createdAt)`
* `Namespace(id, tenantId, quota: {ingest_rps, storage_gb, index_docs})`
* `IngestKey(id, tenantId, name, scopes[], expiresAt, hash)`
* `RoleBinding(tenantId, role, subjectType:user|group, subjectId)`
* `Webhook(id, tenantId, url, purpose, secret, enabled)`

### D. 자동화(API/CLI)

* `POST /v1/tenants` → 메타-DB·인덱스·오브젝트 버킷·기본 대시보드 자동 생성
* `POST /v1/tenants/{id}/oidc` → 고객 IDP 메타데이터(SAML/OIDC) 등록, **도메인 소유 검증**
* `POST /v1/ingest/keys` → 수집 키 발급(스코프·만료 포함), **IP 화이트리스트** 옵션
* `POST /v1/rbac/bindings` → 역할 매핑(OWNER/ADMIN/ANALYST/READONLY/BILLING)
* `POST /v1/webhooks` → 고객 SOAR/티켓/알림 엔드포인트 등록(HMAC 서명)

> CLI 예: `plura tenant create --name "Acme" --region kr --plan ent`

### E. 기본 정책(템플릿)

* **보존**: logs/events 90일, incidents 1년, 원본 3년(리전별)
* **알림**: T0/T1 템플릿(ko/ja/en) 활성, 고객 채널 라우팅 기본값 설정
* **검색 RLS**: `fq=tenant_id:{token.tenant}` 강제, Saved Query 5종 제공
* **WAF/EDR 샘플 룰셋**: `alpha` 채널로 연결, Shadow 모드 7일 후 `stable` 승격

### F. 검증 시나리오(10분)

* **S-1**: 수집키로 샘플 100건 전송 → 인덱스 적재·지연 p95 ≤ 1.2s
* **S-2**: WAF 406/Blocked:1 & 200 혼합 로그 주입 → **Incident 생성** 확인
* **S-3**: DBV360 자동 판정 트리거 → 증거 패키지 표준 출력 확인
* **S-4**: 알림(메일/웹훅) 수신·서명 검증 → 티켓 자동 생성 확인
* **S-5**: SSO 로그인(Owner/Admin) → RBAC 가시성·다운로드 서명 URL 동작

### G. 한도/과금(Plan Guardrails)

* **STD**: `ingest_rps≤200`, 저장 500GB, 테넌트 사용자 50, 웹훅 5개
* **ENT**: 커스텀 한도·전용 샤드 옵션, **전용 지원 채널**
* 한도 초과 시: 소프트 스로틀링 + CSM 알림 + 업그레이드 제안 워크플로우

### H. 보안·감사

* **테넌트 격리**: 전 경로 `tenant_id` 주입·검증, 서비스 간 mTLS
* **비밀 관리**: IngestKey/웹훅 시크릿 **KMS 암호화**·90일 로테이션
* **감사**: 온보딩 전 과정 `security.audit.v1` 기록(요청·승인·발급·검증)

### I. 실패/롤백

* 검증 실패 시 **자동 롤백**(리소스/키 폐기) + 체크리스트 재시도
* 24시간 내 미사용 테넌트 **자동 휴면**(키 비활성화, 비용 방지)

### J. 운영 산출물

* `runbooks/onboarding.md` 체크리스트
* `templates/policies/*.yaml` (보존/알림/RBAC 기본값)
* `terraform/modules/tenant/*` (인덱스·버킷·대시보드 IaC)

---

4. **예시 설명 (Acme-KR 엔터프라이즈 온보딩 25분 완료)**

1) CSM이 계약 확정 후 **Provisioning Bot** 실행 → `tenant=acme-kr` 생성, 네임스페이스/쿼터 적용
2) 고객 **Azure AD OIDC** 메타데이터 등록 → 도메인 소유 TXT 검증 통과
3) `ingest-key` 발급(IP 화이트리스트 포함) → 샘플 로그 100건 전송(**S-1 성공**)
4) 혼합 로그로 **Incident** 발생, **DBV360** 판정·증거 패키지 확인(**S-2~S-3 성공**)
5) 메일·웹훅 서명 검증 통과, **Jira 티켓 자동 생성**(**S-4 성공**)
6) 고객 Admin이 **SSO 로그인** 후 Saved Query 실행·다운로드 서명 URL 확인(**S-5 성공**)
   → 상태 **Active**, 교육 자료 전달 및 첫 주간 합성 모니터링 리포트 예약.
