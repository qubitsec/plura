# 필상 시스템 — Day 8 검색·인덱싱(Solr) 설계

1. **날짜**

* 2024-08-14

2. **목표**

* **로그/사건** 중심의 인덱스 토폴로지·스키마·보존정책 확정
* 분석가 시나리오 기준 **쿼리 패턴/성능 SLO** 정의 및 샘플 제공

---

3. **내용**

### A. 컬렉션/토폴로지

* **리전 분리**: `kr` / `jp` (크로스리전 질의 금지)
* **컬렉션**

  * `logs_raw_{region}_YYYYMM` : 인입 원로그(파티션 월단위, 시계열 롤오버)
  * `events_detect_{region}_YYYYMM` : 판정/특징량
  * `incidents_{region}` : 사건(현재/이력 통합, 컴팩션 컬렉션)
  * `ti_cache_{region}` : TI 평판 캐시(짧은 TTL)
* **샤딩/라우팅**: `tenant_id` 기반 라우팅(rebalance 용이), 샤드 3·Replica 2(Dev 1)
* **가용성**: Solr 9.x + ZK(3노드) · 자동리커버리, 리더 선출 감시(Otel 알람)

### B. 스키마(핵심 필드)

* 공통 메타: `ts(dt)`, `tenant_id(str)`, `region(str)`, `trace_id(str)`
* **logs_raw**

  * `src_ip(ip)`, `dst_host(str)`, `uri(str)`, `param_sig(str)`
  * `status(int)`, `blocked(int)`, `rule_id(str)`
  * `ua(str)`, `ref(str)`, `bytes_in/out(long)`
* **events_detect**

  * `incident_key(str)`, `verdict(str)`, `confidence(pfloat)`
  * `features_ss(mlt)` (Sparse/JSON blob 별도 저장 시 `features_json`)
* **incidents**

  * `incident_id(str)`, `severity(str)`, `state(str)`, `artifact_uri(str)`
  * `ip_bucket(str)` (`src_ip/24`, PII 최소화)
* **필드 규칙**

  * IP 마스킹: `src_ip_trunc`(`/24`) 파생 필드 생성
  * 멀티밸류: `tags_ss`, `rule_ids_ss`
  * **정밀정렬**용 `ts_epoch(pdouble)` 추가(숫자 정렬 안정성)

### C. 분석기/인덱싱 정책

* 텍스트: `uri`, `ua` → **Whitespace + Lowercase + URLTokenizer**
* 키워드: `dst_host`, `rule_id`, `param_sig` → **KeywordAnalyzer**
* 검색 가중치(edismax `qf`): `param_sig^5 uri^2 ua`
* **커밋 정책**: SoftCommit 1s, HardCommit 60s(운영), AutoSoftCommit 장애 시 5s
* **업서트**: `uniqueKey`(doc_id=ulid) + 멱등성 키로 중복 삽입 방지

### D. 보존/ILM

* **logs_raw / events_detect**: 90일(운영), 30일(스테이징) → Object Storage로 스냅샷 후 삭제
* **incidents**: 1년(검색), 3년(아카이브)
* 컬렉션 롤오버 기준: 월단위 + 문서수/스토리지 상한(예: 500M docs or 500GB)

### E. 쿼리 패턴(운영 표준)

* **공격자 IP의 정상(200) 10건 샘플**

  ```http
  q=src_ip:203.0.113.10 AND status:200
  fq=tenant_id:T1 AND ts:[NOW-30MINUTES TO NOW]
  rows=10&sort=random_1 asc
  ```
* **WAF 차단 패턴(406/Blocked:1) 최근 1시간**

  ```http
  q=rule_id:WAF-941100 AND status:406 AND blocked:1
  fq=tenant_id:T1 AND dst_host:shop.example.com AND uri:"/search"
  rows=50&sort=ts desc
  ```
* **사건키 그룹 집계(파이프라인 건강 점검)**

  ```http
  q=*
  fq=tenant_id:T1 AND ts:[NOW-24HOURS TO NOW]
  json.facet={ incidents:{ type:terms, field:incident_key, limit:10, sort:"count desc"} }
  rows=0
  ```
* **FP 의심(동일 IP의 혼합 응답)**

  ```http
  q=src_ip:203.0.113.10
  fq=tenant_id:T1 AND dst_host:shop.example.com
  json.facet={
    codes:{ type:terms, field:status, limit:10 },
    blocked:{ type:terms, field:blocked, limit:2 }
  }
  rows=0
  ```

### F. 성능 SLO & 튜닝

* **SLO**: 상위 5 쿼리 템플릿 기준 `p95 ≤ 800ms`, 샘플링/페이징 `≤ 1.2s`
* **인덱스 튜닝**: DocValues on(정렬/Facet), `filterCache` 1–2GB, `queryResultCache` 512MB
* **핫샤드 방지**: `tenant_id` 해시라우팅 + 대규모 테넌트 전용 샤드 옵션
* **대량 주입**: `bufferedDocs=10k`, `ramBufferSizeMB=512`, 병렬 파이프라인
* **복구 전략**: 리더 전환 자동화 + 스냅샷(일 1회) → MinIO(S3) 업로드

### G. 보안/격리

* **RLS**: 게이트웨이에서 `fq=tenant_id:{token.tenant}` 주입(필수)
* **쿼리 화이트리스트**: 콘솔/리포트는 저장된 쿼리 템플릿만 실행
* **감사**: 쿼리 로그에 `actor, scopes, purpose` 기록(보안 감사 인덱스 별도)

### H. 운영 자동화

* **스키마/컬렉션 IaC**: `solr-schema.yaml`, `solr-collections.yaml` → CI에서 `solrctl apply`
* **재인덱스**: `vN → vN+1` **Dual-Write + 백필**(데이터 밸브로 트래픽 전환)
* **헬스체크**: Ping + 샘플 쿼리(템플릿 3종) 1분 간격, 실패 시 온콜

---

4. **예시 설명 (DBV360 보조 검색 루틴)**

1) 콘솔에서 **오탐 의심 티켓** 열람 → 사건의 `incident_key`와 `src_ip_trunc` 조회
2) 저장된 템플릿 실행:

   * A) **406/Blocked:1 패턴** 최근 24h 상위 규칙/URI 파셋
   * B) 동일 IP의 **정상 200 샘플 10건** 랜덤 추출(시간대 분산)
   * C) **TI 캐시 교차검증**(`ti_cache`)—평판 `score ≥ 80`이면 경고 가중
3) 결과를 **Adjudicator**에 증거로 첨부 → 판정(오탐/정탐/재검토) 업데이트
4) 필요 시 **룰 업데이트**(파라미터 시그니처 완화/강화) 후 저장된 쿼리로 **회귀 검색** 실행
   → 목표: 분석가는 3클릭 이내 **증거 기반 판정**을 완료, 쿼리 일관성·성능 SLO 유지.
