# 필상 시스템 — Day 16 엣지/게이트웨이(Nginx·HAProxy·GSLB) 트래픽 설계

1. **날짜**

* 2024-08-27

2. **목표**

* **GSLB → HAProxy → Nginx(API GW/WAF 프록시)** 3계층 트래픽 경로 표준화
* **레이트리밋·실사용자 IP 복원·보안헤더·카나리/블루그린**을 공통 패턴으로 정리

---

3. **내용**

### A. 경로(요약)

`DNS(GSLB 헬스/가중치)` → `HAProxy(L4/L7 LB·mTLS 내부)` → `Nginx(API Gateway + WAF/OIDC 프록시)` → 백엔드(ingestor/incident/console…)

### B. GSLB 정책

* **헬스체크**: `/healthz` 3/5 실패 시 제외
* **가중치**: KR:JP = 7:3(기본), 장애 시 단일 리전에 100%
* **지리 라우팅**: KR/JP 우선, 타 지역은 가장 가까운 리전
* **스티키 옵션**: 긴급 장애 시 **비활성**(빠른 페일오버 우선)

### C. HAProxy 핵심(발췌)

```haproxy
global
  tune.ssl.default-dh-param 2048
defaults
  timeout connect 5s; timeout client 60s; timeout server 60s
frontend fe_https
  bind :443 ssl crt /etc/haproxy/tls/fullchain.pem alpn h2,http/1.1
  http-response set-header Strict-Transport-Security "max-age=15552000; includeSubDomains"
  http-request set-header X-Request-Start t=%Ts
  http-request set-header X-Forwarded-Proto https
  default_backend be_nginx
backend be_nginx
  balance leastconn
  option httpchk GET /healthz
  server nx1 10.10.0.11:80 check
  server nx2 10.10.0.12:80 check
```

### D. Nginx(API 게이트웨이/보안) 표준

* **실 IP 복원**

```nginx
set_real_ip_from 10.10.0.0/16;
real_ip_header X-Forwarded-For;
real_ip_recursive on;
```

* **보안 헤더/CORS**

```nginx
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options DENY always;
add_header Referrer-Policy same-origin always;
add_header Content-Security-Policy "default-src 'self' https:" always;
# CORS 화이트리스트
map $http_origin $cors {
  default 0; "~^https?://(console\.example\.com|*.cust\.example\.com)$" 1;
}
if ($cors) {
  add_header Access-Control-Allow-Origin $http_origin;
  add_header Vary Origin;
}
```

* **레이트리밋(사용자/토큰/IP)**

```nginx
limit_req_zone $binary_remote_addr zone=ip:10m rate=60r/m;
limit_req_zone $http_authorization zone=token:10m rate=120r/m;
location /v1/ {
  limit_req zone=ip burst=30 nodelay;
  limit_req zone=token burst=60;
}
```

* **압축/캐시(정적)**

```nginx
gzip on; gzip_types text/* application/json application/javascript;
location ~* \.(js|css|svg|woff2)$ {
  expires 7d; etag on; add_header Cache-Control "public, max-age=604800";
}
```

* **웹소켓/SSE**

```nginx
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
```

* **OIDC/인증 프록시(개요)**: `/auth/*`는 OIDC 프록시에 프록시패스 → 성공 시 `Authorization: Bearer` 주입

### E. 카나리/블루그린 라우팅

* **쿠키 기반 카나리**: `cookie release_id=2025.08.4+113; Path=/;` 존재 시 **canary 풀**로 라우팅
* **헤더 기반**: 운영자 테스트는 `X-Canary: 1`로 강제
* **블루그린**: `/`는 `green` 업스트림, 배포 시 `blue`와 스위치(헬스 통과 후)

```nginx
map $http_cookie $upstream_pool {
  default "green";
  "~*release_id=([0-9\.+\-A-Za-z]+)" "canary";
}
upstream api_green { server 10.20.0.21; server 10.20.0.22; }
upstream api_canary { server 10.20.0.31; }
location /v1/ { proxy_pass http://api_$upstream_pool; }
```

### F. 요청 서명/웹훅 검증(게이트웨이)

* 수신 웹훅: `X-Plura-Signature: v1=HMAC-SHA256(body, secret)` 필수
* **재생 방지**: `X-Plura-Timestamp` 5분 윈도우, `nonce` 캐시(5분)로 중복 거부
* 실패는 **429/401/403** 코드로 명확 응답 + 감사 로그 기록

### G. 관측·SLO 연동

* **로그 키**: `ts, req_id, tenant, region, ip, method, path, status, bytes, upstream, latency_ms`
* 지표: `requests_total`, `error_rate`, `p95_latency`, **업스트림별 실패율**, **레이트리밋 히트율**
* **건강 게이트**: p95 지연>800ms 3분 지속 시 카나리 강등/롤백, 오류율>1%면 자동 차단 규칙 상승

### H. 운영 가드레일

* **Egress 기본 거부**(Nginx에서 외부로 나가는 프록시 금지), 허용 도메인만 업스트림 정의
* **요청 본문 크기 제한**: `client_max_body_size 8m` (필요 시 테넌트별 오버라이드)
* **다운로드 보호**: 파일 링크는 **서명 URL+10분 만료**, 헤더 `Content-Disposition` 강제

---

4. **예시 설명 (KR 콘솔 카나리 배포 & 급증 트래픽 방어)**

1) `console`의 `green`은 안정, `canary`에 새 릴리스 배포 후 **쿠키 기반 5% 트래픽 유도**
2) p95 지연·에러율 정상 → 25%→100% 승격, GSLB 가중치는 기존 유지
3) 갑작스런 봇 트래픽 급증으로 `/v1/search`가 포화 → **IP 레이트리밋 히트** 상승
4) 게이트웨이에서 `/v1/search`만 **토큰 기반 레이트리밋** 상향(60→30 r/m) + 캐시 가능한 정적 리소스는 `expires 7d`로 오프로드
5) 업스트림 실패율 2% 초과 시 **자동 카나리 강등** 및 `blue/green` 스위치 보류 → 8분 내 정상화

> 결과: **3계층 표준 경로**와 **카나리/레이트리밋/보안헤더** 조합으로 급변 트래픽·배포 리스크를 흡수하며, 관측지표 기반의 **자동 보호·롤백**이 일관되게 동작.
