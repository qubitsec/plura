# 필상 시스템 — Day 19 인시던트 대응(온콜·IR/CSIRT) 운영 표준

1. **날짜**

* 2024-08-30

2. **목표**

* **온콜 체계·심각도 매트릭스·런북·커뮤니케이션**을 표준화해 **MTTA ≤ 5분, MTTR 60분(대부분 케이스)** 달성
* DBV360·Notifier·SLO 게이트와 **일관 연동**되는 **증거 중심 IR 절차** 확정

---

3. **내용**

### A. 역할 & 교대(On-call)

* **SRE 온콜(Primary/Secondary)**: 가용성·성능·배포 이슈 대응
* **CSIRT 온콜(Primary/Secondary)**: 보안 이벤트·사건 대응(법적 보존 판단 포함)
* **Incident Commander(IC)**: 의사결정·커뮤니케이션 단일 창구(교대 중 지정)
* 교대: **주간 1주 롤링**, 핸드오버 문서·열린 티켓 0건 원칙

### B. 심각도 매트릭스(요약)

| Sev    | 영향             | 예시                          | 목표                     |
| ------ | -------------- | --------------------------- | ---------------------- |
| **T0** | 다수 고객/리전 기능 정지 | 콘솔/APIs 50%+ 실패, 데이터 손실 우려  | MTTA ≤ 2m / MTTR ≤ 30m |
| **T1** | 일부 고객 핵심 기능 저하 | 인입→사건 P95>15s 10분 지속, 알림 지연 | MTTA ≤ 5m / MTTR ≤ 60m |
| **T2** | 단일 테넌트/비핵심     | 특정 쿼리 느림, UI 오류             | 업무시간 내 복구              |
| **T3** | 잠재 이슈/질의       | 경고·관찰 항목                    | 다음 스프린트 처리             |

판정 기준: **SLO 위반·고객 영향·데이터 무결성** 3요소로 결정(콘솔에 자동 제안).

### C. 표준 흐름(10단계)

1. **탐지**: SLO 알람 or 보안 탐지(룰/DBV360) → Notifier로 온콜 호출
2. **선언**: IC/Sev 지정, 상태페이지 초안(사실+지표) 게시
3. **에스컬레이션**: SRE↔CSIRT 교차 호출(보안/가용 구분)
4. **즉각 완화**: 롤백/카나리 강등/샘플링·TTL 조정/레이트리밋 상향
5. **증거 수집**: 자동 **Evidence Package**(지표·로그·릴리스ID·쿼리·TI 스냅샷) 고정
6. **원인 국소화**: 변경 상관(릴리스/플래그/인프라), 핫스팟 쿼리/샤드 파악
7. **영구 해결**: 코드/설정 패치, DR 절차 포함 시 런북대로 진행
8. **검증**: 합성 트랜잭션·지연/오류율 정상 확인, 고객 기능 점검 체크리스트
9. **커뮤니케이션**: 30/60분 주기 업데이트(ETA 대신 지표·사실)
10. **종료 & 포스트모템**: 24~48h 내 RCA·대책 확정, 재발방지 커밋

### D. 커뮤니케이션 표준

* **내부**: 온콜 채널(슬랙) + 브리지(음성) + 타임라인 봇(명령형 `/ir note …`)
* **외부(고객)**: 상태페이지(ko/ja/en), 영향 범위·완화 상태·다음 업데이트 시각만 명시
* **법적 보존 필요 시**: `legal_hold=true` 설정 → 로그·객체·키 파기 중단

### E. 런북 구조(서비스별 공통 섹션)

* **증상→가능원인 Top-N→점검 명령→완화 레시피→복구/검증→롤백 절차**
* **예)** `ingest-queue-backlog`: 소비자 수·DLQ·파서 오류율, **샘플링/필드 축소 트리거** 방법, 재처리 순서
* 각 런북은 **CLI/대시보드 딥링크** 포함: `open grafana://dashboard?id=ingest&tenant=T1`

### F. 증거 패키지(Evidence) 표준

* 자동 포함: `trace/metrics(최근 30m)`, 릴리스/플래그 변경, 문제 쿼리 샘플, 관련 사건/알림 로그
* **무결성**: 해시체인 루트 + 서명자, **다운로드 링크 10분 만료**
* 포맷: JSON + HTML 요약(콘솔 뷰)

### G. 의사결정 가드레일

* **데이터 주권 우선**: 교차 리전 데이터 이동 금지(예외 없음)
* **리스크 낮추기**: **가역적 조치**(롤백/강등)를 우선, 비가역 변경은 IC 승인
* **고객 영향 최소화**: 엔터프라이즈 테넌트 우선 복구, 이후 순차 확장

### H. 측정 & 보상 루프

* KPI: **MTTA/MTTR**, 재발률, 에러버짓 소모, 알람 노이즈 비율, **실패 없는 릴리스 비율**
* 주간 리뷰: Top-3 인시던트 RCA, 런북 개선, **알람 규칙 튜닝**
* 교육: 분기 1회 합동 **GameDay/Chaos** 훈련(멀티AZ, Solr 리더 손실, OIDC 장애)

### I. 자동화 훅

* 인시던트 열릴 때: **카나리 자동 강등**, 관련 서비스 **Feature Flag freeze**
* 종료 시: **성능 회귀 테스트** & **규모 축소 원복**, 상태페이지 자동 Close
* DLQ 존재 시: 용량 맞춰 **배수 재생률** 자동 조절(스파이크 방지)

---

4. **예시 설명 (T1: 인입→사건 지연 상승 18분 해결)**

1) **알람**: KR 리전 `ingest_to_incident_p95=18s(10m 지속)` → T1 선언, IC=SRE-P
2) **완화**: 카나리 25%→5% 강등, Ingestor 소비자 +2, `features_only` 모드로 필드 축소
3) **증거 패키지** 자동 생성: 릴리스 `2025.08.4+113` 직후 지연 상승, Solr 샤드 `kr-logs-202508` 히트 편향 확인
4) **조치**: 대규모 테넌트 전용 샤드로 리밸런스, `filterCache` 2→3GB, 파서 Regex 규칙 한 건 비활성화
5) **검증**: p95 11s→8s→**6.9s** 회복(15분 내), DLQ 1.2k → 0 순차 처리
6) **커뮤니케이션**: 상태페이지 2회 업데이트(영향/완화 위주), 고객 엔터프라이즈 3사 개별 통지
7) **종료/RCA**: 원인—샤드 편향 + 파서 엣지 케이스; 대책—샤드 정책 개선·회귀 테스트 추가·알람 임계 재설정

> 결과: **표준화된 온콜/IR 체계**와 자동 증거화·가드레일 덕분에 탐지→완화→복구가 **예측 가능**해지고, 고객 커뮤니케이션도 **일관·투명**하게 유지됩니다.
