# 필상 시스템 — Day 6 CI/CD 파이프라인 & 릴리스 전략

1. **날짜**

* 2024-08-12

2. **목표**

* **브랜치 전략·품질 게이트·배포 단계**를 표준화해 **30분 내 배포**, **5분 내 롤백** 가능
* KR/JP 리전 **점진적 배포**(Canary/Blue-Green)와 **DB 마이그레이션 절차** 확정

---

3. **내용**

### A. 브랜치 & 버저닝

* **브랜치**: `main`(안정), `develop`(통합), `feat/*`, `fix/*`, `release/*`
* **버전 규칙**: `YYYY.MM.minor+build` (예: `2025.08.3+92`)
* 태그는 **이미지·차트·매니페스트**에 동일하게 주입(원천 단일화)

### B. 파이프라인 단계(서비스 공통)

1. **Lint/Test**: `eslint/ruff/go test` + 커버리지 임계치(행 70%·브랜치 60%)
2. **SCA/Secret Scan**: `trivy fs`·`trivy image`·`gitleaks`
3. **Build**: 멀티스테이지 Docker, SBOM 생성(`cyclonedx`)
4. **Unit Deploy(Dev)**: Kind/K3d, 컨트랙트 테스트(Producer/Consumer)
5. **E2E(Dev)**: 인입→판정→사건→알림 합성 시나리오
6. **Artifact Publish**: OCI 레지스트리, Helm 차트, Kustomize 오버레이
7. **Staging 배포**: KR-stg → JP-stg 순차, 마이그레이션 Dry-Run
8. **Prod 배포**: Canary(5%→25%→100%) 또는 Blue-Green 스위치
9. **Post-Deploy 검증**: SLI/SLO 게이트, 에러율/지연·로그 이상감지

### C. 환경 분리 & 설정 주입

* 오버레이: `env/dev|stg|prod` + `region/kr|jp`
* 설정 원천: **Config**(일반) / **Secret**(민감) / **FeatureFlag**(런타임 토글)
* 이미지는 **동일**하되, 오버레이로 동작을 변경(불변 아티팩트 원칙)  
  .  

### D. 배포 전략

* **Canary**: 트래픽 비율 단계 승격 + 자동 롤백(에러율/지연 임계치 초과 시)
* **Blue-Green**: 새 스택 준비 → 헬스·연기(연동 서비스 체크) → 스위치
* **웹훅/외부 통합**: 서명 검증·재시도·DLQ, 배포 창 제한(야간 금지 옵션)

### E. DB 마이그레이션 원칙

* **Expand → Migrate → Contract** 3단계
* 스키마 변경은 **뒤호환 우선**, 앱은 **FeatureFlag**로 신구 로직 병행
* 롤백 대비: **shadow 테이블** 또는 **트리거 기반 이중 기록**(필요 시)
* 마이그 도구: `migrate`/`liquibase`(서비스별 디렉터리로 버전 관리)

### F. 품질 게이트(SLO 연동)

* **게이트 실패 시 배포 중단**:

  * 에러율(P95) > 1%, 인입→사건 P95 지연 > 15s, 알림 지연 P95 > 10s
  * 신규 릴리스 15분 관찰 기간 내 **이상 감지** 발생
* 게이트 통과 후 **자동 태깅**: `stable/kr`, `stable/jp`

### G. 표준 명령(예)

```bash
# 로컬 검증
make test lint sbom

# 스테이징 배포 (KR)
make deploy ENV=stg REGION=kr STRATEGY=canary

# 프로덕션 롤백 (JP, 직전 안정 태그)
make rollback ENV=prod REGION=jp TO_TAG=$(cat .last_stable_tag)
```

### H. 관측/추적

* OpenTelemetry(Trace/Metric/Log) → Grafana/Tempo/Loki
* 릴리스 전후 **변경 코릴레이션**: `release_id`, `git_sha`, `chart_ver` 레이블 일치

---

4. **예시 설명 (Hotfix—KR 우선 Canary 후 JP 확장)**

1) `fix/ingestor-utf8-bug` 머지 → CI: 테스트/스캔 통과, 이미지 태그 `2025.08.4+113` 발행
2) **KR-stg Canary 5%**: 인입 P95 지연·에러율 정상 → 25% → 100% 승격
3) **KR-prod Canary 5%**: 10분 모니터링 중 에러율 0.3% 유지 → 25% → 100%
4) **JP-prod 배포**: KR 메트릭 안정 확인 후 동일 태그 Blue-Green 스위치
5) 배포 후 15분 **게이트 통과** → `stable/kr`, `stable/jp` 태깅 & 변경 기록(릴리스 노트 자동 생성)
6) 만약 KR-prod에서 에러율 2% 초과 시 **자동 롤백**(이전 `stable` 태그) + 알림/티켓 오픈

> 결과: 지역별 리스크 분산, 30분 내 안전 배포·검증, 장애 시 5분 내 원복 가능.
