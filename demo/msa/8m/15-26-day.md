# 필상 시스템 — Day 15 위협 모델링 & 보안 하드닝 기준

1. **날짜**

* 2024-08-26

2. **목표**

* 서비스 전 구간 **위협 모델(STRIDE + MITRE ATT&CK 맵)** 수립
* **하드닝 기본선(Baseline)**·**Secure SDLC**·**비밀/키 관리** 기준 확정

---

3. **내용**

### A. 위협 모델(요약)

* **자산/경계**: Edge(WAF/API GW), Ingestor, Stream/Rule, Incident, Search(Solr/ZK), Meta-DB, Object Storage, Notifier, Console
* **주요 위협**

  * 인증/인가 우회(세션 고정, 토큰 탈취), 입력 기반 공격(Injection, Deserialization)
  * 로그·웹훅 통한 **데이터 유출(Egress)**, 서드파티 공급망(SBOM 미흡)
  * 인덱스/객체 저장소의 **권한 상승·키 유출**, 메시지 재생·중복 처리
* **대응 전략**

  * **mTLS + OIDC 스코프** + RLS(데이터 계층)
  * 모든 외부 콜백은 **HMAC 서명 + 5분 만료 + 재생 방지 캐시**
  * 저장소는 **암호화·목적 제한**·감사 해시체인(감사 인덱스)

### B. 하드닝 기본선(Baseline)

* **네트워크**: 기본 거부, **Egress 화이트리스트**(TI/메일/SMS 등만), L4 DoS 보호
* **프락시/게이트웨이**:

  * TLS1.2+, `HSTS, X-Frame-Options:DENY, X-Content-Type-Options:nosniff, Referrer-Policy:same-origin`
  * **CORS 화이트리스트**(정적), **레이트리밋**(사용자/토큰/아이피)

    .  
    
* **애플리케이션**:

  * 입력 검증(서버측), 파라미터 시그니처(URI/Query 정규화), 템플릿 렌더 시 **Escape 기본**
  * **권한 검사 미들웨어**(RBAC+ABAC) 공통화, 다운로드는 **서명 URL+만료**
* **런타임 보호**:

  * 컨테이너 **runAsNonRoot, readOnlyRootFS, seccomp/AppArmor**, Capabilities 최소화
  * K8s PodSecurity/NetworkPolicy 적용, 이미지 **서명·검증**(Cosign)
* **데이터**:

  * P0/P1 필드 **컬럼 레벨 암호화**, 인덱스에는 축약 필드(`src_ip_trunc`, `email_hash`)만
  * 키/비밀 **KMS + 90일 로테이션**, 환경변수 대신 **파일/볼륨 주입**

### C. Secure SDLC & 공급망

* **설계**: ADR에 위협·완화·잔여위험 기록, 정책 코드화(IaC/OPA)
* **개발**: 프리커밋 `eslint/ruff/yamllint/gitleaks`, **비밀 차단**
* **빌드**: `trivy fs/image` + **SBOM(cyclonedx)** 생성/서명, **오픈소스 라이선스 검증**
* **테스트**:

  * SAST(코어 서비스), DAST(콘솔/API), IaC 스캔(tfsec)
  * **회귀 리플레이**(WAF/EDR 케이스) + **퍼즈 테스트**(파서/인입)
* **릴리스**: 2인 승인, **릴리스 노트에 보안 항목**(CVE, 취약점 잔존 여부) 필수
* **운영**: 취약점 SLA—Critical 48h, High 7d, Medium 30d 내 조치

### D. 비밀/키 관리

* **원칙**: 사람이 직접 보지 않는다(Zero-touch), 로깅/스크린샷 마스킹
* **스코프**: IngestKey, Webhook Secret, OIDC Client Secret, DB/Redis/S3 자격증명, KMS DEK/KEK
* **프로세스**: 발급→기록(감사)→배포(주입)→**주기 로테이션**→폐기(키 파기 보고)
* **점검**: 월 1회 **시크릿 인벤토리** 대조·미사용 키 폐기, 사용 흔적 없는 계정 잠금

### E. 로깅/감사·개인정보

* **로그**: JSON, `trace_id`, `tenant_id`, `purpose`, **PII 마스킹** 기본(실수치 출력 금지)
* **감사**: `actor, action, dataset, ip, ts, evidence_uri, prev_hash`—**해시체인**
* **프라이버시**: 목적 구속(`purpose` 필수), **다운로드 워터마크**·만료 10분

### F. 체크리스트(샘플)

* [ ] mTLS(서비스 간) & 게이트웨이 TLS 강제
* [ ] Egress 화이트리스트/웹훅 서명 검증
* [ ] 최소권한(RBAC/ABAC/RLS) & 레이트리밋
* [ ] 컨테이너 보안(NonRoot/ReadOnly/seccomp)
* [ ] SBOM 생성·서명·보관 / 취약점 SLA 준수
* [ ] KMS 키 로테이션/폐기 증적 / 비밀 탐지 무위반
* [ ] 로그 PII 마스킹 & 감사 해시체인 유효성 통과

---

4. **예시 설명 (Webhook 데이터 유출 차단 시나리오)**

1) 고객 SOAR로 전송되는 웹훅 요청에 **HMAC 서명 + timestamp** 부여, 수신측은 `X-Plura-Signature` 검증·리플레이 캐시(5분) 사용
2) Egress 정책은 고객 등록 도메인만 허용, 미등록 목적지 시 **즉시 차단 + 감사 이벤트** 기록
3) 페이로드는 **마스킹 요약**만 포함(원본은 서명 URL 10분) → 재전송 실패 시 **DLQ**로 이동
4) 감사 인덱스에 전송·검증·응답 코드·요청 목적(`purpose=security`)이 해시체인으로 기록
   → 결과: 서명·만료·화이트리스트·감사가 결합되어 **무단 반출/변조/재생**을 실질적으로 예방.
