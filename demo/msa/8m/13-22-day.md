# 필상 시스템 — Day 13 알림/연동(Notifiers · Webhook · Ticketing)

1. **날짜**

* 2024-08-22

2. **목표**

* **사건→알림** 파이프라인(이메일·SMS·Webhook·티켓)의 **신뢰성·보안·속도** 표준 확정
* **템플릿·서명·재시도/DLQ·에스컬레이션** 규칙을 정의해 **10초 내 전달 p95** 달성

---

3. **내용**

### A. 알림 아키텍처

* **Notifier**(코어): `notify.requested.v1` 소비 → 채널 어댑터로 팬아웃
* **채널 어댑터**: `email`, `sms`, `webhook`, `ticket`(Jira/Linear/ServiceNow)
* **정책 엔진**: 중요도(`info|warn|high|crit`), **조용시간(Silence)**, 레이트 리밋, 중복 억제(Dedup)
* **멱등성**: `notify_id(ULID)` + `idempotency_key(incident_id+state)` 저장 후 전송

### B. 템플릿 & 현지화

* 포맷: **Handlebars/Mustache**(서버 렌더) + ko/ja/en 번들
* 공통 변수: `tenant, severity, rule_id, incident_key, top_evidence[], ti.score, console_url`
* **짧은 SMS**(≤ 140 bytes)와 **긴 메일/웹훅**(증거 포함) 이원화

```json
// webhook payload (v1)
{
  "notify_id":"01J…",
  "tenant":"T1",
  "severity":"high",
  "event":"incident.changed",
  "incident":{"id":"01K…","state":"open","rule_id":"WAF-941100","key":"ip+host+uri_sig"},
  "evidence":{"samples":{"406":5,"200":3},"ti":{"score":12}},
  "release":{"id":"2025.08.4+113"},
  "ts":"2025-08-22T01:23:45Z"
}
```

### C. 보안·서명·승인

* **전송**: TLS1.2+, DNSSEC/SPF/DKIM(메일), SMS는 공급자 TLS API
* **웹훅 서명**: `X-Plura-Signature: v1=HMAC-SHA256(payload, secret)`, **5분 만료**
* **목적 제한**: `purpose=ops|security|billing` 필수, 감사 로그에 함께 기록
* **수신측 재생 방지**: `timestamp` + **리플레이 차단 캐시**(5분)

### D. 재시도·DLQ·순서보장

* 재시도(지수 백오프): 10s → 1m → 5m → 30m (총 4회)
* 영구 실패: **DLQ**로 이동(`error_type`, 마지막 응답, 헤더 저장)
* 순서: 동일 `incident_id` 키로 **채널별 시퀀서**(직렬화), 타 채널 간은 독립

### E. 라우팅·에스컬레이션

* **라벨 기반 라우팅**: `team: sre|csirt|cust`, `region: kr|jp`, `tenant_tier: std|ent`
* **에스컬레이션 정책**

  * T0(crit): 0분 SMS+앱푸시 → 2분 미응답 시 전화(음성 게이트웨이) → 5분 티켓 강제 할당
  * T1(high): 메일/슬랙 → 10분 미확인 시 SMS
  * 고객 통지: 계약 플랜별 채널/언어 자동 선택(ko/ja/en)

### F. 레이트 리밋·중복 억제

* **키**: `(tenant_id, incident_id, state, severity)` 5분 윈도우 **De-Dup**
* 테넌트/사용자/채널별 **버스트/지속 제한**(예: 60/min, 600/h)
* **합성 이벤트 그룹핑**: 유사 경보 N건 → 단일 요약 알림 + 콘솔 링크

### G. 티켓 연동(표준)

* 필드 맵: `title`, `severity`, `assignee`, `labels`, `description(md)`, `evidence_uri[]`
* **양방향**: 티켓 상태 변화 → `incident.changed.v1` 역주입(싱크 웹훅)
* 실패 시 임시 **로컬 워크큐** 유지, 24h 재시도

### H. 컴플라이언스·프라이버시

* PII 최소화: 기본 템플릿은 **마스킹**(`ip_trunc`, `email_hash`), 원본 링크는 **서명 URL(10분)**
* 지역 밖 전송 금지(계약 예외 없음). 공급자 **데이터 처리위탁** 레지스터 관리

### I. 운영/관측

* SLI: `notify_latency_p95`(요청→수신 2xx), `success_rate`, `dedup_rate`, `retry_ratio`, `dlq_size`
* 대시: 채널별 성공률/지연, 라우팅 히트맵, 상위 실패 원인(4xx/5xx/네트워크)
* 헬스체크: 공급자 API 쿼터/잔액 모니터, 웹훅 **타임아웃 3s**(수신 측 지연 방어)

### J. API(발췌)

* `POST /v1/notify` — 수동 트리거(운영자/테스트)
* `GET /v1/notify/{id}` — 상태 조회(시도/최종 응답/서명 헤더 해시)
* `POST /v1/webhooks/verify` — 샘플 페이로드·서명 검증 도구
* `POST /v1/dlq/{id}:replay` — 실패 알림 재전송

---

4. **예시 설명 (High 사건—다중 채널 에스컬레이션 시나리오)**

1) `incident.changed(open, severity=high)` 발생 → **notify.requested.v1** 발행
2) Notifier 정책 평가: `team=csirt, region=kr, tenant_tier=ent` → **슬랙+메일 동시**, 10분 타이머 세트
3) 수신 확인 없음 → **SMS** 에스컬레이션, 웹훅은 고객 SOAR로 전송(HMAC 서명 검증 통과)
4) 고객 SOAR가 자동 차단 후 **웹훅 콜백**으로 `state=in_progress` 업데이트 → 콘솔 동기화
5) 메일 서버 일시 5xx → 재시도 10s/1m/5m/30m 후 성공, DLQ 0건
6) SLI 집계: `notify_latency_p95=7.8s`, 재시도율 3.1%, De-Dup 42%
   → 결과: **중복 억제**·**보안 서명**·**에스컬레이션**으로 10초 내 대응을 보장, 티켓·콘솔·고객 SOAR가 **증거 링크** 중심으로 일관되게 연동됨.
