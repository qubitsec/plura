# 필상 시스템 — Day 56 경보 상관분석(Correlation) · 디듀프/서프레션 · 유지보수 창 관리

1. **날짜**

* 2024-10-29

2. **목표**

* **이벤트→경보→사건** 흐름의 **상관분석/집계/억제(Suppression)** 표준 확립
* **FP·노이즈·중복 알림 40% 이상 감소**, **MTTR 20%↓**, **업무시간 영향 최소화**

---

3. **내용**

### A. 개념/용어 정리

* **Event**: 원시 탐지 결과(`detect.verdict.v1`)
* **Alert**: 라우팅/정책 적용 후 채널별 전송 단위(`notify.requested.v1`)
* **Incident**: 상관/집계된 분석 단위(티켓/워크플로우의 기준)
* **Correlation Key(사건키)**: `tenant + dst_host + rule_id + uri_sig (+ src_ip_bucket)`
* **Dedup Window**: 동일 사건키에 대해 **중복 경보를 억제**하는 시간창(기본 15분)

### B. 상관 규칙(표준 세트)

1. **동일 사건키 집계**

   * 조건: 15분 내 동일 `incident_key`
   * 액션: **Incident 하나** 유지, `count`·`src_ip_topN`·`status_mix` 누적
2. **IP/ASN 군집**

   * 조건: 서로 다른 `dst_host`라도 `src_asn` 동일 & `rule_id` 유사
   * 액션: **캠페인(합성 Incident)** 생성, 티켓 우선순위 상향
3. **정상혼재 FP 의심**

   * 조건: 30분 내 `blocked:1`와 `status:200` 혼재 & TI 저위험
   * 액션: **DBV360 자동 트리거** + 알림 **review**로 강등
4. **변경 상관**

   * 조건: 릴리스/플래그 전환 ±30분에 특정 룰 히트율 급증
   * 액션: **릴리스 코릴레이션 배지** 부여, 자동 롤백 후보 플래그 ON

### C. 디듀프 & 서프레션 정책

* **시간 기반 디듀프**: `dedup_key = sha1(incident_key + channel + severity)`; 윈도우 15m(High), 5m(Crit 제외), 60m(Low)
* **쓰로틀**: 테넌트·채널별 버스트/지속(예: 60/min, 600/h); 디듀프 히트율 **목표 ≥ 40%**
* **상태 전환 억제**: 동일 Incident에서 **severity/owner** 미변경 시 재알림 금지(주기 업데이트만)
* **서프레션(억제) 조건**

  * 유지보수 창(MW) 내, **사전 등록된** 룰/서비스 영향 경보 → **알림 억제 + 대시보드 배지**
  * **에러버짓 초과 상태**에서 신규 기능 관련 알림은 `info` 강등(운영 가드레일)

### D. 유지보수 창(Maintenance Window, MW)

* **정의**: `env, region, svc, cron, owner, scope(rules|deploy|db)`
* **동작**: MW 활성 구간에 일치하는 경로의 **경보 억제**(Incident/지표는 기록 유지)
* **예외**: `crit`·`security.breach` 태그는 **억제 불가**
* **API 예**

  ```json
  POST /v1/ops/maintenance
  { "region":"kr","svc":"search","cron":"0 22 * * FRI","duration":"2h","scope":["deploy","rules"] }
  ```

### E. SLO 연동/가중치

* **SLO 게이트 연계**: 인입→사건 P95, 알림 P95가 임계 초과 시 **서프레션 완화**(안내 주기 ↑)
* **중요도 가중치**: 엔터프라이즈/핵심 경로 테넌트는 **서프레션 임계 하향**(중복 억제 낮춤)
* **지속 알림 규칙**: Crit은 최소 **15분 간격**으로 지속 공지, High는 **30분**, 그 이하 **60–120분**

### F. 관측 지표 & 목표

* `dedup_rate`(목표 ≥ 40%), `suppression_rate`, `campaign_incident_ratio`,
  `alert_fanout`(Incident당 알림 수), `alert_update_interval_compliance`, `fp_suspect_ratio`
* **성공 기준**: 4주 평균 `alert_fanout` **−35%**, `MTTR ≦ 0.8×` 이전 대비


.  


### G. 구현/IaC 포인트

* **룰 저장소**: 상관규칙 YAML(`correlation/*.yaml`) → CI 컨트랙트 테스트(샘플 리플레이)
* **엔진**: Stream Processor에 **Session Window(5/15/30m)** + `groupBy incident_key` + UDAF(TopN/ratio)
* **노이즈 가드**: DLQ ≥ 임계 시 **윈도우 길이 자동 증가**(5→15m), 알림 주기 완화
* **테넌트 오버레이**: 상관/디듀프 파라미터를 플랜/테넌트별 오버레이 가능

### H. 운영 체크리스트

* [ ] 상위 10 규칙에 대해 **샘플 리플레이 세트** 유지(주 1회 회귀)
* [ ] MW 등록 시 **사전/사후 알림** 자동화(콘솔 배너·상태페이지 초안)
* [ ] 디듀프 충돌키/해시 변경 시 **하위호환 기간 14일** 운영
* [ ] DBV360 연계 실패율 < 1%, 실패 시 백오프/재시도 정책 점검
* [ ] 캠페인(ASN 군집) 규칙의 **오탐 리뷰** 월 1회

---

4. **예시 설명 (검색 경로 경보 폭주 — 47분 내 안정화)**

1) KR 리전 배포 직후 `/v1/search` 관련 **High 알림** 다발, `dedup_rate=12%`, `alert_fanout=4.2`.
2) 상관 엔진이 **릴리스 배지** 부여, 동일 사건키 15m 집계로 Incident 1건으로 축약.
3) **DBV360**가 정상혼재 패턴 감지 → 알림 **review** 강등, 알림 주기 30분으로 자동 조정.
4) MW(22:00–24:00) 활성 확인, 해당 경로 경보 **억제** 후 대시 보드에 배지 표시.
5) 47분 내 `dedup_rate=48%`, `alert_fanout=1.1`, MTTR 22% 단축. 이후 릴리스 롤백 없이 규칙 미세조정.
   → 결과: **상관·디듀프·서프레션·MW**가 유기적으로 작동해 **노이즈를 체계적으로 제어**, 대응 리드타임과 운영 피로도를 크게 낮춤.
