# 필상 시스템 — Day 45 Sysmon 정책(Windows·Linux) 베이스라인 · 노이즈 예산 · 자동 검증

1. **날짜**

* 2024-10-14

2. **목표**

* **Desktop/Server** 이원 정책( *curated* / *strict* )의 **노이즈 예산**과 **예외(Exclude)** 기준 확정
* **배포 전 자동 검증 파이프라인**으로 정탐을 유지하면서 **이벤트 폭주·CPU/디스크 부담 최소화**
* **파일 차단 계열(예: 27/29)** 룰 변경 시 **드라이런·롤백 게이트** 의무화

---

3. **내용**

### A. 정책 구분·적용

* **curated**: 운영 안정/분석 효율 우선(기본). 주기적 자동 업데이트, 보수적 예외 포함.
* **strict**: 단기 고강도 관제·침해 대응. 배포는 **shadow → canary → full** 순.
* **역호환**: 신규 룰은 기본 Off, 드라이런에서 히트·노이즈 변동을 선측정.

### B. 노이즈 예산(일·호스트 p95)

| 구분                  |     ProcessCreate | NetworkConnect | FileCreate/Write | DNS Query |    기타 |    **총합** |
| ------------------- | ----------------: | -------------: | ---------------: | --------: | ----: | --------: |
| **Desktop·curated** |             ≤ 12k |           ≤ 6k |             ≤ 8k |      ≤ 4k |  ≤ 6k | **≤ 36k** |
| **Server·curated**  |             ≤ 25k |          ≤ 12k |            ≤ 18k |      ≤ 9k | ≤ 12k | **≤ 76k** |
| **strict(공통)**      | +30~50% 허용(기간 한정) |                |                  |           |       |           |

> 초과 시: (1) 업데이트/패키지·EDR/백업 예외 재점검 → (2) 필드 축약(경로·해시 선택) → (3) 채널 하향 또는 롤백.

### C. 핵심 이벤트·예외 가이드

* **ProcessCreate**: lolbins·스크립트호스트·브라우저 자식/서비스계정 실행 **포함**.
  *예외*: WU/MSI/브라우저 업데이트·EDR 자체 프로세스(서명자+경로 2조건 결합).
* **NetworkConnect**: 브라우저/스크립트/관리도구의 외부 연결·비표준 포트 **포함**.
  *예외*: 패키지 관리자·공식 업데이트 미러(Windows: `msiexec`, OneDriveUpdater 등 / Linux: `apt`, `dnf/yum`, `snap`, `flatpak`).
* **FileCreate/Write/Delete**: `%TEMP%`·`AppData\Local\Temp`·사용자 프로필 내 실행가능 드롭 **포착**.
  *예외*: 컴파일/패키지 캐시(`.nuget`, `.m2`, `pip_cache`, `Go build cache`, 브라우저 캐시 등).
* **DNS Query**: 고엔트로피·짧은 TTL·비정상 TLD **탐지**, OS/브라우저/업데이트 표준 텔레메트리 **예외**.
* **고위험 행위(Access/RemoteThread/ScriptBlock)**: 크리덴셜/보안 프로세스 접근·WMI/PS 인젝션 **탐지**, EDR/백업 에이전트의 정규 핸들 접근 **예외**.

### D. Windows vs Linux( Sysmon for Linux )

* **Windows**: 서명자·경로 기반 예외(ETW/드라이버/업데이트러) 정밀화.
* **Linux**: `apt/dnf/zypper/pacman`·`gcc/clang/go/rustc/pip` 빌드·캐시 디렉터리 예외.
* **공통**: 컨테이너 런타임 이벤트는 레이블링 후 **별도 인덱스**로 분리(노이즈 격리).

### E. 파일 차단 계열(27/29) 운영

* 차단은 **최후 수단**. 동등 조건의 **탐지 전용 룰**을 병행해 FP 선모니터.
* **드라이런 7일 → KR-stg canary(5→25→100%) → 리전 승격**.
* **롤백 키**: `fileblock.enable=false` 또는 룰 버전 즉시 `-1` 강등.
* 차단 이벤트는 **원로그 해시·드롭 경로·부모/자식 프로세스·샘플 10건** 자동 첨부.

### F. 자동 검증 파이프라인(릴리스 게이트)

1. **정적 검사**: XML 스키마·중복/충돌·RE2 안전성.
2. **리플레이**: 7·30·90일 대표 로그에 신규 룰 적용 → 정탐/오탐/미탐 **회귀 지표** 비교.
3. **노이즈 시뮬**: 이벤트군 p50/p95 증감률 산출, 예산 초과 시 **Fail**.
4. **Shadow**: 실시간 히트·FP 의심(동일 IP 200/400 혼재 등) 자동 수집.
5. **Canary**: KR 5→25→100% / JP 동일, **SLO 게이트**(p95 지연·DLQ) 연동.
6. **릴노트**: 변경 룰·예산 영향·되돌리기 키·증거 링크 자동 생성.

### G. 관측·알람

* 지표: `sysmon_events_total{type}`, `noise_budget_utilization%`, `fileblock_trigger_rate`, `fp_suspect_ratio`, `agent_cpu_mem{p95}`.
* 알람: 예산 활용률 **>120% (30분)** 또는 `fileblock_trigger_rate` 급증 → **T1**.

### H. 운영 체크리스트

* [ ] 새 룰 **드라이런/Shadow 7일** 이상.
* [ ] 예외는 **서명자·경로·해시** 중 2조건 이상 결합.
* [ ] 금·야간 업데이트 윈도우의 노이즈 베이스라인 주기 갱신.
* [ ] 차단 룰은 **즉시 롤백 키**·**RCA 템플릿** 동시 배포.
* [ ] 분기 1회 **curated/strict** 전면 재평가 및 주석 최신화.

---

4. **예시 설명 (KR Desktop—NetworkConnect 노이즈 42%↓, 오탐 0건)**

1) `curated v3.2 → v3.3`에서 브라우저/업데이트 예외를 **서명자+도메인** 결합으로 강화.
2) Shadow 7일: `NetworkConnect p95` **−42%**, `ProcessCreate p95` **−11%**, 정탐률 변화 **−1.8%p(허용)**.
3) Canary 5%에서 `fp_suspect_ratio` 0.2% → 룰 미세조정 후 0% 수렴, **예산 내**.
4) stable 승격 후 총량 **≤ 33k/host/day**, 대시 쿼리 p95 **0.78s → 0.69s** 개선.
   → 결과: **예외 정밀화 + 드라이런/리플레이/게이트**로 정탐을 유지하며 **노이즈 예산 안정**을 달성.
