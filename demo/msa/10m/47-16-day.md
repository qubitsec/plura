# 필상 시스템 — Day 47 퍼플팀(Blue↔Red) 적대 시뮬레이션 · ATT&CK 에뮬레이션(Atomic/Caldera)

1. **날짜**

* 2024-10-16

2. **목표**

* **MITRE ATT&CK** 기반의 **퍼플팀 훈련 체계**(시나리오·도구·안전가드) 확립
* **탐지→DBV360 판정→룰/모델 개선**까지 **폐루프 1회전 ≤ 90분** 달성
* 훈련 산출물(EPKG·RCA·룰 델타·Saved Query)을 **지식베이스에 자동 반영**

---

3. **내용**

### A. 범위 & 도구(권장)

* **에뮬레이션 툴**: Atomic Red Team(Windows/Linux), MITRE **CALDERA**(plugin: emu, stockpile)
* **네트워크/애플리케이션**: L7 공격 시나리오(OWASP/SQLi·XXE·Path Traversal) — **스테이징** 전용
* **관측/증거화**: Sysmon(Win/Linux), OTel, Solr Saved Query, **EPKG-Lite** 자동 수집
* **제한/안전**: R/W 분리 네트워크, 가짜 데이터셋(가명화), **킬스위치 플래그** 준비

### B. 룰 오브 엔게이지먼트(ROE)

* 사전 승인 범위: 리전(stg-kr), 테넌트(`purple-lab`), 시간창(2h), **데이터 유출·암호화 금지**
* **킬스위치**: 알림 폭주/성능 저하 시 즉시 `purple.enable=false`
* 모든 세션/명령은 **Bastion 녹화** + 감사 해시체인 고정

### C. 시나리오 카탈로그(요약)

| 단계  | ATT&CK | 시나리오                        | 주요 로그/지표                | 기대 탐지/대응                |
| --- | ------ | --------------------------- | ----------------------- | ----------------------- |
| IA  | T1190  | 인가되지 않은 파라미터로 SQLi 탐색       | `param_sig`, 406/200 혼재 | WAF 룰 히트, DBV360 review |
| EXE | T1059  | `powershell -enc` 실행·스크립트블록 | Sysmon EID 1/4104       | ScriptBlock 탐지+티켓       |
| PE  | T1547  | `Run` 키/StartUp 지속성 설정      | Registry/Add/ProcCreate | 경고+룰 델타(화이트리스트 제외)      |
| C2  | T1071  | 비정상 TLD로 주기 통신              | DNS 엔트로피/빈도             | 도메인 태깅/알림 high          |
| L/M | T1105  | 임시 디렉터리 드롭 & 외부 전송 시도       | FileCreate/NetConnect   | 차단 후보(27/29) 드라이런       |

### D. 실행 절차(표준 플레이북)

1. **시드선택**: 전술 2~3개 묶음 선택(총 45–60m) → ROE 체크
2. **에뮬레이션**: Atomic/Caldera 실행 → 세부 명령은 **템플릿**에서 호출
3. **실시간 관측**: 대시보드(RED/USE + 룰 히트 + DLQ), 알림/티켓 확인
4. **증거화**: EPKG-Lite 자동 생성(원로그 해시·샘플·TI 스냅샷·쿼리)
5. **판정/개선**: DBV360 재판정 → 룰/모델 델타( `alpha + dry_run` ) 작성
6. **회귀검증**: Saved Query로 전/후 비교 → 성능/SLO 영향 확인
7. **지식화**: KB/런북에 결과·쿼리·룰 변경·RCA 요약 자동 커밋

### E. 자동화 & 인터페이스(예시)

* `POST /v1/purple/run { scenario_ids:["T1190_A01","T1059_POWERSHELL"], tenant:"purple-lab", region:"kr-stg" }`
* `GET /v1/purple/status/{run_id}` — 히트율·지연·알림 집계
* `POST /v1/purple/export/{run_id}` — EPKG-Lite 생성(서명 URL 10분)
* `POST /v1/rules/draft` — 델타 초안 등록(`channel:"alpha"`, `dry_run:true`)

### F. 품질/SLO & 가드레일

* **탐지 리드타임**: 인입→사건 P95 ≤ **10s**, 사건→알림 P95 ≤ **8s**
* **안전 한계**: DLQ p95 ≤ **5m**, 콘솔/API p95 ≤ **1.0s** 유지 못하면 즉시 중단
* **윤리/컴플라이언스**: 실제 고객 데이터/프로덕션 리전 **금지**, 데이터 경계 위반 0건

### G. 산출물 & 리포트(자동)

* `purple-report.pdf`(시나리오/명령/탐지결과/FP·FN/개선안),
* `rules-delta.md`(변경 포인트·회귀 결과·롤백 키),
* `saved-queries.yaml`(추가/개선 템플릿),
* `rca.md`(근본원인·예방책·남은 리스크)

### H. 체크리스트

* [ ] ROE 승인·킬스위치·시간창 설정
* [ ] 스테이징 격리·가명 데이터 확인
* [ ] Saved Query/대시보드 사전 점검(성능 예산)
* [ ] 완료 후 **룰 델타**는 반드시 **Shadow 7일** 경유

---

4. **예시 설명 (T1190+T1059 번들 — 72분 폐루프 완료)**

1) `T1190_A01`(SQLi 파라미터 급증) + `T1059_PS_Enc` 실행 → 406/200 혼재와 `ScriptBlock 4104` 동시 관측.
2) EPKG-Lite 자동 생성, **DBV360** 판정: `review(0.66)` → `allow(0.81)`(한국어 검색어 영향).
3) **룰 델타**: “ko_search 파라미터 완화 + PS EncodedCommand 임계 상향” 초안 등록(`alpha/dry_run`).
4) 회귀 쿼리 비교: FP 1.4%→0.3%, 정탐률 -0.5p(허용). SLO 정상(p95<1s).
5) KB/런북 자동 갱신, 다음 주 **Shadow 7일** 계획 수립.
   → 결과: 훈련이 **탐지 품질 개선**으로 직결되고, 모든 단계가 **증거 중심·자동화**로 연결되어 재현 가능성이 보장된다.
