# 필상 시스템 — Day 40 에이전트/콜렉터 배포 · 자동 업데이트 · 호환성

1. **날짜**

* 2025-10-06

2. **목표**

* **Windows/Linux** 에이전트(Collector/EDR·Sysmon 설정 포함) **배포·업데이트·롤백** 표준화
* **보안(코드서명/무결성)**·**파동 배포(웨이브)**·**호환성 매트릭스** 확정, **장애 시 10분 내 롤백**

---

3. **내용**

### A. 대상 & 채널

* **제품군**: Collector(로그/EDR), Sysmon 설정(XML), 보조 도구(업데이트러/진단)
* **릴리스 채널**: `alpha → beta → stable`(+ `lts`), 테넌트/그룹별 할당 가능
* **플랫폼**: Win 10/11·Server 2016+ / Rocky9·Ubuntu 20.04+

### B. 패키징 & 서명

* **Windows**: MSI + 코드서명(EV), **Driver/ETW** 사용 시 카탈로그 서명
* **Linux**: RPM/DEB, 리포 서명(GPG), `systemd` 유닛 템플릿
* **아티팩트**: 해시(SHA-256)·SBOM·릴리스 노트 동봉

### C. 배포 토폴로지

* **중앙 업데이트 서비스**(region local) ↔ **사이트 프록시/캐시**(옵션)
* **웨이브**: 5% → 25% → 100%(엔터프라이즈는 조직·OU·태그 단위)
* **시간창**: 업무시간 외(기본), 예외는 Change Mgmt 절차 준수

### D. 설치/업데이트 정책

* **모드**: 무인(Silent) 기본, 대화형(테스트) 옵션
* **호환성 가드**: OS/커널/권한 점검 실패 시 설치 거부 + 진단 로그 수집
* **프록시/오프라인**: PAC/NTLM/MTLS 지원, **오프라인 번들**(캐시 후 지연 설치)
* **재시도**: 5→15→60분(3회), 실패 시 **self-heal**(서비스 재등록)

### E. 롤백 & 버전 핀(Pin)

* **즉시 롤백**: 10분 내 이전 `stable` 버전 복귀(서비스 중단 없이 재기동)
* **핀**: 특정 그룹/테넌트 `version=pin:1.9.3` 유지(문제 해결 시 해제)
* **Sysmon XML**은 **버전 태그**와 **서명**으로 관리(설정만 롤백 가능)

### F. 보안·무결성

* **다운로드 서명 검증**(Windows: Authenticode, Linux: GPG) 실패 시 중단
* **러ntime 보호**: Anti-tamper(서비스 DACL·LaunchProtected), **자체 무결성 체크섬** 주기 검증
* **권한**: 최소권한 서비스 계정, 로그/키는 KMS 보호

### G. 구성·플래그 연동

* **원격 구성**: 수집 경로·필터·버퍼·전송 재시도, **플래그로 런타임 토글**
* **Sysmon**: `curated/strict` 두 세트, **OS별 예외(apt/yum 캐시 등)** 내장
* **업데이트 러너**는 **킬스위치 불가**(정책상 실행 금지, 관리 API로만 중지)

### H. 관측·건강 점검

* 에이전트 **Heartbeat**(버전/OS/상태/최신 체크 결과), **업데이트 성공률**, **Crash/Restart Rate**
* **SLI**: 업데이트 성공률 ≥ **99%**, 롤백 소요 p95 ≤ **10분**, Heartbeat gap=0

### I. 인벤토리 & 라이프사이클

* **자산 뷰**: 호스트→버전→채널→마지막 체크인→Sysmon XML 해시
* **수명주기**: 설치→활성→업데이트→유지보수→오프보딩(키 폐기·로그 전송 종료)

### J. 운영/런북(요약)

* **사전 체크**: 디스크≥1GB, CPU 여유≥10%, 프록시/방화벽 포트 오픈
* **장애 대응**: 설치 실패→오프라인 번들/로컬 캐시, 충돌 의심→Safe Mode 재설치
* **컴플라이언스**: 변경은 RFC/릴노트·서명·감사 해시체인 고정

---

4. **예시 설명 (KR 웨이브 배포—Sysmon XML 충돌 롤백 12분)**

1) `collector 1.10.0 (stable)` + `sysmon-curated v3.2`를 **5% 웨이브**로 KR에 배포 시작.
2) 일부 Win2016 서버에서 ETW 충돌로 **Heartbeat gap** 발생(재시작 반복).
3) 업데이트 서비스가 **자동 가드** 발동: 해당 OU **핀=1.9.3**, Sysmon XML **v3.1로 즉시 롤백**.
4) 12분 내 정상화(재시작율↓), 실패 노드에는 **오프라인 번들** 재적용.
5) RCA: ETW 공급자 충돌; 대책—Win2016 전용 XML 프로파일 분리, 호환성 체크 강화.
   → 결과: **웨이브·핀·즉시 롤백** 체계로 장애 폭발 반경을 최소화하고, **인벤토리/SLI** 기반으로 신속 복구.
