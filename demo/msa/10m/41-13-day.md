# 필상 시스템 — Day 41 하이브리드 배포(온프레미스/에어갭) · 엣지 게이트웨이 · 데이터 주권

1. **날짜**

* 2025-10-07

2. **목표**

* **온프레미스/에어갭/하이브리드** 환경의 설치·동기화·업데이트·지원 표준 확정
* **데이터 주권**을 유지하며 **콘솔 UX·탐지 품질·운영 자동화**를 SaaS와 **기능 동등(parity)**으로 제공

---

3. **내용**

### A. 배포 모델 & 경계

* **SaaS 단독**: KR/JP 리전 운영(기본).
* **하이브리드(권장)**: 고객망 **Edge Gateway**(수집/캐시/프록시) + 클라우드 **Control Plane**.
* **온프레미스 전용**: 고객 DC에 **Control Plane 축소판** + 선택적 인터넷 단절(에어갭).
* **데이터 경계**: 원로그·증거는 고객망 보관(객체 저장소), **메타/모델/정책**만 클라우드와 교환.

### B. 엣지 게이트웨이(필수 컴포넌트)

* **역할**: 인입 집계(버퍼링/압축), 스키마 검증, 멱등/재시도, 저장된 쿼리 실행(로컬 인덱스 옵션).
* **구성**: Nginx(API/WAF 프록시) + Stream Worker + Mini-Solr(선택) + OTel Collector.
* **보안**: 게이트웨이↔클라우드 **mTLS**, 모든 외부 콜백 **HMAC 서명**·Egress 화이트리스트.
* **캐시**: 룰/플래그/템플릿 캐시 TTL 2–5s(오프라인 시 보수적 기본값).

### C. 동기화/전송(표준 프로토콜)

* **메타(룰/플래그/정책)**: gRPC 스트림(푸시) + 1s 폴백, 서명 번들(OPA/Rules).
* **데이터(요약/지표)**: 배치 NDJSON(1~5분 주기) 또는 실시간(선택), **목적 바인딩** 필수.
* **증거(대용량)**: 고객망 S3에 저장 후 **서명 URL**로 참조—클라우드로 원본 전송 금지.
* **오류/DLQ**: 로컬 격리 → 재생 API(`POST /v1/edge/dlq:replay`).

### D. 에어갭/부분 단절 운영

* **정책/룰 번들 오프라인 배포**: 서명된 `edge-bundle.tgz`(SBOM 포함), QR/USB 승인 절차.
* **지연 동기화**: 연결 회복 시 **증적 해시** 대조→누락분 재전송(역사 순서 보장).
* **지원 채널**: 오프라인 **증거 패키지(EPKG-Lite)** 생성→고객망에서 암호화 내보내기.

### E. 설치·업데이트

* **IaC**: Ansible/Helm 차트 제공(고객망 레지스트리), **불변 이미지 + 가변 구성**.
* **웨이브 롤아웃**: Edge 5%→25%→100%, 실패 시 롤백(10분 내).
* **버전 정렬**: 클라우드 `compatMatrix.yaml`과 **자동 협상**(지원 최소/최대), 불일치 시 경고·차단.

### F. 기능 동등성(Parity) & 제한

* **동등**: 탐지엔진/DBV360/티켓/알림/저장 쿼리/대시보드(핵심).
* **제한**: 일부 생성형/RAG 설명은 **로컬 캐시 근거만**(외부 TI 직접 조회 금지—프록시 경유).
* **옵션**: Mini-Solr 로컬 인덱싱(최근 7일) + 중앙 인덱스 질의 프록시.

### G. 운영·관측(하이브리드 지표)

* **SLI**: `edge_to_cloud_latency_p95 ≤ 2s`, `sync_backlog ≤ 5m`, `rule_bundle_age ≤ 15m`.
* **대시**: 사이트별 인입·적체·DLQ·캐시 히트율·오프라인 지속시간.
* **알람**: 10분↑ 단절 시 **S2** 티켓 자동 생성(고객·CSM 동시 통지).

### H. 보안·주권·감사

* **주권 준수**: 교차 리전 데이터 전송 금지, 메타만 글로벌 공유.
* **키/비밀**: KMS(고객 소유 우선) + STS 단명, 정책/룰 번들은 **이중 서명**.
* **감사**: 동기화/오프라인 내보내기/번들 적용은 **해시체인**으로 고정.

### I. API/계약(발췌)

* `GET /v1/edge/capabilities` — 기능/버전 교섭 결과.
* `POST /v1/edge/bundle:apply` — 서명 번들 적용(사전 검증/롤백 스냅샷).
* `GET /v1/edge/health` — 연결/백로그/캐시 상태.
* `POST /v1/edge/export { scope, window }` — 오프라인 EPKG-Lite 생성.

### J. 체크리스트

* [ ] 고객망 S3/키 관리 준비(KMS)·DNS/프록시·방화벽 룰 승인.
* [ ] 초기 동기화 완료 전 **차단 모드**(정책상 기본 보수) 유지.
* [ ] Edge 장애 대비 **로컬 큐 용량/보존기간** 설정(최소 24h).
* [ ] 번들 서명/검증 리허설(분기 1회), 롤백 스냅샷 유효성 점검.
* [ ] 단절 리허설: 1h/4h/24h 케이스별 복구·백로그 소진 시간 측정.

---

4. **예시 설명 (하이브리드—KR 제조사 에어갭 사이트 24h 단절 복구)**

1) 계획 점검으로 **WAN 24h 차단**—Edge는 **보수적 정책**으로 탐지/알림 로컬 처리, 번들은 `v12` 유지.
2) 단절 동안 인입 4.1억건 → 로컬 큐/압축으로 저장(드롭 0.04% 이내), 사건/티켓은 **로컬 싱크**로 운영 지속.
3) 회복 후 **증적 해시 대조**→누락분 재전송(ULID 순), `sync_backlog` 2h 내 0.
4) 중앙 콘솔에서 24h 구간 재생(리플레이)·대시 정합성 확인, **SLO 위반 없음**.
5) 감사 인덱스에 단절/복구 타임라인·해시 요약·번들 체크 결과 고정.
   → 결과: **엣지 게이트웨이·서명 번들·지연 동기화** 조합으로 에어갭 환경에서도 **주권과 기능 동등성**을 유지하며, **무중단 운영**과 **신속 복구**를 보장.
