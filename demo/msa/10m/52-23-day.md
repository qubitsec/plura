# 필상 시스템 — Day 52 비밀/자격증명 관리(Secrets · KMS · STS) · 로테이션 · 유출 대응

1. **날짜**

* 2024-10-23

2. **목표**

* 모든 서비스/에이전트/운영 채널의 **비밀·키·토큰**을 **KMS+STS** 중심으로 통합 관리
* **자동 로테이션(≤90일)**·**스코프 최소화**·**유출 대응 플레이북** 표준화 → **정적 비밀 0건**을 목표

---

3. **내용**

### A. 비밀 자산 범위(카탈로그)

* **애플리케이션**: DB/Redis/S3 자격증명, OIDC 클라이언트 시크릿, Webhook 시크릿(HMAC)
* **플랫폼**: 레지스트리 토큰、K8s 시크릿、Helm/Kustomize 값
* **운영**: Bastion/EDR 제어 토큰、Terraform/CI OIDC 바인딩、TI API 키
* **에이전트**: IngestKey(스코프/만료 포함), 업데이트러 서명 키(검증 전용)

### B. 설계 원칙

* **Zero-Trust & Zero-Standing**: 장기(static) 비밀 금지, **STS 단명(15–60m)** 기본
* **분리**: 비밀은 **KMS 전용 저장**(앱에서 참조만), Config/Flags에 **직접 값 금지**
* **최소권한**: 스코프=리소스·리전·테넌트 단위, 목적(purpose) 태그 필수

### C. 발급/사용 흐름(표준)

1. 서비스/CI가 **OIDC**로 KMS에 **AssumeRole** 요청
2. KMS가 정책(리전/리소스/목적) 평가 → **STS 크리덴셜(예: 30m)** 발급
3. 앱은 STS로 DB/S3/Webhook 서명 수행, 만료 전 **투명 갱신**
4. 사용/만료/회수 이벤트는 `security.audit.v1`로 중앙 기록(해시체인)

### D. 저장/전달

* **K8s**: 시크릿은 `sealed-secrets`/CSP KMS로 암호화, Pod에는 **tmpfs 볼륨**으로 주입
* **파일 시스템 금지**: 영구 디스크에 평문 저장 불가, 덤프/코어에 비밀 마스킹
* **전달 경로**: mTLS + 最小 TTL 캐시, Sidecar(Secrets Proxy) 옵션 제공

### E. 로테이션 정책

* **주기**: 기본 90일, 고위험(외부 노출 경로/운영 토큰) 30일
* **방식**: *Dual-Key* 전략(신·구 겹침 기간 ≤ 24h) → 점진 전환 → 구키 파기
* **검증**: 프리플라이트 헬스체크(스테이징) 후 프로덕션 파급
* **지표**: `rotation_age_p95`, `stale_secret_count(=0)`.

### F. 코드/CI 보호

* **gitleaks** 프리커밋/CI 게이트(차단형)
* **레포 보호**: 서명 커밋 + 보호 브랜치 + PR 2인 리뷰
* **CI 비밀**: OIDC Workload Identity만 허용(고정 토큰 금지), Job 로그 **시크릿 레드액션**

### G. 유출(Leak) 탐지·대응 플레이북

1. **탐지**: gitleaks/레지스트리 스캔/엔드포인트 DLP/외부 인텔 피드 히트
2. **분류**: 비밀 타입/스코프/리스크 점수(외부 접근 가능성·리전·테넌트 영향)
3. **즉시 조치**

   * STS: 만료 대기(≤60m).
   * Static/장기: **Kill & Rotate** 자동(신규 발급→구키 취소)
   * Webhook: 시그니처 시크릿 교체 & **리플레이 차단 캐시** 플러시
4. **완화**: WAF 규칙/레이트리밋 상향(필요 시), 의심 세션 **강제 재인증**
5. **감사/통지**: 사건/영향 범위/교체 내역 **EPKG-Secret**로 고정, 필요 시 고객 통지
6. **재발 방지**: RCA + 정책/교육/자동화 보강

### H. 거버넌스·정책(OPA/Gatekeeper)

* `secrets.no_static_in_config == true`
* `k8s.secret.source in {"sealed","kms"}`
* `webhook.secret.rotation_age_days < 90`
* `ci.job.oidc_required == true`
* 위반 시 **deny** + 티켓 자동 생성

### I. API/자동화(발췌)

* `POST /v1/secrets/issue { scope, ttl, purpose }` — STS 발급
* `POST /v1/secrets/rotate { secret_id, overlap_hours }` — 로테이션
* `POST /v1/secrets/revoke { secret_id, reason }` — 폐기/취소
* `GET  /v1/secrets/age?owner=team-xyz` — 로테이션 만료 임박 목록
* `POST /v1/secrets/leak:handle { artifact_uri }` — 유출 대응 자동화

### J. 운영 체크리스트

* [ ] 정적 비밀 0건, STS 전환 100%
* [ ] 모든 Webhook 시크릿 **만료일/회전 스케줄** 등록
* [ ] 레포 전역 **gitleaks** 활성 & 위반 0건
* [ ] 로테이션 실패 시 **Dual-Key 롤백** 경로 검증
* [ ] 분기 1회 **테이블탑(유출 가상 훈련)** 수행

---

4. **예시 설명 (Webhook 시크릿 유출 — 22분 내 차단·교체)**

1) gitleaks가 외부 포크 PR에서 `X-Plura-Signature` 시크릿 패턴 탐지 → **유출 티켓 S1** 생성.
2) SOAR가 `secrets/leak:handle` 트리거: **신규 시크릿 발급→수신측 키 롤오버 알림→구키 폐기** 자동화(8분).
3) 게이트웨이가 **리플레이 캐시 재설정** + 레이트리밋 일시 상향, 과거 15분 내 동일 nonce 요청 **차단**.
4) 상태페이지(내부) 업데이트, 감사 인덱스에 **교체 해시/타임라인** 고정. 22분 내 위험 해소, 고객 영향 0.
   → 결과: **KMS+STS·Dual-Key·자동화 플레이북**으로 비밀 유출을 **신속·가역적으로 차단**, 정적 비밀을 제거하여 장기 리스크를 근본적으로 낮춤.
