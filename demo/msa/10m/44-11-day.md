# 필상 시스템 — Day 44 대규모 DDoS·봇 방어 전략(Edge/WAF/Rate-Limit/PoW)

1. **날짜**

* 2024-10-11

2. **목표**

* **GSLB → LB(HAProxy) → Nginx/WAF → App** 경로에서 **대규모 L3/4/7 DDoS·봇 트래픽**을 흡수·차단
* **정상 사용자 영향 최소화**(p95 지연 ≤ 1.0s), **자동 복구·가드레일** 표준화

---

3. **내용**

### A. 위협 모델(요약)

* **L3/4**: SYN/UDP Flood, Reflection(SSDP/DNS/NTP)
* **L7**: HTTP GET/POST Flood, Slowloris, Search/Facet 남용, **봇 스크레이핑**
* **내부 연계**: 알림/Webhook 남용, TI/외부 API 호출 소진

### B. 방어 계층(Reference Path)

1. **GSLB**: 지리/가중 라우팅 + Anycast/GeoIP 블랙홀(공격 리전 분산)
2. **HAProxy(L4/7)**: `conn_rate`·`http_req_rate` 기반 **IP/ASN 단위** 스로틀/드롭
3. **Nginx/WAF**: 레이어7 레이트리밋·Captcha/PoW·Bot Score 차단·캐시/정적 오프로딩
4. **App/Search**: 쿼리 템플릿 화이트리스트, **Expensive Query 거부**(facet 제한)

### C. 레이트 리밋 정책(표준 값)

* **IP 기반**: 60 r/m 기본, 버스트 30 (Nginx `limit_req_zone`)
* **토큰/사용자 기반**: 120 r/m, API 키별 **별도 버킷**(공유IP 보호)
* **경로 별 상한**: `/v1/search` 30 r/m, `/v1/notify` 10 r/m, `/v1/webhooks/*` 120 r/m
* **동적 상향/하향**: 공격 감지 시 자동 **50%로 하향**, 복원 시 15분에 걸쳐 원복

### D. Bot/자동화 트래픽 판별

* **신호**: JA3/JA4 지문·User-Agent 리스크·헤더 일관성·TLS 핸드셰이크 타이밍·쿠키 지속성
* **Bot Score(0–100)**: 80↑ 차단, 60–79 **Proof-of-Work(잡기) 또는 Captcha** 요구
* **Good Bot 카탈로그**: 검색엔진/모니터링 화이트리스트(역방향 DNS·ASN 검증)

### E. Proof-of-Work(옵션)

* **헤더**: `X-Plura-PoW: nonce, timestamp, work=sha256^n`
* **난이도**: 공격 단계별 `n=18→22→26` 동적 조정(모바일 고려)
* **만료**: 60초, 재사용 불가(서명+nonce 캐시)

### F. 캐시·오프로딩

* **정적 리소스**: `expires 7d`, ETag, HTTP/2 Push 금지(오폭주 방지)
* **검색 결과**: 저장 쿼리 + 파라미터 해시 **15–90s 캐시**, 상위 타일 사전 가열(warm-up)
* **에러 페이지/429**: 경량 HTML(≤3KB), 재시도 힌트 포함

### G. 탐지·자동화(가드레일)

* **탐지 지표**: `req_rate`, `429_rate`, `upstream_5xx`, `p95_latency`, `bot_score_hist`
* **상향/차단 룰**:

  * `429_rate > 5%` & `req_rate > 2×baseline` → 레이트리밋 50% 강화 + PoW on
  * `upstream_5xx > 1%` → 카나리 강등, Search Expensive Query 차단
* **해제 조건**: 15분 정상 구간 유지 → 단계적 원복

### H. 검색/인덱스 보호

* **쿼리 가드**: `rows≤200`, `facet limit≤50`, deep pagination 금지(커서 기반)
* **쿼터**: 테넌트별 QPS 상한, 특정 테넌트 폭주 시 **그 테넌트만** 스로틀
* **미터링 연동**: 이상 사용량 급증 → CS 알림 + 업셀/정책 제안

### I. 컴플라이언스/프라이버시

* **차단 로그**: `reason(bot_score|ratelimit|pow_fail), asn, ja3, ip_bucket(/24), ts`
* **PII 최소화**: 원 IP는 저장 금지(필요 시 /24 버킷 + 해시), **주권 준수**로 리전 외 전송 금지

### J. SLO·운영 체크리스트

* **SLO(공격 시)**: 콘솔/API p95 ≤ **1.0s**, 정상 사용 95% 이상 **무영향**
* **런북**: 공격 단계(감지→강화→완화→원복), PoW 난이도 표, Good Bot 예외 등록 절차
* **리허설**: 분기 1회 `10×` 트래픽 합성, PoW/Captcha·레이트리밋 자동 전이 확인

---

4. **예시 설명 (KR 리전 L7 GET Flood—25분 방어·안정화)**

1) 14:02 KST, `/v1/search` QPS **8×** 급증, `bot_score≥80` 비중 62%, `p95=1.7s`.
2) 자동 가드: IP/토큰 레이트리밋 **50% 강화**, **PoW n=22 활성화**, Expensive Query 차단.
3) 7분 내 `p95=0.92s` 회복, `429_rate` 6.3%→1.1%로 하락, 정상 사용자 영향 **<1%**.
4) 공격 소스 ASN 3개에 HAProxy 레벨 드롭 적용, Good Bot 화이트리스트 유지 확인.
5) 25분 후 정상화 → 레이트리밋 단계적 원복(15분), PoW 해제, RCA·대시 스냅샷 첨부.
   → 결과: **다계층 레이트리밋+Bot Score+PoW**로 대규모 L7 공격을 **흡수·완화**하고, 정상 사용자 경험을 유지한 채 **자동 복구**를 달성.
