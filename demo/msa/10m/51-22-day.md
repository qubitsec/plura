# 필상 시스템 — Day 51 데이터 카탈로그·계보(Lineage)·영향도 분석(Impact Analysis)

1. **날짜**

* 2024-10-22

2. **목표**

* **메타데이터/계보 수집 표준**을 확정하여 스키마·파이프라인·리포트 변경의 **영향도(Impact) 자동 추정**
* **PII 태깅 전파·품질지표 연계**로 **오류/규제 리스크를 사전 차단**, 회귀 시 **복구 시간 단축(≤ 30분)**

---

3. **내용**

### A. 아키텍처(개요)

* **Catalog**: `datasets`(Solr 컬렉션/DB 스키마/오브젝트 버킷), `fields`(컬럼/키), `reports/queries`(Saved Query/대시보드).
* **Lineage**: **OpenLineage 스타일**의 `job/run` 이벤트(`inputs[] → outputs[]`, `facets{schema, columnLineage, dataQuality}`).
* **Collector**: Ingestor/Stream/ETL/Report 렌더러에 **에이전트** 주입(OTel span hook + lineage facet).
* **Registry 연동**: 기존 `schema/{collection}/vN.json`, `SavedQuery` 템플릿과 키로 링크.

### B. 데이터셋/필드 메타(스키마)

```yaml
dataset: solr:logs_raw_kr_202410
fields:
  - { name: ts, type: datetime, pii: false, quality: {null_rate:0.0} }
  - { name: src_ip_trunc, type: string, pii: masked, tags:[ip, /24] }
  - { name: ip_bucket, type: string, pii: masked, lineage: { derivedFrom:["src_ip"] } }
owners: [ "team-ingest" ]
retention: { hot: 90d, cold: 1y }
```

### C. 계보 이벤트(OpenLineage 유사)

```json
{
  "job": {"name":"ingest-normalize"},
  "run": {"runId":"01J..."},
  "inputs":[{"namespace":"raw","name":"waf:edge_kr"}],
  "outputs":[{"namespace":"solr","name":"logs_raw_kr_202410"}],
  "facets":{
    "schema": {"fields":[{"name":"ip_bucket","type":"string"}]},
    "columnLineage":{
      "fields":[{"output":"ip_bucket","inputFields":[{"namespace":"raw","name":"client_ip"}]}]
    },
    "dataQuality":{"metrics":{"null_rate.ip_bucket":0.0003}}
  },
  "timestamp":"2024-10-22T01:23:45Z"
}
```

### D. 영향도 분석 규칙

* **스키마 변경(EMC 단계)** 감지 시 자동 계산:

  * *필드 추가/제거/타입 변경* → 참조 **SavedQuery/Report/Rule/Model** 그래프 추출.
  * 영향 범주: `break`(필수 의존), `warn`(옵셔널/기본값), `info`(비가시 필드).
* **PII 태그 전파**: `derivedFrom` 사슬을 따라 **마스킹/다운로드 제약** 자동 상속.
* **품질 연계**: `dq_null_rate`/`type_error` 상승 시 해당 필드를 사용하는 **쿼리/리포트**에 경고 배지.

### E. SLO·지표

* **수집 지연**: lineage 이벤트 수집 p95 **≤ 60s**
* **커버리지**: 카탈로그 등록 데이터셋 **100%**, 필드 레벨 95%+
* **영향도 계산**: 변경 트리 추출 p95 **≤ 10s**
* **품질 연동**: DQ 알람→영향 리포트 생성 **≤ 5m**

### F. 거버넌스·가드레일

* **승인 게이트**: `break` 영향 존재 시 **PR 차단 + RFC 필요**
* **주권/프라이버시**: 카탈로그/계보 메타는 리전별 저장, PII 값 **저장 금지**(태그만)
* **감사**: 모든 변경/영향 리포트는 **해시체인** 고정, 릴리스 노트와 링크

### G. 운영·UX

* **카탈로그 뷰**: Dataset/Field 카드(오너·PII·품질지표·사용량 Top 쿼리).
* **영향 리포트**: “이 변경은 `incidents_kr`의 `ip_bucket`을 참조하는 **SavedQuery 6개/리포트 2개/모델 1개**에 영향”
* **개발자 워크플로우**: PR에 **영향 요약 코멘트** 봇이 자동 게시(수정 가이드 포함).

### H. API(발췌)

* `POST /v1/lineage/events` — 계보 이벤트 수집(배치/스트림)
* `GET  /v1/catalog/datasets/{id}` — 스키마/오너/PII/품질/의존성
* `GET  /v1/impact?change=schema:incidents_kr#ip_bucket:drop` — 영향도 그래프(JSON/HTML)
* `POST /v1/catalog/tags { field, tags:[pii.masked,'ip'] }` — 태그/정책 적용

### I. 체크리스트

* [ ] Ingest/ETL/Report 경로에 **lineage collector** 주입(스테이징→프로덕션)
* [ ] 모든 SavedQuery/Rule/Model 아티팩트에 **소스 필드 참조 메타** 추가
* [ ] EMC 단계마다 **영향 리포트** 생성·검토·PR 링크
* [ ] PII 태그 전파·마스킹 정책 **유닛 테스트** 포함

---

4. **예시 설명 (ip_bucket 필드 제거 Contract 단계—무중단 검증)**

1) 개발자가 `ip_bucket` 제거 PR 생성 → Catalog가 **영향도 분석** 실행: `break` 1(리포트), `warn` 3(SavedQuery).
2) BOT이 PR에 “대체: `src_ip_trunc` 사용 또는 매핑 뷰 추가” 제안 + **자동 수정 패치** 첨부.
3) CI에서 **스키마 회귀** + **리포트 렌더 테스트** 통과, 영향 리포트에 모든 소비자 업데이트 확인.
4) 배포 후 lineage 이벤트가 `ip_bucket` 미사용을 반영, DQ 지표 정상(Null=0.0x%).
   → 결과: **계보·영향도 자동화** 덕분에 스키마 진화를 **무중단·무누락**으로 수행하고, PII/품질/리포트 준수까지 일관되게 보장.
