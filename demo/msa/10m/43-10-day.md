# 필상 시스템 — Day 43 멀티테넌시·리전 격리 테스트(침투·오용 시나리오)

1. **날짜**

* 2025-10-10

2. **목표**

* **테넌트 간 데이터/권한/리소스 격리**와 **리전 주권**이 실제 공격·오용 시나리오에서도 유지되는지 검증
* **자동 테스트 스위트 + 침투 체크리스트**를 확정하여 **격리 위반(교차 조회/전송) 0건** 보장

---

3. **내용**

### A. 범위 & 가정

* 범위: API Gateway(mTLS/OIDC), Ingest/Search(Solr), Meta-DB(Postgres RLS), Object Storage(S3/MinIO), Notifier/Webhook, Edge Gateway(하이브리드)
* 전제: OPA 정책/레이트리밋/서명 검증 활성, 저장 쿼리는 템플릿 기반

### B. 테스트 스위트(자동)

1. **RLS/쿼리 격리**

   * 케이스: `tenant=T1` 토큰으로 `T2` 리소스 조회/다운로드 시도 → **403 + 감사 로그**
   * Solr: `fq=tenant_id:{token.tenant}` 자동 주입 미작동 시 **정책 deny**
2. **리전 주권**

   * KR 토큰으로 JP 인덱스/객체 URI 접근 → **deny + 이벤트 sovereignty.violation**
   * Edge 오프라인 시 중앙으로 원본 전송 시도 → **정책 차단**(요약치만 허용)
3. **웹훅/egress**

   * 미서명·만료 시그니처, 미등록 도메인 전송 → **deny + 재생 방지 히트**
4. **레이트리밋/자원 고립**

   * 한 테넌트의 초당 10× 폭주 → 해당 테넌트만 스로틀, 타 테넌트 **정상**
5. **권한 상승 방지**

   * `READONLY`가 `rules:write` 호출 → **AUTH_40301**
   * JIT 없이 Bastion 우회 시도 → **차단 + 계정 잠금**

**합격 기준**: 위반 0건, 감사 해시체인 **연속성(audit_gap=0)**, 탐지→차단 지연 **≤ 2s**.

### C. 침투 체크리스트(수동·분기 1회)

* **IDOR/객체 직접 참조**: `/tenants/T2/*` 경로, S3 서명 URL 파라미터 변조
* **쿼리 인젝션/필터 우회**: 저장 템플릿 변수 삽입·이중 인코딩(ko/ja URL 포함)
* **Webhook SSRF/데이터 유출**: 내부 메타데이터 엔드포인트 요청 시도
* **Edge 재구성 오용**: 번들 미서명·다운그레이드 롤백 시도(타임락·서명 검증 확인)

### D. 도구·자동화

* 테스트 러너: `k6 + OPA test`, `zap-baseline`, `psql RLS harness`, `solr policy smoke`
* 배치: CI 파이프라인 `isolation` 스테이지(일일), **분기 침투 리허설** 워크플로우
* 산출: `isolation-report.pdf`(서명), `violations.ndjson`(없으면 빈 파일), 대시보드 위젯

### E. 지표·SLO

* `cross_tenant_denies`, `cross_region_denies`, `webhook_replay_blocks`, `rate_limit_isolation`
* 목표: **교차 접근 0건**, `deny_latency_p95 ≤ 200ms`, 위반 탐지→보고 **≤ 60s**

### F. 운영 가드레일

* **정책 실패 기본 보수**: OPA/캐시 장애 시 `deny`(다운로드/변경), 읽기는 마스킹 뷰만
* **템플릿 강제**: 콘솔/리포트 쿼리는 저장 템플릿만 허용(임의 Raw 금지)
* **감사 확대**: `purpose` 누락 요청 **거부**, Break-Glass는 2인 승인+타임락

### G. API(발췌)

* `POST /v1/isolation/test:run { scope: all|api|search|db|webhook }`
* `GET /v1/isolation/report?range=7d` — 위반/차단 요약
* `POST /v1/sovereignty/simulate { region:'kr'→'jp', mode:'deny' }` — 가상 위반 시뮬레이터

---

4. **예시 설명 (교차 테넌트 조회 차단—실전 시나리오)**

1) 외부 사용자가 저장 쿼리 파라미터를 변조해 `tenant=T2` 문서를 요청.
2) 게이트웨이가 `tenant_id` 불일치 감지 → **OPA deny** 즉시 응답(200ms 내).
3) 감사 인덱스에 `actor, purpose, resource, trace_id, prev_hash` 기록, CSIRT 티켓 자동 생성.
4) 동일 공격이 3회 반복되자 레이트리밋 규칙이 발동(해당 IP만 스로틀), 타 테넌트 영향 **0**.
5) 대시보드 `cross_tenant_denies=3` 집계, 주간 리포트에 케이스·증거 자동 첨부.
   → 결과: **RLS/OPA/레이트리밋/감사**가 유기적으로 작동해 **격리 위반 0건**과 **즉시 가시성**을 달성.
