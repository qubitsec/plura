# 필상 시스템 — Day 57 테스트/데모/분석용 **가명·합성 데이터** 파이프라인(Privacy-Preserving Analytics)

1. **날짜**

* 2024-10-30

2. **목표**

* 운영 로그/사건 데이터를 **가명처리(Pseudonymization)**·**비식별화(Anonymization)**·**합성(Synthetic)** 으로 안전 변환하여
  **스테이징/개발/데모/리서치** 환경에 공급
* **분석 유용성(Utility) 보존 ≥ 90%**, **재식별 위험(Privacy Risk) ≤ 1%** SLO 확정

---

3. **내용**

### A. 데이터 계층화(3 레벨)

| 레벨                        | 목적/사용처            | 보존 정책     | 예시 필드 처리                                                                  |
| ------------------------- | ----------------- | --------- | ------------------------------------------------------------------------- |
| **Pseudonymized(Pseudo)** | 운영 분석/리플레이(내부 한정) | 리전 내 90일  | `src_ip → HMAC-SHA256(ip, k_tenant)` → `/24` 버킷 유지, `email → salted hash` |
| **Anonymized(Anon)**      | 스테이징·데모           | 리전 내 1년   | `uri/query` 파라미터 **시그니처만**(단어벡터/해시), 희소 카테고리 **k-익명화(k≥10)**              |
| **Synthetic(Syn)**        | 공개 데모·외부 공유 가능    | 3년(문서/샘플) | 통계/모형 기반 합성(코호트 분포·상관 유지), **원본과 1:1 매핑 금지**                              |

> 원칙: **주권 준수(리전 내 처리)**, 원본은 **WORM** 보관, 외부 반출은 Syn만 허용.

### B. 필드별 처리 규칙(표준)

* **식별자**:

  * `src_ip` → `ip_bucket(/24)` + `HMAC(ip, tenant_key)`(역가역 금지: 키는 KMS STS 단명)
  * `email/phone` → `salted hash` + 도메인/TLD만 보존 옵션
* **콘텐츠/파라미터**:

  * `query/body` → **param_sig**(정규화 토큰/엔트로피/키워드 TF)만 보존, 원문 제거
  * `uri` → 경로 수준만 보존(`/search`, `/login`), 매개변수는 시그니처로 대체
* **시간/지리**:

  * `ts` → **DP(차등프라이버시) 라플라스 노이즈** ±[0..3]초(집계 정확도 유지),
  * `geo/asn` → 국가/ASN 레벨만 보존, 세부 좌표 제거
* **식별 위험 높은 패턴**: 주민/여권/CC 등 정규식 **즉시 드랍 + 이벤트 기록(DLP)**

### C. 합성 데이터 생성(Logs/Incidents 전용)

* **모델**: 빈도 기반 + 코호트 조건부 생성(예: `dst_host`, `hour-of-day`, `param_sig`)
* **상관 유지**: `status_mix ↔ blocked_ratio`, `req_rate(ip_bucket) ↔ TI score` 등 공분산 행렬 보존
* **희소치 처리**: 빈도 상위 95%만 직접 합성, 꼬리(rare) 값은 **가짜 카테고리**로 클러스터링 후 샘플링
* **검증**: 원본과 **JSD/JSDivergence ≤ 0.1**, Top-N 규칙 히트율 차이 **≤ 5%p**

```yaml
# synth.yaml (발췌)
targets:
  - collection: logs_raw_kr_202410
    fields:
      - name: ts;      gen: "dp_time_noise";  params: {eps: 2.0, max_seconds: 3}
      - name: uri;     gen: "path_sampler";   params: {top_k: 500}
      - name: param_sig; gen: "ngram_markov"; params: {n:3, vocab_size: 2000}
      - name: status;  gen: "categorical";    params: {from: "empirical"}
      - name: blocked; gen: "bernoulli";      params: {p_from: "cond(status)"}
      - name: ip_bucket; gen: "pseudo_ip24";  params: {hmac_key_ref: "kms:tenant"}
```

### D. 품질·위험 SLO & 측정

* **Utility**

  * 쿼리 성능/지표 유사도: 상위 10 템플릿 p95 지연/카디널리티 차이 **≤ ±10%**
  * 탐지 품질 유사도: 룰/모델 히트율 차이 **≤ 5%p**
* **Privacy**

  * **k-익명성 k≥10**, **l-다양성 l≥2**, 희귀 조합(≤0.1%) **마스킹**
  * **재식별 리스크 ≤ 1%**(시뮬레이션 어택: 링크·동형·빈도)
* **감사**: 변환 로그에 `transform_id, params_hash, dp_epsilon, actor, ts, prev_hash` 고정

### E. 파이프라인(ETL/스트림)

1. **Extract**: 운영 컬렉션/DB에서 **목적(purpose=dev|demo|research)** 지정 추출
2. **Transform**: 위 규칙 엔진(OPA로 정책 검증) → Pseudo/Anon/Syn 생성
3. **Validate**: Utility/Privacy 지표 산출(대시보드/리포트) → **Gate** 통과 시만 적재
4. **Load**: `solr: *_sanitized` / `db: *_anon` / `s3://syn/…` 에 적재
5. **Publish**: 스테이징/데모 환경에 **버전 태깅** 배포(`sanitizer-2024.10.x`)

### F. 거버넌스/정책(OPA 예시)

```rego
package privacy

default allow = false

# PII는 원문 저장 금지
deny[msg] {
  some f
  input.record[f].pii == "raw"
  msg := sprintf("raw PII not allowed: %v", [f])
}

# 최소 k-익명성
deny[msg] {
  input.metrics.k_anonymity < 10
  msg := "k-anonymity < 10"
}

allow {
  not deny[_]
}
```

### G. 인터페이스/API

* `POST /v1/sanitize/run { source, level: "pseudo|anon|syn", purpose, window, region }`
* `GET  /v1/sanitize/report/{run_id}` — Utility/Privacy 지표, dp_epsilon, 샘플 비교
* `GET  /v1/datasets?type=sanitized|synthetic` — 사용 가능 세트 목록
* `POST /v1/sanitize/policy:test` — 변환 정책 정적 검증

### H. 운영 체크리스트

* [ ] **목적 바인딩** 필수(`purpose ∈ {dev,demo,research}`), 원본 경로 접근 차단
* [ ] 합성 데이터에 **원본 키/해시/ULID** 포함 금지(유추 가능성 차단)
* [ ] 정책/매개변수(`eps`, `k`, `vocab`) **버전 관리** + 해시체인
* [ ] 주기적 **재식별 공격 시뮬레이션**(링킹·유니크 조합) 리포트
* [ ] 데모 배포 전 **법무/컴플라이언스 승인** 자동 체크

---

4. **예시 설명 (스테이징용 Syn 로그 생성 — 2시간 내 승인/배포)**

1) `POST /v1/sanitize/run`(source=`logs_raw_kr_202410`, level=`syn`, purpose=`demo`, window=24h) 실행.
2) 변환 엔진이 **DP 노이즈/시그니처화/HMAC-ip_bucket** 적용 → Syn 3천만 레코드 생성(70분).
3) 품질 게이트: 쿼리 p95 **+6%**, 히트율 차이 **+3.2%p**, k=12, 재식별 리스크 0.6% → **통과**.
4) `*_sanitized` 컬렉션/`syn` 버킷에 적재, 대시보드 보고서 자동 생성 → **승인 후 스테이징 배포**(총 2시간).
   → 결과: **가명·합성 파이프라인**으로 개발/데모/리서치 환경이 **안전·신뢰·대응력**을 확보하며, 운영 데이터의 주권·프라이버시를 강력히 보호.
