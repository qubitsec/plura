# 필상 시스템 — Day 46 위협 헌팅(Threat Hunting) 플레이북 · MITRE ATT&CK 매핑 · 쿼리 라이브러리

1. **날짜**

* 2024-10-15

2. **목표**

* **MITRE ATT&CK 전술/기술**(Tx)에 정렬된 **위협 헌팅 플레이북**과 **저장 쿼리 라이브러리**를 확정
* 헌팅→검증(DBV360)→티켓/알림→룰/모델 개선까지 **폐루프(Closed Loop)**를 1회전 **≤ 60분**으로 표준화

---

3. **내용**

### A. 헌팅 운영 원칙

* **가설 기반**: “최근 KR 리전에서 `T1190(Exploitation for Client Execution)` 우회 시도가 증가했다.”처럼 **전술·가정·증거**를 명시
* **템플릿 우선**: 모든 헌팅은 **Saved Query 템플릿**과 **증거 패키지(EPKG-Lite)** 생성 규칙을 동반
* **시간 예산**: 수집(10m)→검증/상호연관(20m)→판정/티켓(15m)→룰/모델 제안(15m)

### B. 플레이북 카탈로그(요약)

| 전술(ATT&CK)          | 기술(Tx)         | 헌팅 가설               | 핵심 지표/특징량                                       | 대응 액션(초안)               |
| ------------------- | -------------- | ------------------- | ----------------------------------------------- | ----------------------- |
| **Initial Access**  | T1190, T1195   | 특정 URI/파라미터 시그니처 급증 | `param_sig`, `status_mix`, `blocked_ratio`      | 룰 델타 생성, FP 샘플 수집       |
| **Execution**       | T1059(ps/스크립트) | PS/WMI 기반 실행 급증     | `ProcessCreate: powershell/wmic`, `ScriptBlock` | DBV360 재분석, PS 제한 모드 제안 |
| **Persistence**     | T1547(Startup) | 사용자 프로필 경로에 실행파일 생성 | `FileCreate in %APPDATA%`, `Autorun keys`       | 파일 차단 후보(드라이런), EDR 퀘런틴 |
| **Defense Evasion** | T1027(난독화)     | 고엔트로피 쿼리/헤더         | `payload_entropy`, `unicode_mixed`              | WAF 시그니처 강화, TI 교차검증    |
| **C2**              | T1071(Web C2)  | 비정상 TLD로 빈발 통신      | `DNS entropy`, `dst_host TLD`, `req_rate`       | 도메인 태깅/차단 검토            |

### C. 저장 쿼리 템플릿(발췌)

1. **T1190_파라미터_시그니처_급증 탐지**

```yaml
key: hunt.t1190.param_spike
params:
  - {name: host, type: string, required: true}
  - {name: window, type: duration, default: "NOW-1HOUR TO NOW"}
template: |
  q=param_sig:("union_select" "or_1_eq_1" "%27" "sleep(")
  fq=tenant_id:{TENANT} AND dst_host:${host} AND ts:[${window}]
  json.facet={
    sigs:{type:terms, field:param_sig, limit:10, sort:"count desc"},
    codes:{type:terms, field:status, limit:5}
  }
rows=0
```

2. **T1059_PowerShell/WMI_실행 급증**

```yaml
key: hunt.t1059.ps_wmi_burst
params:
  - {name: window, type: duration, default: "NOW-24HOURS TO NOW"}
template: |
  q=Image:(*\\powershell.exe *\\wmic.exe) OR CommandLine:*EncodedCommand*
  fq=tenant_id:{TENANT} AND ts:[${window}]
  rows=200&sort=ts desc
```

3. **T1071_Web_C2_의심_도메인**

```yaml
key: hunt.t1071.web_c2_suspicious_tld
params:
  - {name: tlds, type: list, default: ["top","xyz","club","live","work"]}
  - {name: window, type: duration, default: "NOW-6HOURS TO NOW"}
template: |
  q=dst_host_tld:(${tlds})
  fq=tenant_id:{TENANT} AND ts:[${window}]
  json.facet={ ip:{type:terms, field:src_ip_trunc, limit:10}, host:{type:terms, field:dst_host, limit:10} }
  rows=0
```

.  

### D. 폐루프(Closed Loop) 절차

1. **헌팅 실행**: 템플릿 선택→파라미터 입력→결과 검토(상위 파셋/샘플 10건)
2. **증거화**: *“EPKG-Lite 생성”* 클릭→원로그 해시/샘플/쿼리/스크린샷 자동 묶음
3. **검증(DBV360)**: `detect:adjudicate` 호출→`verdict + confidence` 획득
4. **조치**: 티켓/알림 생성, **룰/모델 델타 초안** 자동 생성(`channel=alpha`, `dry_run=true`)
5. **회귀 확인**: 저장 쿼리로 **전/후 비교**(히트율·FP율), 문제 시 플래그/룰 되돌리기

### E. 품질·SLO

* **Turnaround**: 헌팅 시작→조치 제안 **≤ 60분** / DBV360 검증 **≤ 20분**
* **정확도 지표**: 헌팅 제안과 인간 판정 일치율 **≥ 85%**, FP 라벨 비율 **≤ 3%**
* **재현성**: 헌팅 결과는 **쿼리 키 + 파라미터**로 저장, 누구나 동일 증거 재생 가능

### F. 가드레일·보안

* **주권 준수**: 교차 리전 쿼리 금지(게이트웨이가 `tenant_id/region` 강제 주입)
* **DLP**: 내보내기는 EPKG 링크(서명 URL 10분), 원본 로그 직접 첨부 금지
* **성능 예산**: 상위 5 템플릿 p95 **≤ 800ms**, 페이징/샘플링 사용

### G. 운영 체크리스트

* [ ] 각 전술별 **최소 2개** 템플릿 확보(ko/ja/en 라벨)
* [ ] 헌팅 실행 후 **EPKG-Lite** 첨부 없는 티켓 금지
* [ ] DBV360 `false_positive` 라벨은 **룰 델타**와 연결하여 7일 내 반영
* [ ] 월 1회 템플릿 성능/정확도 리뷰(캐시·qf 재가중치 점검)

---

4. **예시 설명 (T1190 의심 트래픽 — 48분 폐루프 완료)**

1) `hunt.t1190.param_spike`를 `host=shop.example.com`, `window=NOW-1H TO NOW`로 실행 → `param_sig="union_select"` 급증과 `status 406/200` 혼재 포착.
2) **EPKG-Lite** 생성 후 **DBV360 재판정**: `verdict=review`, `confidence=0.71`, TI 점수 낮음.
3) 룰 델타 초안: “한국어 검색어 포함 시 화이트리스트” 추가(`alpha + dry_run`).
4) 회귀 쿼리로 전/후 비교: FP 의심 1.6% → **0.3%**로 감소, 정탐률 변화 −0.4%p(허용).
5) 티켓에 증거/리포트 첨부, 델타는 KR-stg **canary 5→25→100%** 승격.
   → 결과: **템플릿화된 헌팅 + DBV360 + 룰 델타**가 연결되어 **1시간 내** 근거 기반 개선을 반복 실행.
