# 필상 시스템 — Day 49 엔드포인트 격리(Containment) · 라이브 리스폰스(Windows/Linux) · SOAR 오케스트레이션

1. **날짜**

* 2024-10-18

2. **목표**

* **EDR+SOAR** 기반으로 엔드포인트 **신속 격리(네트워크/프로세스/계정)** 및 **라이브 포렌식** 절차 표준화
* **T1/T2 사건**에서 **30분 내 1차 차단**, **60분 내 최소 증거 확보(EPKG-Lite)** 달성

---

3. **내용**

### A. 격리 정책(수준·전이)

* **L0: 관찰(Observe)** — 프로세스 트레이싱/오딧만 활성, 사용자 영향 無
* **L1: 부분 격리(Partial)** — 아웃바운드 제한(허용: 콘솔/업데이트/KMS), C2/TI 블록, 로컬 로그인 유지
* **L2: 전체 격리(Full)** — 네트워크 단절(mTLS만 허용), 관리자만 콘솔/Bastion 접속
* **전이 규칙**: `T0/T1` 즉시 L2 → 라이브 수집 후 **L1 완화** or **리이미징** 결정

### B. 라이브 리스폰스 수집(표준 셋)

* **시스템 상태**: 프로세스/핸들/네트워크 연결, 서비스/드라이버, 스케줄러/크론, 시작 프로그램
* **메모리/디스크**: 휘발성 메모리 스냅샷(가능 시)·핵심 아티팩트(MFT/Prefetch/Amcache·bash_history)
* **실행흔적**: Sysmon 최신 24h, PowerShell ScriptBlock(4104), WMI Event, auth 로그
* **네트워크**: ARP/라우팅/소켓, DNS 캐시, 최근 프록시 설정
* **무결성**: 전 수집물 **sha256** + **EPKG-Lite**(manifest/해시/요약 HTML) 자동 생성

### C. Windows/Linus 절차(요약 커맨드)

**Windows (관리자/EDR LR 모듈)**

* 격리: `plura-edr.exe isolate --mode {partial|full}`
* 수집: `plura-lr.exe collect --profile win-core --out \\edge-gw\share\EPKG`
* 메모리: `plura-lr.exe memdump --driver <auto> --out …` (가능 시)
* 해제: `plura-edr.exe deiso --ticket <INCID>`

**Linux (root/EDR LR 에이전트)**

* 격리: `plura-edr isolate --mode partial --allow "s3,kms,console"`
* 수집: `plura-lr collect --profile lin-core --out /mnt/epkg`
* 메모리: `plura-lr memdump --tech avml|lime --out …` (커널 지원 시)
* 해제: `plura-edr deiso --ticket <INCID>`

> 모든 결과물은 **리전 로컬 S3/MinIO(WORM+KMS)** 저장, 콘솔에는 **서명 URL(10분)** 링크만 노출.

### D. SOAR 오케스트레이션(플로우)

1. **트리거**: `incident.severity ∈ {high,crit}` or DBV360 `verdict=block`
2. **평가**: 자산 중요도/업무시간/원격근무 여부 → 격리 수준 결정(L1/L2)
3. **실행**: EDR 격리 → LR 프로파일 수집 → EPKG-Lite 업로드
4. **완화**: 임시 FW 룰(C2/TI), 스케줄러/서비스 비활성, 의심 계정 **잠금/JIT 만료**
5. **검증**: 합성 트랜잭션(핵심 서비스 영향 없음) + DLQ=0 확인
6. **결정**: 클린 & 복귀(L0/L1) / 리이미징 / 포맷 후 재배포

### E. API/자동화(발췌)

* `POST /v1/edr/isolate { host_id, mode, reason, incident_id }`
* `POST /v1/lr/collect { host_id, profile, evidence_level }`
* `POST /v1/firewall/temporary_block { ioc[], ttl }`
* `POST /v1/account/disable { user, ttl, reason }`
* `GET  /v1/evidence/{incident_id}` — EPKG 목록/서명 해시/CoC
* `POST /v1/edr/deisolate { host_id, ticket }` — 해제(2인 승인 옵션)

### F. SLO·KPI

* **격리 리드타임**: 트리거→L1 **≤ 10분**, 트리거→L2 **≤ 15분**
* **수집 시간**: LR 프로파일(코어) **≤ 30분**, 메모리 덤프 **≤ 45분**(가능 시)
* **재감염률**: 30일 내 동일 호스트 **< 2%**
* **지표**: `isolation_time`, `lr_success_rate`, `epkg_time_p95`, `reimage_rate`, `business_impact_events`

### G. 가드레일·안전

* **업무임팩트 최소화**: L1 우선, 서버 역할(DB/검색/메시지)은 **세그먼트 단절**+허용목록 통신만
* **데이터 주권**: EPKG 원본은 **리전 내** 보관, 외부 공유는 금지(서명 URL만)
* **프라이버시**: 사용자 디렉터리 수집은 **목적·범위·만료**를 CoC에 명시, 무차별 수집 금지
* **릴리즈/복귀**: 해제 전 **소거검사(IOC/서비스 무결성)**와 **패치/크리덴셜 리셋** 필수

### H. 운영 체크리스트

* [ ] 격리 수준(L0/L1/L2)·전이 조건 문서화, 온콜 단축키 등록
* [ ] LR 프로파일(Win/Lin) 정기 점검: 수집 항목·용량·시간 예산
* [ ] 임시 FW 룰/계정 잠금 **자동 만료**(TTL) 검증
* [ ] 리이미징/재배포 플레이북 최신화(드라이버/에이전트 프리시드 포함)
* [ ] EPKG-CoC 루트 해시 **일 1회 고정**, 감사 인덱스 점검

---

4. **예시 설명 (KR 리전 T1 — 워크스테이션 L2 격리·EPKG 28분 완결)**

1) `INC-01J…`(WAF 941100 차단 후 내부 PS 인젝션 의심) 트리거 → **L2 격리** 자동 실행(2분).
2) SOAR가 `win-core` LR 수집 시작 → 프로세스/네트워크/ScriptBlock/Prefetch 확보(18분).
3) EPKG-Lite 업로드·서명(8분) → DBV360 재판정 `verdict=block(0.87)` + TI 교차검증.
4) 임시 FW 룰(C2 도메인 3개 차단)·의심 사용자 비밀번호/토큰 **즉시 리셋**.
5) 업무 중단 영향 없음(세그먼트 허용목록 유지). 60분 내 리이미징 결정·재배포 예약.
   → 결과: **자동 격리 + 표준 LR + EPKG** 덕분에 **30분 내 차단**, **60분 내 증거 확보**를 달성하고, 서비스 영향 없이 안전하게 복구 경로로 전환.
