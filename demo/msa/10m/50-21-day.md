# 필상 시스템 — Day 50 MLOps(탐지 모델) 라이프사이클 · 데이터셋/라벨링 · 드리프트/롤아웃

1. **날짜**

* 2024-10-21

2. **목표**

* **탐지 모델(실시간 경량/배치 고정밀)**의 **데이터→학습→검증→배포→모니터링** 전 주기 표준화
* **FP/미탐 라벨( DBV360 )**을 활용한 **폐루프 학습** 확립, **안전 롤아웃(Shadow→Canary)**로 품질/리스크 동시 관리

---

3. **내용**

### A. 아키텍처(개요)

* **Feature Store**: 단기 윈도우 통계(1m/5m/1h) + 컨텍스트 특징량(`req_rate`, `status_mix`, `payload_entropy`, `ti_score`)
* **Label Ingest**: DBV360 라벨(`true_positive/false_positive/missed`) + 티켓 레이블 동기화
* **Model Types**:

  * `online-light`(경량 트리/로지스틱, 지연予算≤5ms)
  * `batch-heavy`(XGBoost/LightGBM, 재평가·리랭킹용)

### B. 데이터셋 규격

* **샘플 단위**: 사건 키 혹은 요청 단위(`incident_key`, `src_ip_trunc`, `uri_sig`, 시간창 특징)
* **분할**: 시계열 분할(훈련:검증:테스트 = 70:15:15), **리전별 층화**(KR/JP)
* **라벨 품질**: 최근 90일 라벨에 한해 사용, **불일치/중복 라벨**은 보류 큐로 이동
* **PII 최소화**: 원본 문자열 대신 시그니처/해시(예: `param_sig`, `ip_bucket`)

### C. 학습/특징 엔지니어링

* **정규화**: 로그 스케일링, 빈도 기반 스무딩
* **피처 세트**:

  * 행위: `req_rate(ip,1m/5m)`, `err_ratio(ip,5m)`, `status_mix`, `uri_depth`, `method_mix`
  * 콘텐츠: `payload_len`, `entropy`, `susp_char_rate`, `keyword_tf(sig)`
  * TI/컨텍스트: `ti_score`, `asn_country_mismatch`, `block_history(ip,24h)`
* **피처 중요도**: SHAP 상위 Top-K를 **근거(Explain)** 카드로 노출

### D. 평가 지표(필수)

* **정확도**: PR-AUC, ROC-AUC, F1(positive=공격)
* **운영지표**: **FP율 ≤ 2%**, **Missed 회귀 실패 ≤ 1%**, **온라인 지연 p95 ≤ 5ms**
* **비용지표**: 특징 계산 CPU/메모리 오버헤드, Solr 쿼리 증가율

### E. 드리프트/건강 모니터링

* **입력 분포**: KS-Test/PSI(월/주기), **피처 누락/스파스** 비율
* **출력 안정성**: 스코어 드리프트, 임계 부근 샘플 비중(0.45–0.55)
* **경보 조건**: PSI > 0.25 또는 FP율 2%↑/Missed 회귀 실패 발생 → **학습 파이프라인 자동 트리거**

### F. 모델 레지스트리 & 거버넌스

* **Registry**: `model:{name}:{semver}+build` (메타: 데이터 범위/특징 버전/지표/SHAP 스냅샷)
* **승인 플로우**: 연구→후보(cand)→승인(approved)→프로덕션(prod)
* **감사/재현**: 학습 스크립트/난수 시드/데이터 스냅샷 해시를 **해시체인**으로 고정

### G. 배포 전략(안전 롤아웃)

* **Shadow**: 실트래픽 복제, **결정 비반영**, 지표/드리프트만 수집(7일)
* **Canary**: 5%→25%→100% (KR→JP 순), **SLO 게이트 연동**(지연/FP/Missed)
* **Kill-Switch**: `detect.model.enable=false` 또는 이전 `prod`로 즉시 롤백(5분 내)

### H. 자동화 파이프라인(예)

1. 매일 01:00 KST **데이터 스냅샷/라벨 조인** → 특징 생성
2. **훈련/튜닝**(하이퍼파라미터 그리드/베이지안) → PR-AUC Top-1 후보 등록
3. **회귀 재생(7/30/90일)** → FP/Missed 기준 통과 시 `candidate→approved`
4. **Shadow 7일** → 드리프트 OK & SLO OK → **Canary** → **Prod** 태그
5. **릴리스 노트** 자동 생성(지표/주요 피처/되돌리기 키)

### I. API/도구

* `POST /v1/ml/train { dataset_id, feature_ver }` — 학습/튜닝 실행
* `GET /v1/ml/models?stage=candidate|approved|prod` — 레지스트리 조회
* `POST /v1/ml/deploy { model_id, strategy: "shadow|canary" }`
* `GET /v1/ml/metrics?model_id=…` — FP/Missed/드리프트/SLO
* 노트북 템플릿: `ml/notebooks/edr_waf_hybrid.ipynb`(EDA/SHAP/회귀)

### J. 운영 체크리스트

* [ ] 라벨 신뢰도 90일 이내/중복 제거 완료
* [ ] PR-AUC 개선 ≥ +2%p 또는 FP율 감소 ≥ 0.5%p (둘 중 하나 충족)
* [ ] Shadow 7일·Canary SLO 통과, **지연 p95 ≤ 5ms**
* [ ] 릴리스 노트/SHAP Top-K/되돌리기 키 포함
* [ ] 월 1회 **모델/피처 버전 정리**(EoL 지정)

---

4. **예시 설명 (모델 v2 → v3 교체 — FP 1.2%p↓, 지연 3.9ms 유지)**

1) v3 후보(Feature ver `f_2024.09`) PR-AUC +3.1%p, Missed 회귀 실패 0.4% → **approved**.
2) **Shadow 7일**: PSI 0.12, FP 추정 1.6% → 기준 충족.
3) **KR-prod Canary 5→25→100%**: 온라인 지연 p95 **3.9ms**, FP **1.9% → 0.7%**, Missed 불변.
4) JP 동일 승격 후 **Prod 태그 전환**, 릴리스 노트와 SHAP Top-10 피처/되돌리기 키 배포.
   → 결과: **DBV360 라벨 기반 폐루프 + 안전 롤아웃**으로 탐지 품질을 향상시키면서 **성능·안정성·주권**을 모두 충족.
