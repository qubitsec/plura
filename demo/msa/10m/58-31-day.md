# 필상 시스템 — Day 58 제로트러스트 네트워킹(ZTNA) · 서비스 아이덴티티(SPIFFE/SPIRE) · mTLS/권한정책

1. **날짜**

* 2024-10-31

2. **목표**

* 전 서비스 간 통신을 **서비스 아이덴티티 기반(mTLS)** 으로 일원화하고, **정책(OPA/Gatekeeper)** 로 권한을 강제
* **자동 발급·회전(≤24h)**, **권한 최소화(ABAC)**, **가시성/감사 100%** 달성

---

3. **내용**

### A. 아키텍처 개요

* **ID Plane**: SPIRE(Server + Agents) → **SPIFFE ID** 발급(`spiffe://pil.svc/<region>/<ns>/<svc>`)
* **Data Plane**: Envoy/Nginx 측차(사이드카) 또는 노드 프록시 → **mTLS** 종료·정책 질의
* **Policy Plane**: OPA( Rego ) + Gatekeeper(Admission) → 허용 도메인/스코프/레이트리밋

### B. 서비스 아이덴티티(SPIFFE)

* 네임스페이스/라벨 기반 ID 템플릿

  ```
  spiffe://pil.svc/${region}/${namespace}/${service}?ver=${release_id}
  ```
* **SVID**(X.509/JWT) 동시 제공:

  * **X.509**: mTLS 핸드셰이크(수명 기본 **24h**),
  * **JWT-SVID**: 비동기 서명 검증(웹훅/서버리스)용.

### C. 발급·회전(자동화)

* **등록(Entry)**: IaC(Helm/Kustomize)로 `spiffeID ↔ k8s ServiceAccount` 매핑
* **에이전트**: 노드당 SPIRE Agent가 워크로드 신뢰성 검증(UID/SA/PodSelector)
* **회전 주기**: X.509 24h, JWT 1h. **시계 드리프트 감시** 및 **사전 갱신(80%)**
* **중단 없는 교체**: Envoy SDS(Secret Discovery Service)로 라이브 업데이트

### D. 트러스트 도메인 & 리전 격리

* **리전별 트러스트 도메인**: `pil.kr`, `pil.jp`(교차 신뢰 금지)
* **경계 정책**: `spiffe://pil.kr/*` ↔ `spiffe://pil.jp/*` 통신 **deny** (주권 준수)
* **프록시 예외**: 상태페이지/모니터링 등 공용 출구는 서명된 **Egress 정책**으로 화이트리스트

### E. 권한(ABAC) 정책(예시 Rego)

```rego
package mesh.authz

default allow = false

allow {
  input.src.spiffe.trust_domain == input.dst.spiffe.trust_domain
  input.src.ns == input.dst.ns
  input.src.labels["team"] == input.dst.labels["team"]
  input.request.method == "POST"
  input.request.path == "/v1/incidents"
}
deny[msg] {
  not allow
  msg := sprintf("deny %v -> %v %v %v",
    [input.src.spiffe, input.dst.spiffe, input.request.method, input.request.path])
}
```

* **속성(ABAC)**: `region/ns/team/role/scope` + **시간창/변경창** 조건(배포 중 제한)

### F. 부하/레이트리밋 & DDoS 가드

* Envoy RateLimitService: **토큰/테넌트/스코프별** 버스트/지속 제한(공격 시 자동 하향)
* **Circuit Breaker**: 업스트림 오류율/지연 임계 초과 시 **trip** → 카나리 강등/롤백 훅

### G. 가시성·감사·지표

* **OTel**: `mtls_handshake_time`, `authz_decision_latency`, `policy_deny_rate`
* **감사 이벤트**: `mesh.authz.decision`(src/dst spiffe, policy_id, allow/deny, trace_id, ts, prev_hash)
* **SLO**: mTLS 핸드셰이크 p95 **≤ 15ms**, 정책 평가 p95 **≤ 5ms**, **false_deny_rate < 0.1%**

### H. 운영/런북

* **온보딩**: 서비스 템플릿에 SA/Entry/Envoy 사이드카 자동 주입, `readiness`에 SDS 준비 상태 포함
* **장애 대응**: CA 교체 시 **Trust Bundle** 이중화(구/신 동시 유효 48h) → 점진 전환
* **회복 절차**: Agent 불안정 시 노드 격리→재기동, SDS 타임아웃 시 폴백 연결 **차단(보수적)**

### I. IaC/검증 게이트

* Gatekeeper Constraint:

  * `require_spiffe_id: true` (Sidecar 없는 Pod **deny**)
  * `egress_whitelist_only: true`
  * `svid_ttl_max_hours: 24`
* CI **정책 테스트**: 샘플 트래픽/경로에 대해 `opa test` + 합성 핸드셰이크 벤치

### J. API/구성(발췌)

* `GET /v1/mesh/cert/status` — SVID 유효기간/회전 상태
* `POST /v1/mesh/policy/validate` — Rego 정적 검증(케이스 포함)
* `GET /v1/mesh/audit?since=…` — 최근 allow/deny 결정 스트림
* `POST /v1/mesh/trustbundle:roll` — CA 번들 교체(이중화 윈도우 설정)

---

4. **예시 설명 (KR 리전 CA 교체 — 무중단 42분)**

1) 만료 7일 전 **새 CA 번들** 배포(`pil.kr v2`), SPIRE가 **이중 신뢰** 구성(구/신 48h 공존).
2) Envoy SDS가 새 SVID 롤링(80% 갱신 후) → 정책 평가 p95 **4.2ms**, 핸드셰이크 p95 **12ms** 유지.
3) 40분 경과 후 잔여 20% 갱신 확인 → 구 번들 폐기, 감사 로그에 **trustbundle:roll** 타임라인 고정.
4) 교체 중 교차 리전 호출(`pil.jp`) **deny** 정상 작동, 서비스 오류율 변화 없음.
   → 결과: **SPIFFE/SPIRE+mTLS+OPA**로 **제로트러스트**가 실현되고, **자동 회전·정책 가드**로 보안·가용성을 동시에 확보.
