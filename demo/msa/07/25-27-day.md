## 27일차 – 쿠버네티스 스토리지

**날짜: 7월 24일**

---

## 주제

# **27. 볼륨·스토리지(PV / PVC)**

> “컨테이너는 무상태지만, **서비스는 그렇지 않다**”

---

## 1️⃣ 왜 스토리지가 문제인가

쿠버네티스의 기본 전제는 이렇습니다.

* Pod는 언제든지 죽는다
* Pod는 다시 만들어진다
* Pod의 로컬 파일은 **사라진다**

그런데 현실의 서비스는 다음을 요구합니다.

* DB 데이터 유지
* 업로드 파일 유지
* 로그/캐시 유지

그래서 **스토리지는 쿠버네티스에서 가장 조심해야 할 영역**입니다.

---

## 2️⃣ 로컬 스토리지의 한계 (왜 쓰면 안 되나)

Pod 내부 파일 시스템은 다음과 같은 특성을 가집니다.

* Pod 삭제 시 데이터 소멸
* 다른 노드로 이동하면 접근 불가
* 장애 복구 불가

결론

> **Pod 로컬 저장 = 테스트용**
> **운영 데이터 저장 = 금지**

---

## 3️⃣ 쿠버네티스 스토리지의 기본 개념

쿠버네티스는 스토리지를 **두 단계로 분리**합니다.

### PV (PersistentVolume)

* 클러스터 차원의 **실제 스토리지 자원**
* 관리자/인프라 영역
* NFS, iSCSI, 클라우드 디스크 등

---

### PVC (PersistentVolumeClaim)

* 애플리케이션이 요청하는 **스토리지 요청서**
* 개발자/서비스 영역
* “얼마나, 어떤 성능이 필요하다”

---

**Pod는 PV를 직접 보지 않는다**
**PVC만 요청한다**

---

## 4️⃣ PV–PVC–Pod 관계 한눈에 보기

```
[ Pod ]
   ↓
[ PVC ]  ← 요청 (용량/모드)
   ↓
[ PV ]   ← 실제 스토리지
```

* Pod ↔ PVC: 느슨한 결합
* PVC ↔ PV: 조건 매칭

---

## 5️⃣ 왜 이렇게 나누었는가 (핵심 이유)

이 구조 덕분에:

* 애플리케이션은 스토리지 구현을 몰라도 됨
* 스토리지 교체/확장 가능
* 인프라와 애플리케이션 책임 분리

> **스토리지는 인프라 문제,
> 스토리지 사용은 애플리케이션 문제**

---

## 6️⃣ 접근 모드(Access Mode) 이해하기

스토리지는 **어떻게 붙일 수 있는지**가 중요합니다.

### 주요 모드

* **ReadWriteOnce (RWO)**
  → 하나의 노드에서만 쓰기 가능
  → DB에 주로 사용

* **ReadOnlyMany (ROX)**
  → 여러 노드에서 읽기만

* **ReadWriteMany (RWX)**
  → 여러 노드에서 읽기/쓰기
  → 공유 파일, 업로드 영역

모든 스토리지가 RWX를 지원하지는 않음

---

## 7️⃣ StorageClass: 자동화의 핵심

**StorageClass**는
“이런 종류의 스토리지를 만들어라”는 템플릿입니다.

* 성능(SSD/HDD)
* 백업 정책
* 동적 프로비저닝 여부

PVC가 생성되면:

* StorageClass 기준으로
* PV를 **자동 생성**

**수동 PV 관리 지옥 탈출**

---

## 8️⃣ Stateful 서비스의 현실

### 어떤 서비스가 상태를 가지는가

* 데이터베이스
* 메시지 브로커
* 검색 엔진
* 파일 저장 서비스

이들은 보통:

* **Deployment**
* **StatefulSet**

StatefulSet은

* 고정된 이름
* 고정된 스토리지
* 순차적 생성/삭제

을 보장합니다.

---

## 9️⃣ 흔한 실패 패턴

### Pod 로컬에 데이터 저장

→ 재시작 시 데이터 유실

### RWX 안 되는 스토리지에 다중 Pod

→ 데이터 충돌/마운트 실패

### 스토리지 성능 고려 안 함

→ 서비스 전체 성능 저하

---

## 1️⃣0️⃣ 운영 관점의 스토리지 원칙

### ✅ 핵심 원칙 5가지

1. 상태 데이터는 반드시 PV/PVC 사용
2. 접근 모드를 정확히 이해
3. StorageClass로 표준화
4. Stateful 서비스는 StatefulSet
5. 백업/복구 시나리오 사전 검증

---

## 1️⃣1️⃣ 결론: 스토리지는 ‘설계 영역’이다

* 스토리지는 붙이면 끝
* 장애/확장/백업까지 고려

> **쿠버네티스에서
> 스토리지를 잘못 설계하면
> 모든 자동화가 무력해진다**

---

## ✅ 오늘의 핵심 요약

* Pod 로컬 스토리지는 운영에서 사용하지 않는다.
* PV는 실제 스토리지, PVC는 요청서다.
* Pod는 PVC만 알고, PV는 모른다.
* StorageClass로 스토리지 자동화를 한다.
* 상태 서비스는 StatefulSet을 고려한다.

---
