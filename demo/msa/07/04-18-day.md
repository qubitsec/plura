## 18일차 – 컨테이너 입문

**날짜: 7월 4일**

---

## 주제

# **18. Dockerfile 기초**

### 빌드 · 레이어 · 캐시

> “Dockerfile은 배포 품질을 결정하는 설계도다”

---

## 1️⃣ Dockerfile이 왜 중요한가

컨테이너 운영의 품질은 **이미지 품질**에서 갈립니다.
그리고 이미지 품질은 거의 전부 **Dockerfile**에서 결정됩니다.

* 빌드가 느리다
* 이미지가 크다
* 보안 취약점이 많다
* 캐시가 안 먹는다

대부분 **Dockerfile 설계 문제**입니다.

---

## 2️⃣ Dockerfile이란 무엇인가

**Dockerfile**은 이미지를 만드는 **선언적 스크립트**입니다.

* 어떤 베이스 이미지에서 시작할지
* 어떤 파일을 넣을지
* 어떤 명령으로 빌드/실행할지

를 **순서대로 선언**합니다.

---
  
  .  
## 3️⃣ Dockerfile의 기본 구조

아주 단순한 예시 흐름입니다.

```
FROM base-image
WORKDIR /app
COPY . .
RUN build-command
CMD run-command
```

각 줄은 **이미지의 한 레이어**를 만듭니다.

---

## 4️⃣ 레이어(Layer) 개념이 핵심이다

Docker 이미지는 **레이어의 스택**입니다.

* 한 줄 = 한 레이어
* 앞 레이어가 바뀌면
  → 뒤 레이어는 **전부 다시 빌드**

이게 **캐시 성능**을 좌우합니다.

---

## 5️⃣ 캐시(Cache)가 먹히는 구조

Docker는 이렇게 캐시를 씁니다.

* 이전 빌드와 **명령 + 입력이 같으면**
* 해당 레이어를 재사용

### 나쁜 예

```
COPY . .
RUN npm install
```

* 코드 한 줄 바뀌면
* 의존성 설치를 다시 함

---
  
  .  
### ✅ 좋은 예

```
COPY package.json package-lock.json ./
RUN npm install
COPY . .
```

* 의존성은 자주 안 바뀜
* 캐시가 잘 유지됨

---

## 6️⃣ Dockerfile 설계 기본 원칙 6가지

### ✅ 1) 변경 적은 것부터 위로

* OS, 런타임, 라이브러리
* 자주 바뀌는 코드는 아래로

---

### ✅ 2) 레이어 수는 “적절히”

* 무조건 줄이는 게 목표
* 캐시 효율과 가독성의 균형

---

### ✅ 3) 멀티 스테이지 빌드 활용

* 빌드용 이미지 ≠ 실행용 이미지
* 최종 이미지를 작게 유지

---

### ✅ 4) 실행 권한은 최소화

* root 실행 피하기
* 가능하면 non-root 사용자

---

### ✅ 5) 이미지 크기 최소화

* 불필요한 빌드 도구 제거
* 실행에 필요한 것만 남기기

---

### ✅ 6) 환경 변수로 설정 분리
  
  .  
* 설정을 이미지에 박지 말 것
* 환경별 설정은 외부에서 주입

---

## 7️⃣ 멀티 스테이지 빌드 개념

```
FROM build-image AS builder
RUN build

FROM runtime-image
COPY --from=builder /output /app
CMD run
```

### 효과

* 빌드 도구 제거
* 이미지 크기 대폭 감소
* 보안 노출 최소화

**운영 이미지에는 실행에 필요한 것만**

---

## 8️⃣ 흔한 실수 TOP 5

### 모든 걸 한 RUN에 몰기

* 가독성 저하
* 디버깅 어려움

### 최신(latest) 베이스 이미지 고정

* 재현 불가
* 예기치 않은 변경 위험

### secrets를 이미지에 포함

* 토큰/키 유출 위험

### 빌드 캐시를 고려하지 않음

* CI/CD 느려짐
  
  .  
### 컨테이너 안에서 설정 수정

* 재배포 시 모두 사라짐

---

## 9️⃣ 결론: Dockerfile은 ‘운영 문서’다

Dockerfile은 개발자만 보는 파일이 아닙니다.

* 운영 안정성
* 배포 속도
* 보안 수준
* 장애 대응력

을 모두 좌우합니다.

> **Dockerfile은
> “이미지 생성 스크립트”가 아니라
> “운영 품질 설계서”다**

---

## ✅ 오늘의 핵심 요약

* Dockerfile 한 줄 = 이미지 한 레이어다.
* 레이어 구조가 캐시 성능을 결정한다.
* 변경 적은 것부터 위에 둔다.
* 멀티 스테이지 빌드는 사실상 필수다.
* 운영 이미지는 작고 단순해야 한다.

---
