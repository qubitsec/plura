## 19일차 – 컨테이너 운영 기초

**날짜: 7월 5일**

---

## 주제

# **19. 환경변수·설정 관리 (12-Factor App 관점)**

> “설정은 코드가 아니라 **환경**이다”

---

## 1️⃣ 왜 설정 관리가 MSA에서 치명적인가

서비스 수가 늘어날수록 가장 먼저 무너지는 것이 **설정 관리**입니다.

* 환경별(dev/stage/prod) 설정이 코드에 섞임
* 이미지마다 다른 설정을 굽기(bake)
* 비밀정보가 소스/이미지에 포함
* 배포 때마다 재빌드

결과: **재현 불가·보안 위험·배포 공포**

---

## 2️⃣ 12-Factor App의 핵심 원칙(설정)

12-Factor App은 설정에 대해 단 한 가지를 강하게 요구합니다.

> **Config을 코드에서 완전히 분리하라**

### 의미

* 설정은 **환경변수(Environment Variables)** 로 주입
* 코드/이미지는 **환경에 독립적**
* 같은 이미지로 dev/stage/prod 실행 가능

---

## 3️⃣ 설정을 코드/이미지에 넣으면 생기는 문제

### 이미지마다 설정이 다름

* 환경 바뀔 때마다 재빌드 필요
* 롤백 어려움

### 비밀정보 유출

* 토큰/비밀번호가 이미지에 남음
* 레지스트리 유출 시 치명적

### 운영 추적 불가

* “지금 어떤 설정으로 돌고 있는지” 모름

---

## 4️⃣ 권장 패턴: 설정의 3분류

설정을 다음 3가지로 나눠 다룹니다.

### ① 일반 설정 (Config)

* 기능 플래그
* 외부 API 주소
* 타임아웃 값

→ **환경변수 / ConfigMap**

---

### ② 민감 정보 (Secret)

* DB 비밀번호
* API 키
* 토큰

→ **Secret 저장소(암호화)**
→ 코드/이미지 금지

---

### ③ 실행 파라미터 (Runtime)

* 스레드 수
* 메모리 옵션
* 로그 레벨

→ **환경변수 / 런타임 옵션**

---

## 5️⃣ 컨테이너에서의 설정 주입 방식

### ✅ 환경변수 주입

* 가장 단순하고 표준적인 방식
* 12-Factor App의 기본

```
ENV DB_HOST=...
ENV LOG_LEVEL=info
```

또는 실행 시 주입

```
docker run -e DB_HOST=...
```

---

### ✅ 파일 기반 설정(보조)

* 인증서
* 대용량 설정
* 라이브 리로드 필요 시

단, 파일도 **외부에서 주입**해야 함
(이미지에 포함)

---

## 6️⃣ 쿠버네티스 관점의 설정 관리 맛보기

(아직 깊게 들어가지는 않습니다)

### ConfigMap

* 일반 설정 저장
* 환경변수/파일로 주입

### Secret

* 민감 정보 저장
* 기본적으로 base64 + 접근 제어
* 외부 Vault 연계 가능

**이미지는 동일, 설정만 바뀜**

---

## 7️⃣ 환경별 설정 전략(현실적인 기준)

### 권장 전략

* 이미지: **완전히 동일**
* 설정: 환경별로 분리

```
prod:
  DB_HOST=prod-db
stage:
  DB_HOST=stage-db
```

“환경별 브랜치/이미지”는 피할수록 좋음

---

## 8️⃣ 흔한 실패 패턴

### 설정을 Dockerfile에 박아두기

→ 재빌드 지옥

### .env 파일을 이미지에 COPY

→ 유출 위험

### 서비스마다 설정 방식 제각각

→ 운영 혼란

---

## 9️⃣ 결론: 설정 분리가 곧 운영 분리다

* 코드 변경 ≠ 설정 변경
* 배포 ≠ 설정 변경
* 이미지 ≠ 환경

> **설정을 분리하면
> 배포가 가벼워지고,
> 운영이 안전해진다**

---

## ✅ 오늘의 핵심 요약

* 설정은 코드/이미지에서 분리한다.
* 환경변수는 MSA의 기본 설정 전달 방식이다.
* 민감 정보는 반드시 별도로 관리한다.
* 같은 이미지를 모든 환경에서 사용해야 한다.
* 설정 관리가 무너지면 MSA 운영도 무너진다.

---
