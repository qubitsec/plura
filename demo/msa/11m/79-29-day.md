# 필상 시스템 — Day 79 텔레메트리 비용·카디널리티 관리(Log/Metric/Trace) · 샘플링·리밸런싱

1. **날짜**

* 2024-11-29

2. **목표**

* **로그/메트릭/트레이스**의 **카디널리티·수집량·보존**을 체계적으로 통제해 **SLO 가시성은 유지**하면서 **TCO 20%↓**
* **샘플링/필드 축약/집계 메트릭화** 표준과 **카디널리티 가드**로 **폭증·스파이크**를 **5분 내 흡수**

---

3. **내용**

### A. 공통 원칙(가드레일)

* **필수만 수집**: 의사결정·RCA에 불필요한 필드/라벨 금지(특히 자유형 텍스트, 요청 ID 중복).
* **카디널리티 예산**: 서비스별 **활성 라벨 조합 ≤ 50k**, 테넌트/리전 라벨은 고정.
* **주권/프라이버시**: 원 IP/원문은 금지, `ip_bucket`·`param_sig`만( Day 57·71 정합).
* **되돌리기 키**: 모든 축약/샘플링에는 즉시 복원 가능한 플래그 제공.

### B. 로그(Log) — 축약·샘플링

* **레벨 정책**: `ERROR` 항상, `WARN` 50% 샘플, `INFO` 템플릿만(키 이벤트).
* **필드 축약**: `ua/ref`·`headers`는 해시/길이·Top-N만 저장, 대용량 페이로드는 **요약치**(길이/해시/MIME).
* **샘플링 스위치**(플래그)

  * `log.sample.ingest=0.7`(혼잡 시), `log.sample.non_key=0.3`
  * 키 이벤트(Incident open/crit, DLQ 적재, Failover)는 **예외(100%)**.
* **보존**: 인덱스 30일, 원본은 Object Storage(압축·WORM) 90일.

### C. 메트릭(Metric) — 집계·라벨 통제

* **RED/USE 핵심만**: `req_total/err_total/latency_ms_{p50,p95}` + 자원(포화도).
* **라벨 정리**: `user_id/request_id` 금지, `tenant_id/region/release_id`만 허용.
* **카디널리티 가드**

  * `label.value.length ≤ 64`, `unique(label_set) 초과 시 drop + warn`
  * **핫 라벨**(예: `dst_host`)는 **Top-K(≤100)**만 유지, 나머지는 `other`.
* **집계 메트릭화**: 반복 로그 패턴은 **Counter/Summary**로 대체(예: WAF 룰 히트율).

### D. 트레이스(Trace) — 비용/가치 샘플링

* **Head 10%**, **오류·핵심 경로 Always-On**( Day 67 ).
* **Tail 샘플링**: 지연 상위 p95/p99, 비용 상위 쿼리만 추가 채집.
* **스팬 축약**: 이벤트 메시지 256자, 속성 Allowlist(PII/대형 배열 차단).
* **보존**: 일반 72h, 핵심/오류 7일.

### E. 자동 제어(Anomaly/Quota 연동)

* **신호**: `log_ingest_rps`, `metric_cardinality`, `trace_span_rate`, `cost_per_tb`.
* **행동**(플래그 자동 전환):

  * 로그 폭주 → `log.sample.ingest↑`, `features_only`(Day 72)
  * 메트릭 폭주 → 문제 라벨 **차단/집계** 전환, Cardinality Guard ON
  * 트레이스 폭주 → Head 10→5%, Tail 조건 강화(지연 임계↑)

### F. 저장소/압축/인덱스

* **로그**: zstd, 필드형 인덱스는 `tenant_id/region/ts/incident_id/rule_id` 우선
* **메트릭**: 장기 보존은 5분/1시간 집계만(원본 7일)
* **트레이스**: Attribute Blocklist·샘플링 룰을 코드로 관리(`trace-sampling.yaml`)

### G. 대시보드·품질 지표

* `telemetry_cost_daily`, `metric_cardinality`, `log_sample_rate`, `trace_sampling_head/tail`,
  `pii_violation=0`, `drop_rate`(허용 1% 미만), `visibility_gap`(핵심 이벤트 누락)
* **목표**: 비용 **−20%**, 핵심 지표/합성 시나리오 가시성 **100%**, FP/미탐 영향 **무시 가능 수준**.

### H. API/자동화(발췌)

* `POST /v1/telemetry/policy/apply { service, log_sample, metric_labels[], trace_rules }`
* `GET  /v1/telemetry/cardinality?service=...` — 라벨 조합 상위/초과 원인
* `POST /v1/telemetry/rollback { policy_id }` — 즉시 복귀
* `GET  /v1/telemetry/cost?range=30d` — 비용/절약액 리포트(FinOps 연동)

### I. 운영 체크리스트

* [ ] 로그 INFO 제거·키 이벤트만 유지, 대용량 필드 요약화
* [ ] 메트릭 라벨 세트 월 1회 정리·Top-K 적용, 과다 라벨 자동 차단
* [ ] 트레이스 Tail 규칙으로 **문제 구간만** 깊게 관찰
* [ ] 자동 제어(Anomaly/Quota)와 **되돌리기 키** 검증
* [ ] 합성 모니터링·SLO 카드에서 **가시성 손실 0%** 확인

---

4. **예시 설명 (KR 검색 라벨 폭증 — 22분 내 교정, 비용 −18%)**

1) 신규 릴리스 후 `metric_cardinality(search.*)` 급증(라벨 `dst_host`에 고유값 18만).
2) 자동 가드: 라벨 Top-K 100 유지 + 나머지 `other`, Cardinality Guard ON → Drop Rate 0.6% 이하.
3) 로그는 `features_only` + `INFO` 필터, 트레이스 Head 10→7%.
4) 22분 내 비용 **−18%**, p95 변동 ≤ +3%, 합성 시나리오/핵심 지표 **가시성 100%** 유지.
   → 결과: **샘플링·축약·카디널리티 가드**로 텔레메트리 비용을 제어하면서 **운영 가시성**과 **탐지 품질**을 보존.
