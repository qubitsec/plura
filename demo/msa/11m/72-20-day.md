# 필상 시스템 — Day 72 쿼터·레이트리밋(Quota/Throttle) 플랫폼: 테넌트·리전 단위 한도 · 버스트 크레딧 · 과금/알림 연동

1. **날짜**

* 2024-11-20

2. **목표**

* 인입(Records)·검색(QPS)·알림(Emails/SMS/Webhooks)·엣지(API) **자원 한도**를 **테넌트/리전** 단위로 일원화
* **버스트 크레딧**·**소프트 스로틀링**·**하드 컷오프** 순의 **안전 완화(Graceful Degradation)**를 표준화하고
  **과금(오버리지)·SLO·알림**과 연동하여 **서비스 안정성↑, 예측 가능 비용** 달성

---

3. **내용**

### A. 아키텍처 개요

```
Requester(콘솔/SDK/Agent/Edge)
   → API Gateway(Nginx/Envoy) ──┐
   → Stream Ingestor(Kafka)     │  →  Quota Service(중앙) ← FinOps( Day 29 )/Billing( Day 22 )
   → Search/Notify/Connector    │      └─ TokenStore(Redis) + UsageCache
                                └─ Policy Engine(OPA): plan/tenant/region rules
```

* **정책 원천**: `quota/{plan}.yaml` + 테넌트 오버레이(`tenant-overrides.yaml`)
* **토큰 저장소**: Redis(지역 로컬), **저지연 토큰 버킷** + **누적량(계량)** 하이브리드

### B. 표준 한도(기본값, 플랜별 상이)

| 리소스         | 키             | 기본 한도(분당/시간/일) | 버스트 크레딧 |        소프트 스로틀 | 하드 컷오프 |
| ----------- | ------------- | -------------- | ------: | -------------: | -----: |
| 인입(Records) | `ingest_rpm`  | 12k/m · 7.2M/h | 최대 10분치 | 429 + 샘플링/필드축약 | 429 지속 |
| 검색(QPS)     | `search_qps`  | 60/s(tenant)   |     2분치 | 429 + 결과 캐시 강제 |    429 |
| 알림(건)       | `notify_rpm`  | 300/m          |     5분치 |     채널 우선순위/집계 |   큐 정지 |
| 웹훅 수신       | `webhook_rps` | 100/s          |     1분치 |   검증 지연+재시도 힌트 |    503 |

> **버스트 크레딧**: 한도 미사용 시 적립, 급증 시 자동 소진. **소프트 스로틀**은 기능 유지형 완화(샘플링/캐시/집계).

### C. 토큰 버킷/누적 계량(하이브리드)

* **즉시 제어**: Envoy/Nginx RateLimitService → **버킷**(burst/steady)
* **장기 계량**: Quota Service가 **분/시간/일** 창 별 사용량 집계(Exactly-once 이벤트 기반)
* **분산 일관성**: 지역 캐시(5s TTL) + 중앙 스냅샷(60s), 오차 범위 내 **보수적 차단** 원칙

### D. 소프트 스로틀링 액션(리소스별)

* **인입**: 샘플링 상승(예: 1.0→0.7), 긴 필드 제거(`ua/ref`), `features_only` 모드
* **검색**: 저장 쿼리만 허용, `rows≤200/ facet.limit≤50` 강제, 결과 캐시 TTL 90s
* **알림**: 합성 배치(요약 1건), Slack/Email 우선, SMS/전화 지연
* **웹훅**: 검증 타임아웃 3s→1s, 실패 백오프 가속(10s→1m→5m→30m)

### E. 플랜·오버레이·승급

* **STD/ENT** 플랜 파일 + 테넌트 오버레이(프로젝트/캠페인 등 일시 상향)
* **승급**: 사용량이 **예상 오버리지 3일 연속**이면 CSM 알림 + **한도 제안/업그레이드 가이드**
* **엔터프라이즈 계약**: SLA/가용성을 조건으로 **전용 샤드**·별도 Rate Pool 부여

### F. OPA 정책(발췌)

```rego
package quota

default allow = true

# 교차 리전 금지 + 리전 풀 분리
deny[msg] {
  input.request.region != input.token.region
  msg := "cross-region not allowed"
}

# 고위험 경로는 상위 한도
adjust[action] {
  input.request.path == "/v1/incidents"
  action := {"soft_throttle": {"limit":"rows<=100", "cache_ttl":"60s"}}
}

# 테넌트 예외(기간/사유)
exception {
  input.tenant in {"TEN_ent_kr01"}
  time.now_ns() < input.policy.exceptions["TEN_ent_kr01"].until
}
```

### G. 관측·경보·리포트

* **지표**: `quota_hit_rate`, `soft_throttle_rate`, `hard_cutoff_events`, `burst_credits_remaining`, `overage_forecast`
* **경보**: `hard_cutoff_events > 0`(5m) 또는 `overage_forecast > +20%` → T1/CSM 티켓
* **리포트**: 테넌트 콘솔 “사용량 & 한도” 카드(일·주·월), 오버리지 예측 곡선( Day 22/29 연동)

### H. 실패/폴백 시나리오

* **Quota Service 장애**: 게이트웨이가 **로컬 보수 한도** 적용(안전값), 이벤트는 큐에 적재 후 동기화
* **캐시 분할 뇌**: 지역 간 차이 감지 시 **더 보수적**인 값 사용
* **오버레이 만료 누락**: 자동 만료 + 롤백, 영향 테넌트 알림

### I. API/CLI(발췌)

* `GET  /v1/quota/limits?tenant=...&region=kr` — 현재 한도/버스트/예외
* `POST /v1/quota/override { tenant, key, new_limit, ttl, reason }` — 임시 상향(승인2인)
* `GET  /v1/quota/usage?tenant=...&window=24h` — 사용량/예측
* `POST /v1/quota/plan/apply { tenant, plan }` — 플랜 변경(과금 연동)
* CLI: `plura quota get|set|override|report`

### J. 운영 체크리스트

* [ ] 게이트웨이/인입/검색/알림 **모든 경로**에 레이트리밋 훅 배치
* [ ] 버스트 크레딧/소프트 스로틀 파라미터 **스테이징 검증** 후 프로덕션 적용
* [ ] 오버레이는 **TTL/사유** 필수, 만료 점검 크론
* [ ] 하드 컷오프 이벤트는 **RCA 48h** 내 작성(사용자 경험 영향 최소화)
* [ ] 콘솔 “한도 초과 가이드”와 **업그레이드 경로** 최신화(i18n)

---

4. **예시 설명 (KR 테넌트 인입 급증 — 무중단 완화 & 예측 연계)**

1) 캠페인 트래픽으로 `ingest_rpm` 초과 → **버스트 크레딧** 자동 소진(7분).
2) 초과 지속 → **소프트 스로틀** 발동(샘플링 0.7, 필드 축약), 429 비율 0.6%로 제한.
3) Quota Service가 **오버리지 +18%/월** 예측 → CSM/고객 알림 + 업그레이드 제안.
4) 2시간 후 캠페인 종료, 한도 복귀·버스트 크레딧 재충전. 서비스 **무중단/데이터 손실 0**.
   → 결과: **버스트→완화→알림→과금** 일관 흐름으로 급증 트래픽에도 **안정성**과 **고객 신뢰**(투명 과금)를 함께 확보.
