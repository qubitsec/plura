# 필상 시스템 — Day 73 사용량/비용 이상 감지(Anomaly) · 자동 완화(Throttle/Cache/Flag) · RCA 리포트

1. **날짜**

* 2024-11-21

2. **목표**

* **실시간 사용량·비용 지표**에서 **이상 징후(Anomaly)**를 탐지하고, **자동 완화 액션**(Throttle/Cache/Flag/Failover)을 표준화
* **과금/쿼터( Day 22 · Day 72 ) / FinOps( Day 29 )**와 연동하여 **과금 폭주·성능 저하**를 **5분 내 제어**, **RCA 자동 리포트 ≤ 2h**

---

3. **내용**

### A. 신호(Features) & 소스

* **사용량**: `ingest_rpm, search_qps, notify_rpm, webhook_rps`
* **비용**: `CIR_p95(Record)·CQS_p95(Query)·CIN_p95(Incident)`, `cost_per_tb_scanned`(Lake)
* **인프라**: `cache_hit_ratio`, `edge/origin p95`, `solr filterCache hit`, `DLQ 증가율`
* **이벤트/변경**: 릴리스/플래그/실험/유지보수창(MW), 테넌트 캠페인 일정(캘린더)

### B. 모델/탐지 로직

* **베이스라인**: 주/요일·시간대별 Holt-Winters(계절성) + EWMA
* **이상치**: `zscore ≥ 4` 또는 `IQR×3` 바깥, **변경 이벤트 코릴레이션**(±30m) 가중
* **분류**: `infra(캐시/오리진) | app(릴리스/플래그) | tenant(캠페인) | abuse(봇/크롤)`
* **임계**: 3분 연속 **고신뢰 이상** 또는 5분 내 **누적 비용 +15%↑** → **Auto-Mitigation**

### C. 자동 완화(Playbooks)

1. **인입 폭주(tenant)**

   * 액션: **버스트 크레딧 소진** → **소프트 스로틀**(샘플링↑, 필드 축약) → 캐시 강제
2. **검색 비용 급증(app/infra)**

   * 액션: 저장 쿼리만 허용, `rows≤200`·`facet.limit≤50`, **TTL 90s**로 상향, Expensive Query 차단
3. **알림 폭주(abuse)**

   * 액션: 동일 사건키 디듀프 확대(15→30m), 채널 우선순위 조정(Slack/Email 우선)
4. **오리진 병목(edge/origin)**

   * 액션: CDN 캐시 키 정규화·Invalidate, **Failover** 전환(읽기 전용), PoW/Captcha 활성화

> 모든 액션은 **되돌리기 키**와 함께 플래그로 적용, 15분 관찰 후 단계적 원복.

### D. 정책/가드레일(OPA)

```rego
package anomaly.mitigation

default allow = false

# 변경 이벤트가 있으면 먼저 릴리스 가드
prefer_release_root_cause {
  input.events.release_within_30m == true
}

# 테넌트 캠페인 화이트리스트는 소프트만 허용
allow_soft_only {
  input.context.tenant in input.policy.campaign_whitelist
  input.mitigation.level == "soft"
}

# 교차 리전/PII 영향 액션 금지
deny[msg] {
  input.action.cross_region == true
  msg := "cross-region mitigation not allowed"
}
allow {
  not deny[_]
  not prefer_release_root_cause
}
```

### E. 파이프라인

```
Metrics/Events → (Feature Builder) → Anomaly Scorer
      ↘ Correlator(릴리스/플래그/MW/캠페인)
          ↘ Mitigation Planner → Flag/Quota/CDN/RateLimit API
                               → RCA Generator(리포트 · EPKG-Lite)
```

* **지연 요구**: 탐지→완화 트리거 p95 **≤ 5분**, 롤백 경로 사전 계산

### F. 지표·SLO

* **탐지 정확도**: Precision ≥ 0.9, Recall ≥ 0.85(고비용 케이스)
* **제어 성능**: 완화 후 10분 내 `CQS_p95` **−20%** 또는 `edge p95` **≤ 300ms** 회복
* **과금 보호**: 예측 오버리지 **≥ +20%** 케이스에서 24h 비용 **≤ −15%**로 교정
* **오탐 완화율**: 릴리스/실험 코릴레이션로 **불필요 자동조치 < 5%**

### G. 대시보드/UX

* **Anomaly 타임라인**: 지표 스파이크·변경 이벤트 배지·적용한 액션/되돌리기 키
* **코스트 카드**: 일/주/월 예측 vs 실측, **완화 전/후 차이**(절감액)
* **원클릭 RCA**: 로그/Trace/릴리스/쿼터·플래그 변동을 묶은 **EPKG-Anomaly** 다운로드

### H. API/자동화(발췌)

* `POST /v1/anomaly/score { signals[], context }` — 점수·원인 후보
* `POST /v1/anomaly/mitigate { key, plan, dry_run? }` — 플래그/쿼터/CDN 조치
* `POST /v1/anomaly/rollback { key }` — 되돌리기
* `GET  /v1/anomaly/report?range=24h` — RCA/절감액/영향 지표
* `POST /v1/anomaly/policy/whitelist { tenant, window }` — 캠페인 화이트리스트

### I. 운영 체크리스트

* [ ] 릴리스/실험/유지보수창 캘린더와 **코릴레이터** 동기화
* [ ] 소프트→하드 순서, 되돌리기 키/플래그 항상 준비
* [ ] 캠페인 테넌트는 **화이트리스트** 등록(과잉 제어 방지)
* [ ] 완화 후 15/60분 리그레션 체크(SLO/비용/경보 노이즈)
* [ ] RCA 리포트 자동 배포(내부/고객용 요약)

---

4. **예시 설명 (KR 검색 비용 스파이크 — 27분 내 안정화, 비용 −19%)**

1) `CQS_p95` 0.0037→**0.0056**(+51%) 스파이크, 릴리스 배지 없음 → **app/infra**로 분류.
2) 자동 완화: 저장 쿼리만 허용, `rows≤200`·`facet.limit≤50`, TTL 90s 상향, Expensive Query 차단.
3) 11분 내 p95 **0.0041**로 하락, 캐시 히트 +14%p. 27분 시점 p95 **0.0036**, 비용 **−19%**.
4) RCA: 특정 템플릿 파라미터 누락으로 캐시 키 폭증 → 패치 배포, 되돌리기 키 해제.
   → 결과: **탐지→완화→RCA** 자동 루프로 **비용·성능** 모두 안정화, 운영 개입은 승인 클릭 한 번으로 축소.
