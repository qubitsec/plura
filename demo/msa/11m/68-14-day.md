# 필상 시스템 — Day 68 메일 알림 보안·전달성 표준: SPF/DKIM/DMARC/BIMI/ARC · 피싱 방지 · 바운스/피드백 루프

1. **날짜**

* 2024-11-14

2. **목표**

* Notifier(메일) 경로에 **전달성(Deliverability)**과 **위·변조 방지**를 내장
* **SPF/DKIM/DMARC/BIMI/ARC** 체계와 **바운스/피드백 루프** 표준으로 **스팸/피싱 0건**, **수신 성공률 ≥ 99.2%** 달성

---

3. **내용**

### A. 발송 도메인·IP 거버넌스

* 도메인 구조: `notify.example.com`(운영), `stg-notify.example.com`(스테이징)
* 전용 발송 IP/풀(리전별 KR/JP 분리), 역/정방향 DNS 일치
* **목적 바인딩**: 알림만 허용(마케팅 분리), 서명 비밀은 **KMS+STS**(Day 52)

### B. 인증·정책 (필수)

* **SPF**: `v=spf1 include:spf.notify.example.com -all` (하드 FAIL)
* **DKIM**: 2048-bit 키, `s=kr01/jp01` 등 리전별 selector, 헤더/본문 canonicalization=`relaxed/relaxed`
* **DMARC**: `v=DMARC1; p=reject; rua=mailto:dmarc-agg@...; ruf=mailto:dmarc-for@...; pct=100; fo=1`
* **BIMI**: 검증된 로고(`SVG+VMC`), DMARC `p=reject` 선행
* **ARC**(중계 환경 대비): 수신측 신뢰 보호—게이트웨이 경유 시 **ARC-Seal/ARC-Message-Signature** 추가

### C. 콘텐츠·링크 보안

* **서명 링크**만(10분 만료, 목적 라벨 포함), 원본 로그/PII 금지(EPKG 링크만)
* 본문 고정 요소: 사건 요약, 근거 지표(대시·TI), “이 메일이 의심스러우면 콘솔에서 확인” 배너
* **표준 From/Reply-To**: `no-reply@notify.example.com` / `support@...`
* **MIME·헤더**: `List-ID`, `Auto-Submitted: auto-generated`, **대량 발송 시** `Precedence: bulk`

### D. 발송 속도·평판 관리

* 테넌트/도메인별 **버스트/지속 레이트**(예: 120/min, 3k/h), 신규 테넌트는 **웜업 곡선**
* **블록리스트 모니터링**: Spamhaus/URIBL/Google Postmaster—히트 시 자동 스로틀+RCA 티켓
* **도메인 평판**: 하드 바운스율 ≤ 0.3%, 스팸 신고율 ≤ 0.02% 목표

### E. 바운스·피드백 루프(Bounce/Feedback Loop)

* **하드 바운스**(550/5.1.x): 주소 즉시 비활성 + 테넌트에 알림
* **소프트 바운스**(4.x/5.2.x): 10m/1h/6h 재시도 후 DLQ → 72h 만료
* **FBL(스팸 신고)**: 주소/테넌트 차단, 콘솔에 신고 사유 요약(최근 5건 콘텐츠 비교)
* 메트릭: `delivery_rate`, `hard_bounce_rate`, `soft_bounce_rate`, `spam_complaint_rate`

### F. 피싱 방지·탐지

* **도메인 보호**: 등록 변형 문자열( homoglyph/typo ) 워치 → 유사 도메인 알림
* **내용 검사**: 링크 도메인 화이트리스트, HTML 내 **@style/script 금지**, 버튼 외 링크 제거
* **수신자 검증**: 엔터프라이즈 고객 희망 시 **S/MIME** 옵션 제공(서명 전용)

### G. 템플릿/현지화(i18n)

* ko/ja/en 템플릿 분리, 가독성 높은 **플레인 텍스트 동봉**(MIME 멀티파트)
* 제목 규칙: `[INCIDENT #{id}] {severity} · {dst_host} · {rule_id}`
* 긴급/중요 등급에만 이모지/배지 허용(스팸 필터 회피)

### H. 관측·SLO & 런북

* **SLO**: 수신 성공률 ≥ **99.2%**, 평균 수신 지연 ≤ **60s**, 하드 바운스 ≤ **0.3%**
* 대시보드: 도메인/ISP별 전달성, 바운스 사유 Top-N, 신고 트렌드, DKIM/DMARC 실패율
* 런북: (1) DMARC 실패 급증 → DNS/selector 확인 → 재서명 롤오버 (2) 특정 ISP 수신 오류 → 속도 제한·콘텐츠 단순화

### I. API/자동화(발췌)

* `POST /v1/notify/email` — 발송(서명/템플릿/i18n/레이트 자동 적용)
* `POST /v1/notify/bounce:webhook` — 바운스/스팸 신고 수신(서명 검증)
* `GET  /v1/notify/dmarc/report?range=7d` — Aggregate/Forensic 리포트
* `POST /v1/notify/domain/warmup { tenant, slope }` — 신규 테넌트 웜업

### J. 체크리스트

* [ ] SPF/DKIM/DMARC/BIMI/ARC 전 리전 적용, DMARC `p=reject` 운영
* [ ] 하드 바운스 자동 비활성·FBL 연동, 신고율 모니터
* [ ] 링크는 **서명 URL**만, HTML 최소화·텍스트 동봉
* [ ] 블록리스트/평판 모니터링 알람→티켓 자동화
* [ ] 템플릿 i18n·콘솔 진위 확인 배너 포함

---

4. **예시 설명 (DMARC 실패 급증—23분 내 복구)**

1) JP 리전에서 DKIM selector 만료로 DMARC 실패율 28% 급증 → 수신 성공률 96.7%.
2) 런북대로 **키 롤오버**(새 `jp02`) 적용, DNS 전파 확인 후 재발송 큐 처리.
3) 23분 내 성공률 99.4% 회복, 실패 메일은 **서명 URL** 유효성 재검증 후 안내 발송.
   → 결과: **인증·정책·바운스 관리** 표준으로 알림 경로의 전달성과 무결성을 유지, 피싱/스팸 리스크를 구조적으로 차단.
