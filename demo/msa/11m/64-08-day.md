# 필상 시스템 — Day 64 오브젝트 스토리지(S3/MinIO) 거버넌스 · 성능 · 라이프사이클(WORM/버전닝)

1. **날짜**

* 2024-11-08

2. **목표**

* **증거/로그/리포트**가 저장되는 오브젝트 스토리지의 **보안·성능·비용**을 균형화
* **WORM/버전닝·MFA Delete·정책**(OPA)로 **무결성**을 보장하고, **계층화/압축**으로 **TCO 20%↓**

---

3. **내용**

### A. 버킷/네임스페이스 설계

* 버킷 유형: `evidence/{region}`, `reports/{region}`, `snapshots/{region}`, `temp/{region}`(24h TTL)
* 키 규칙: `tenant/incident_id/type/ULID.ext`(경로 스캔 최소화), 메타 태그 `purpose, pii_level, retention_class`

### B. 무결성·보안(필수)

* **WORM(Object Lock)**: `GOVERNANCE` 기본, EPKG/감사물은 `COMPLIANCE`(법적 보존 시)
* **버전닝**: 전 버킷 `Enabled`, 삭제는 **Delete Marker**만 허용
* **MFA Delete**: `evidence/*` 필수, 키 파기·삭제에 MFA 필요
* **암호화**: SSE-KMS(AES-256-GCM), **리전별 KMS 키** + 키 회전 90일
* **정책(OPA/Gatekeeper)**

  * `object.put -> deny if pii_level == "raw" and bucket != "evidence"`
  * `cross_region_put -> deny`(주권)
  * `public_read -> deny`(모든 버킷)

### C. 접근 제어

.  

* 원칙: **서명 URL(10분)** 기반 다운로드, 콘솔은 **마스킹 뷰**
* 역할: `writer(evidence)`, `reader(reports)`, `auditor(증거 조회)`, `ops(snapshot)` — 최소권한 IAM
* **테넌트 격리**: 프리픽스 수준 IAM + 조건식 `s3:prefix == ${tenant}/*`

### D. 라이프사이클 & 계층화

* 등급: `hot(0–30d)` → `warm(31–180d)` → `cold(181–365d)` → `archive(>365d)`
* 정책 예:

  * `temp/*`: 24h 후 만료(삭제)
  * `evidence/*`: 180d 이후 `cold`, 3y 후 `archive`, `legal_hold=true` 시 정지
  * `reports/*`: 30d 후 `warm`, 365d 후 삭제(버전은 90d 보존)

### E. 성능·비용 최적화

* 멀티파트 업로드: **≥100MB** 자동, 파트 64–128MB(+ 병렬 4–8)
* 압축: 텍스트/JSON은 **zstd**(CLI/SDK 레벨), PDF/이미지는 비압축
* 인덱싱: 큰 리스트는 **Prefix 파티셔닝**(연/월/테넌트) + 키 캐시 테이블(DB)
* 네트워크: VPC 엔드포인트/내부망 고정, 오리진은 **mTLS** 필수

### F. 백업/복구 & 검증

* Cross-bucket(동일 리전) 복제(DR 용), **교차 리전 금지**
* **무결성 검증**: 업로드 시 SHA-256 ETag 저장, 월 1회 샘플 검증(1%)
* 스냅샷: 메타 인덱스(DB)와 **키 목록 스냅샷**을 함께 보관(검색/복구 가속)

### G. 관측·지표

* `put/get/err_rate`, `latency_p95`, `storage_bytes{class}`, `object_count`, `version_count`, `lifecycle_transitions`, `worm_violations=0`
* SLO: PUT/GET p95 **≤ 150ms**(hot), 무결성 실패 **0%**, 라이프사이클 지연 **≤ 15m**

### H. API/자동화(발췌)

* `POST /v1/obj/put { bucket, key, kms_key, worm: "gov|comp", tags{} }`
* `POST /v1/obj/presign { bucket, key, ttl }`
* `POST /v1/obj/lifecycle/apply { bucket, policy_id }`
* `GET  /v1/obj/audit?prefix=tenant/...&range=...`
* `POST /v1/obj/legal_hold { key, enable }`

### I. 운영/가드레일

* 대용량 업로드 실패 시 **부분 파트 정리**(AbortMultipart), 잔여 파트 모니터
* `temp/*`에 민감 태그 금지, EPKG는 항상 `evidence/*`에만 저장
* 삭제 요청은 **키 파기→Delete Marker** 순, 감사 해시체인에 타임라인 고정

---

4. **예시 설명 (증거 패키지 EPKG 누락·삭제 시도 — 19분 내 방어/복구)**

1) 내부 계정이 `reports/*`에 원본 로그 업로드 시도 → OPA 정책 **deny** + 보안 티켓 자동 생성.
2) 공격자가 `evidence/*` EPKG 버전을 삭제 시도 → **MFA Delete 미통과**로 실패, 감사 이벤트 기록.
3) 일부 EPKG 키 불일치 경고 감지 → 월간 샘플 검증에서 실패 3건 → **재업로드/ETag 재검증**으로 19분 내 복구.
4) 라이프사이클 지연으로 `cold` 전환이 늦은 키 0.6% → 작업 큐 재처리 후 정상화.
   → 결과: **WORM/버전닝·MFA Delete·OPA 정책**과 **검증/라이프사이클 자동화**가 결합되어 **무결성·주권·비용**을 동시에 달성.
