# 필상 시스템 — Day 66 콘솔 인증 하드닝: WebAuthn/Passkey(FIDO2) · OIDC/OAuth · 세션 보안·위험기반 MFA

1. **날짜**

* 2024-11-12

2. **목표**

* 콘솔/관리자 접근의 **피싱 저항 인증**(WebAuthn Passkey + FIDO2)과 **OIDC 통합**을 표준화
* **세션 생명주기 관리·위험기반 MFA·디바이스 바운딩**으로 **계정 탈취/세션 하이재킹 0건** 목표, **재인증 UX 최소화**

---

3. **내용**

### A. 아키텍처(개요)

* **IDP(OIDC)**: Authorization Code + PKCE, 브랜드 테넌트/엔터프라이즈 IDP 연동 지원
* **WebAuthn/FIDO2**: 플랫폼/보안키 양자 지원(Windows Hello, Touch ID, YubiKey 등)
* **세션 계층**: 서명 쿠키(HTTPOnly/SameSite=Lax, `Secure`) + 서버측 세션 저장(Short-lived) + **Refresh Token Rotation**
* **위험 신호**: UEBA(Day 62) 피드 + 디바이스 지문/ASN/Geo/시간대

### B. 등록(Enrollment) & 로그인 플로우

1. **등록**

   * 1차 신뢰(이메일 링크 또는 SSO 성공) → WebAuthn **Attestation** 요구
   * 기본 **Passkey 2개 이상** 권장(플랫폼+보안키), 복구키(오프라인) 발급
2. **로그인**

   * OIDC 시작 → **Passkey 우선**(이름/비번 없음) → Fallback: TOTP(고위험 시 금지)
   * 위험 점수 `≥ θ_review` → **Step-up**(추가 WebAuthn/SSO with MFA)

### C. 위험기반 MFA 정책(예시)

* **신호**: `geo_jump`, `ASN 변화`, `디바이스 미등록`, `야간/휴일 접근`, `대량 다운로드/설정변경 전`
* **정책**

  * `risk < 0.4` → WebAuthn 단일로 통과
  * `0.4 ≤ risk < 0.85` → **Step-up WebAuthn**(다른 인증기) or SSO-MFA
  * `risk ≥ 0.85` → **차단 + JIT 필요**(관리자 승인), 세션/리프레시 토큰 폐기

### D. 세션 보안 & 수명주기

* **만료**: Access 15m, Refresh 8h(회전), **장기 Remember Me 금지**
* **토큰 바인딩**: 디바이스 지문/클라이언트 인증정보 해시(UA+PLATFORM+WebAuthn credentialId)와 묶음
* **동시 세션**: 관리자 1–2개 제한, 초과 시 **가장 오래된 세션 종료**
* **민감 액션**: *룰/플래그 변경, Export/Erasure, 키 관리* 전 **재인증(5분 내 WebAuthn)**

### E. 테넌트/엔터프라이즈 SSO 연동

* **프로필**: `enterprise_sso:true`, 사전 검증된 도메인/메타데이터(JWKS) 필수
* **권한 맵핑**: OIDC `groups/roles` → RBAC(`OWNER/ADMIN/ANALYST/READONLY/BILLING`), ABAC에 `tenant_id/region` 주입
* **Fail-safe**: IDP 장애 시 **비상 Break-Glass**(Day 37, 30분 제한·2인 승인)만 허용

### F. 브라우저/네트워크 가드

* **CSP**: `default-src 'self' https:` + frame/worker 제한, **XFO DENY**, `Referrer-Policy:same-origin`
* **OAuth 가드**: Redirect URI **고정/화이트리스트**, `state`/`nonce` 검증, `PKCE S256` 강제
* **세션 고정 방지**: 로그인 성공 시 세션ID 회전, 쿠키 재발급

### G. 데이터/감사

* **로그**: `auth.event.v1`(enroll/login/challenge/step-up/deny), `session.lifecycle.v1`(issue/rotate/revoke)
* **감사 필드**: actor, device hash, geo/city (국가만 기본 노출), risk score, method(webauthn/totp/…), trace_id, prev_hash
* **보존**: 180일, 리전 내 저장(주권 준수)

### H. UX 원칙

* **Passkey 기본·비밀번호 비활성 옵션**(비번리스 테넌트)
* 복구 경로: 복구키 + 관리자의 **JIT 승인**(증빙 필요)
* 에러/단절 시 *안내 강화*: “다른 인증기 시도/보안키 삽입/브라우저 설정 확인”
* 이동성: Passkey **동기화 플랫폼**(iCloud/Google Password Manager 등) 가이드

### I. API/구성(발췌)

* `POST /v1/auth/webauthn/register/options` / `/verify` — 등록
* `POST /v1/auth/webauthn/login/options` / `/verify` — 로그인
* `POST /v1/auth/session/revoke` — 현재/모든 세션 종료
* `POST /v1/auth/step-up` — 민감 액션 전 재인증
* `GET  /v1/auth/factors` / `POST /v1/auth/factors/delete` — 인증기 관리

### J. SLO·지표

* **피싱 저항 커버리지**: 관리자/운영자 **100%** WebAuthn 사용
* **세션 하이재킹 0건**, **위험 기반 Step-up 탐지 지연 p95 ≤ 30s**
* **사용자 경험**: 정상 로그인 성공률 ≥ 99.5%, 평균 로그인 **≤ 3.0s**, Step-up 비율 ≤ 8%

---

4. **예시 설명 (고위험 접근 — 90초 내 차단·재인증)**

1) `admin@ent-co`가 **미등록 디바이스**·이상 ASN에서 야간 접근 → 위험 `0.88`.
2) 정책에 따라 **즉시 차단**, 콘솔에 “관리자 승인 또는 보안키 재인증 필요” 배너 표시.
3) 관리자가 JIT 승인(30분) 후 **다른 WebAuthn 인증기**로 Step-up 성공 → 세션 재발급, 민감 기능 접근 허용.
4) 감사 인덱스에 이벤트 타임라인/리스크 근거/승인자 기록.
   → 결과: **Passkey+위험기반 MFA+세션 가드**로 **피싱/세션 탈취**를 실무적으로 차단하고, 필요 시 **JIT로 안전한 우회**를 제공해 UX와 보안을 모두 확보.
