# 필상 시스템 — Day 76 표준 이벤트 택소노미 & 매핑: **OCSF 1.2** · **MITRE ATT&CK** · **SIGMA 규칙** 정합

1. **날짜**

* 2024-11-26

2. **목표**

* 인입(Log/WAF/EDR/Console/UEBA) 전 경로의 **이벤트 표준 스키마**를 **OCSF 1.2**로 일원화
* **MITRE ATT&CK** 전술/기술·**SIGMA** 탐지 규칙과 **상호 참조**(정합)하여 **탐지·검색·Export**의 호환성을 확보
* 고객 BI/SIEM/데이터레이크 연동 시 **매핑 오류 0건**, **스키마 안정화(Backwards-compat)** 보장

---

3. **내용**

### A. 이벤트 표준(OCSF 1.2) 코어 필드

* 공통 메타: `time, time_observed, event_uid(ULID), severity, status, vendor, product, class_uid, class_name, activity_id, activity_name`
* **주권/RLS 필수 확장**: `region, tenant_id`
* **프라이버시(시그니처)**: `ip_bucket(/24)`, `param_sig, uri_sig`, **원 IP/원문 금지**(Day 57, Day 71 정합)
* 컨텍스트: `rule_id, release_id, exp_key?, variant?, trace_id`

> 저장소 기준
>
> * 실시간 인덱스: `events_detect_{region}_YYYYMM`
> * 레이크하우스: `events_detect_lake`(Iceberg/Parquet) — Day 71

.  

### B. 도메인별 OCSF 매핑(발췌)

| 원천             | OCSF Class                                                                     | 주요 필드 매핑                                                                                                                             |
| -------------- | ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------ |
| **WAF/웹**      | `Application Activity (class_uid 3001)`                                        | `activity_name=web_request`, `http.request{method,uri=uri_sig,headers*masked}`, `outcome{blocked}`, `dst{host}`, `src{ip=ip_bucket}` |
| **EDR/Sysmon** | `Process Activity (3002)` / `File Activity (3003)` / `Network Activity (3004)` | `process{image, signer?, cmd_trunc}`, `file{path_sig, sha256}`, `net{dst_port, protocol}`                                            |
| **TI/평판**      | `Threat Intelligence (4001)`                                                   | `ti{source, score, labels[]}`, `ioc{type, value_hash}`                                                                               |
| **UEBA/콘솔**    | `Authentication (1002)` / `Admin Activity (3006)`                              | `user{hash, role}`, `admin_action{type=flag/rule/export}`                                                                            |
| **알림/티켓**      | `Alert (6001)`                                                                 | `alert{rule_id, confidence, related_event_uid[]}`, `link{console, epkg}`                                                             |

### C. **MITRE ATT&CK** 정합(전술/기술 라벨)

* 필드: `mitre{ tactic_id, tactic_name, technique_id, technique_name, subtechnique_id? }`
* 매핑 원칙

  * 룰/모델은 **최소 1개 기술(TID)** 라벨 필수, 콘솔에서 **근거 링크**(Saved Query/샘플) 표시
  * **복합 이벤트**(여러 기술 가능)의 경우 `technique_id[]` 배열 허용, `primary_tid` 지정
* 예시

  * WAF SQLi 탐지 → `TA0001 Initial Access`, `T1190 Exploit Public-Facing Application`
  * PS EncodedCommand → `TA0002 Execution`, `T1059.001 PowerShell`

### D. **SIGMA** 규칙 호환

* 저장 경로: `/rules/sigma/{domain}/{lang}/rule.yml`
* 필수 헤더: `id, title, status(stable|test), logsource(product, service), level, tags([attack.txxxx])`
* **OCSF 필드 타겟팅**: 시그니처 필드 기준(예: `event.class_name`, `process.image`, `net.dst_port`, `application.http.uri`)
* 회귀 파이프라인: 신규/변경 SIGMA → **샘플 리플레이(7/30/90d)** → **OCSF 변환 적합성** 테스트

```yaml
title: PS EncodedCommand Suspicious
id: SIG-PS-ENC-001
status: stable
logsource: { product: windows, service: sysmon }
detection:
  selection:
    event.class_name: "Process Activity"
    process.image|endswith: "\\powershell.exe"
    process.cmd_trunc|contains: "-enc"
condition: selection
level: high
tags: [attack.t1059.001, attack.execution]
```

### E. 스키마 안정성 & 진화(EMC)

* **Expand**: 새 필드는 OCSF extension으로 `x_plura.*` 네임스페이스에 **nullable** 추가
* **Migrate**: 백필 잡으로 상위 계층(레이크하우스) 보정, 다운스트림 컨슈머 **계약 테스트**
* **Contract**: 구 필드 Soft-Deprecate → 2주 관찰 후 제거, **버전 라벨**(`schema_version`) 유지

### F. 검색/Export 템플릿(OCSF 키 기반)

1. **최근 24h SQLi 차단 Top Host**

```http
q=class_name:"Application Activity" AND activity_name:"web_request" AND outcome.blocked:1 AND param_sig:"union_select"
fq=tenant_id:T1 AND region:kr AND time:[NOW-24HOURS TO NOW]
json.facet={ host:{type:terms, field:"dst.host", limit:10} }
rows=0
```

2. **Process→Network 연쇄(PS→외부 통신)**

```http
q=class_name:"Process Activity" AND process.image:"*\\powershell.exe"
fq=tenant_id:T1 AND region:kr AND time:[NOW-1DAY TO NOW]
join=event_uid->related_event_uid  # (콘솔 조인 연산자)
q2=class_name:"Network Activity" AND net.dst_port:[1 TO 1024]
rows=100&sort=time desc
```

### G. 검증·관측 SLO

* **스키마 적합성**: OCSF 유효성 실패율 **0%**, 변환 실패는 **DLQ** 격리
* **정합성**: MITRE/SIGMA 태깅 누락율 **< 1%**
* **성능**: 변환 파이프라인 p95 **≤ 50ms/이벤트**, 인덱스 적재 지연 p95 **≤ 1.2s**
* 대시: `ocsf_validate_fail`, `mapping_mitre_missing`, `sigma_replay_fail`, `schema_version_mix`, `consumer_contract_fail`

### H. 거버넌스/정책

* **주권/PII**: 원 IP/원문 파라미터 입력 시 **수집 거부 + 보안 티켓**
* **릴리스 게이트**: 스키마/룰 변경(PR)에 **OCSF/MITRE/SIGMA** 자동 검사 붙임

.  

* **카탈로그**: `/schemas/ocsf/1.2/` 문서화 + 예제, 고객용 **OCSF Export** 가이드 제공

### I. API/자동화(발췌)

* `POST /v1/schema/validate { event }` — OCSF 유효성 확인
* `GET  /v1/schema/versions` — 현재/과거 버전, 호환성 매트릭스
* `POST /v1/rules/sigma/test { rule_id, range }` — 리플레이/정합성 리포트
* `GET  /v1/events/mitre?technique=T1059.001&range=7d` — MITRE 조회(OCSF 필터)

### J. 운영 체크리스트

* [ ] 모든 이벤트 경로 **OCSF 1.2** 변환기 활성, **x_plura.*** 확장 네임스페이스 준수
* [ ] MITRE/SIGMA 태그 누락 1% 미만, 누락건 **자동 티켓**
* [ ] 레이크하우스/Export OCSF 스키마 동기화(고객 SIEM 호환)
* [ ] EMC 단계별 계약 테스트(컨슈머 호환) 통과 후 배포
* [ ] 고객 문서(i18n) 최신화: OCSF 필드·MITRE 코드·SIGMA 예제 포함

---

4. **예시 설명 (PS EncodedCommand 탐지—OCSF/SIGMA/MITRE 일치 검증 12분)**

1) Sysmon → `Process Activity`(OCSF) 변환: `process.image=powershell.exe`, `cmd_trunc=-enc ...`.
2) SIGMA `SIG-PS-ENC-001` 리플레이 통과, 이벤트에 `tags=[attack.t1059.001]` 라벨 부여.
3) 콘솔에서 MITRE 필터 `T1059.001`로 조회 → 관련 사건·규칙·증거 링크 일치 확인.
4) 고객 SIEM으로 **OCSF Export** 실행 → 필드/라벨 호환 OK, 실패 0건(12분 내 검증).
   → 결과: **OCSF·MITRE·SIGMA** 정합 표준으로 내부 탐지/검색/Export 전 과정의 **호환성·재현성**이 보장되고, 고객 환경과의 **연동 마찰**이 크게 줄어든다.
