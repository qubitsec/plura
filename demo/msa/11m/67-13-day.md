# 필상 시스템 — Day 67 분산 추적(OpenTelemetry) 표준: 스키마·샘플링·마스킹·Trace↔Log/Metric 상관

1. **날짜**

* 2024-11-13

2. **목표**

* 전 경로(인입→탐지→사건→알림)의 **엔드투엔드 추적**을 **OpenTelemetry(OTel)**로 일원화
* **PII 마스킹·주권 준수·저비용 샘플링**을 보장하면서 **Trace↔Log/Metric** 상관을 **3클릭 이내** 달성

---

3. **내용**

### A. 추적 스키마 & 컨텍스트 전파

* **스키마**: OTel semantic conventions + 도메인 키

  * 공통: `trace_id, span_id, tenant_id, region, release_id, exp_key?, variant?`
  * 인입: `dst_host, uri, status, blocked, param_sig?`(로그에만)
  * 탐지: `rule_id, verdict, confidence`
  * 사건: `incident_id, severity, state`
  * 알림: `channel, target, notify_id`
* **전파**: W3C **`traceparent`/`tracestate`** (Gateway가 없는 요청엔 생성)
* **주석(Annotation)**: 릴리스/플래그 변경, 유지보수창(MW), DBV360 재판정 이벤트를 **Span Event**로 기록

### B. 샘플링 전략(저비용·고가치)

* **기본**: Head 10% (콘솔/검색 5%, 인입 파이프라인 10%)
* **핵심 경로/오류**: **Always-On**(Incident open/crit, 5xx, DLQ 적재, Kill-Switch, Canary 단계)
* **테넌트 가중치**: ENT 플랜·PoC 테넌트는 +5~10%p 상향
* **Exemplar 연계**: 레이턴시 지표의 p95/p99 버킷에 **대표 Trace 링크** 저장(대시보드에서 원클릭 점프)

### C. PII·보안 마스킹(필수)

* **규칙**

  * `src_ip → ip_bucket(/24)`까지만, **원 IP 금지**(로그/트레이스 동일)
  * `email/phone/token/cookie` → **패턴 기반 마스킹**(`***`)
  * `query/body` → **시그니처(param_sig)**만, 원문 금지
* **게이트웨이 필터**: 민감 헤더 제거(`Authorization`, `Cookie`, `Set-Cookie`, `X-Internal-*`)
* **정책(OPA)**: 원문 PII가 Span Attribute에 진입하면 **수집 거부 + 알림**
* **주권**: Trace/Log 저장은 **리전 내 백엔드**(Tempo/Loki 등), 교차 전송 금지

### D. Trace↔Log/Metric 상관 규칙

* **Log**: `trace_id, span_id` 필수, **LogQL/Solr**에서 `trace_id`로 역추적 템플릿 제공
* **Metric**: RED/USE 지표에 `trace_exemplar` 라벨 부여 → p95 이상 구간 클릭 시 연관 Trace 표시
* **Incident 뷰**: `incident_id`로 **관련 Trace Top-N** 자동 집계(시간창 ±5m, rule_id 일치)

### E. 백엔드 & 보존

* **수집**: OTel Collector(리전 로컬) → Tempo(Trace)/Loki(Log)/Prometheus(Metric)
* **보존**: Trace 72h(핵심 경로 Always-On은 7일), Log 30일(인덱스), Metric 13개월(집계 단계별)
* **압축/비용**: Trace Attribute **Blocklist/Allowlist**, Span 이벤트는 256자 이내 요약

### F. 성능·품질 가드

* **오버헤드 SLO**: SDK/에이전트 CPU **< 3%**, 요청 지연 **< 5ms**(p95)
* **샘플링 적중**: 핵심 경로 트레이스 비율 **≥ 95%**, 오류 트레이스 누락 **0%**
* **경보**: `trace_drop_rate > 1%` or `pii_violation>0` → T1 + 수집 파이프라인 점검

### G. 계측 가이드(서비스별)

* **Gateway/Nginx**: `http.server.duration`, `http.route`, **client_ip_trunc**(버킷)
* **Ingestor/Stream**: `kafka.consumer.lag`, `process_latency_ms`, `idempotency_hit`
* **Detect**: `rule_id`, `features_count`, `verdict/confidence`
* **Incident/Notify**: `transition`, `webhook.retry_count`, `notify_latency_ms`
* **DB/Cache**: `db.client.operation.duration` + `db.system=postgres|redis`

### H. 운영/UX

* 콘솔 **Trace 카드**: (1) 타임라인, (2) 관련 로그 탭, (3) 릴리스/플래그 배지, (4) “Issue Ticket” 원클릭
* **저비용 모드**: 야간/저부하 시간엔 Head 5%로 하향, 장애 시 자동 상향
* **개발자 경험**: 로컬 Dev는 Always-On + 샘플 데이터로 재현 링크 자동 생성

### I. API/자동화(발췌)

* `GET /v1/trace/{trace_id}` — 연관 로그/메트릭/릴리스 이벤트 포함
* `POST /v1/trace/sampling { service, head_pct, rules[] }` — 동적 샘플링 변경
* `GET /v1/trace/policy/violations?range=1h` — PII/주권 위반 요약
* `POST /v1/trace/exemplar/attach { metric, trace_id, ts }`

### J. 체크리스트

* [ ] 모든 서비스에 **W3C 전파·OTel SDK** 기본 포함
* [ ] PII 마스킹/Blocklist 정책 **CI 테스트**(샘플 스팬 유닛테스트)
* [ ] 핵심 경로 Always-On + 오류 샘플 100% 확보
* [ ] 대시보드에서 **Exemplar→Trace→Log** 3클릭 동선 검증
* [ ] 보존/비용 리포트 월간 검토, 샘플링 테이블 튜닝

---

4. **예시 설명 (알림 지연 상승 — Trace 2분 내 원인 국소화)**

1) 알림 p95 12s 상승 → 대시보드 **Exemplar** 클릭 → 관련 Trace로 점프.
2) Trace에서 `notify.request` 하위 스팬의 **웹훅 서명 검증** 지연 확인(외부 수신측 429).
3) 관련 로그 탭에서 `retry_count`↑와 `rate_limit` 헤더 확인 → 수신측 쿼터 초과로 판정.
4) 2분 내 원인 국소화 → 라우팅 정책을 다른 엔드포인트로 전환, p95 7.8s로 회복.
   → 결과: **OTel 스키마·샘플링·상관 표준** 덕분에 **저비용**으로도 장애 시 **즉시 가시성**과 **재현성**을 확보.
