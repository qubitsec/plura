# 필상 시스템 — Day 62 UEBA(사용자·엔티티 행위분석) · 콘솔/관리자 이상행위 탐지 · JIT/정책 연동

1. **날짜**

* 2024-11-06

2. **목표**

* 콘솔 사용자·운영자·서비스 계정의 **행위 기반 이상 탐지(UEBA)** 표준 확정
* **JIT/JEA·OPA 정책·Notifier/IR**와 연동해 **권한오남용·내부위협·세션 탈취**를 **10분 내 탐지/차단**

---

3. **내용**

### A. 범위 & 데이터 소스

* **행위 이벤트**: 콘솔 클릭스트림(민감 필드 마스킹), API 호출(log/search/rules/flags), 다운로드/서명URL 발급, 설정변경/릴리스 조작, JIT/Bastion 세션 메타, 실패/비정상 인증
* **컨텍스트**: 사용자/역할/팀/테넌트/리전, 디바이스/브라우저 지문, IP·ASN·Geo(국가), 업무시간/휴일 캘린더
* **라벨/피드백**: IR 티켓 라벨(`malicious|benign|misuse|policy_violation`)과 연계

### B. 시그널 & 특징량(예)

* **접속/세션**: 신규 ASN·이상 Geo 점프(시간-거리), 다중 동시 세션, JIT 없는 고위험 API 호출
* **행위 패턴**: 평시 대비 `query_rate↑`, `bulk_export`, `download_bytes↑`, `flag_change_burst`
* **권한오남용**: READONLY가 `rules:write`/`tenant:admin` 시도, Break-Glass 빈도, 유지보수창 외 고위험 변경
* **관계 기반**: 유사 역할/팀 대비 행위 벡터 거리(마할라노비스/코사인)

### C. 모델/룰 하이브리드

* **통계/프로파일**: 사용자/팀/역할별 베이스라인(최근 30d) + Z-score/KS-test
* **이상탐지**: Isolation Forest/LOF(온라인 파이프라인) + 룰(화이트/블랙리스트)
* **스코어**: `risk = w_a*stat + w_b*model + w_c*policy + w_d*context` (임계: `review≥0.6`, `block≥0.85`)
* **설명가능성**: Top-K 기여 특징(예: `geo_jump`, `bulk_export`, `jit_missing`)를 근거로 노출

### D. 정책·가드레일 연동(OPA/Rego)

* **즉시 차단**:

  * JIT 미보유 + `admin_write` 시도
  * `geo_jump & high_download` 동시 발생
  * 유지보수창 외 `rules/flags` 대량 변경
* **소프트 가드**: `review` 구간은 **Captcha/2차 인증/관리자 확인** 요구
* **자동 조치**: JIT 세션 강제 만료, 계정 일시 잠금(15m), 서명 URL 발급 중지, 다운로드 워터마크 강화

### E. 파이프라인 & 저장

* **스트림**: `auth.event.v1`, `console.action.v1`, `ops.change.v1`, `jit.session.v1` → Feature Extractor → UEBA Scorer → `security.alert.ueba.v1`
* **저장/보존**: 행위 메타 180d(리전 내), 민감 필드는 마스킹/해시, 원본 PII 저장 금지
* **학습/튜닝**: 주간 재학습(증분), 라벨 반영(티켓 결과) → 모델 레지스트리(stage: cand/approved/prod)

### F. 알림/IR 연동

* **알림 라우팅**: `team:csirt/sre/csm`, `severity: high|crit`, 템플릿에 **근거/행위 타임라인/서명 링크** 포함
* **IR 자동화**:

  * `block` 스코어 시: 세션 강제 종료 + 계정 잠금 + IR 티켓 생성 + EPKG-Lite(행위 로그 요약)
  * `review` 스코어 시: 2차 인증 요구 + 콘솔 배너 알림 + CSIRT 워크플로우 트리거

### G. SLO & 지표

* **탐지 지연 p95 ≤ 10분**, **오탐률(FP) ≤ 3%**, **미탐 회귀 실패 ≤ 1%**
* 지표: `ueba_alerts_by_severity`, `geo_jump_rate`, `bulk_export_rate`, `jit_violation_count`, `auto_lock_count`, `false_positive_ratio`
* **품질 루프**: 월간 Top-20 케이스 리뷰 → 룰/임계/특징 업데이트

### H. 프라이버시/주권

* 사용자 동의·고지(내부 정책), **목적 바인딩**(`purpose=security`) 필수
* **리전 경계**: 행위 데이터 교차 리전 전송 금지, 보고서는 집계/익명화로 생성
* **투명성**: 콘솔에 본인 행동 로그 열람(최근 30d) + 이의 제기 채널

### I. API/인터페이스(발췌)

* `POST /v1/ueba/score { subject, features }` — 실시간 스코어 질의
* `GET  /v1/ueba/alerts?subject=user@&range=24h` — 이상 알림 조회
* `POST /v1/ueba/label { alert_id, label }` — IR 라벨 반영(학습 피드백)
* `POST /v1/ueba/policy/override { user, ttl, reason }` — 일시 예외(2인 승인)

---

4. **예시 설명 (관리자 계정 세션 탈취 의심 — 14분 내 차단)**

1) `admin@tenant-a` 계정에서 **이상 Geo 점프**(Tokyo→Seoul 5분 내)와 **저장 쿼리 대량 실행/CSV 다운로드** 급증, JIT 없음.
2) UEBA 스코어 `0.91(block)` → OPA 정책이 **세션 종료 + 계정 15분 잠금 + 서명 URL 발급 차단** 자동 실행.
3) Notifier가 CSIRT에 **crit 알림**, EPKG-Lite(행위 타임라인·지문·IP/ASN 해시) 첨부.
4) 사용자는 MFA 재인증 요구 배너 확인, CSIRT는 IR 플레이북에 따라 비밀번호/토큰 재발급·기기 신뢰도 검증.
5) 14분 내 확산 차단, 재학습에 `malicious` 라벨 반영 → 유사 시나리오 임계 하향(재발 방지).
   → 결과: **행위 기반 탐지 + 정책/온콜 자동화**로 내부위협/세션 탈취를 신속히 억제하고, 프라이버시·주권·투명성을 함께 보장.
