# 필상 시스템 — Day 60 개발자 통합 키트( SDK · CLI ) 표준: 인입·검색·웹훅 서명 검증

1. **날짜**

* 2024-11-04

2. **목표**

* 고객/파트너가 **빠르고 안전하게** 연동할 수 있도록 **공식 SDK( Python/Node.js/Go ) + CLI** 표준화
* **인입(Logs)**·**저장 쿼리 실행(Search)**·**웹훅 서명 검증(verify)**를 일관된 방식으로 제공하여
  **통합 리드타임 50%↓**, **연동 오류율 < 0.5%**, **웹훅 위·변조 0건** 달성

---

3. **내용**

### A. 패키지/리포 구조

```
/sdks
  /python  (pip: plura-sdk)
  /node    (npm: @plura/sdk)
  /go      (module: github.com/plura/sdk)
  /cli     (plura CLI: Windows/macOS/Linux)
  /examples
    /ingest-quickstart
    /search-saved-query
    /webhook-verify
```

* **버저닝**: SemVer (`MAJOR.MINOR.PATCH`), API 호환성은 Day 26(OpenAPI/AsyncAPI)와 동기화
* **배포**: CI가 태그 생성 → SDK 빌드/테스트 → 패키지 레지스트리 공개 + 체인지로그 자동 생성

### B. 공통 설계 원칙

* **Zero-Config 기본값**: `PLURA_API_BASE`, `PLURA_TENANT_ID` 환경변수 자동 인식
* **STS 단명 토큰( Day 52 )** 우선, 정적 비밀 금지
* **Idempotency** 지원: `Idempotency-Key`(ULID) 자동 부여/전파
* **리전/주권**: `region` 필수 파라미터(교차 리전 호출 금지 경고)
* **재시도/백오프**: 429/5xx에 한해 지수 백오프(1s/2s/4s, Jitter) 최대 3회

.  

### C. 인입(Logs) — Quickstart 스니펫

**Python**

```python
from plura_sdk import IngestClient
cli = IngestClient(region="kr")          # API base 자동 추론
cli.put_events([
  {"ts":"2024-11-04T00:00:01Z","tenant_id":"TEN_kr_x",
   "dst_host":"shop.example.com","uri":"/search","status":406,"blocked":1,
   "param_sig":"union_select","event_id":"01JXYZ..."}
])
```

**Node.js**

```js
import { IngestClient } from "@plura/sdk";
const cli = new IngestClient({ region: "kr" });
await cli.putEvents([{ ts: new Date().toISOString(), tenant_id: "TEN_kr_x", uri:"/login", status:200 }]);
```

**Go**

```go
cli := sdk.NewIngestClient(sdk.Config{Region: "kr"})
evt := sdk.Event{Ts: time.Now().UTC(), TenantID: "TEN_kr_x", URI: "/api", Status: 200}
if err := cli.PutEvents(context.Background(), []sdk.Event{evt}); err != nil { panic(err) }
```

* **보안 가드**: 1건 ≤ 256KB, 배치 기본 500건, 자동 zstd 압축
* **멱등**: 동일 `event_id` 재전송 시 서버가 **중복 무시**

### D. 검색( Saved Query 실행 ) — 템플릿 매핑

**Python**

```python
from plura_sdk import SearchClient
sc = SearchClient(region="kr")
res = sc.exec_saved_query(
  key="q.fp_suspect",
  params={"host":"shop.example.com", "time_range":"NOW-24HOURS TO NOW"}
)
print(res.facets["codes"], res.facets["blocked"])
```

**Node.js**

```js
import { SearchClient } from "@plura/sdk";
const sc = new SearchClient({ region: "kr" });
const r = await sc.execSavedQuery("hunt.t1071.web_c2_suspicious_tld",
  { tlds: ["top","xyz","club"], window: "NOW-6HOURS TO NOW" });
console.log(r.facets);
```

**Go**

```go
sc := sdk.NewSearchClient(sdk.Config{Region:"kr"})
r, _ := sc.ExecSavedQuery(ctx, "q.fp_suspect", map[string]string{
  "host":"shop.example.com", "time_range":"NOW-24HOURS TO NOW",
})
fmt.Println(r.Facets)
```

* **SLO 가드**: SDK가 p95 800ms 초과 시 경고 로그 + 재시도 1회

### E. 웹훅 서명 검증(HMAC v1) — 클라이언트/수신측

**서명 헤더 규격**

```
X-Plura-Signature: v1=<hex(hmac_sha256(body, secret))>
X-Plura-Timestamp: <unix-epoch-seconds>
```

**Python(수신측 검증)**

```python
import hmac, hashlib, time
def verify_plura(req_body: bytes, signature: str, ts: str, secret: str) -> bool:
    if abs(int(time.time()) - int(ts)) > 300:  # 5m window
        return False
    mac = hmac.new(secret.encode(), req_body, hashlib.sha256).hexdigest()
    return hmac.compare_digest(f"v1={mac}", signature)
```

**Node.js(Express 미들웨어)**

```js
export function verifyPlura(req, res, next){
  const sig = req.get("X-Plura-Signature");
  const ts  = parseInt(req.get("X-Plura-Timestamp") || "0", 10);
  if (!sig || Math.abs(Date.now()/1000 - ts) > 300) return res.status(401).end();
  const mac = crypto.createHmac("sha256", process.env.PLURA_WEBHOOK_SECRET)
                    .update(req.rawBody).digest("hex");
  if (`v1=${mac}` !== sig) return res.status(401).end();
  next();
}
```

**Go(net/http)**

```go
func VerifyPlura(r *http.Request, secret string) bool {
    sig := r.Header.Get("X-Plura-Signature")
    ts  := r.Header.Get("X-Plura-Timestamp")
    t, _ := strconv.ParseInt(ts,10,64)
    if math.Abs(float64(time.Now().Unix()-t)) > 300 { return false }
    body, _ := io.ReadAll(r.Body); r.Body = io.NopCloser(bytes.NewReader(body))
    mac := hmac.New(sha256.New, []byte(secret)); mac.Write(body)
    return sig == "v1="+hex.EncodeToString(mac.Sum(nil))
}
```

* **리플레이 차단**: SDK가 자동으로 **nonce 캐시(5m)** 검사 옵션 제공
* **보안 권고**: 서명 실패/타임스탬프 이상 → **HTTP 401** + 감사 로깅(해시체인)

### F. CLI 워크플로우

```bash
# 1) 로그인(STS OIDC 교환) & 기본 설정
plura auth login --region kr

# 2) 샘플 로그 배치 전송
plura ingest put --file samples/waf.ndjson --tenant TEN_kr_x --batch-size 500

# 3) 저장 쿼리 실행 후 표/CSV 출력
plura search run q.fp_suspect --param host=shop.example.com --range "NOW-24HOURS TO NOW" -o csv

# 4) 웹훅 서명 검증 로컬 테스트
plura webhook verify --secret env:PLURA_WEBHOOK_SECRET --file payload.json --sig "v1=abc..." --ts 1698812345
```

* **추가 기능**: `plura dlq replay`, `plura rules draft apply --dry-run`, `plura flags set --rollout 25`

### G. 품질/보안 가드레일

* **TLS v1.2+** / 서버 인증서 고정(Pinning 옵션)
* **입력 검증**: JSON Schema 사전검증 실패 시 상세 오류 포맷 반환
* **리전 차단**: SDK가 다른 리전 엔드포인트에 요청 시 **Hard Fail**
* **로그 민감정보 마스킹**: 키/토큰/쿠키 패턴 자동 마스킹(로컬 로그에만 적용)

### H. 관측·SLO

* SDK/CLI는 **OTel Exporter** 내장: `sdk_request_latency_ms`, `sdk_retry_count`, `webhook_verify_fail`
* **목표**: 요청 성공률 ≥ 99.5%, p95 지연(인입) ≤ 300ms / (검색) ≤ 800ms, 웹훅 검증 오탐 ≤ 0.1%

### I. API/호환성

* `GET /v1/capabilities`로 서버 기능 플래그 수신 → SDK가 가능한 엔드포인트만 노출
* **호환성 매트릭스** 문서화: SDK 버전 ↔ 최소/최대 API 버전( Day 26 )
* **폐기 경로**: Deprecated API 호출 시 경고 로그 + 대체 경로 자동 안내

### J. 운영 체크리스트

* [ ] SDK 각 언어별 **샘플/스캐폴드** 제공(ingest/search/webhook)
* [ ] **gitleaks** & SBOM·서명(Cosign) 포함 배포( Day 38 )
* [ ] STS/OIDC 설정 가이드(i18n: ko/ja/en) & 토큰 만료/갱신 테스트
* [ ] 성능/회귀 벤치(ingest/search) CI 파이프라인에 포함
* [ ] 고객 온보딩( Day 14 )와 연계한 **1-클릭 키 발급/예제 다운로드**

---

4. **예시 설명 (고객 PoC — 30분 내 연동/검증 완료)**

1) 고객이 `plura auth login` 후 **샘플 NDJSON**으로 인입 성공(재시도/멱등 자동 처리).
2) 콘솔에서 **Saved Query** 키를 선택해 `plura search run` 실행 → FP 의심 파셋 즉시 확인.
3) 고객 SOAR 웹훅 엔드포인트에 SDK **검증 미들웨어** 적용 → 서명/타임스탬프/리플레이 모두 통과.
4) SLO 대시보드에 `sdk_request_latency_ms p95=210ms`, `webhook_verify_fail=0` 기록.
   → 결과: 표준화된 **SDK·CLI** 덕분에 **개발자 경험(DX)**이 크게 개선되고, **보안·주권·신뢰성**을 내장한 채 30분 내 PoC 연동이 가능해짐.
