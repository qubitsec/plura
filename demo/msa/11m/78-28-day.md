# 필상 시스템 — Day 78 합성 모니터링(Synthetic) & 가용성 검증 · 에러버짓(ErrBudget) · 카오스 프로브

1. **날짜**

* 2024-11-28

2. **목표**

* **사용자 여정 기반 합성 트랜잭션**으로 콘솔/API/검색/알림의 **가용성·지연·정확성**을 **분 단위**로 검증
* **에러버짓(ErrBudget)** 관리와 **카오스 프로브(경량 장애 주입)**를 표준화하여 **문제 10분 내 탐지**, **SLO 위반 시 자동 대응** 확립

---

3. **내용**

### A. 합성 시나리오(표준 6종)

1. **콘솔 로그인 & 저장 쿼리 실행**

   * 단계: `/auth → /console → saved-query(q.fp_suspect)`
   * 검증: 응답 200, 결과 파셋에 `status in {200,406}` 존재, p95 ≤ 800ms
2. **인입→사건(End-to-End)**

   * NDJSON 10건 전송 → `detect.verdict=review` 1건 이상 → `incident.open` 조회
   * 지연 SLO: **ingest→incident p95 ≤ 15s**
3. **알림(메일/웹훅) 루프백**

   * 테스트 티켓 생성 → 메일/웹훅 수신 엔드포인트(서명 검증) 확인
   * 지연 SLO: **incident→notify p95 ≤ 10s**
4. **검색(템플릿 3종)**

   * `q.fp_suspect`, `q.c2_suspect_multilang`, `q.admin_console_behavior`
   * 지연 SLO: 각 p95 ≤ 800ms, 캐시 미스/히트 모두 측정
5. **엣지→오리진 페일오버**(드라이런)

   * 조건부 헤더로 Failover 라우팅 강제 → 읽기형 API 200/지연 ≤ 600ms
6. **데이터 Export(경량)**

   * Saved Report 즉시 실행 → 서명 URL 유효/워터마크 확인, 완료 ≤ 15m

> 시나리오별 **테넌트/리전 분리**(KR/JP), **주권 준수**로 교차 호출 금지.

### B. 에이전트/스케줄

* **런너**: k6(HTTP+SSE), Playwright(콘솔 UI), 포스트맨/소박한 gRPC 클라이언트
* **스케줄**: 1분 간격(핵심 3종), 5분/15분(나머지), 야간엔 저빈도
* **지역성**: KR/JP PoP + 사내 PoP 1곳(외부/내부 경로 비교)
* **레퍼런스 데이터**: 테스트 테넌트 `TEN_synth_*`, **시그니처 필드만** 사용(IP/파라미터 원문 금지)

### C. SLO·에러버짓 모델

* **SLO**(월 기준, 일부 재확인)

  * 콘솔/API 가용성 99.9%
  * **ingest→incident p95 ≤ 15s**, **incident→notify p95 ≤ 10s**, **검색 p95 ≤ 800ms**
* **에러버짓**: `ErrBudget = 1 - SLO`

  * 소비율 임계: **25%**(개발 동결), **50%**(릴리스 동결 + 성능 스프린트), **80%**(플래그/부하 완화 강제)
* **집계**: 합성 성공/실패·지연 상위 1% 샘플은 **Trace/Log** 링크(OTel Exemplar)로 자동 첨부

### D. 카오스 프로브(경량 장애 주입)

* **대상**: 검색 샤드 리더 전환, 메시지 브로커 파티션 지연(50–200ms), Notifier 외부 의존 429, Edge 캐시 무효화
* **주기/가드**: 주 1회 스테이징, 월 1회 프로덕션 **저강도**(심야·5분 미만), SLO 악화 시 즉시 중단
* **검증**: 합성 시나리오 지연/성공률 변동이 **가설대로** 나타나는지 확인(런북 업데이트)

### E. 상관·자동 대응(Playbooks)

* 합성 실패 → **릴리스/플래그/Quota/Anomaly** 타임라인과 코릴레이션(±30m)
* **자동 조치 예**

  * 검색 p95↑ → 템플릿 전용 + TTL 90s + Expensive Query 차단 (Day 73)
  * 알림 실패율↑ → 디듀프 확대·채널 우선순위 조정 (Day 56)
  * 인입→사건 지연↑ → 샘플링/필드 축약(Soft throttle) (Day 72)
* 조치 후 **되돌리기 키**와 관찰 창(15분) 자동 설정

### F. 데이터·프라이버시 가드

* 합성 데이터는 **가명/합성( Day 57 )** 세트를 사용, 원본 PII 금지
* **테넌트/리전 RLS** 강제, Export/Erasure 트리거 금지
* 결과 아티팩트는 `reports/{region}/synthetic/`에 저장(서명 URL·10분)

### G. 대시보드·경보

* 타일: `synth_success_rate`, `synth_p95_{flow}`, `edge_vs_origin_p95`, `notify_success_rate`, `errbudget_spend`
* 상태 배지: 릴리스/플래그/카오스/유지보수창
* **경보**

  * 합성 실패 3회 연속 또는 p95 임계 초과 5분 → **ALERT** + 온콜 호출
  * 에러버짓 소모율 **>25/50/80%** 단계 알림(자동 조치 템플릿 제안)

### H. API/자동화(발췌)

* `POST /v1/synth/run { scenario, region }` — 임의 실행(검증/링크 반환)
* `GET  /v1/synth/metrics?window=1h` — 성공률/지연/실패 사유
* `POST /v1/synth/chaos { probe, ttl }` — 경량 장애 주입(승인 2인)
* `POST /v1/slo/errbudget/rollup { range }` — 에러버짓 집계/상태

### I. 운영 체크리스트

* [ ] 테스트 테넌트/데이터셋 분리·가명화 검증
* [ ] 핵심 3 시나리오 1분 주기, 나머지 5–15분 주기 실행
* [ ] 카오스 프로브 **스테이징 우선**, 프로덕션은 저강도·짧게
* [ ] SLO 위반 시 자동 조치 + 되돌리기 키·관찰 창 부여
* [ ] 에러버짓 소모에 따른 **변경 속도 조절**(개발/배포 동결 규칙 적용)

---

4. **예시 설명 (알림 경로 합성 실패—9분 내 완화, 27분 내 정상화)**

1) `incident→notify` 합성에서 3회 연속 실패(웹훅 429). Edge/Origin 정상, 릴리스 이벤트 없음.
2) 자동 조치: **디듀프 확대** + **채널 우선순위**(Slack/Email 우선) + 수신측 백오프 가속.
3) 9분 내 실패율 0.3%로 하락, p95 8.9s → 27분 내 7.4s 정상화, 에러버짓 소모 6%에서 멈춤.
4) RCA: 고객 SOAR 쿼터 제한. 커넥터 Rate 정책 업데이트·고객 가이드 발송.
   → 결과: **합성 모니터링+에러버짓+자동 완화**로 문제를 **선제 탐지·국소화**하고, 운영 개입 최소로 **SLO를 회복**.
