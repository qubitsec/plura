# 필상 시스템 — Day 65 실험/실행(Experimentation) 표준: A/B/n · 롤아웃 가드레일 · 효과 측정

1. **날짜**

* 2024-11-11

2. **목표**

* **Feature Flag( Day 20 )** 기반 **A/B/n 실험**을 안전하게 수행하기 위한 **설계·배포·분석** 표준 확정
* **가드레일 지표**로 SLO/보안/비용 악화 **즉시 차단**, **효과 측정** 자동화로 결정 리드타임 **≤ 24h**

---

3. **내용**

### A. 설계 원칙

* **작은 폭발반경**: 테넌트/사용자/리전 단위 **타깃팅 + 퍼센트 롤아웃**
* **동형 비교**: 실험군/대조군의 **동시 기간·동일 트래픽 소스** 확보(리버전 금지)
* **목적 구속**: `purpose=experiment` 메타 필수(로그·저장·보고 모두)
* **주권 준수**: KR/JP **리전 내 통계** 별도 산출(교차 합산 금지)

### B. 실험 모델(A/B/n) 정의

```yaml
experiment:
  key: search_cache_ttl_90s
  hypothesis: "검색 p95↓, CQS 비용↓, FP율 변화 없음"
  variants:
    - { name: control, params: { ttl: 30 } }
    - { name: v90,     params: { ttl: 90 } }
  target:
    region: kr
    tenants: ["ent-*"]        # 와일드카드 허용
    users:   ["role:ANALYST"] # 세그먼트
  traffic: { control: 50, v90: 50 }
  duration: { min_hours: 24, max_days: 7 }
  guardrails:
    - slo.ingest_to_incident_p95 < 15s
    - error_rate < 1.0%
    - finops.CQS_p95 < 0.006   # 비용 상한
  primary_metric: search_p95
  secondary: [ "cache_hit_ratio", "alert_fanout", "FP_rate" ]
```

### C. 배포·수행(플래그 연동)

* 플래그 스키마:

  * `exp/{key}` → `{ variant: control|v1|v2, ttl: <int>, rollout: <percent> }`
* **할당 규칙**: 안정된 해시(`tenant_id|user_id`)로 **고정 배정**(세션 간 일관성)
* **노이즈 완화**: 릴리스/장애/유지보수창(MW)이 겹치면 **자동 일시정지**
* **관측**: 모든 요청/사건에 `exp_key, variant, release_id` 라벨 주입 → OTel/지표/로그 일관

### D. 가드레일(실시간 차단)

* **중단 조건(즉시)**

  * 가드레일 위반 5분 지속(슬라이딩 윈도우)
  * 보안 이벤트(교차 리전 전송, 서명 실패, 권한오남용) 히트
* **행동**: 해당 Variant **롤백(rollout=0)** → 상태페이지 내부 공지 → RCA 티켓 자동 생성
* **완화**: Canary 5%로 재시작 가능(승인 2인)

### E. 분석·효과 측정(자동화)

* **유의성 검정**:

  * 연속값(p95 지연/비용): **Mann–Whitney U**
  * 비율(성공률/에러율/FP율): **Two-proportion z-test**
* **파워/샘플 크기**: 표본 크기 자동 추정(효과크기 `d`, 유의수준 0.05, 파워 0.8) → 예상 **실험 시간** 가이드
* **편향 통제**: **코호트 매칭**(테넌트 플랜/트래픽 볼륨), **주중/주말** 효과 분리
* **결과 리포트**(자동 생성): 효과크기, p-value, 신뢰구간, 가드레일 위반/없음, 권고(승격/폐기/재실험)

### F. 개인정보/윤리

* **PII** 저장 금지, 변형(가명/버킷)만 지표에 사용
* **민감 기능**(보안/차단/정책)은 **리뷰 보드** 승인 후 제한적 실험(Strict 리전/테넌트)
* 고객 가시성: 실험 적용 여부/가드레일 요약을 **투명하게 공지**(계약 옵션)

.  

### G. 파이프라인/지표

* 스트림: `ops.experiment.assign.v1`, `ops.experiment.metrics.v1`, `ops.experiment.guardrail.v1`
* 핵심 지표: `search_p95`, `ingest_to_incident_p95`, `error_rate`, `cache_hit_ratio`,
  `FP_rate`, `CQS_p95`, `exp_rollback_events`, `sample_balance`
* **SLO**: 결과 리포트 **≤ 24h**, 가드레일 위반 차단 **≤ 5m**, 샘플 불균형(bias) < 3%

### H. API/CLI(발췌)

* `POST /v1/exp/start { key, target, variants, traffic, duration, guardrails[] }`
* `GET  /v1/exp/status?key=...` — 진행/샘플 균형/가드레일
* `POST /v1/exp/stop { key, reason }` — 조기 종료/롤백
* `GET  /v1/exp/report?key=...` — 효과/유의성/권고(HTML/PDF)
* CLI: `plura exp start|status|stop|report`

### I. 운영 체크리스트

* [ ] **사전 파워 분석**으로 최소 기간 산정(무리한 조기결론 금지)
* [ ] 플래그/릴리스/알람 **타임라인 동기화**(코릴레이션 오판 방지)
* [ ] 가드레일·SLO 위반 시 **즉시 차단 + RCA**
* [ ] 결과/권고를 **RFC/ADR**에 반영(승격·폐기 사유 기록)
* [ ] 반복 학습: 성공 실험은 표준 설정에 반영, 실패는 지식베이스에 사례화

---

4. **예시 설명 (검색 캐시 TTL 30s→90s — 36시간 내 결론)**

1) `search_cache_ttl_90s` A/B 실험 시작(KR, 엔터프라이즈 테넌트, 50:50).
2) 8시간 경과: 가드레일 OK, Edge/Origin 정상.
3) 24시간: `search_p95` **−11% (p=0.014)**, `cache_hit_ratio` **+18%p**, `CQS_p95` **−12%**. FP율 변화 **+0.1%p(비유의)**.
4) 36시간 리포트 자동 발행: **승격 권고**(KR→JP 확장), 롤백 키/되돌리기 경로 포함. ADR 갱신 후 `ttl=90`을 **stable** 설정으로 채택.
   → 결과: **A/B 실험 표준**과 **가드레일** 덕분에 성능·비용을 개선하면서 위험은 통제되고, 결정은 **근거·재현** 가능한 형태로 빠르게 수렴.
