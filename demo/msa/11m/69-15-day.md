# 필상 시스템 — Day 69 커넥터/앱 마켓플레이스(Integrations) 프레임워크 · 샌드박싱 · 심사/버전 관리

1. **날짜**

* 2024-11-15

2. **목표**

* 티켓/ITSM/SIEM/SOAR/메시징/데이터소스 연동을 위한 **공식 커넥터 프레임워크** 표준 확정
* **보안 샌드박스(WASM/분리 네트워크)**·**권한 스코프**·**심사/버전/성능 SLO**로 **연동 리스크 0건**, **개발→배포 리드타임 50%↓**

---

3. **내용**

### A. 아키텍처(개요)

* **Connector Host**(관리형 실행기) ← **커넥터 패키지**(WASM 또는 Sidecar)
* **Permission Broker**: 스코프(예: `incidents:read`, `notify:send`, `obj:presign`) 평가·발급
* **Secrets/KMS(STS)**: 정적 비밀 금지, 커넥터는 **STS 단명** 자격만 사용(Day 52)
* **Network Policy**: **Egress 화이트리스트**(등록 도메인만), 교차 리전 통신 금지

### B. 커넥터 패키지 규격

```
connector/
  manifest.yaml        # 메타/권한/이벤트/레이트
  wasm.wasm           # 또는 sidecar image
  schema/inputs.json  # 유효성 규칙
  schema/outputs.json # 매핑 정의
  tests/*.json        # 계약 테스트 케이스
```

* **manifest.yaml(예)**

```yaml
name: jira-cloud
version: 1.3.0
scopes: [ "incidents:read", "notify:send" ]
egress:
  - https://api.atlassian.com
rate:
  burst: 10/min
  sustained: 100/h
events:
  consumes: [ "incident.changed.v1" ]
  produces: [ "ticket.created.v1" ]
```

### C. 실행·샌드박스

* **WASM 우선**: CPU/메모리/파일·시간 제한(예: 300ms/호출, 128MB), 호스트 API만 호출 가능
* **Sidecar(예외)**: 대형 SDK 필요 시 컨테이너 격리 + AppArmor/SELinux + read-only FS
* **보안 가드**: 민감 헤더 제거, **서명 링크**만 허용(원본 로그 직접 전송 금지), DLP 룰 적용

### D. 권한·승인 흐름

1. 마켓에서 커넥터 설치 요청 → **Consent 화면**에 스코프/목적 표시
2. 테넌트 OWNER/ADMIN 2인 승인(고위험 스코프)
3. **STS 토큰** 발급(최대 60m), 만료·회수 이벤트는 `security.audit.v1` 기록
4. 범위 축소/해지 가능(`PATCH /v1/connectors/{id}:revoke`)

### E. 개발→심사→배포

* **개발**: 샌드박스 키로 로컬 실행(`plura conn dev …`) + 계약 테스트 통과
* **심사(Review)**: SBOM/서명(Cosign), 정적 스캔(trivy), 규정 준수 체크(주권/Egress/스코프)
* **스테이징 배포**: KR-stg 5%→25%→100% → **프로덕션**(KR→JP)
* **버전 관리**: `approved`/`deprecated`/`sunset` 상태, Sunset 90일 전 알림

### F. 상호운용 & 매핑

* **이벤트 매핑**: 입력(`incident.changed.v1`) → 외부 API 필드 매핑(템플릿)
* **오류 표준화**: `error.code`(`CONN_AUTH`, `CONN_RATE`, `CONN_SCHEMA`) + `retry_after`
* **재시도/백오프**: 10s→1m→5m→30m, 실패는 `connector.dlq`로 이동(재생 가능)

### G. 관측·SLO

* **SLO**: 호출 성공률 ≥ 99.0%, p95 처리시간 ≤ 800ms(WASM)/≤ 1500ms(Sidecar)
* 지표: `conn_calls_total`, `success_rate`, `latency_p95`, `rate_limit_hits`, `dlq_size`, `egress_denies`, `scope_uses`
* **경보**: `success_rate < 97% (15m)` 또는 `egress_denies>0` → **T1** + 자동 차단

### H. 마켓플레이스 UX/거버넌스

* **카탈로그 카드**: 설명/권한/리전/평가/최근 릴리스 노트
* **테넌트 제한**: 리전별 가용성·데이터 주권 배지 표기(KR/JP 별도)
* **자동 업데이트**: 패치 버전 자동, 마이너 이상은 승인 필요
* **리뷰 정책**: 보안/성능/지원 SLA(중요 커넥터는 24×7 핫라인)

### I. API/CLI(발췌)

* `GET  /v1/connectors` — 목록/상태/버전
* `POST /v1/connectors/install { id, scopes[] }` — 설치+승인
* `PATCH /v1/connectors/{id}:revoke` — 스코프 축소/해지
* `GET  /v1/connectors/{id}/metrics` — 지표/상태
* CLI: `plura conn dev|test|publish|install|revoke`

### J. 체크리스트

* [ ] WASM 우선, Sidecar는 예외 사유 기록
* [ ] 스코프 최소화·목적 바인딩 명시, STS 60m 이하
* [ ] Egress 화이트리스트·주권 준수(교차 리전 금지)
* [ ] 계약 테스트/샌드박스 실행/정적 스캔/SBOM·서명 필수
* [ ] SLO·지표 대시보드와 경보 설정, Sunset 90일 알림

---

4. **예시 설명 (Jira Cloud 커넥터 — 40분 내 안전 설치·연동)**

1) 마켓에서 **Jira Cloud** 선택 → 스코프 `incidents:read`, `notify:send` 동의(2인 승인).
2) 설치 후 `incident.changed.v1(open)` 이벤트 수신 → 티켓 생성 API 호출(p95 620ms), 티켓 ID를 사건에 역주입.
3) DK/레이트 오류 3회 발생 → 자동 백오프·재시도, 성공률 99.3% 유지, DLQ 0.
4) 하루 후 패치 1.3.1 자동 적용(서명 검증) — 지표 정상, Sunset 예정 알림 없음.
   → 결과: **샌드박스·권한·심사·SLO**가 내장된 프레임워크로 서드파티 연동을 **안전·신속·예측 가능**하게 운영.
