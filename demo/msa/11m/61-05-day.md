# 필상 시스템 — Day 61 CDN/엣지 캐싱·오리진 페일오버·실시간 엣지 로그 수집

1. **날짜**

* 2024-11-05

2. **목표**

* **CDN(CloudFront/Cloudflare/NGINX-Cache)** 기반 **엣지 캐싱·보호(Shield/Bot)·오리진 페일오버** 표준 확정
* **실시간 엣지 로그**를 인입 파이프라인에 결합해 **가용성↑, 지연 p95 ≤ 300ms, 오리진 실패 시 복구 ≤ 60s** 달성

---

3. **내용**

### A. 아키텍처(개요)

```
Client → Anycast DNS → CDN Edge(Shield/Bot/PoP Cache)
                   ├─ Primary Origin: HAProxy → Nginx(API/WAF) → Apps
                   └─ Failover Origin: HAProxy(standby) → Nginx → Apps(stg-readonly or warm)
            ↘ Edge Log Stream → Kinesis/Logpush → Ingestor(kr/jp)
```

* **리전 분리**: KR/JP 각각 독립 CDN 배포(교차 지역 오리진 금지).
* **Shield & Bot**: L3/4 흡수 + L7 Bot Score, Day 44 정책과 연동.

### B. 캐싱/정책(표준)

* **경로 정책**

  | 경로                |  캐시 | TTL            | 주의사항                                                 |
  | ----------------- | --: | -------------- | ---------------------------------------------------- |
  | `/assets/*`       |  on | 7d (immutable) | ETag/Cache-Control `public,max-age=604800,immutable` |
  | `/console/*`      |  on | 1–5m           | Stale-While-Revalidate 60s, Auth 헤더 무시               |
  | `/v1/search`      |  on | 15–90s         | 파라미터 해시 기반, Saved Query만                             |
  | `/v1/incidents/*` | off | -              | 개인정보·권한 확인 필요                                        |
* **변형(Vary)**: `Vary: Accept-Encoding, Authorization?0, Cookie?0, X-Region`
* **Key 규칙**: `key = scheme + host + path + normalized_query(allowlist)`
* **서명 URL**: 증거/다운로드는 **캐시 금지**, `Cache-Control: no-store`, 만료 10분.

### C. 오리진 페일오버(60s 이내)

* **헬스체크**: `/healthz` 2/3 실패 또는 p95 지연>800ms 60s 지속 → **Failover**
* **상태별 동작**

  * **읽기형 API**: Failover 오리진 활성화(읽기/검색 전용)
  * **쓰기형 API**: 503 with `Retry-After: 30`, 클라이언트 재시도( Day 60 SDK 규칙 )
* **원복**: Primary 5분 안정(p95<600ms, 5xx<0.5%) 확인 후 트래픽 25%→100% 단계 복귀

**CloudFront 예시(요약)**

```json
"OriginGroups": {
  "Items": [{
    "Id": "api-group",
    "FailoverCriteria": {"StatusCodes": {"Items": [500,502,503,504]}},
    "Members": [{"OriginId":"primary-api"}, {"OriginId":"failover-api"}]
  }]
},
"DefaultCacheBehavior": {
  "ViewerProtocolPolicy": "https-only",
  "Compress": true,
  "CachePolicyId": "Managed-CachingOptimized",
  "OriginRequestPolicyId": "AllViewerExceptHostHeader"
}
```

### D. 엣지 로그 스트리밍 → 인입 파이프라인

* **소스**: CloudFront Realtime Logs / Cloudflare Logpush(JSONL)
* **전송**: Kinesis/HTTP → `ingest.log.v1` 매핑(필수 필드: `edge_location, edge_result, bot_score, tls_ja3, cache_status`)
* **정규화**: `cache_status=HIT|MISS|EXPIRED|BYPASS`, `bot_score`(0–100), `edge_latency_ms`, `origin_latency_ms`
* **활용**:

  * 검색/콘솔 SLO 대시(Edge/Origin 분리 시계열)
  * DBV360에 **정상혼재 판단** 보조(Edge MISS 대비 200/406 비율)
  * Day 56 상관 규칙의 **유지보수 창(MW) 자동 억제** 근거로 사용

### E. 보안/가드레일

* **mTLS 오리진** + `X-Forwarded-For` 실IP 복원(프록시 체인 검증)
* **서명 쿠키/헤더** 화이트리스트(민감 헤더 제거)
* **Egress 화이트리스트**: CDN→오리진, 오리진→외부 호출 제한
* **정책**: CDN 캐시 키에 PII/토큰 포함 금지, 관리자 콘솔은 `no-cache`

### F. SLO & 지표

* **사용자 체감**: Edge p95 **≤ 300ms**, Origin p95 **≤ 800ms**
* **가용성**: Edge 99.99%, Origin 99.9%, **Failover 전환 ≤ 60s**
* **캐시 효율**: `cache_hit_ratio ≥ 70%`(정적), `≥ 40%`(검색), `bot_block_rate` 추적
* **지표**: `edge_requests`, `edge_errors`, `origin_5xx`, `failover_events`, `cache_status_*`, `bot_score_hist`

### G. 운영/런북(핵심)

1. **캐시 폭주/정책 오류**: `cache_bypass↑` → Key/Headers 검사 → Allowlist 수정 → 즉시 Invalidate
2. **오리진 장애**: Failover 발동 확인 → 쓰기 API 일시 억제/큐잉 → Primary 복구/원복
3. **봇 트래픽 급증**: Bot Score 임계 상향 + PoW(CF Turnstile 등) 활성 → Edge HIT 유지율 확인
4. **로그 지연**: Kinesis/DLQ 확인 → 재생(배수 0.5×) → 인덱스 적재율 확인

### H. API/자동화

* `POST /v1/cdn/invalidate { path, region, scope:"assets|console|search" }`
* `GET  /v1/cdn/metrics?region=kr&window=5m`
* `POST /v1/cdn/failover:trigger { origin_group, reason }` (테스트용)
* `POST /v1/ingest/edge-logs` (서명 HMAC, 배치 JSONL)

---

4. **예시 설명 (KR Origin 장애 — 41분 내 복구, 사용자 p95 290ms 유지)**

1) KR 오리진 HAProxy 5xx 급증 → CloudFront **Failover** 38초 내 전환, Edge HIT 78% 유지.
2) 쓰기형 `/v1/incidents` 503+재시도 안내, 큐 적체 없이 보존.
3) 인프라 복구 후 Primary p95 520ms/5xx 0.2%로 안정 → 25%→100% 원복(3단계, 7분).
4) 전체 구간 사용자 p95 **≤ 290ms**, 증거: Edge/Origin 분리 대시 + Realtime Logs EPKG.
   → 결과: **엣지 캐싱·자동 페일오버·로그 스트림** 결합으로 장애 시에도 체감 성능과 가용성을 유지하고, 증거 기반 운영을 보장.
