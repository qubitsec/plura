# 필상 시스템 — Day 75 엔터티 그래프(Threat Graph) · 관계 상관 · 피벗 분석

1. **날짜**

* 2024-11-25

2. **목표**

* **IP/호스트/계정/프로세스/파일/규칙/사건/티켓/TI**를 **하나의 그래프**로 연결하여
  **피벗 분석(3-클릭)**·**캠페인(Cluster) 식별**·**공격 경로 시각화**를 표준화
* **주권/RLS/PII 마스킹**을 유지하면서 **그래프 질의 p95 ≤ 1.5s**, **클러스터링 10분 내 갱신** 달성

---

3. **내용**

### A. 엔터티/관계 스키마(요약)

* **노드(Entity)**

  * `IpBucket`(`/24`), `Host`(FQDN), `Account`(hash된 user), `Process`(Image+Signer),
    `File`(sha256), `Incident`(id), `Rule`(id/ver), `TI`(indicator), `ASN`, `Campaign`(유사 이벤트 그룹)
* **엣지(Relation)**

  * `CONNECTS_TO`(IpBucket→Host), `RESOLVES`(Host→IpBucket), `TRIGGERED_BY`(Incident→Rule),
    `EXECUTES/DROPS`(Process↔File), `BELONGS_TO`(IpBucket/Host/Incident→Campaign),
    `RELATED_TI`(Entity→TI), `ASSOCIATED_ACCOUNT`(Incident↔Account)
* **공통 속성**: `tenant_id, region, ts_first, ts_last, weight, source`
* **주의**: **원 IP/계정원문 금지**—모든 식별자는 버킷/해시/서명 기준( Day 57·71 정합)

### B. 적재 파이프라인

```
Ingest(Log/EDR/TI) → Normalizer(param/ip_bucket 등)
  → Graph ETL(증분·Upsert) → Graph Store(Neo4j/Janus/AGE) + Cache(Sorted-Set)
  → Clusterer(5~10m 배치: Louvain/Label Propagation) → Campaign 노드 업데이트
```

* **RLS/주권**: 그래프 파티션(`region/tenant`) 분리, 질의 시 `tenant_id` 필터 강제
* **정합성**: 이벤트 ULID 타임라인 보존, `weight`는 빈도/최근성 가중치로 산정

### C. 핵심 질의(템플릿)

1. **피벗: 동일 캠페인 영향 호스트 Top-N**

```cypher
MATCH (c:Campaign {id:$camp})<-[:BELONGS_TO]-(i:Incident)-[:TRIGGERED_BY]->(r:Rule)
WHERE i.tenant_id=$tenant AND i.region=$region
RETURN i.dst_host AS host, COUNT(*) AS cnt, COLLECT(DISTINCT r.id)[0..5] AS rules
ORDER BY cnt DESC LIMIT 20;
```

2. **연쇄 경로: Account → Process → File → TI**

```cypher
MATCH (a:Account {hash:$uhash})-[:ASSOCIATED_ACCOUNT]-(i:Incident)
MATCH (i)-[:RELATED_TI]->(t:TI)
OPTIONAL MATCH (i)-[:EXECUTES]->(p:Process)-[:DROPS]->(f:File)
RETURN i.id, p.image, f.sha256[0..8] AS file8, t.name, t.score
ORDER BY i.ts_last DESC LIMIT 50;
```

3. **C2 인프라 축: ASN 중심 허브**

```cypher
MATCH (asn:ASN {id:$asn})<-[:IN_ASN]-(ip:IpBucket)<-[:RESOLVES|CONNECTS_TO]-(h:Host)
MATCH (h)<-[:CONNECTS_TO]-(src:IpBucket)
RETURN h.fqdn AS c2, COUNT(*) AS deg, COLLECT(DISTINCT src)[0..5] AS src_buckets
ORDER BY deg DESC LIMIT 10;
```

### D. 클러스터링/캠페인 규칙

* 알고리즘: **Louvain(모듈러리티)** 기본, **시간 가중(최근 7일↑)**, **룰/시그니처 유사도** 결합
* **캠페인 승격 조건**: 모듈러리티 ≥ 0.45, 노드수 ≥ 30, 24h 지속, 다중 테넌트 히트(동일 리전)
* **명명 규칙**: `CAMP-YYYYMMDD-<top_rule>-<asn|tld>`

### E. 성능·캐시·가드레일

* **SLO**: 읽기 p95 **≤ 1.5s**, 클러스터링 배치 **≤ 10m**, 증가분 병합 **≤ 60s**
* **캐시**: 핫 캠페인/노드 Top-K를 **Key-Value**에 인덱싱, 그래프 앞단 **결과 캐시 60–180s**
* **가드**:

  * 경로 길이 `≤ 6`, 팬아웃 한계(각 단계 최대 500)
  * 교차 리전/테넌트 **deny**, 원문 PII 입력 차단(OPA)
  * 대형 질의는 **오프피크**·백그라운드 렌더(이미지/도식은 서명 URL로 제공)

### F. 콘솔 UX

* **피벗 패널**: 노드 클릭 → 연결 엣지/근거(샘플 10건 링크) → “DBV360 판정”·“룰 델타 초안” 바로가기
* **캠페인 카드**: 핵심 규칙/ASN/TLD·증가율·테넌트 분포·Top 호스트/URI 시그니처
* **경로 뷰**: `Account→Incident→Process→File→TI` 시퀀스/시간축, EPKG 링크 표시

### G. 관측·지표

* `graph_query_p95`, `graph_cache_hit`, `campaign_count`, `avg_degree`,
  `pii_violation=0`, `rls_denies`, `cluster_runtime`, `merge_lag`
* 경보: `pii_violation>0` 또는 `cluster_runtime>15m`(지속) → T1

### H. API/자동화(발췌)

* `GET /v1/graph/pivot?entity=incident&id=...` — 피벗 결과(보안 필터 적용)
* `GET /v1/graph/campaigns?range=7d&tenant=...` — 캠페인 목록
* `POST /v1/graph/cluster:run { range, region }` — 수동 클러스터링(오프피크)
* `GET /v1/graph/path?from=account:...&to=ti:...&max_hops=6` — 경로 검색
* `GET /v1/graph/metrics` — 런타임/품질 지표

### I. 운영 체크리스트

* [ ] 그래프 파티션(RLS/주권) 및 PII 차단 규칙 **CI 테스트**
* [ ] 클러스터링 파라미터(시간 가중/임계) 월 1회 검토
* [ ] 핫 캠페인 캐시·대시보드 카드 성능 점검(p95≤1.5s)
* [ ] 콘솔 피벗→DBV360→룰 델타 **3-클릭 동선** 검증
* [ ] EPKG 링크·증거 샘플(서명 URL) 누락 0건

---

4. **예시 설명 (ko 검색어 기반 오탐 캠페인 분리 — 28분 내 근거 확정)**

1) Louvain 결과에서 `CAMP-20241125-941100-kr` 생성—`/search`·`param_sig="ko_search"` 중심 히트.
2) 피벗으로 **동일 IP 버킷의 200/406 혼재**와 TI 저위험 확인 → DBV360 자동 트리거.
3) 28분 내 **오탐 캠페인**으로 분류, 룰 델타(한국어 검색 파라미터 완화) 생성→KR-stg Canary.
4) 캠페인 카드에 영향 테넌트/호스트/규칙 요약, RCA와 함께 릴리스 노트 연결.
   → 결과: **그래프 피벗+캠페닝**으로 다수 사건의 **공통 근거**를 빠르게 도출, **정탐률 유지·노이즈 감소**를 동시에 달성.
