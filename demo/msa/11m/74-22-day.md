# 필상 시스템 — Day 74 테넌트 데이터 Export/연동(Report/BI/SIEM) 표준 · 스케줄 · 서명/주권 가드

1. **날짜**

* 2024-11-22

2. **목표**

* 테넌트가 **자체 BI/SIEM/저장소**로 안전하게 **데이터 Export**(레포트·CSV/JSON/Parquet·API 스트림)를 수행하도록 표준화
* **주권(RLS)·서명 URL·쿼터/과금( Day 22/72 )** 가드와 **스케줄/증거화**를 결합해 **보안·성능·비용**을 동시에 만족

---

3. **내용**

### A. Export 범위/형식(권장)

* **레포트**: PDF/HTML/CSV(요약 지표·Top-N·타임라인)
* **데이터 덤프**: CSV/NDJSON(운영 분석), Parquet(대용량/BI)
* **스트림**: Webhook(서명 HMAC)·Kafka(테넌트 전용 토픽)
* **테이블/뷰 원천**

  * `incidents_{region}`(요약) / `logs_raw_*`(시그니처 필드만) / `events_detect_*` / `ti_cache_*`
  * Lakehouse( Day 71 )의 `*_lake_view`(RLS 적용 뷰) 우선

> 원칙: **PII 원문 금지**(IP는 `ip_bucket`, 파라미터는 `param_sig`), **교차 리전 금지**, RLS 강제.

### B. 요청 모델 & 스케줄

```json
{
  "tenant":"TEN_kr_x",
  "region":"kr",
  "format":"parquet|csv|ndjson|pdf",
  "source":"incidents|logs|lake",
  "query":"saved:{key=csirt_weekly}|raw:{q=...,fq=...,rows=...}",
  "schedule":{"cron":"0 9 * * MON","timezone":"Asia/Seoul"},
  "delivery":{"type":"s3","bucket":"tenant-export-kr","prefix":"weekly/"},
  "retention_days":30,
  "purpose":"customer_report"
}
```

* **스케줄**: 테넌트 타임존 기준, **Maintenance Window**와 충돌 시 자동 지연( Day 56 )
* **한도**: 동시 실행 ≤ N(플랜별), 쿼리 `max_scan_bytes`/`max_rows` 준수( Day 71 )

### C. 보안/주권/감사 가드

* **RLS/주권**: 토큰의 `tenant/region`을 게이트웨이가 강제 주입(교차 리전 **deny**)
* **서명 URL**: 10분 만료, 1회용(Nonce 캐시), 다운로드 **워터마크**(tenant/actor/time)
* **서명 헤더(Webhook/Kafka)**: `X-Plura-Signature: v1=HMAC-SHA256(body, secret)`
* **감사**: `export.requested/started/completed/downloaded` 이벤트를 **해시체인**으로 고정(EPKG-Export)

### D. 성능/비용 가드

* **쿼터 연동**: `export_scan_bytes`, `export_rows`, `export_jobs`를 **Quota/FinOps**에 누적( Day 29/72 )
* **리소스 보호**: 장기 쿼리는 **오프피크** 실행, 결과는 **Result Cache(5–15m)** 재사용
* **압축/분할**: CSV/NDJSON → **zstd** 압축, Parquet → 128MB RowGroup, **객체 512MB 이하**로 분할
* **재시도/중단복구**: 청크 단위 체크포인트, 실패 조각만 재시도

### E. 템플릿(저장 쿼리) 우선

* **Saved Query/Report** 키 기반 Export를 우선(성능/보안 가드 내장)
* **Raw 모드**는 **승인 2인** + 샌드박스 테스트 통과 시 허용(파라미터 화이트리스트)

### F. 커넥터/전달 경로

* **S3/MinIO**: 테넌트 소유 버킷에 Put(서명/KMS), 또는 **서명 URL 제공**
* **SIEM/SOAR**: Splunk HEC/Elastic Ingest API(서명·RLS), 커넥터 프레임워크( Day 69 ) 사용
* **Webhook**: 배치 JSONL + HMAC 서명(5분 시계 윈도우), 실패는 **DLQ → 재생**

### G. 실패/예외 처리

* **PII/정책 위반**: 즉시 **Fail** + 알림, 샘플·정책 불일치 항목 EPKG에 첨부
* **한도 초과**: 소프트 스로틀(샘플링·기간 축소), 지속 시 **하드 차단** + 업그레이드 가이드( Day 72 )
* **리전 충돌**: 다른 리전 목적지 지정 시 거부(주권), 올바른 리전 버킷 안내

### H. 관측·SLO

* **SLO**: 성공률 ≥ 99.0%, 완료 시간 p95 ≤ 15m(레포트) / ≤ 60m(대용량 Parquet 200GB 기준)
* 지표: `export_jobs_running`, `export_bytes`, `cost_per_export`, `policy_denies`, `download_latency_ms`
* **경보**: `policy_denies>0` 또는 `cost_per_export` p95↑ → CS/CSIRT 티켓

### I. API/CLI(발췌)

* `POST /v1/export/jobs { ... }` — 생성(검증·승인 포함)
* `GET  /v1/export/jobs/{id}` — 진행/로그/서명 링크
* `POST /v1/export/jobs/{id}:cancel` — 취소(데이터 파기)
* `POST /v1/export/templates/run { key, params, delivery }` — 템플릿 즉시 실행
* CLI: `plura export create|status|cancel|download`

### J. 운영 체크리스트

* [ ] Saved Query/Report 기반 우선, Raw는 2인 승인·샌드박스 필수
* [ ] RLS/주권/서명 URL·워터마크 정상 동작 확인
* [ ] 쿼터·비용 지표 대시보드 연동 및 한도 알림 활성화
* [ ] 실패/부분 성공 시 **재시도 청크**만 수행(비용 절감)
* [ ] 템플릿/리포트는 i18n(ko/ja/en)·시각 회귀 테스트 포함

---

4. **예시 설명 (주간 CSIRT 레포트 + Parquet 덤프 — 41분 내 완료)**

1) `saved:CSIRT-Weekly` 템플릿 실행(범위: 최근 7일) + **Parquet 덤프**(incidents/logs 요약) 동시 요청.
2) 스케줄러가 **오프피크**에서 병렬 실행(테넌트 RLS·주권 통과), 결과는 `tenant-export-kr/weekly/`에 업로드.
3) PDF/CSV 레포트는 9분 내, Parquet 120GB는 41분 내 완료. **서명 URL(10분)** 배포 + 워터마크 적용.
4) 콘솔 대시보드에 비용/스캔 바이트/다운로드 이벤트 기록, EPKG-Export가 감사 인덱스에 고정.
   → 결과: **Export 표준+가드**로 고객 BI/SIEM 연동이 **안전·예측 가능**해지고, 비용·성능·주권을 모두 만족하는 **자급형 데이터 액세스**가 실현된다.
