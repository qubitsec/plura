# 필상 시스템 — Day 77 피크 트래픽 대비 체계(블랙프라이데이/연말) · 변경 동결 · 용량/품질 게이트

1. **날짜**

* 2024-11-27

2. **목표**

* 블랙프라이데이/연말 성수기 **피크 10× 트래픽**을 안정 흡수하기 위한 **변경 동결(Change Freeze)·용량 점검·품질 게이트** 표준 확정
* **가용성 99.99%**, **엔드투엔드 지연 p95 ≤ 800ms**, **롤백 5분 내** 달성

---

3. **내용**

### A. 기간/범위(Freeze 정책)

* **동결 기간**: 11/28 00:00 KST ~ 12/02 09:00 KST (KR) / 11/28 00:00 JST ~ 12/02 09:00 JST (JP)
* **허용 변경(L1만)**: 문구/UI 사소 변경, 룰/플래그 **값 조정(되돌리기 키 보유)**, 운영 스크립트 안전 패치
* **금지**: 스키마/인덱스/검색 파라미터 구조 변경, 배포/릴리스(L2/L3), 커넥터 신규 설치, 차단 룰 신규 On

### B. 용량·성능 리허설(최소 72h 전 완료)

* **부하 모델**: 인입 10×, 검색 QPS 6×, 알림 4×(버스트 60s)
* **목표**: 브로커/인덱스/메타DB/오브젝트 PUT **에러율 < 0.5%**, 큐 적체 0, DLQ 증가율 < 0.2%
* **체크리스트**

  * Kafka: 파티션/ISR 점검, `acks=all`, 토픽 보존/컴팩션 설정 확인
  * Solr: 캐시 사이즈/DocValues/핫샤드 분리, 코어 헬스/리더 전환 테스트
  * Meta-DB: 파티션 프리생성, VACUUM/REINDEX 일정 조정(동결 기간 제외)
  * CDN: 캐시 키/TTL 재검토, Origin Failover 연습(읽기 전용 경로 확인)

### C. SLO/품질 게이트(Freeze 중 적용)

* **게이트 실패→자동 조치**

  * `ingest→incident p95 > 15s(5m)` → 샘플링/필드 축약 On (Day 72)
  * `search p95 > 800ms(5m)` → 템플릿 전용/TTL 90s/Expensive Query 차단 (Day 73)
  * `notify p95 > 10s` or 실패율 > 1% → 디듀프 확대/채널 우선순위 적용 (Day 56)
* **롤백 기준**: 성능/안정 저하 유발 플래그/룰은 **되돌리기 키** 즉시 실행, 5분 내 복귀

### D. 운영 조직·온콜(확대 편성)

* **SRE 온콜**: 리전별 Primary/Secondary + DB/검색 전담
* **CSIRT**: FP/미탐/오탐 캠페인 급증 대응, DBV360 티켓 SLA 강화(15m)
* **상태페이지**: 공지 배너(성수기 모드), 업데이트 간격 S1=15m/S2=30m 유지(ko/ja/en)

### E. 트래픽 제어·완화(실행 플래그)

* 게이트웨이 레이트리밋 상향/하향 플래그 `gateway.rate.scale` (0.5–2.0)
* 검색 캐시 강제 `search.cache.force_ttl=90s`
* 알림 합성/요약 `notify.aggregate=true` (캠페인 단위 1건)
* CDN PoW/Captcha 토글 `edge.pow.enable=true` (Day 44 연동)

### F. 데이터·증거 보전(무결성)

* EPKG evidence 버킷 **WORM/버전닝** 점검, **MFA Delete** 활성 재확인 (Day 64)
* 감사/결정 로그 해시체인 루트 고정(일 1회), **Export/Erasure** 작업은 동결(긴급 예외만)

### G. 커뮤니케이션/리스크 관리

* **고객 공지**: 성수기 모드/지원 채널/지연 가능성(최소) 안내, PoC/ENT 테넌트 1:1 연락
* **변경 캘린더 잠금**: L2/L3 PR 자동 차단, CAB 승인 체인 **비활성**
* **사전 RCA 템플릿** 준비: 성능 저하/과금 스파이크/오탐 폭주 시나리오 3종

### H. 대시보드(피크 전용)

* 카드: `edge/origin p95`, `ingest_rps`, `search_qps`, `cache_hit_ratio`, `dlq_size`, `quota_hit_rate`, `notify_success_rate`
* 배지: 릴리스/플래그/실험(MW) 타임라인, Anomaly 자동 완화 이벤트(ON/OFF)

### I. API/자동화(발췌)

* `POST /v1/freeze/enable { window, scope }` — 변경 동결 On/Off
* `POST /v1/ops/scale { key, factor }` — 레이트/캐시/PoW 등 스케일 조정
* `GET  /v1/peak/health` — 피크 지표 가드 상태(녹/황/적)
* `POST /v1/peak/rollback { key }` — 되돌리기 키 즉시 실행

### J. 운영 체크리스트

* [ ] 72h 전 리허설(10× 부하) 통과, 보고서 보관
* [ ] 모든 **되돌리기 키**·플래그 문서화, 콘솔 단축키 바인딩
* [ ] 온콜 캘린더/상태페이지/고객 공지 동기화
* [ ] 피크 중 알림 노이즈 40%↓(상관/디듀프/서프레션), MTTR 20%↓
* [ ] 피크 종료 후 **포스트모템**(24–48h 내), 튜닝/정책 반영

---

4. **예시 설명 (KR 검색 경로 과부하 — 17분 내 안정화, 사용자 p95 730ms 유지)**

1) 블랙프라이데이 오전, `search_qps 6.8×`, `p95=1.1s` 상승 → **품질 게이트 발화**.
2) 자동 조치: 템플릿 전용 + `rows≤200/facet≤50`, TTL 90s, Expensive Query 차단.
3) CDN PoW On, 캐시 적중률 +16%p → 11분 내 `p95=0.78s`.
4) 알림 합성으로 팬아웃 42%↓, DLQ 0 유지. 17분 시점 `p95=0.73s`, 오류율 0.3%.
   → 결과: **동결·리허설·가드레일**이 결합되어 피크 시간대에도 **가용성·성능**을 유지하고, 되돌리기·자동 완화로 **운영 리스크**를 체계적으로 제어.
