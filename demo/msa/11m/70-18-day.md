# 필상 시스템 — Day 70 검색 품질(Relevance) 표준: ko/ja/en 형태소 · 시그니처 기반 탐색 · 동의어/오탈자 · 성능 가드

1. **날짜**

* 2024-11-18

2. **목표**

* **ko/ja/en** 다국어 로그/사건 검색에서 **정확도·재현율**을 균형화하는 **분석기·동의어·오탈자·부스팅** 표준 확정
* **성능 가드**(p95 ≤ 800ms)와 **보안/주권**을 유지하면서 **분석가 3-클릭 내 근거 탐색** 달성

---

3. **내용**

### A. 컬렉션별 분석기(Analyzer) 전략

* **logs_raw_*/events_detect_***

  * 경로/파라미터: **Keyword + Lowercase + URLTokenizer** (정확 매치 우선)
  * `param_sig`/`uri_sig`: **N-gram(3)** 기반 인덱스 + `qf` 부스팅
  * `ua/ref`: Whitespace + Lowercase(보조 필드)
* **incidents_***

  * 텍스트 설명/태그: **언어별 형태소**

    * **ko**: OpenKoreanText(통합명사/불용어)
    * **ja**: Kuromoji(기본) + 사용자 사전(보안용어/벤더명)
    * **en**: Standard + Porter/Lowercase
  * 키 필드: `rule_id, incident_key, dst_host`는 **Keyword**(정확 매치)
* **ti_cache_***

  * 라벨/설명: Whitespace + Synonyms(보안 용어 집합), 스코어 필드는 수치정렬 전용

> 원칙: **원문(PII)은 인덱싱 금지**, `ip_bucket(/24)`·`param_sig`·`uri_sig` 등 **시그니처**만 인덱싱(주권/프라이버시).

---

### B. 질의 스키마 & 부스팅(qf/bq)

* **기본 쿼리 파서**: `edismax`
* **qf(필드 가중치)**

  * `param_sig^5 uri_sig^3 dst_host^2 rule_id^2 ua`
  * 사건 화면은 `incident_key^6 rule_id^4 tags_ss^2 description_txt`
* **bq(Boost Query)**

  * 최근성: `ts:[NOW-24HOURS TO NOW]^1.5`
  * 심각도: `severity:(crit OR high)^2`
  * TI: `ti_score:[70 TO *]^1.2`
* **pf(구문 부스팅)**: 사건 설명/태그에만 적용(ko/ja/en 각각)

---

### C. 동의어(Synonyms)·오탈자(Fuzzy)·토큰 정규화

* **보안 동의어 사전(공용)**

  * 예: `sql injection, sqli`, `command and control, c2`, `xss, cross site scripting`, `ko: 관리자 페이지=admin`
  * 관리: `synonyms/security-{lang}.txt`(월 1회 리프레시, CI 계약 테스트 포함)
* **오탈자 허용**

  * **길이≥5 토큰**에 한해 `fuzzy=1`(편집거리 1), 짧은 토큰은 **정확 매치**만
  * 성능 가드: Fuzzy가 걸린 조건은 **최대 2개 필드** 제한
* **정규화**

  * 유니코드 정준화(NFKC)·폭/반각 통일, 한자/가나 흔용어는 사용자 사전으로 보정(ja)

---

### D. 저장 쿼리 템플릿(고급 검색)

1. **오탐 의심(혼재 패턴)**

```yaml
key: q.fp_suspect
params:
  - {name: host, type: string, required: true}
  - {name: range, type: duration, default: "NOW-24HOURS TO NOW"}
template: |
  q=param_sig:("union_select" "or_1_eq_1") OR (uri_sig:"/search" AND status:406)
  fq=tenant_id:{TENANT} AND dst_host:${host} AND ts:[${range}]
  json.facet={ codes:{type:terms,field:status,limit:5}, blocked:{type:terms,field:blocked,limit:2} }
  rows=0
```

2. **C2 의심 도메인(다국어 동의어 매칭)**

```yaml
key: q.c2_suspect_multilang
params:
  - {name: tlds, type: list, default: ["top","xyz","live","work"]}
  - {name: range, type: duration, default: "NOW-6HOURS TO NOW"}
template: |
  q=(label_txt:(c2~ OR "command and control"~ OR "원격 제어"~ OR "C2") OR dst_host_tld:(${tlds}))
  fq=tenant_id:{TENANT} AND ts:[${range}]
  rows=0
```

3. **관리 콘솔 행위(ko/ja/en 형태소)**

```yaml
key: q.admin_console_behavior
params:
  - {name: range, type: duration, default: "NOW-1DAY TO NOW"}
template: |
  q=tags_ss:("admin" OR "관리자" OR "管理") OR description_txt:("룰 변경" OR "ルール 変更" OR "rule update")
  fq=tenant_id:{TENANT} AND ts:[${range}]
  rows=100&sort=ts desc
```

---

### E. 하이라이트/설명가능성(Explain)

* **하이라이트**: `hl=true&hl.fl=param_sig,uri_sig,description_txt&hl.simple.pre=<em>&hl.simple.post=</em>`
* **Explain 카드**: 상위 기여 필드/토큰 Top-5, 부스팅 항목(bq/pf) 표시(분석가 검증 지원)

---

### F. 성능·캐시·가드레일

* **성능 SLO**: 상위 5 템플릿 `p95 ≤ 800ms`, 샘플링 쿼리 `≤ 1.2s`
* **캐시**: 템플릿+파라미터 해시 기반 **15–90s** 결과 캐시(콘솔/엣지 양쪽)
* **가드**

  * `rows ≤ 200`, `facet.limit ≤ 50`, **Deep pagination 금지**(커서 기반)

.  

  * Fuzzy 사용 시 facet 금지(성능 보호)
  * 테넌트/리전 `fq` **강제 주입**(게이트웨이), 교차 리전 조회 **deny**

---

### G. 관리/운영

* **사전/동의어/분석기 버전**: `relevance-{lang}-vN`(릴리스 노트 의무)
* **회귀 테스트**: 7·30·90일 리플레이, **Hit@K / MRR / NDCG** 지표로 비교
* **품질 대시**: 쿼리 성공률, p95 지연, 캐시 적중률, Fuzzy 이용률, FP 의심 비중
* **지식화**: “질의→증거→DBV360 판정” 링크 자동 저장(3클릭 동선)

---

### H. API/자동화(발췌)

* `POST /v1/search/saved/{key}:execute` — 템플릿 실행(파라미터 검증/가드 적용)
* `POST /v1/search/relevance/test { suite: "nightly" }` — 회귀 스위트 실행
* `POST /v1/search/synonyms/apply { lang, version }` — 동의어 갱신(검증 후 롤아웃)
* `GET  /v1/search/explain?trace=true` — 부스팅/기여 토큰 리포트

---

### I. 체크리스트

* [ ] **시그니처 우선**(param/uri_sig), PII 금지·주권 준수
* [ ] ko/ja/en 형태소/사전 최신화, 사용자 사전(벤더/약어) 반영
* [ ] Fuzzy 제한·캐시 적용으로 성능 SLO 준수
* [ ] Hit@K/MRR 회귀 지표 녹색일 때만 프로덕션 롤아웃
* [ ] Explain 카드와 3-클릭 동선(검색→증거→판정) 검증

---

4. **예시 설명 (ko/ja 혼합 로그 — 오탐 1.6%p↓, p95 0.74s 유지)**

1) `relevance-koja-v3` 롤아웃: `param_sig` N-gram 강화 + ko/ja 동의어 사전 갱신.
2) 24h 회귀: `Hit@10 +7.9%p`, 오탐 의심 비중 **1.6%p↓**, 캐시 적중률 **+12%p**.
3) Fuzzy 비율 3.2%로 제한, p95 **0.74s**(SLO 충족).
4) 분석가는 Explain 카드로 **기여 토큰**을 확인하고 DBV360 판정을 신속히 검증.
   → 결과: **형태소·동의어·시그니처·가드레일** 조합으로 다국어 환경에서도 **정확·재현·성능**을 모두 만족, “3-클릭 근거 탐색”을 안정화.
