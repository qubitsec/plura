# 필상 시스템 — Day 63 엔드포인트 하드닝 베이스라인(CIS) · 구성 드리프트 감지/교정 · 감염 저항성

1. **날짜**

* 2024-11-07

2. **목표**

* **Windows/Linux(서버/워크스테이션)** 공통 **하드닝 베이스라인** 확정(CIS/L1+α)
* **드리프트 감지→자동 교정→증거화** 표준으로 **취약 구간 0건**, **평균 교정 ≤ 15분** 달성

---

3. **내용**

### A. 범위/원칙

* **범위**: OS 보안 옵션, 서비스/포트, 인증/잠금, 로깅/감사, 브라우저/스크립트 실행 정책, 업데이트/서명 강제
* **원칙**: “**기본 거부(default-deny)**·**최소권한**·**불변 이미지 + 가변 정책**·**가시성/감사 100%**”
* **적용 구분**: `desktop-curated` / `server-curated` / `strict(high-risk)` 세트

### B. 베이스라인(요약 체크리스트)

**공통(Win/Linux)**

* 계정/인증: MFA 필수(관리계정), **잠금 정책**(5회/15분), 비활성 계정 자동 잠금(30일)
* 원격접속: RDP/SSH는 **Bastion/JIT**만, 직접 노출 금지. SSH는 `PasswordAuthentication no`, `AllowUsers=svc-*` 화이트리스트
* 서비스/포트: 불필요 데몬 제거, LLMNR/NetBIOS/SMBv1 비활성(Win), NFS/FTP 비활성(Lin)
* 로그/감사: **Sysmon + OS 감사** 활성, **원격 전송**(리전 로컬), **시간 동기화**(NTP, drift 알림)
* 실행 차단: **LOLBAS/GTFOBins** 실행 가드(정책 기반 허용목록), 매크로/스크립트 서명 강제
* 업데이트: 자동 패치 윈도우/재부팅 정책, 드라이버/커널 **서명 강제**

**Windows(추가)**

* Defender ASR 룰 Core On, LSASS 보호(Protected Process Light), **LAPS** 적용
* WDAC/Applocker: `publisher + path` 조합 허용목록, **감사→차단 단계적 전환**
* RDP: 네트워크 레벨 인증(NLA), 클립보드/드라이브 리다이렉션 차단(역할별 예외)

**Linux(추가)**

* SSH: `PermitRootLogin no`, `ClientAliveInterval 300/CountMax 2`, `Ciphers/ MACs` 최신군
* 커널 하드닝: `fs.protected_* = 1`, `kernel.kptr_restrict = 2`, `kernel.unprivileged_bpf_disabled = 1`
* 패키지: 서명 리포만 허용, 자동 제거(`unattended-upgrades`/`dnf-automatic`)

### C. 드리프트 감지·교정(표준 파이프라인)

* **선언**: `baseline/*.yaml` (플랫폼·프로파일별 키-값 정책, 증거 쿼리 포함)
* **에이전트**: Ansible Pull/OSQuery(질의) + Windows는 Intune/PowerShell DSC, Linux는 Ansible/CSI
* **주기**: 감시 5분, **허용 편차**(유예 10분) 이후 **자동 교정(Remediation)**
* **증거화**: `host_id, drift_keys[], before/after, actor=auto, ts, prev_hash` → 감사 인덱스 고정
* **예외 관리**: `owner, scope, ttl` 필수(만료 전 알림), 예외는 **Strict에서만** 제한적 허용

### D. 샘플 정책 스니펫

```yaml
profile: server-curated
rules:
  - key: ssh.password_auth
    query: osquery: "SELECT value FROM ssh_configs WHERE key='PasswordAuthentication'"
    desired: "no"
    remediate: ansible: "lineinfile path=/etc/ssh/sshd_config regexp='^PasswordAuthentication' line='PasswordAuthentication no' notify=restart_sshd"
  - key: win.lsass.ppl
    query: powershell: "(Get-ItemProperty 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa').RunAsPPL"
    desired: "1"
    remediate: powershell: "Set-ItemProperty ... -Name RunAsPPL -Value 1"
  - key: logging.sysmon
    query: osquery: "SELECT state FROM services WHERE name='Sysmon64' OR name='sysmon'"
    desired: "running"
    remediate: script: "plura-edr sysmon ensure --profile curated"
```

### E. 감염 저항성(Resilience) 가드

* **코어 보호**: ASR/WDAC/Applocker(Win)·AppArmor/SELinux(Lin) **감사→차단** 단계 운영
* **실행 경로**: `%TEMP%`·사용자 홈에서 **실행 파일/스크립트 차단**, 설치는 관리자 채널만
* **USB/외부미디어**: **읽기 전용** 기본, 실행/autorun 금지
* **백업 보호**: VSS/MFA Delete/버전닝 설정 변조 **정책 차단 + 알림**

### F. SLO/지표

* **드리프트 탐지→교정** p95 **≤ 15분**, **잔여 드리프트 0건**(핵심 키)
* **취약 구성 점수**: `baseline_compliance ≥ 98%`(서버)/`≥ 95%`(워크스테이션)
* **차단 정책 FP율**: **≤ 0.5%**(Strict는 1%까지 허용), **예외 만료 준수 ≥ 98%**

### G. 운영/런북

1. **대규모 드리프트**: 변경 배포/패치 창 확인 → 원복 플래그 또는 정책 오버레이 적용 → 15분 내 안정화
2. **차단 FP 발생**: WDAC/Applocker/AppArmor를 **감사 모드**로 일시 하향 → 해시/서명자 예외 추가 → Shadow 7일 후 재상향
3. **OSQuery/DSC 실패**: 에이전트 재기동·정책 강제 재적용, 감사 인덱스에서 실패 호스트 쿼리

### H. API/자동화

* `POST /v1/baseline/apply { profile, hosts[], mode:"enforce|audit" }`
* `GET  /v1/baseline/drift?range=1h&profile=server-curated`
* `POST /v1/baseline/exception { host, key, ttl, owner, reason }`
* `GET  /v1/baseline/compliance?tenant=...` — 점수/미준수 키/증거 링크

---

4. **예시 설명 (SSH 비밀번호 인증 재활성 드리프트 — 12분 내 교정)**

1) 스테이징 서버 일부에서 `PasswordAuthentication yes` 드리프트 감지(`drift_keys=ssh.password_auth`).
2) 유예 10분 동안 변경 배포 확인 후 **자동 교정** 실행(라인 수정→`sshd` 재시작).
3) 감사 인덱스에 **before/after**·호스트·시각·자동 교정자 기록, 예외는 **0건**(Strict 아님).
4) 12분 내 잔여 드리프트 0, `baseline_compliance` 99.2% 회복.
   → 결과: **정책 선언→감지→교정→증거화** 사이클로 구성이 **항상 의도 상태**에 유지되고, 감염/오남용에 대한 **저항성**이 크게 향상된다.
