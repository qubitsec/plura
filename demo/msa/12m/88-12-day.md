# 필상 시스템 — Day 88 투명성 로그(Transparency Log) · 머클 트리 공증(Notary) · 타임스탬프(TSA) · 검증 클라이언트

1. **날짜**

* 2024-12-12

2. **목표**

* **감사/결정/다운로드/키·정책 변경** 전 과정을 **투명성 로그(머클 트리 기반)**로 공증
* **서명·타임스탬프(RFC 3161)·교차서명**을 결합해 **변조 불가·검증 가능** 체계를 확보
* **검증 실패 0건**, **증빙 생성 p95 ≤ 2s**, **외부 검증 TAT ≤ 60s** 달성

---

3. **내용**

### A. 범위(투명성 대상 이벤트)

* `security.audit.v1`(접근/목적구속/다운로드)
* `policy.decision.v1`(OPA 허용/거부)
* `key.action.v1`(BYOK/HYOK 로테이션/회수, Day 83)
* `export.jobs.*`(생성/완료/다운로드, Day 74)
* `route.attest.v1`(교차전송 경로 증명, Day 87)
* `rca.*`/`cqi.*`(포스트모템/개선, Day 80)

### B. 로그 구조(머클 트리)

```
append-only log (per region)
 ├─ leaf: SHA256(event_canonical_json)
 ├─ tree: Merkle(leaf…)
 └─ STH(Signed Tree Head): {size, root_hash, timestamp, sig_notary}
```

* **리전 분리**: `kr.log` / `jp.log` 별도 운영(교차 합산 금지)
* **주권**: 로그/증빙은 **리전 내 WORM** 보관( Day 64 )

### C. 공증/서명·타임스탬프

* **서명**: Notary 키(하드웨어 보호)로 **STH** 서명(ed25519)
* **TSA**: 각 STH에 **RFC 3161** 타임스탬프 토큰 부착(외부 신뢰 앵커)
* **교차서명**: 월 1회 **상호 교차서명(kr↔jp)** — *루트만* 교차, **데이터 교차 이전 없음**(정책 준수)

### D. 수집·정규화·캔노니컬 JSON

* 이벤트는 **정렬 키 순·공백 미포함**의 **Canonical JSON**으로 고정
* PII/원문은 금지, `ip_bucket / param_sig / uri_sig`만( Day 57·71·85 정합)
* 이벤트 해시·서명은 **EPKG 링크**와 함께 저장(검증/재현 용이)

### E. 검증 클라이언트(내/외부)

* **기능**:

  1. STH 체인 검증(서명·TSA 유효성)
  2. **증명 경로**(leaf→root) 생성/검증
  3. 시간/범위 조회(“이 시간 이전에 존재했는가?”)
* **CLI 예**

  ```bash
  plura tlog verify --leaf-hash <sha256> --region kr --sth https://tlog.kr/sth.json
  plura tlog inclusion --txn <event_id> --out proof.json
  plura tlog check-range --from 2024-12-12T00:00Z --to 2024-12-12T23:59Z
  ```

### F. API/포맷(발췌)

* `GET  /v1/tlog/sth?region=kr` → `{size, root, ts, sig, tsa}`
* `POST /v1/tlog/inclusion { leaf_hash }` → `{proof[], sth}`
* `GET  /v1/tlog/lookup?selector=incident:INC-01J...` → leaf/증명/요약
* `GET  /v1/tlog/audit?range=24h` → 일괄 검증 리포트(실패 0 목표)

### G. 운영/가드레일

* **Append-only 강제**: 재작성 금지, *misbehaviour* 감지 시 **사이드 로그**에 증거 고정
* **로테이션**: 일 단위 세그먼트(사이즈 상한), 세그먼트별 STH·TSA 별도 보관
* **백업**: STH·증명(Proof) 스냅샷을 **콜드 버킷**에도 복제(동일 리전)
* **성능**: 적재 p95 ≤ 2s(배치 1000건 기준), 증명 생성 p95 ≤ 1s

### H. 대시보드·지표

* `tlog_append_latency_p95`, `sth_gap_sec`, `tsa_failure`, `inclusion_fail`, `proof_size_p95`, `audit_gap=0`
* **SLO**: `audit_gap=0`, `tsa_failure=0`, **STH 간격 p95 ≤ 60s**

### I. 거버넌스/정책 연계

* **RCA/EPKG**: 각 RCA·Export·경로증명에 **tlog inclusion URL** 첨부(제3자 검증 가능)
* **Purpose Binding**( Day 85 ): 목적/형식 불일치 사건은 **tlog 태그**로 별도 표기(감사 우선 검토)
* **PIA/DPIA**( Day 86 ): 미평가 경로에서 생성된 이벤트는 **경고** + 차단 게이트

### J. 테스트/감사(정기)

* **월간 무작위 표본 검증**(내부/외부 감사인 동시) — 포함증명/시간증명/TSA 유효성 체크
* **카오스**: *split-world* 시뮬레이션(이중 루트) 감지 → 경보/키 롤오버/공개 공지 절차

---

4. **예시 설명 (Export 다운로드 진위 분쟁 — 7분 내 증명 완료)**

1) 고객이 “12/12 10:03 KST에 보고서가 실제로 발급되었는가?” 질의.
2) 콘솔이 **tlog inclusion** 링크 제공 → 검사자는 **STH+TSA** 검증 후 **inclusion proof** 확인.
3) `export.downloaded` 이벤트가 10:03:12 KST 포함증명 완료(루트·서명·TSA 일치) → **진위 확인**.
4) 분쟁 종료까지 7분, 감사 리포트에 링크/증명 JSON 첨부.
   → 결과: **투명성 로그 + 공증**으로 모든 중요한 결정/다운로드/키 변경이 **검증 가능**해져, 신뢰·감사 대응력이 크게 향상.
