# 필상 시스템 — Day 87 데이터 주권(Residency)·교차전송 통제(CBT) · 지오펜싱 · 경로 증명(Attestation)

1. **날짜**

* 2024-12-11

2. **목표**

* **KR/JP 리전** 간 **데이터 교차 전송(Cold/Hot/관리 트래픽)**을 **정책·네트워크·암호·감사** 4중 가드로 차단/관리
* **경로 증명(Attestation)**으로 “데이터가 어디로, 어떤 경로로 이동했는가”를 **증거화**하여 **위반 0건**, **감사 TAT ≤ 24h**

---

3. **내용**

### A. 범위·정의

* **데이터 클래스**: `P0(민감 PII) / P1(운영·사건 증거) / P2(메타) / P3(공개)`
* **전송 유형**: `Hot(실시간 API/웹훅) / Warm(Export/리포트) / Cold(스냅샷/백업)`
* **원칙**: `P0/P1` **교차 전송 금지**, `P2`는 승인·목적구속( Day 85 ) 하에서 제한적 허용, `P3`는 정책 준수 범위 내 허용

### B. 정책(OPA/Rego) — 요청·응답 단·전송 단

```rego
package sovereignty.guard
default allow = false

# 토큰/요청의 리전 일치
deny[msg] { input.req.region != input.token.region; msg := "cross-region request forbidden" }

# 데이터 클래스별 허용 범위
deny[msg] { input.data.class in {"P0","P1"}; input.dest.region != input.src.region; msg := "P0/P1 cross-region banned" }

# 예외(승인·타임락·목적)
allow {
  input.exception.approved == true
  input.exception.expires_at > time.now_ns()
  input.purpose in {"ops","customer_report"}  # 예: P2만
}
```

### C. 네트워크·지오펜싱

* **DNS/Anycast 분리**: `kr.api.example` ↔ `jp.api.example`(상호 CNAME 금지)
* **FW/SG**: 리전간 **L3 차단**(화이트리스트만 허용: 상태페이지/공개 사이트)
* **eBPF/Envoy**: `X-Region` 태그와 **SPIFFE ID**( Day 58 ) 기반 **지역간 세그먼트 Drop**
* **테넌트 엣지**: 하이브리드/에어갭( Day 41 )의 **업링크 도메인 화이트리스트**와 TTL 감시

### D. 암호화·키 경계

* **KMS 리전별 분리**( Day 83 ): CMK/DEK **교차 사용 금지**, HYOK는 대상 리전에서만 호출
* **토크나이제이션**( Day 82 ): 경계 전 **가명화** 강제—가명·시그니처만 이동 가능
* **전송 암호화**: mTLS + TLS1.2+, **클라이언트 인증**(SPIFFE) 필수

### E. 경로 증명(Attestation) & 서명 영수증

* **Hop-by-Hop 증거**: Gateway/Service/Connector가 **`route.attest.v1`** 이벤트 발행

  * 필드: `src_region, dest_region, purpose, data_class, bytes, hop(spiffe,ip), ts, prev_hash`
* **영수증**: 전송 완료 시 **서명 요약** 생성(체인 해시·총 바이트·대상·목적) → WORM 저장( Day 64 )
* **검증 도구**: `attest verify --txn <id>` 로 체인·서명·정책 일치성 점검

### F. 예외·승인(필수 요건)

* **대상**: `P2` 한정(메타/집계/보고), 목적은 `ops | customer_report | legal`
* **승인**: 2인 + 타임락(15분) + 기간/범위/바이트 상한 + 역전송 금지
* **자동 만료**: 종료 시 **역복구(롤백)** 불필요하도록 **단방향 사본**만 생성

### G. 모니터링·지표·SLO

* 지표: `cbt_denies`, `route_attest_count`, `cross_region_attempts`, `exception_active`, `bytes_by_class`, `violations=0`
* **SLO**: 위반 **0건**, 예외 승인 TAT **≤ 2h**, **Attestation 누락 0건**, 감사 리포트 생성 **≤ 24h**

### H. 실패/사고 처리

* **탐지**: `cross_region_attempt` 발생 → 즉시 **deny + alert(T1)**
* **완화**: 연결 차단(eBPF/Envoy), 관련 키/토큰 임시 폐기, 목적구속 엔진( Day 85 ) 재검증
* **RCA**: 경로 증명 체인 수집 → **EPKG-RCA**로 보관, PIA/DPIA( Day 86 ) 재평가·게이트 보강

### I. API/CLI(발췌)

* `POST /v1/sovereignty/exception { purpose, class:P2, region_src, region_dest, ttl }`
* `GET  /v1/sovereignty/attest/{txn}` — 경로 증명/서명 영수증
* `GET  /v1/sovereignty/metrics?region=kr&range=24h`
* CLI: `plura region guard on|off`, `plura attest verify --txn ...`

### J. 운영 체크리스트

* [ ] 게이트웨이/서비스 **지역 헤더·토큰** 일치 검증 On
* [ ] FW/SG **교차 리전 흐름 0건** 확인(월간 점검)
* [ ] KMS/HYOK 키 **리전 경계 준수** 테스트, BYOK/HYOK 정책 갱신( Day 83 )
* [ ] 경로 증명 이벤트 누락 0건, 감사 영수증 월간 샘플 검증
* [ ] 예외는 **2인 승인/타임락/목적·클래스 제한**과 자동 만료 필수

---

4. **예시 설명 (JP→KR 크로스 전송 시도 — 6분 내 차단·증거 고정)**

1) 커넥터가 JP 데이터(`class=P2`)를 KR로 Export 시도 → OPA **deny**, eBPF 경로 차단.
2) Notifier가 CSIRT에 **T1 알림**, 콘솔에 예외 신청 가이드 표시.
3) 운영자가 목적 `customer_report`, 기간/바이트 상한·TTL 2h로 예외 신청 → 2인 승인 후 허용.
4) 전송 완료 시 **서명 영수증** 생성, 감사 인덱스에 체인 고정.
   → 결과: **정책·네트워크·키·감사** 4중 가드와 **경로 증명**으로 **주권 위반을 제로**에 가깝게 유지하고, 필요한 경우에도 **근거있는 제한적 예외**만 허용.
