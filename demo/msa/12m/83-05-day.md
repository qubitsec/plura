# 필상 시스템 — Day 83 고객 관리 키(BYOK/HYOK) · 테넌트 전용 KMS/키스코프 · 듀얼-컨트롤·회수·재암호화

1. **날짜**

* 2024-12-05

2. **목표**

* 테넌트가 **자신의 키로 모든 민감 데이터**(오브젝트/Export/토큰 금고/백업 메타)를 **암호화·통제(BYOK/HYOK)** 할 수 있도록 표준화
* 테넌트 전용 KMS Key + 듀얼-컨트롤(2인 승인) + 회수/재암호화(Zero-Downtime)로 **주권/컴플라이언스** 충족
* **키 교체 ≤ 30분**, **회수 시 데이터 접근 0건**, **재암호화 동안 서비스 중단 0** 달성

---

3. **내용**

### A. 용어/스코프

* **BYOK**: 고객이 제공한 마스터 키(CMK)를 **클라우드 KMS로 가져와**(Import) 사용
* **HYOK**: 고객 HSM/외부 KMS에서 **원격 서명/복호화**만 수행(키는 절대 반출되지 않음)
* **대상 데이터**: `evidence/EPKG`, `Export 산출물`, `Token Vault(해시/토큰 메타)`, `Backup 메타/WAL`, (옵션) `Search 스냅샷`

### B. 암호화 계층(Envelope)

```
CMK(tenant, region)  →  DEK(dataset/scope, rotate 90d)  →  Data(오브젝트/레코드)
             │                               │
             └─ KEK 래핑(Import/KMS)          └─ AEAD( AES-256-GCM ) / Deterministic-AEAD(조인필드)
```

* **DEK 로테이션**: 90일(정책), CMK는 180일/고객 트리거 시
* **형식 보존 필요**(전화/이메일): Day 82의 **FPE**는 **DEK 대신** FPE 키 슬롯 사용(테넌트별)

### C. 키 생명주기(상태 머신)

1. `provisioned`(CMK 등록/검증) →

.  

2. `enabled(active)`(DEK 발급·데이터 암호화) →
3. `rotate_pending`(듀얼 라이트: 신/구 DEK 병행) →
4. `retire`(구 DEK 제거) →
5. `disable`(일시 중지: 접근 차단) →
6. `revoke`(회수: 영구 차단, 재암호화 필요)

> **듀얼 라이트**: 회전/재암호화 중 **신/구 DEK 동시 지원**으로 중단 없이 전환.

### D. 테넌트 전용 KMS/정책(Region-local)

* **키스코프**: `region=kr|jp`, `tenant_id`, `dataset(evidence|export|token|backup)`
* **정책 예(요약)**

  * `Allow Encrypt/Decrypt` to 서비스 역할(**STS 15–60m**)
  * `BYOK Import`는 **테넌트 관리자 2인** + 우리측 보안승인 필요
  * **교차 리전 Deny**(키/암호문 이동 금지, Day 42·64·71 정합)

### E. HYOK(외부 KMS/HSM) 흐름

* **서명/복호화 요청**을 **프록시**가 대신 전달(고객 KMS 엔드포인트)
* **컨트롤**: QPS/Rate Limit + **목적 바인딩(purpose=“encrypt|decrypt”)** + 호출 **감사 해시체인**
* **지연 가드**: p95 > 200ms 지속 시 로컬 캐시된 **세션 키**로 “쓰기 전용” 허용(복호 필요 시 대기)

### F. 듀얼-컨트롤 & 승인(2인 + 시간잠금)

* **고위험 작업**: Import/Disable/Revoke/Rotate/BYOK→HYOK 전환
* **승인 플로우**: 요청자 + 승인자(서로 다른 소속/역할) + **타임락(15분)** → 수행
* **감사**: `key.action.v1`(actor, action, cmk_id, scope, ts, prev_hash) 이벤트 WORM 저장

### G. 회수(Revoke)·재암호화(Zero-Downtime)

* **Revoke 준비**: 영향 범위 스캔(키 사용 오브젝트/레코드) → **재암호화 잡 계획**
* **단계**

  1. **듀얼 라이트** ON(신 DEK 병행)
  2. 백그라운드 **재암호화**(오브젝트 512MB 청크, 병렬 8–16, p95 ≤ 150ms/PUT)
  3. 완료율 100% + 검증(해시/사이퍼텍스트 버전) → **구 DEK 폐기**
  4. 최종 **Revoke(CMK)**, 접근 차단 이벤트 고정
* **실패/롤백**: 중단 시 지점 재개(체크포인트), 장애 시 구 DEK 경로로 **읽기 전용** 폴백

### H. 콘솔/UX & API

* **키 카드**: 상태(활성/회전/회수), 범위, 마지막 사용, 다음 로테이션, 리스크 배지
* **워크플로우 가드**: 교차 리전·권한 부족·SoD( Day 81 ) 위반 시 즉시 거부
* **API(발췌)**

  * `POST /v1/kms/byok/import { cmk_pem, region, tenant }`
  * `POST /v1/kms/rotate { scope, strategy:"dual-write", batch:{size,parallel} }`
  * `POST /v1/kms/revoke { cmk_id, dry_run? }`
  * `GET  /v1/kms/impact?cmk_id=...` — 영향 오브젝트/레코드 집계
  * `GET  /v1/kms/audit?range=7d` — 키 작업 감사 로그

### I. 지표·SLO

* `encrypt_latency_p95 ≤ 5ms`, `decrypt_latency_p95 ≤ 10ms(HYOK 200ms 경고)`
* `rotate_duration_p95 ≤ 30m`(200TB 기준 스트리밍), `rekey_fail_rate < 0.1%`
* `revoke_success_rate=100%`, **회수 후 접근 이벤트 0건**
* `cross_region_violation=0`, **감사 누락 0건**

### J. 운영 체크리스트

* [ ] 테넌트별 **CMK 등록/검증** 문서화, 2인 승인/타임락 테스트
* [ ] DEK **90일 로테이션** 스케줄·듀얼 라이트 경로 점검
* [ ] 재암호화 체커(해시/사이퍼텍스트 버전)·중단 재개 체크포인트 검증
* [ ] HYOK 지연/장애 대비 **쓰기 전용 폴백**과 알림
* [ ] Export/EPKG/TokenVault 전 경로 **BYOK/HYOK 적용률 100%** 모니터

---

4. **예시 설명 (ENT 테넌트 BYOK→회수 전환 — 27분 재암호화, 중단 0)**

1) 고객 규정 변경으로 **CMK 회수(Revoke)** 요청. 영향 평가에서 `evidence/export/token` 총 86TB 식별.
2) **듀얼 라이트**로 신 DEK 활성 → 백그라운드 재암호화 **병렬 12**로 시작, p95 PUT 140ms 유지.
3) 27분에 100% 완료·검증 통과 → 구 DEK 폐기 → **CMK Revoke** 실행(2인 승인·타임락).
4) 전 과정 서비스 **중단 0**, 접근 차단 이벤트 0건, 감사 로그/EPKG-RCA 자동 고정.
   → 결과: **BYOK/HYOK + 듀얼-컨트롤 + 무중단 재암호화** 표준으로 고객 주권을 극대화하면서 가용성과 운영 안정성을 유지.
