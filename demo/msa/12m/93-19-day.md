# 필상 시스템 — Day 93 자동 카나리 분석(ACA) · 통계 가드레일 · 롤백/승격 오케스트레이션

1. **날짜**

* 2024-12-19

2. **목표**

* **릴리스/플래그/룰/모델** 변경 시 **자동 카나리 분석(ACA)**으로 **객관적 승격/롤백** 결정을 표준화
* **지표·통계 검정·가드레일**을 일원화해 **오류 배포 0건**, **결정 TAT ≤ 15분**, **자동 롤백 ≤ 5분** 달성

---

3. **내용**

### A. 적용 범위 & 단계

* **대상**: App/Worker, 검색 설정, 룰/모델( Day 9/50 ), 플래그( Day 20 ), 커넥터( Day 69 )
* **단계**: `shadow(옵션) → canary 5% → 25% → 50% → 100%` (KR→JP 순)
* **관찰 창**: 각 단계 **10~15분**(서비스별 SLO·트래픽에 따라 자동 조정)

### B. 핵심 지표 & 가드레일

* **성능/가용성**: `ingest→incident p95`, `search p95`, `notify p95`, `error_rate`, `timeout_rate`
* **품질**: `FP_rate`, `missed_regression`(리플레이), `DLQ_rate`, `cache_hit_ratio`, `CQS/CIR/CIN` 비용지표( Day 29 )
* **보안/주권**: `purpose_mismatch_denies`, `sovereignty_denies`( Day 85/87 )
* **절대 임계(하드 가드)**:

  * `error_rate_canary > control + 0.5%p`
  * `search p95_canary > 0.8s` 또는 `ingest→incident p95 > 15s` 5분 지속
  * 보안/주권 위반 **>0** → **즉시 롤백**

### C. 통계 분석(자동)

* **분석법**

  * 지연/비용(연속): **Mann–Whitney U** (p<0.05, 효과크기 `|Δ|/MAD`)
  * 비율(오류·FP·DLQ): **Two-proportion z-test** (p<0.05, 최소 효과검출 `>= 0.2%p`)
* **정규화/성숙도**: 시간대·트래픽 차이는 **코호트 매칭**(테넌트 플랜/요일/시간)으로 보정
* **결정 규칙**: `pass | hold | rollback` (+ 사유/증거 링크)

### D. 오케스트레이션(승격/롤백)

```
Release/Flag/Rule → ACA Runner(수집·검정) → Decision Engine
      ↘ pass → 승격(다음 단계)     ↘ rollback → 되돌리기 키 실행(≤5분)
      ↘ hold → 관찰 연장/수동 검토  → EventHub 통지( Day 92 )·TLog 공증( Day 88 )
```

* **승격**: 단계별 **자동 승격**, 최종 100% 후 **stable 태깅**·릴노트 업데이트
* **롤백**: `rollback key` 또는 **이전 stable** 즉시 전환, **상관 가드**(Day 56/73/77) 동시 가동
* **hold**: 관찰 10분 연장 또는 **수동 승인** 대기(승인 2인 가능)

### E. 구성·정책

* 프로필별 임계/관찰 창:

  * `latency_sensitive`: 15m 창, 효과크기 임계 **낮음**(엄격)
  * `throughput_focused`: 10m 창, 비용 지표 가중 ↑
* **필수 전제**: 되돌리기 키·합성 시나리오( Day 78 )·릴리스 노트·RCA 템플릿( Day 80 ) 링크 등록

### F. 콘솔/리포트 UX

* **카나리 대시**: Control vs Canary **스파크라인**, p값/효과크기, 가드레일 배지(녹/황/적)
* **증거 카드**: OTel Exemplar Trace( Day 67 ), 대시보드 스냅샷, 리플레이 결과(7/30/90d)
* **결정 로그**: 승격/롤백 사유·지표·검정 결과를 **투명성 로그**에 고정( Day 88 )

### G. 지표·SLO

* `decision_tat_p95 ≤ 15m`, `auto_rollback_p95 ≤ 5m`
* `false_rollback_rate ≤ 2%`, `post_release_incident_rate ↓ ≥ 20%`
* `tlog_inclusion_gap=0`, `guardrail_bypass=0`

### H. API/CLI(발췌)

* `POST /v1/aca/start { artifact, type, regions, profile }`
* `GET  /v1/aca/status?release=...` — 단계/지표/결정/근거
* `POST /v1/aca/override { decision, reason }` — 수동 개입(감사 필수)
* `POST /v1/aca/rollback { release, reason }` — 즉시 롤백
* CLI: `plura aca start|status|promote|rollback`

### I. 운영 체크리스트

* [ ] 되돌리기 키·합성 시나리오·릴노트 **사전 준비**
* [ ] 프로필/임계·관찰 창 환경별 검증(스테이징→프로덕션)
* [ ] EventHub 라우팅/온콜 알림 연결( Day 92 )
* [ ] 승격/롤백 결정 내역 **TLog 공증**·RCA로 연결
* [ ] 월간 메타분석: false rollback/late rollback 원인·임계 최적화

---

4. **예시 설명 (룰 델타 v9 — `hold→rollback` 12분, 안전 복귀)**

1) WAF `WAF-941100 v9` 카나리 5% 시작 6분 후 `FP_rate +0.7%p`, `search p95 +140ms`.
2) ACA 검정 p=0.012(유의), 하드 가드 미달은 아니나 **hold** 결정 → 관찰 연장.
3) 12분 시점에도 개선 無, `DLQ_rate` 상승 감지 → **rollback** 자동 실행(3m 내 안정).
4) RCA 드래프트 자동 생성, 템플릿 완화 범위 수정 후 재시도 계획 수립.
   → 결과: **ACA + 가드레일 + 자동 롤백**으로 위험 배포를 **초기 단계에서 안전하게 차단**, 안정성·품질을 동시에 보장.
