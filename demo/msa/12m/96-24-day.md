# 필상 시스템 — Day 96 장기 보존(Cold/Archive) 거버넌스 · 리하이드레이션(복원) · 법적 보존(Legal Hold)

1. **날짜**

* 2024-12-24

2. **목표**

* **증거/로그/리포트/스냅샷**의 **장기 보존(Cold/Archive)** 정책과 **리하이드레이션(복원)** 절차를 표준화
* **법적 보존(Legal Hold)** 중단·키 파기 금지·감사 추적을 엄격히 보장하면서 **복원 p95 ≤ 2h(200GB)** 달성

---

3. **내용**

### A. 보존 클래스 & 라이프사이클

* **Hot(0–30d)** → **Warm(31–180d)** → **Cold(181d–3y)** → **Archive(>3y)**
* 버킷/프리픽스별 정책:

  * `evidence/*`: 180d Cold → 3y Archive(법적 보존 시 예외)
  * `reports/*`: 30d Warm → 365d Delete(버전 90d)
  * `snapshots/*`: 90d Cold → 2y Archive
* **WORM/버전닝/MFA Delete**( Day 64 ) 일관 적용, **키 로테이션**( Day 83 ) 캘린더 반영

### B. 인덱스 & 메타(빠른 탐색)

* **메타 인덱스**: `archive_index`(tenant, region, class, date, bytes, epkg_hash, legal_hold)
* **검색 키**: `incident_id, rule_id, dst_host, ip_bucket, param_sig, ts_range` (PII 원문 금지)
* **카탈로그 조회**: `GET /v1/archive/search?tenant=...&range=...&class=evidence`

### C. 리하이드레이션(복원) 절차

1. **요청/승인**: 목적(`security|legal|ops`)·범위(기간/키워드)·보존 클래스 확인 → `security/legal`은 2인 승인

.  
 
2. **프리페치**: Cold/Archive 객체 **프리페치 작업** 시작(병렬 8–16, zstd 해제)
3. **검증**: SHA-256 ETag/루트 해시 재검증 → 실패 시 재다운로드/경보
4. **로딩**: 목적별 대상에 리하이드레이트

   * 검색 인덱스: **임시 컬렉션**(`*_rehyd`)로 적재(읽기 전용)
   * 레이크하우스: 임시 뷰로 마운트(읽기 전용)
   * 증거: EPKG를 임시 버킷에 복제(서명 URL 10분)
5. **만료/청소**: TTL(기본 7일) 후 자동 제거, 감사 로그 고정

### D. 법적 보존(Legal Hold)

* **토글**: 사건/범위에 `legal_hold=true` → 라이프사이클 정지, 키 파기 금지
* **감사**: `legal_hold.toggled/extended/released` 이벤트 TLog( Day 88 ) 고정
* **해제**: 법무 승인 후 해제 → 라이프사이클 재개, 관련 Export/삭제 요청 처리

### E. 비용/성능 가드

* **프리페치 큐**: 동시성 제어(테넌트/리전별), 과금/쿼터( Day 22/72 ) 연동
* **캐시 계층**: Warm 캐시 버킷(최근 30d 재사용 빈도↑) → 복원 시간 단축
* **압축/스플릿**: 512MB 단위 청크, 멀티파트 병렬화, 실패 조각 재시도

### F. SLO·지표

* **복원 p95**: 200GB ≤ **2h**, 1TB ≤ **8h**
* **무결성 실패율**: **0%**(재시도 후)
* **Legal Hold**: 토글/해제 승인 TAT ≤ **4h**, 위반 **0건**
* 지표: `rehyd_jobs_running`, `rehyd_bytes`, `rehyd_p95`, `integrity_fail`, `legal_hold_active`

### G. API/CLI

* `POST /v1/archive/rehydrate { tenant, range, class, target:"solr|lake|epkg", purpose }`
* `GET  /v1/archive/status/{job}` — 진행/검증/링크
* `POST /v1/archive/legal_hold { incident, enable }`
* CLI: `plura archive rehyd|get|legalhold`

### H. 운영 체크리스트

* [ ] 보존 정책/클래스·키 로테이션 캘린더 상시 동기
* [ ] 리하이드 작업자 풀/동시성 한도·재시도 검증
* [ ] 임시 인덱스/뷰는 읽기 전용·TTL 제거, 비용 모니터
* [ ] Legal Hold 토글/해제는 2인 승인·TLog 포함증명 확인
* [ ] 복원 후 RCA/지식화(반복 패턴 최적 보존/캐시 정책 반영)

---

4. **예시 설명 (법적 보존 사건 복원 — 86분 완료, 무결성 100%)**

1) 법무 요청으로 `INC-01J...` 6개월 구간 **evidence/logs** 복원(목적 `legal`).
2) 2인 승인 후 프리페치 병렬 12, 41분에 200GB 복원 완료 → **임시 EPKG 버킷** 링크 발급.
3) 해시/루트 검증 0 실패, 필요한 범위 **임시 인덱스**로 로딩하여 타임라인 재구성.
4) 사건 종결 후 `legal_hold` 유지, Export는 서명 URL·워터마크로 제한, 7일 후 자동 청소.
   → 결과: **Cold/Archive 거버넌스 + 리하이드레이션** 표준으로 장기 보관 데이터도 **무결성·주권·보안**을 유지하며 빠르게 복원·활용 가능.
