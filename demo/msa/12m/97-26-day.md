# 필상 시스템 — Day 97 컨테이너 이미지 라이프사이클 & 레지스트리 거버넌스: 태깅·프로모션·정리(GC)·CVE 게이트

1. **날짜**

* 2024-12-26

2. **목표**

* **이미지/차트/매니페스트**의 **생성→프로모션(dev→stg→prod)→보존/정리(GC)** 전 과정을 표준화
* **서명·프로비넌스( Day 38/94 ) + 취약점 게이트**로 **변조/취약 배포 0건**, **롤백 ≤ 5분**, **스토리지 비용 20%↓**

---

3. **내용**

### A. 레지스트리/리포 구조 & 태깅 규칙

```
registry.{region}.example.com/
  apps/{svc}/{name}:{semver}+{gitsha}     # 불변 태그
  apps/{svc}/{name}@sha256:<digest>       # 배포 기준
  channels/{env}/{svc}:stable|candidate   # 채널 태그(가리키기용)
  charts/{svc}:{semver}                   # Helm 차트
```

* **금지**: `:latest` 사용, 가변 태그 오버라이트
* **필수 라벨**: `org.opencontainers.image.{version,revision,source,created}` / `plura.{region,release_id,build_id}`

### B. 빌드·서명·스캔(파이프라인)

1. **빌드**: 멀티스테이지(DISTRO-LESS 권장), 루트 실행 금지
2. **SBOM 생성**: CycloneDX + in-toto 프로비넌스( Day 38 )
3. **스캔**: `trivy image` — **Critical/High=0**, Medium은 예외(만료일 필수)
4. **서명**: Cosign(KMS 지역 키) — 아티팩트·SBOM·프로비넌스 모두 서명( Day 94 게이트 통과)
5. **푸시/태깅**: `:{semver}+{gitsha}` + 채널 `candidate` 갱신

### C. 프로모션 흐름(dev→stg→prod)

.  

* **입력**: ACA 카나리 계획( Day 93 ), 합성 시나리오( Day 78 ), 되돌리기 키
* **단계**

  1. `dev` 빌드/스캔/서명 완료 → `stg` 채널로 **promote**
  2. `stg`에서 **ACA canary**(5→25→100%) 통과 시 `prod:candidate`로 승격
  3. 15분 관찰·지표 녹색 → `prod:stable` 재지정, 릴리스 노트/투명성 로그 고정( Day 88 )

### D. 런타임 검증 & 롤백

* **검증**: Admission/Webhook에서 **서명·프로비넌스·CVE** 재검증(캐시 TTL 60s)
* **핀(고정)**: `digest allowlist`만 허용, 태그 변조 방지
* **롤백**: `channels/prod/{svc}:stable` 직전 Digest로 **5분 내** 자동 전환(되돌리기 키)

### E. 보존·정리(GC) 정책

* **보존 윈도우**

  * `prod:stable` 기록 **180일**, `prod:candidate` **30일**, `stg` **30일**, `dev` **14일**
  * 브랜치/실험 이미지: **7일**(활동 없을 시)
* **정리 기준**

  * 참조 없는 태그·매니페스트·레이어 **GC** (드라이런→실행)
  * **취약 태그 차단 목록**(CVE/정책 위반) → 즉시 숨김/차단 + 알림
* **예외**: 보안/사고 RCA 관련 Digest는 **WORM 버킷**에도 백업( Day 64 )

### F. 베이스 이미지 관리

* **월 1회** 롤업(필수), 긴급 CVE 24–72h
* **허용 목록**: `distroless`, `ubi-minimal`, `alpine(보안 패치 최신)` 등
* **정책**: 베이스 이미지 해시 핀 + 서명 검증, 미허용 소스 **빌드 차단**

### G. SRE/배포 가드레일

* **자원 요청/제한** 라벨 강제, **readOnlyRootFS**·`runAsNonRoot`·seccomp/AppArmor( Day 36 )
* **Egress 화이트리스트**·SPIFFE ID·mTLS( Day 58 )
* **Config/Flags**는 **이미지와 분리**( Day 20/94 ) — 이미지 교체만으로 동작 변화 금지

### H. 대시보드·지표

* `image_count_by_env`, `digest_unique`, `sbom_coverage=100%`, `signed_artifacts=100%`,
  `cve_block_events`, `promotion_latency_p95`, `rollback_time_p95`, `registry_storage_bytes`, `gc_reclaim_bytes`
* **SLO**: 프로모션 TAT p95 **≤ 30m**, 롤백 p95 **≤ 5m**, CVE 차단 누락 **0건**

### I. API/CLI(발췌)

* `POST /v1/registry/promote { repo, from: "stg", to: "prod:candidate", digest }`
* `POST /v1/registry/rollback { repo, to: "prod:stable@<digest>" }`
* `POST /v1/registry/gc { repo, dry_run: true|false }`
* `GET  /v1/registry/metrics?repo=apps/ingestor`
* CLI: `plura reg promote|rollback|gc|metrics`

### J. 운영 체크리스트

* [ ] 서명·프로비넌스 검증 실패 **0건**, 실패 시 차단 + 자동 롤백
* [ ] 취약/불용 태그 정리 주기 운영(주간) — 드라이런→실행 로그 검토
* [ ] 베이스 이미지 월간 롤업 + 긴급 CVE 핫픽스 루틴 동작
* [ ] 채널 태그로만 배포, **Digest 핀** 필수
* [ ] 비용 모니터링: 저장소 바이트·Reclaim 효과(월간 20% 절감 목표)

---

4. **예시 설명 (검색 서비스 Hotfix — 21분 프로모션, 4분 롤백 시험 통과)**

1) `apps/search:2024.12.26+ab3c9f` 빌드→스캔·서명 OK → `stg` 승격 후 ACA canary(5→25→100%) 정상.
2) 21분 내 `prod:candidate`→관찰 녹색→`prod:stable` 지정, 지표 정상.
3) 롤백 리허설 수행: 직전 `stable` Digest로 **4분 내** 복귀 확인(트래픽 무중단).
4) 주간 GC에서 미참조 레이어 38GB 회수, 저장소 비용 −23%.
   → 결과: **태깅·프로모션·정리·CVE 게이트** 일관 표준으로 배포/복귀가 **빠르고 안전**해지고, **비용/보안**까지 동시에 개선.
