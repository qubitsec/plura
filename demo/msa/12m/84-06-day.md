# 필상 시스템 — Day 84 캐시 일관성 & 무효화 표준: SWR/ETag · 서로게이트 키(태그) · 정합성 테스트 · 캐시 포이즈닝 방어

1. **날짜**

* 2024-12-06

2. **목표**

* **CDN/엣지/오리진/애플리케이션 캐시**의 **정합성·성능·보안**을 동시에 달성하는 정책 수립
* SWR(Stale-While-Revalidate) + ETag + Surrogate-Key(태그 기반 무효화)로 **p95 ≤ 300ms** 유지,
  변경 전파 **≤ 60s**, **포이즈닝/키 폭주 0건** 달성

---

3. **내용**

### A. 일관성 모델(서비스별)

* **정적 자산**: **Strong Cache** — `Cache-Control: public, max-age=604800, immutable`, 버전 해시(파일명).
* **콘솔 뷰/목록**: **SWR** — `max-age=60, stale-while-revalidate=60`, ETag 필수(약한 일관성 허용).
* **검색 결과(템플릿)**: **SWR+TTL 15–90s**(Day 70), 파라미터 화이트리스트 기반 **Key 정규화**.
* **상태성 데이터(사건 상세/다운로드/서명 URL)**: **No-Store** — `Cache-Control: no-store`, 절대 캐시 금지.

### B. 캐시 키 전략(정규화)

* **기본 Key**: `scheme + host + path + normalized_query(allowlist only)`
* **정규화 규칙**

  * 순서/중복 파라미터 제거, 공백/대소문자/폭/반각 정규화(NFKC)
  * **허용 리스트 외 파라미터 무시**(키 폭주 방지) — 저장 쿼리만 허용
  * 지역/테넌트 가드: `X-Region`, `X-Tenant`를 **Key-Variant**로 별도 분기(주권/RLS)

### C. Surrogate-Key(태그) 기반 무효화

* 각 응답에 `Surrogate-Key`(여러 개 가능) 부여:

.  

  * 예) `surrogate-key: tenant:T1 rule:WAF-941100 dashboard:overview`
* **무효화 정책**

  * 태그 단위 `PURGE`(CDN/오리진 동시), 범위 충돌 방지 위해 **정규식 금지**·정확 매칭만
  * 대량 무효화는 **Batch API**와 **백오프**(초당 50 요청) 적용
* **전파 목표**: CDN PoP **≤ 30s**, 오리진 코어/내부 캐시 **≤ 60s**

### D. ETag/조건부 요청

* **생성**: 콘텐츠 해시(zstd 전 원문 SHA-256 8바이트) → `ETag: "w/abcdef12"`(weak OK)
* **검증**: `If-None-Match` 지원, **동일 테넌트/리전 토큰**일 때만 304 허용(교차 리전 금지)
* **주의**: PII/서명 URL 응답에는 ETag 사용 금지(캐시 흔적 차단)

### E. Stale 처리 & 보호

* **SWR**: 재검증 중 **Stale Serve** 허용(최대 60s), 장애 시 **Stale-If-Error=300**
* **서킷 브레이커**: 오리진 지연/p95>800ms 60s 지속 시 **Failover + Stale Serve**(Day 61)
* **강제 리프레시**: 운영자는 `Cache-Bypass: 1` 헤더로 검증 강제(온콜 디버깅용, 감사 기록)

### F. 캐시 포이즈닝 방어

* **헤더/쿼리 화이트리스트**: 캐시 키에 포함 가능한 헤더/파라미터 **정적 목록**(CSP·Accept-Encoding 외 금지)
* **Vary 최소화**: `Vary: Accept-Encoding, X-Region` 기본, `Authorization/Cookie`는 **키에서 배제 & 프록시에서 제거**
* **URI 정규화**: 이중 인코딩/혼합 케이스(`%2F`, `//`) → 표준화 후 키 생성, 원본 로그에는 **시그니처만**
* **응답 헤더 서명**(옵션): `X-Cache-Sig: v1=HMAC(resp_meta, secret)`로 변조 탐지
* **테스트**: PoC 벡터(Host 헤더 주입, CRLF, 권한 없는 vary 확장) 주기 점검

### G. 무효화 트리거(소스 이벤트)

* **룰/플래그 변경**: 관련 `surrogate-key: rule:ID`/`flag:KEY` purge
* **릴리스/실험 종료**: `release:ID`/`exp:KEY` purge + 검색 캐시 TTL 복원
* **Incident 상태 전이**: `incident:ID` purge(상세뷰), 목록은 태그 `dashboard:*` SWR로 자동 갱신
* **TI/평판 업데이트**: `ti:indicator` 태그 purge → 관련 파셋/카드 자동 재계산

### H. 정합성/성능 테스트(리그레션)

* **코렉트니스**: 변경 전/후 **해시 비교·샘플 200건**(304/200/TTL/태그 일치 여부)
* **전파 시간**: PURGE→HIT 전환 **p95 ≤ 60s** 검증(멀티 PoP)

.  

* **성능**: 캐시 ON 시 p95 ≤ 300ms, OFF/미스 시 p95 ≤ 800ms 유지
* **안전성**: 포이즈닝 벡터/키 폭주(≥1k 변형/분) 시도 → 탐지/차단 확인

### I. 관측·지표

* `cache_hit_ratio`, `edge_p95/origin_p95`, `purge_latency_p95`, `stale_serve_rate`,
  `key_cardinality`, `poison_attempts`, `purge_error_rate`, `swr_revalidate_time`
* **SLO**: HIT 비율(정적≥70%, 검색≥40%), PURGE 전파 p95 ≤ 60s, 포이즈닝 탐지/차단 100%

### J. API/자동화(발췌)

* `POST /v1/cache/purge/tags { tags: ["tenant:T1","rule:WAF-941100"] }`
* `POST /v1/cache/purge/keys  { keys: ["https://.../v1/search?..."] }`
* `GET  /v1/cache/metrics?region=kr` — 히트/지연/키 카디널리티/전파 시간
* `POST /v1/cache/config { service, ttl, swr, vary[] }` — 런타임 조정(승인 2인)

### K. 운영 체크리스트

* [ ] 모든 응답에 **정규화 Key + ETag/SWR/Surrogate-Key** 점검
* [ ] PURGE 전파 모니터링(멀티 PoP)·실패 재시도·배치 제한
* [ ] 키 폭주 경보(카디널리티 상한)·포이즈닝 테스트 정기 수행
* [ ] 변경 이벤트(룰/플래그/릴리스)와 **자동 PURGE 훅** 연계
* [ ] 서명 URL/PII 응답 **No-Store** 준수 확인

---

4. **예시 설명 (KR 검색 캐시 정합성 이슈 — 34분 내 복구, p95 280ms 유지)**

1) 릴리스 직후 `cache_hit_ratio` 급락·오래된 결과 노출 보고. `key_cardinality` 급증(허용 리스트 밖 파라미터 유입).
2) 자동 가드: **Key 화이트리스트 재적용** + `surrogate-key: release:20241206` 일괄 PURGE.
3) 9분 내 HIT 58%→71% 회복, 34분 내 모든 PoP 전파 확인(PURGE p95=42s).
4) 포이즈닝 테스트 통과, p95 280ms 유지. RCA: 템플릿 파라미터 누락 → 키 정규화 규칙에 추가, 회귀 테스트 보강.
   → 결과: **SWR/ETag + Surrogate-Key + 키 정규화** 표준으로 캐시 **정합성·성능·보안**을 동시에 확보하고, 변경 시에도 **예측 가능한 전파**와 **자동 복구**를 달성.
