# 필상 시스템 — Day 94 룰/모델/설정(Flags·Rules·Models) 서명·프로비넌스 · 런타임 검증(Enforcement)

1. **날짜**

* 2024-12-20

2. **목표**

* **탐지 룰(시그니처/DSL) · ML 모델(가중치) · Feature Flags/Config**를 **이미지와 별개로** 독립 서명·프로비넌스 관리
* 배포 전/런타임에 **정책(OPA)·서명·프로비넌스**를 검증하여 **변조·오배포 0건**, **롤백 ≤ 5분**, **검증 지연 p95 ≤ 30ms** 달성

---

3. **내용**

### A. 아티팩트 범위 & 표준 포맷

* **Rules**: `ruleset-*.tar.zst` (YAML/DSL + 테스트 케이스 + 메타)
* **Models**: `model-<name>-<semver>.bin` + `manifest.json`(데이터 범위/특징 버전/지표/SHAP Top-K) — Day 50 연계
* **Flags/Config**: `flags-<svc>-<region>.json` / `config-<svc>-<semver>.yaml` — Day 20 연계
* **공통 메타(`manifest.json`)**

  ```json
  { "name":"rules:detect-web", "version":"2024.12.20+7",
    "source_repo":"git@.../detect", "commit":"abc123",
    "builder":"ci@1.42", "build_at":"2024-12-20T01:23Z",
    "provenance":"in-toto attestation", "sbom":"cyclonedx.json",
    "tests":["replay_7d","replay_30d","perf_smoke"] }
  ```

### B. 서명·프로비넌스 체계

* **서명**: Cosign(키: `kms://<region>/plura-artifacts`)로 **아티팩트 파일 + manifest** 서명
* **프로비넌스**: in-toto/SLSA Attestation(`builder id`,`source uri`,`git sha`,`reproducible?`) — Day 38 연계
* **키 수명/로테이션**: 90일, 키 교체시 **이중 신뢰 창(48h)** 운영(신/구 모두 검증 통과)

### C. 배포 파이프라인 게이트(사전)

1. **계약/품질**: OCSF/SIGMA 정합·리플레이·성능 스모크( Day 27/34/76 )
2. **서명/프로비넌스** 검증: 서명 유효·체인 유효·SLSA 단계 충족 확인
3. **정책(OPA)**:

   ```rego
   package artifact.gate
   default allow = false
   deny[msg] { input.provenance.builder_trust < 2; msg := "untrusted builder" }
   deny[msg] { time.now_ns() - input.signature.ts > 90*24*3600*1e9; msg := "stale signature" }
   deny[msg] { input.region != input.token.region; msg := "cross-region artifact" }
   allow { not deny[_] }
   ```
4. **ACA/카나리** 준비: 되돌리기 키·관찰창·합성 시나리오 등록( Day 93/78 )

### D. 런타임 검증(Enforcement)

* **사이드카/라이브러리**가 로드 시점에 **서명·프로비넌스**를 재검증 → 실패 시 **구 버전으로 폴백**
* **해시 핀(Pinning)**: 배포 승인된 `digest allowlist`와 일치하지 않으면 거부
* **동적 룰/플래그 페치**: ETag/버전 검증 + 서명 헤더(`X-Artifact-Sig`) 확인, 불일치 시 **캐시된 안정본** 사용
* **정책 훅**: 위험 키(예: 차단 룰·Kill-Switch)는 **2인 승인 + 타임락** 필수( Day 92 )

### E. 롤백·승격·차단

* **롤백**: `POST /v1/artifacts/rollback { type:"rule|model|flag", to:"stable" }` — 5분 내 안정화 목표
* **승격**: ACA 통과 후 `stable` 태깅(증거: 지표/p-value/효과크기) — Day 93
* **차단(Blocklist)**: 문제가 확인된 `digest/semver`는 **전 리전 차단 목록**에 등재(기간/사유 기록)

### F. 관측·지표

* `artifact_verify_latency_p95 (≤30ms)`, `verify_fail_rate (<0.1%)`,
  `fallback_rate`, `rollback_time_p95 (≤5m)`, `stale_signature_denies`,
  `provenance_trust_score`, `tlog_inclusion_gap=0`( Day 88 )
* **경보**: 검증 실패/스테일 서명/교차 리전 아티팩트 감지 시 **즉시 ALERT + 자동 롤백**

### G. API/CLI

.  
.  

* `POST /v1/artifacts/publish { type, file, manifest }` — 서명/프로비넌스 부착 후 레지스트리 업로드
* `GET  /v1/artifacts/verify?type=rule&version=...` — 검증 결과/체인/키
* `POST /v1/artifacts/promote { type, version }` — 승격(ACA 연계)
* `POST /v1/artifacts/rollback { type, to }` — 즉시 롤백
* `POST /v1/artifacts/block { digest, reason, ttl }` — 차단 목록 추가
* CLI: `plura art publish|verify|promote|rollback|block`

### H. 거버넌스·보안 가드

* **주권**: 리전 로컬 레지스트리/키만 허용(교차 전송 금지, Day 87 )
* **투명성**: 모든 `publish/promote/rollback/block`는 **투명성 로그**에 고정( Day 88 )
* **SoD/JIT**: 고위험 플래그 변경은 **JIT + 2인 승인**( Day 81/37/66 )
* **PIA/DPIA**: 모델/룰이 PII 처리에 영향 시 **자동 재평가**( Day 86 )

### I. 운영 체크리스트

* [ ] 아티팩트 **서명·프로비넌스** 필수, 키 이중 신뢰 창/로테이션 캘린더 유지
* [ ] 런타임 **해시 핀 + 검증 실패 폴백** 경로 점검
* [ ] ACA/카나리/되돌리기 키 사전 등록, 합성 시나리오 준비
* [ ] 차단 목록 관리(만료/해제 포함), 투명성 로그 포함증명 검증
* [ ] 고객/감사 문서(i18n): 아티팩트 검증 절차·증거 링크 안내

---

4. **예시 설명 (모델 v3 서명 누락 — 3분 롤백, 21분 재배포)**

1) KR 리전 `model:v3` 로드 시 **서명 누락** 검출 → 런타임 검증 실패 **폴백**(v2 안정본).
2) EventHub 경보( Day 92 )와 동시에 **자동 롤백** 기록, 투명성 로그 포함증명 생성( Day 88 ).
3) CI가 누락 원인(서명 스텝 스킵) 수정 → 재서명/프로비넌스 부착 → ACA 카나리 통과.
4) 21분 내 재배포·승격 완료, 지표 정상. 고객 영향 0, RCA/게이트 강화(서명 스텝 필수) 반영.
   → 결과: **룰/모델/플래그 서명·프로비넌스 + 런타임 검증**으로 변조·오배포를 구조적으로 차단하고, **신속 롤백/재배포**까지 자동화해 안정성을 극대화.
