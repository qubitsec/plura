# 필상 시스템 — Day 82 토크나이제이션/암호화 게이트웨이(입력단 가명화) · FPE/Tink · 키 로테이션 연계

1. **날짜**

* 2024-12-04

2. **목표**

* **입력단(Edge/GW)에서 즉시 가명화**(Tokenization)·암호화로 **원본 PII 유입을 원천 차단**
* **FPE(Format-Preserving Encryption)/Tink** 기반 키 관리·로테이션과 **주권(KMS·RLS)** 연계를 표준화
* 검색/탐지 정확도를 유지하면서 **재식별 위험 ≤ 1%**, **토큰화 지연 p95 ≤ 5ms** 달성

---

3. **내용**

### A. 아키텍처(개요)

```
Client → Edge/Nginx → Tokenization Gateway → Ingestor/Streams → Search/Detect
                                 │
                                 └─ KMS(Region-local) / Tink AEAD & FPE / HSM(Optional)
```

* **경로 원칙**: 원본 PII(이메일/전화/IP/고객ID 등)는 **Gateway에서만 관찰** → 내부에는 **토큰/시그니처**만 전파
* **주권**: KMS/키·토큰 테이블은 **리전별 분리**, 교차 리전 전송 금지(OPA Gate)

### B. 대상·정책(표준 규칙)

* **대상 필드**: `email, phone, nat_id*, account_id, ip_addr`
* **출력 규칙**

  * `ip_addr` → `ip_bucket(/24)` + `HMAC(ip, k_tenant)` (비가역)
  * `email` → **FPE-Email**(로컬파트 부분 보존) + **salted hash**(조인용)
  * `phone` → **FPE-Num**(국가 규격 유지: +82-***-****)
  * `account_id` → **Deterministic AEAD** 토큰(조인 가능)
  * `query/body` → **param_sig**(정규화 시그니처), 원문 폐기
* **화이트리스트**: 이미 가명/시그니처 형태(`ip_bucket`, `param_sig`)는 통과

### C. 토크나이제이션 엔진(성능/신뢰)

* **라이브러리**: Google **Tink**(AEAD/Deterministic AEAD), FPE는 FF3-1(국가 규격 허용 범위 내)
* **형식 보존(FPE)**: UI/정규식 검증·레거시 상호운용에 유리, **고위험 데이터는 AEAD 우선**
* **지연**: p95 **≤ 5ms**(싱글 필드), 배치 변환은 스트림 워커로 오프로딩
* **내결함**: 실패 시 **하드 거부**(PII 원문 통과 금지) + 샘플(마스킹) 첨부 경고 이벤트

### D. 키·보관소 설계(Region-local KMS)

* **키 계층**: `KEK(region) → DEK(도메인/필드별) → Token`
* **수명**: DEK 90일 로테이션, KEK 180일(교체 시 **Double-WRAP** 지원)
* **저장**: 토큰 테이블(`token_vault_{region}`) — `tenant_id, field, token, salt_hash, created_at, key_id`
* **접근**: Vault는 **읽기 제한**(역토큰화 API는 관리/법적 근거 필요), 모든 접근은 **CoC 해시체인**

### E. 역토큰화(필요 시) & 절차

* **정책**: 원칙적 금지. 예외는 **법적 보존/수사 협조/고객 권리(Export/열람) 요청**에 한함( Day 42 · 74 )
* **절차**: 2인 승인 + 목적/범위/만료 **명시** → 일회용 서명 URL(10분)로 결과 제공 → 감사 고정
* **RLS/주권**: 요청·결과 모두 리전 내 처리, 교차 리전 결과 배포 금지

### F. 탐지/검색 영향 최소화(정확도 보존)

* **조인/집계**: `salted hash`·Deterministic AEAD 토큰으로 **동일자 식별** 가능(원문 없이)
* **룰/모델**: `param_sig`/`uri_sig`/행위 피처 기반( Day 9 · 57 · 70 )으로 **정탐 유지**
* **동등성 보장 테스트**: 토큰화 전/후 **Hit@K/MRR/정탐률** 편차 **≤ 1%p** 목표(회귀 파이프라인 포함)

### G. 운영/가드레일

* **게이트웨이 플래그**: `tokenize.enable=true`, `fpe.email.local_preserve=2`, `aead.det.drift_guard=on`
* **드리프트 감지**: 토큰 충돌률/미토큰 필드 탐지 시 **T1 경보** + 즉시 차단
* **키 분실/유출 대응**: `key_revoke` 플로우—신규 키로 **리토큰화 배치** + 영향 범위 EPKG-RCA 생성
* **성능 보호**: 멀티필드 변환은 **벡터라이즈** 처리 + 연결 재사용, 실패율 >0.1% 시 회로 차단

### H. 관측·SLO 지표

* `tokenize_latency_p95`, `tokenize_fail_rate`, `vault_hits`, `det_token_collision`,
  `deidentify_coverage(=대상 필드 토큰화 비율)`, `reverse_token_requests(예외)`
* **SLO**: 실패율 **< 0.1%**, 커버리지 **= 100%**, 역토큰화 예외 **= 0(평시)**

### I. API/자동화(발췌)

* `POST /v1/tokenize { fields:{ email, phone, account_id }, policy }` — 배치/스트림 변환
* `POST /v1/tokenize/reverse { ticket, purpose, scope }` — 예외적 역토큰화(2인 승인)
* `GET  /v1/tokenize/metrics?region=kr` — 지표/충돌률/커버리지
* `POST /v1/tokenize/rotate { key_id, rollout }` — DEK 로테이션(듀얼 라이트)

### J. 체크리스트

* [ ] Edge/GW **온** — 원문 PII는 내부로 유입 금지
* [ ] DEK 90일 로테이션 자동화, KEK 180일 교체 리허설
* [ ] 회귀 스위트(Hit@K/MRR/정탐률) 녹색일 때만 롤아웃
* [ ] 역토큰화는 **2인 승인 + 목적/만료** 필수, 감사 해시체인 고정
* [ ] 주권·RLS·Export( Day 74 ) 정합성 CI 테스트

---

4. **예시 설명 (이메일/전화 토큰화 롤아웃 — 정탐 0.3%p 변화, p95 3.7ms)**

1) 게이트웨이 `tokenize.enable=true` 적용(KR→JP 순), 이메일 FPE-Email + 해시, 전화 FPE-Num 활성.
2) 회귀: Hit@10/정탐률 **−0.3%p**, MRR **−0.1%p**(목표 이내), 검색 p95 변화 **+0.02s**.
3) 운영 24h: `deidentify_coverage=100%`, 실패 0.06%, 토큰 충돌 0건, 역토큰화 요청 0.
4) 키 로테이션 리허설(듀얼 라이트) 통과 후 정식 롤아웃, EPKG-RCA/정책 문서 갱신.
   → 결과: **입력단 가명화 + FPE/Tink + KMS 로테이션** 표준으로 **재식별 위험을 근본 차단**하면서도 **탐지/검색 품질**과 **성능 SLO**를 안정적으로 유지.
