# 필상 시스템 — Day 85 목적구속(Purpose Binding) 엔진 · 데이터 최소화 · 동의/정책/감사 일원화

1. **날짜**

* 2024-12-09

2. **목표**

* 모든 **조회/검색/Export/다운로드/연동(Webhook/SIEM)** 경로에 **목적(Purpose)**을 **명시·검증·기록**하여
  **데이터 최소화·주권(RLS)·감사**를 강화하고, **무목적 접근 0건**, **목적 불일치 차단 100%** 달성

---

3. **내용**

### A. 개념 & 분류(표준 Purpose)

* `security`(IR/탐지/DBV360), `ops`(운영/성능), `billing`(정산/리포트), `customer_report`(고객 보고),
  `research`(합성/가명만), `legal`(법적 보존/수사), `support`(고객 지원)

> 원칙: **PII 원문은 `legal` 제외 금지**, `research`는 **Syn/Anon만**(Day 57/71 연계).

### B. 아키텍처(엔드투엔드 훅)

```
Gateway(Nginx/Envoy)
   └─ Purpose Enforcer(OPA/Rego)  ← Policy Catalog (purpose.yaml)
         ├─ Purpose Header/Claim 주입·검증  (X-Purpose, OIDC claim: purpose)
         ├─ Minimizer(필드/범위 축소)      (ip_bucket/param_sig 강제)
         ├─ RLS/Region 검증                (tenant_id/region 일치)
         └─ Auditor  → security.audit.v1 (해시체인/WORM, Day 64)
```

* **적용 범위**: Search API, Export/Report, Webhook/Kafka, Object 다운로드(서명 URL), Lakehouse SQL(뷰/세션).

### C. 정책 카탈로그(purpose.yaml 발췌)

```yaml
purposes:
  security:
    pii_level: [masked]          # 원문 금지
    sources:  [search, incidents, events, ti_cache]
    export:   [pdf, csv, ndjson]  # parquet 제한
    retention: 180d
  customer_report:
    pii_level: [masked]
    sources: [lake_view, incidents]
    export:  [pdf, csv, parquet]
    retention: 365d
  legal:
    pii_level: [masked, raw*]    # *예외: 2인 승인 + 타임락
    sources: [evidence]
    export:  [epkg]
    retention: legal_hold
```

### D. OPA/Rego(집행 규칙)

```rego
package purpose.guard

default allow = false

valid_purpose {
  input.purpose in {"security","ops","billing","customer_report","research","legal","support"}
}

# 주권/RLS
deny[msg] {
  input.region != input.token.region
  msg := "cross-region forbidden"
}

# PII 최소화
deny[msg] {
  input.purpose != "legal"
  input.response.contains_raw_pii == true
  msg := "raw PII not allowed for purpose"
}

# 연구는 합성/가명만
deny[msg] {
  input.purpose == "research"
  not input.source in {"*_sanitized","*_lake_view","syn"}
  msg := "research requires sanitized/synthetic sources"
}

# 목적/소스/형식 매트릭스
deny[msg] {
  not valid_purpose
  msg := "invalid purpose"
}
allow { not deny[_] }
```

### E. 최소화(Minimizer) 동작

* **필드 축소**: `src_ip → ip_bucket`, `email/phone → hash`, `query/body → param_sig`, `headers → allowlist hash`
* **범위 축소**: 시간 `range` 상한(기본 24h, `legal`만 확대), 행 수/스캔 바이트 상한(플랜·목적별)
* **Join 제한**: 개인 식별 키로의 직접 Join 금지(Deterministic AEAD/해시 조인만 허용, Day 82)

### F. 감사/체인 오브 커스터디

* 이벤트: `purpose.requested/approved/denied/exported/downloaded`
* 필드: `actor, tenant, region, purpose, source, shape(fields,minimizations), counts(rows,bytes), link(epkg|signed_url), ts, prev_hash`
* **보존**: 3년(legal_hold 시 연장), WORM(버전닝/MFA Delete, Day 64)

### G. UX/에러 메시지(표준)

* 목적 미지정: “**목적이 필요합니다**(예: security, customer_report). 목적은 감사 기록에 남습니다.”
* 불일치: “**요청된 목적과 데이터 범위가 맞지 않습니다** — 원문 PII는 legal 목적/승인이 필요합니다.”
* 가이드: 콘솔 **Purpose Picker**(툴팁·템플릿) + 최근 선택 **자동 완성**

### H. SLO·지표

* **무목적 요청 차단율 100%**, **목적 불일치 차단율 100%**
* **목적 명시율 100%**(모든 성공 요청)
* 지표: `purpose_missing`, `purpose_mismatch_denies`, `minimization_applied%`, `legal_exceptions(0 평시)`
* 지연 가드: 목적 검증 + 최소화 **p95 ≤ 15ms**, Export 승인 플로우 **≤ 10m(legal 제외)**

### I. API/자동화(발췌)

* `POST /v1/purpose/approve { request_id, approvers[] }` — 예외 승인(2인/타임락)
* `GET  /v1/purpose/policies` — 목적별 소스/형식/PII 규칙
* `POST /v1/search/saved/{key}:execute { purpose, params }` — 목적 인자 필수
* `POST /v1/export/jobs { purpose, ... }` — Export 생성(자동 검증)
* `GET  /v1/purpose/audit?range=7d` — 감사 열람(요약)

### J. 운영 체크리스트

* [ ] 게이트웨이/콘솔 **Purpose Picker** 필수화, OIDC 토큰 `purpose` 클레임 전파
* [ ] Minimizer 설정(필드/범위/형식) CI 테스트, 회귀(정탐률/Hit@K 편차 ≤ 1%p)
* [ ] `legal` 예외는 **2인 승인 + 타임락 + EPKG** 의무
* [ ] 대시보드로 목적 누락/불일치/예외 추적, 교육/가이드 배포
* [ ] 고객 문서(i18n) — 목적별 가능한 소스/형식/보존/승인 절차 명시

---

4. **예시 설명 (Export 목적 불일치 — 2분 내 차단·가이드 제공)**

1) 고객 지원자가 `customer_report` 목적으로 `logs_raw` 원문 Export 요청 → OPA **deny**(PII 원문 금지).
2) 콘솔 안내: 템플릿 **Saved Report**(마스킹/요약) 또는 **lake_view + Parquet** 선택 제안.
3) 사용자가 템플릿 선택 후 재요청 → **자동 최소화** 적용, 9분 내 완료.
4) 감사 인덱스에 **purpose.requested/denied/approved/exported**가 연결 저장, 교육 링크 전송.
   → 결과: **목적구속 엔진**이 데이터 최소화·주권·감사를 일관되게 강제, **오남용/과잉 Export**를 제로에 가깝게 낮추면서 업무 흐름은 매끄럽게 유지.
