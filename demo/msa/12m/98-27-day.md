# 필상 시스템 — Day 98 탐지 컨텐츠 운영(DetOps) 표준: 커버리지 맵 · FP/미탐 파이프라인 · 릴리스 캘린더

1. **날짜**

* 2024-12-27

2. **목표**

* **룰/시그니처/쿼리 템플릿**의 **생애주기(발의→설계→검증→배포→효용평가→폐기)**를 표준화
* **커버리지(ATT&CK/자산/리스크) 맵**과 **FP/미탐(라벨) 파이프라인**을 일원화하여 **정탐률↑·운영비용↓**
* **릴리스 캘린더/가드레일**과 연결해 **안전 롤아웃(Shadow→Canary)**, **RCA·지식화 자동화** 달성

---

3. **내용**

### A. 커버리지 맵(Coverage Map)

* 축: **전술/기술(ATT&CK)** × **경로(WAF/EDR/UEBA/TI)** × **자산군(Web/WS/DB/Edge)** × **리전/테넌트 플랜**
* 카탈로그: `/coverage/map.yaml`

```yaml
T1190:
  routes: [WAF, UEBA]
  assets: [Web, Edge]
  signals: [param_sig:"union_select", status_mix(406/200)]
  tests: [replay_30d, synthetic_sqli]
  owner: team-detect-web
```

* 대시: **커버리지 %**, **블라인드 스팟**, **최근 30일 정탐/오탐/미탐 추세**, **테넌트 가중치**(ENT↑)

### B. 룰 생애주기(Lifecycle)

1. **Propose**: 이슈/RFC + 근거(샘플/쿼리/케이스)·목표(TID/리스크)
2. **Design**: DSL/조건·예외·설명가능성 필드(Top-K 특징)·**Purpose/RLS** 준수( Day 85 )
3. **Validate**: 리플레이(7/30/90d), 성능 스모크( Day 27/34 ), OCSF/SIGMA 정합( Day 76 )
4. **Stage**: `alpha(dry-run) → beta(Shadow 7d) → canary(5→25→100%)`( Day 93 )
5. **Operate**: FP/미탐 라벨 유입(DBV360, Day 9/50), 품질 스코어 업데이트
6. **Retire**: 중복/무효/부작용 룰은 합의 후 폐기, 지표/사유 기록

### C. FP/미탐 파이프라인

* **소스**: DBV360 라벨(`false_positive|missed|true_positive`), 헌팅( Day 46 ), 고객 피드백(티켓)
* **라벨 큐**: `label.inbox`(검수) → `label.approved`(학습/튜닝)
* **튜닝 규칙**

  * FP↑ → **예외 정교화**(서명자/도메인/경로)·**가중치↓**·**시그니처 보정**
  * 미탐↑ → **조건 완화/특징량 추가**·**보조 신호(TI/UEBA) 결합**
* **품질 스코어(Q)**: `Q = 1 - (FP_rate*w1 + Missed*w2) + EvidenceCompleteness*w3 - CostImpact*w4`

  * 임계: `Q<0.6` **개선 필수**, `Q<0.4` **자동 폐기 후보**

### D. 릴리스 캘린더 & 가드레일

* 캘린더: **주 2회 고정 슬롯**(KR/JP 분리), **Freeze/휴일 제외**( Day 77 )
* 가드레일: **되돌리기 키**·합성 시나리오( Day 78 )·Quota/비용 가드( Day 72/73 )
* 고위험(차단/파일류 27/29): **Shadow 7d + Canary + 2인 승인**( Day 94 )

### E. 템플릿/규칙 예시(발췌)

```yaml
rule_id: WAF-941100-ko_search-relax
version: 9
when: param_sig in ["ko_search"] and status:406 and blocked:1
assert:
  - mix(status, 30m, by:src_ip).ok_ratio > 0.4
then: review; tag("sqli-ko"); score(-0.2)
tests: [replay_30d_sqli_ko, perf_smoke_search]
explain: ["param_sig","ok_ratio","ti_score"]
```

### F. 지표·SLO

* `precision/recall`, `FP_rate ≤ 2%`, `missed_regression ≤ 1%`, `Q_avg ≥ 0.8`
* 운영: **카나리 승격 결정 TAT ≤ 15m**, **롤백 ≤ 5m**, **포스트모템 48h 내**( Day 80 )
* 비용: 변동 시 **FinOps 영향 ±10% 이내**( Day 29 )

### G. 콘솔 UX

* **DetOps 보드**: 커버리지 맵, FP/미탐 큐, 릴리스 캘린더, 현재 카나리 상태(지표/검정 p값)
* **룰 카드**: Q 스코어·라벨 추세·최근 RCA 링크·Shadow/Canary 로그·되돌리기 키
* **원클릭**: “튜닝 제안 적용→Shadow”, “카나리 승격/롤백”, “폐기 제안”

### H. API/CLI(발췌)

* `POST /v1/detops/rule/propose { tid, route, rationale, samples[] }`
* `POST /v1/detops/rule/tune { rule_id, patch }`
* `POST /v1/detops/replay { rule_id, range }`
* `POST /v1/detops/release { rule_id, channel }`
* `GET  /v1/detops/coverage?tid=T1190&region=kr`
* CLI: `plura det propose|tune|replay|release|coverage`

### I. 운영 체크리스트

* [ ] 커버리지 맵 최신화(ATT&CK/자산/리전), 블라인드 스팟 보완 계획
* [ ] FP/미탐 라벨 큐 **SLA(48h)** 검토·튜닝 반영
* [ ] Shadow/Canary/ACA( Day 93 ) 통과 없이 **직행 배포 금지**
* [ ] 폐기 룰은 **RCA/이유/대체 경로** 문서화
* [ ] 지표/비용/가드레일 위반 시 **자동 롤백 + RCA** 연계

---

4. **예시 설명 (T1190 SQLi 완화 룰 — 14일 운용, FP −1.9%p · 미탐 0.4%p↓)**

1) `ko_search` 완화 룰 제안→리플레이 통과·Shadow 7d 운영.
2) Canary 5→25→100% 승격, Q=0.86 유지.
3) 14일 지표: FP **−1.9%p**, 미탐 **−0.4%p**, 비용 영향 +3%p(허용).
4) 커버리지 맵/DetOps 보드 갱신, 기여 특징·증거 링크와 함께 **지식화** 완료.
   → 결과: **DetOps 표준**으로 탐지 컨텐츠가 **지속 개선**되고, **품질·비용·안전**을 동시에 만족하는 릴리스가 정착.
