# 필상 시스템 — Day 91 서비스 의존성 그래프(SDG) · 변경 리스크 스코어링 · RFC 영향 시뮬레이션

1. **날짜**

* 2024-12-17

2. **목표**

* **서비스/데이터/인프라** 전층의 **의존성 그래프(SDG: Service Dependency Graph)**를 구축하고
  **RFC/릴리스/플래그/스키마** 변경 시 **리스크 스코어**와 **영향 반경**(Blast Radius)을 자동 산출
* **릴리스 전 시뮬레이션 TAT ≤ 5분**, **고위험 변경 사전 차단 100%**, **회귀 누락 0건** 달성

---

3. **내용**

### A. 스코프 & 모델(노드/엣지)

* **노드**: `Service(App/API/Worker)`, `DB(Table/Partition)`, `Index(Solr Core)`, `Stream(Topic)`, `Cache`,
  `Connector`, `FeatureFlag`, `Schema(Model/Rule/SIGMA/OCSF)`, `Runbook`, `Dashboard`, `CDN Route`.
* **엣지 타입**

  * `CALLS`(서비스→서비스), `CONSULTS`(서비스→DB/인덱스/캐시), `CONSUMES/PRODUCES`(토픽),
  * `GOVERNS`(정책/플래그→서비스), `FEEDS`(커넥터·CDN→오리진), `DERIVES`(대시/리포트↔데이터).
* **메타**: `SLO(가중치)`, `Criticality(Tier1/2/3)`, `TenantScope`, `Region`, `ChangeWindow`, `Owner`.

### B. 수집/구축 파이프라인

```
IaC(Helm/Kustomize) / OpenAPI / AsyncAPI / dbt-graph / Solr schema
   → Graph Builder(변환/정규화)
   → SDG Store(Neo4j/Janus) + Cache
   → Impact Engine(시뮬레이션)
```

* **신뢰원**: 리포지토리 메타 + 런타임 추적(OTel, Day 67) + 카탈로그/Lineage( Day 51/71 ) 결합.
* **주권 분리**: KR/JP 그래프 **분리 저장**, 교차 경로는 `CBT guard`(Day 87)로 표시.

.  

.  

.  

### C. 변경 이벤트 표준 입력

* `RFC`(feature/infra), `Release Tag`, `Flag Delta`, `Schema(EMC, Day 34/76)`, `Connector Deploy( Day 69 )`.
* 각 이벤트는 **변경 종류/범위/시간창/되돌리기 키**를 포함(자동 추출).

### D. 리스크 스코어링(정의)

`RiskScore = (TopologicalReach × CriticalityWeight × SLOPenalty) + DataClassPenalty + ChangeTypeWeight − GuardrailScore`

* **TopologicalReach**: 의존 깊이×팬아웃(경로≤6, 단계당 상한 500).
* **CriticalityWeight**: Tier1=3, Tier2=2, Tier3=1.
* **SLOPenalty**: 영향 경로에 `p95` 여유<20% 또는 에러버짓 소진율↑이면 +1~+3.
* **DataClassPenalty**: P0/P1 데이터 경로 +3( Day 42/57/71 ).
* **ChangeTypeWeight**: 스키마 파괴/인덱스 구조/토픽 계약 변화 +3, 코드/플래그 값 조정 +1.
* **GuardrailScore**: 되돌리기 키/카나리/Shadow/테스트 커버리지·합성 시나리오( Day 27/78 )로 −1~−3.

### E. 영향 시뮬레이션(Blast Radius)

* **시나리오**: `fail-stop`(서비스 장애), `latency+30%`, `schema-field drop`, `topic schema change`, `cache key rule change`.
* **결과**: 영향 서비스·데이터셋·대시보드·런북 목록, **대체 경로/완화 플래그** 추천.
* **출력**: “**KR/tenant:ENT** 영향 경로 12개, Tier1 3개, 예상 p95 +220ms, DLQ 증가 1.2%p → 조치: TTL 90s, 템플릿 전용, 토픽 dual-publish”

### F. 게이트 & 차단 규칙

* **고위험 자동 차단**: `RiskScore ≥ 7` 또는 `P0/P1` 경로에서 `schema contract` 변경 → **BLOCK**
* **조건부 허용**: `4 ≤ RiskScore < 7`이면 **필수 가드**(Shadow 7일, 카나리 5→25→100%, 되돌리기 키, 합성 시나리오 추가).
* **저위험**: `RiskScore < 4` 즉시 허용(표준 게이트 통과 전제).

### G. 콘솔 UX

* **변경 카드**: RiskScore, Blast Radius 요약, **필수 가드** 체크, **되돌리기 키** 유효성 표시.
* **의존 그래프 뷰**: 클릭 시 경로/가중치·SLO 배지 표시, “**완화 적용**” 버튼(플래그/캐시/쿼터).
* **증거 링크**: OTel Trace/Lineage/카탈로그/런북/합성 테스트 결과.

### H. 대시보드·지표

* `risk_high_blocks`, `risk_conditional_allows`, `avg_blast_radius`, `guardrails_applied`,
  `post_release_incident_rate`, `rollback_latency_p95`, `false_block_rate(≤2%)`.
* **SLO**: 고위험 **사전 차단 100%**, 릴리스 후 T1/Incident율 **주간 기준 ↓20%**.

### I. API/자동화(발췌)

* `POST /v1/sdg/impact { change:{type,scope}, region }` — 영향 시뮬레이션
* `GET  /v1/sdg/graph?service=ingestor&region=kr` — 인접/경로 조회
* `POST /v1/sdg/gate { rfc_id }` — 게이트 평가(`allow|allow_with_guards|block`)
* `POST /v1/sdg/mitigation { rfc_id, actions[] }` — 완화(캐시/플래그/쿼터) 적용
* `GET  /v1/sdg/report?range=30d` — 블로킹/허용/사후지표 리포트

### J. 운영 체크리스트

* [ ] SDG 최신화(리포/스키마/토픽/카탈로그/라인리지 자동 동기)
* [ ] SLO·에러버짓·FinOps 지표 연결( Day 18/29/78 )
* [ ] 고위험 변경 차단 규칙·되돌리기 키 가용성 점검
* [ ] 합성 시나리오/회귀 테스트 자동 생성·통과 확인
* [ ] 변경 승인 흐름에 **SDG 리포트** 첨부(투명성 로그, Day 88)

---

4. **예시 설명 (Solr 스키마 필드 제거 RFC — `block` 후 보완·통과)**

1) RFC: `incidents.ip_bucket` 제거 제안 → SDG가 **Blast Radius 19**, Tier1×2 검출, RiskScore **8.4**.
2) 게이트 **BLOCK** → 보완안: `EMC(Expand→Backfill→Contract)`로 재작성, **대체 필드 매핑** 제공, Shadow 7일·카나리 계획 첨부.
3) 재평가: RiskScore **4.9**로 하락, **allow_with_guards**로 승인.
4) 배포 후 Incident 0건, 롤백 불요. SDG 리포트/투명성 로그 링크로 **감사 가능성** 확보.
   → 결과: **의존성 그래프+리스크 스코어+게이트**로 **고위험 변경을 사전 차단**하고, 보완·가드레일을 통해 **안전한 배포**만 허용.
