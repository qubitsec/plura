# 필상 시스템 — Day 99 분석가 RAG/엔터프라이즈 검색 표준: 벡터 인덱스(ko/ja/en) · 인용 근거·안전 가드

1. **날짜**

* 2024-12-30

2. **목표**

* 분석가 콘솔/KB/런북/RCA/정책/릴노트/대시보드 설명문을 **RAG(검색 증강 생성)**로 신속 탐색·요약
* **ko/ja/en** 멀티링궐 벡터 인덱스와 **정확 인용(근거 링크)**, **안전 가드(주권·목적구속·PII)**를 표준화
* **정확 인용률 ≥ 98%**, **환각율 ≤ 1%**, **응답 p95 ≤ 1.5s** 달성

---

3. **내용**

### A. 아키텍처(개요)

```
Docs(KB/Runbook/RCA/Policies/Release Notes/SDK) → Ingestor
  → Chunker(언어/섹션 인지) → Embedder(multilingual) → Vector Store(지역별)
  → Retriever(Hybrid: BM25 + Vector) → Re-ranker(Cross-Encoder)
  → Answer Composer(근거 인용·요약) → Output Guard(PII/주권/목적) → 콘솔 카드
```

* **리전 분리**: `kr_vectors`, `jp_vectors` **독립 저장소**(교차 전송 금지, Day 87)
* **문서 출처**: `/docs`, 상태/보안 템플릿( Day 90 ), RCA/EPKG 요약( Day 80/64 ), API 스펙( Day 26/60 )

### B. 수집·청크·메타

* **청크 크기**: 600–1,000자(한글) / 350–700자(영문/일문), **슬라이딩 100자** 중첩
* **구조 메타**: `title, h1/h2, section_path, lang, region, pii_level, purpose_allowed`
* **정규화**: 표/코드는 별도 청크 + 원본 파일 **서명 URL(10분)** 메타만 저장(원문 PII 금지)

### C. 임베딩/인덱싱(멀티링궐)

* **임베딩 모델**: 다국어 Sentence Transformer(ko/ja/en 튜닝) + **정책/룰 도메인 보정**
* **하이브리드 검색**: BM25(정확 키워드) + 벡터(의미 유사도) → **Cross-Encoder 재랭킹** Top-k
* **언어 감지 & 번역**: 질의/문서 언어 자동 판별, **질의 언어 우선** 답변(필요 시 요약 번역)

### D. 안전 가드(OPA/후처리)

* **목적구속**( Day 85 ): 질의 목적 미지정/불일치 시 거부/가이드
* **주권**( Day 87 ): **리전 외 벡터/원문 접근 금지**, 링크는 리전별 서명 URL만
* **PII/비밀**( Day 57/82 ): 청크 스캔 시 PII 발견 → **마스킹/제외**, 답변에 원문 PII 출력 금지
* **인용 강제**: 각 문장/단락에 **근거 청크 ≥ 1** 필요, 미충족 시 **Answer Composer 재시도/거부**

### E. 답변 스타일 & 인용 규칙

* **형식**: “요약 → 근거 목록(문서/섹션/줄범위) → 다음 행동 제안(옵션)”
* **인용 최소화**: 필요한 곳에만, **문장 뒤** `[ref: 문서 · 섹션]` / 콘솔에선 링크 카드
* **숫자/사실**: 반드시 근거 인용(릴노트/정책/RCA/템플릿/도표)
* **불확실성**: 근거 미흡 시 “추정/불확실” 명시 + 탐색 확장 제안

### F. 품질/평가 지표

* **정확 인용률(Attribution Accuracy)** ≥ **98%**
* **환각율(Hallucination)** ≤ **1%**(수정 필요 문장 비율)
* **Pass@k**(정답 청크 상위 k에 포함) ≥ **95%@10**
* **응답 p95** ≤ **1.5s**(Top-k=20, 재랭킹 100)
* 주기: **야간 회귀 스위트**(FAQ 300문항, ko/ja/en), 레드팀 질문 100문항

### G. 운영/데이터 파이프라인

* **증분 인덱싱**: Git Hook/Docs CI 이벤트 → 변경 섹션만 재임베딩
* **삭제/비공개 처리**: 문서 태그 `private/remove` → 벡터 즉시 제거 + 캐시 무효화( Day 84 )
* **버전 라벨**: `docs-2024.12.x`—질의 시 최신 우선, 과거 버전 **옵션 표기**

### H. 콘솔 UX

* **RAG 카드**: 요약·근거 3–5개·언어 토글(ko/ja/en)·“원본 열기(서명 URL)”
* **추가 액션**: “Saved Query 열기”, “RCA 링크”, “룰 델타 제안 만들기”( Day 98/93/80 연계)
* **피드백**: 👍/👎 + “부정확/부족한 근거/오래됨/다른 언어 필요” 라벨 → **재학습 큐**

### I. API/CLI(발췌)

* `POST /v1/rag/query { q, lang?, purpose, region, k=20 }`
* `POST /v1/rag/feedback { id, label, note }`
* `POST /v1/rag/reindex { path|doc_id }`
* CLI: `plura rag ask|reindex|feedback`

### J. 지표·경보

* `rag_latency_p95`, `attribution_accuracy`, `hallucination_rate`, `pass_k`, `stale_doc_ratio`, `feedback_neg_rate`
* 경보: 환각율 > 1% 또는 정확 인용률 < 98% 1h 지속 → **T1** + 인덱스 재빌드/도메인 보정

---

4. **예시 설명 (ko 질문→ja 문서 혼합 — 1.2s, 인용 100%)**

1) 질문: “**웹훅 서명 검증 규칙**이 뭐였죠?”(ko) → 하이브리드 검색에서 Day 60/68/74 연관 섹션 Top-k.
2) Re-rank 후 Composer가 **규칙 요약** + **3개 근거**(서명 헤더·타임스탬프·리플레이 차단) 생성.
3) 응답 1.2s, 인용 100%(ko/ja 원문 섹션 혼합, 리전 일치), 원본은 **서명 URL(10분)** 링크로 제공.
4) 사용자는 “웹훅 테스트” 액션으로 Saved Query 실행(템플릿), 👍 피드백 기록.
   → 결과: **멀티링궐 RAG + 인용 강제 + 안전 가드**로 분석가는 **정확·근거 있는 답변**을 빠르게 얻고, **정책/주권**을 유지한 채 업무를 가속화.
