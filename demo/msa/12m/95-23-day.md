# 필상 시스템 — Day 95 테넌트/샤드 리밸런싱(검색·스트림·메타DB) · 핫샤드 완화 · 무중단 마이그레이션

1. **날짜**

* 2024-12-23

2. **목표**

* **Solr(검색)·Kafka/Redis Streams(인입)·PostgreSQL(메타DB)** 의 **테넌트/샤드 리밸런싱**을 **무중단**으로 수행
* **핫샤드/편향**을 완화하고 **성능·비용**을 최적화(핵심 쿼리 p95 ≤ 800ms, Lag=0, DB 지연 p95 ≤ 40ms)
* **MW/Freeze( Day 56/77 )·SLO 게이트**와 연동한 **안전한 오케스트레이션** 확립

---

3. **내용**

### A. 핫샤드 탐지 & 후보 선정

* **지표**: `solr shard_qps/skew > 2.0`, `filterCache hit < 30%`, `kafka lag_top_partition > 95%tile`, `pg bloat > 25% or hot partition write > 60%`
* **후보**: (1) 대규모 테넌트 전용 샤드 분리, (2) 날짜/호스트 버킷 재분배, (3) 토픽 파티션 증가 & 재할당, (4) DB 파티션/스키마 재배치
* **안전 창**: 유지보수창(MW) + 변경 동결(L1만, Day 77)에서 수행

### B. 검색(Solr) 리밸런싱 — **Dual-Write + Backfill + Cutover**

1. **준비**

   * 신규 컬렉션 생성: `logs_raw_kr_202412_reb` (샤드/리더 배치 개선, DocValues/캐시 사이즈 재설정)
   * 라우팅 규칙 업데이트: `tenant_id` 해시 → **대규모 테넌트 전용 샤드** 옵션
2. **Dual-Write**

   * Ingest 파이프라인에서 **기존 + 신규 컬렉션 동시 쓰기**(ETag/멱등 키 유지)
   * SLO 게이트: p95>0.8s or 5xx>0.5% → 즉시 중지/롤백
3. **Backfill**

   * 기간/테넌트 단위 병렬 백필(레이트 제한), `commitWithin` 조정, DLQ 0 확인
4. **Cutover**

   * 콘솔/템플릿의 **읽기 엔드포인트**를 신규로 전환 → 15분 관찰 → 구 컬렉션 ReadOnly → 단계적 제거
5. **핫샤드 가드**

   * `tenant_bucket` 균형·`filterCache` 2→3GB, 히트 편향 시 **qf 재가중치**( Day 70 )

### C. 스트림(Kafka/Redis) 리밸런싱 — **Increase Partitions + Reassign + EOS 보장**

1. **토픽 확장**: 파티션 수 **배수 증가**(2×/3×), `min.insync.replicas=2`, `acks=all` 유지
2. **재할당**: 리더/팔로워 균형, **핫 브로커** 분산
3. **컨슈머 확장**: 그룹 스케일 아웃(HPA), **EOS(Exactly-once 효과, Day 59)** 유지
4. **컷오버**: 새 파티션으로 **점진 이동**(키 해시 범위 추가) → 레그=0 확인 후 구 범위 폐기
5. **레이트 가드**: 과도한 burst 시 **샘플링/필드 축약**( Day 72 )

### D. 메타DB(PostgreSQL) — **파티션 재배치 & 테넌트 재홈(Rehome)**

1. **파티션 생성/재배치**: 월 파티션 **사전 생성** + `LIST(tenant_bucket)` 서브파티션 분할( Day 55 )
2. **Rehome 전략**

   * **논리 복제**(pub/sub)로 대상 스키마/테넌트를 **새 인스턴스**로 동기화
   * **쓰기 일시 정지 ≤ 30s** 창에서 **스위치**(DNS/서비스 라우팅), 읽기는 계속 허용
3. **검증**: 합성 트랜잭션(계정 생성→티켓 생성→조회) 5분 내 통과, RPO 0/ RTO ≤ 30분 확인
4. **청소**: 구 파티션 Reindex/Vacuum, 7일 관찰 후 Drop 또는 Archive

### E. 오케스트레이션 & 자동화

* **Runbook 단계**

  1. 후보 선정 → **Impact 시뮬레이션**( Day 91 SDG )
  2. MW/Freeze 캘린더 등록( Day 92 )
  3. SLO/합성 시나리오( Day 78 ) 활성 → **사전/사후 비교**
  4. Step 실행: Search → Streams → DB 순(역방향 롤백 경로 보유)
* **자동 롤백 키**

  * `search.rebalance.cutover=false`, `stream.partition.route=old`, `db.rehome.rollback=on`
* **감사/증거**: 모든 단계 이벤트는 **투명성 로그**( Day 88 ) 및 EPKG-Rebalance로 고정

### F. 품질·지표·SLO

* **검색**: p95 ≤ 800ms, `cache_hit_ratio ≥ 60%`, `shard_skew ≤ 1.5×`
* **스트림**: `lag=0`, `rebalance_time ≤ 20m`, `dlq_size=0`
* **DB**: `replication_lag ≤ 10s`, `failover_success=100%`, `bloat_ratio ≤ 15%`
* **총괄**: 사건/알림 지연 SLO(15s/10s) **미달 시 즉시 중지/롤백**

### G. API/CLI(발췌)

* `POST /v1/rebalance/search/start { collection, routing, dual_write:true }`
* `POST /v1/rebalance/stream/expand { topic, new_partitions }`
* `POST /v1/rebalance/db/rehome { tenant, target_instance }`
* `GET  /v1/rebalance/status?id=...` / `POST /v1/rebalance/rollback { id }`
* CLI: `plura rebalance search|stream|db start|status|rollback`

### H. 운영 체크리스트

* [ ] 핫샤드 지표·편향 스냅샷 저장(전/후 비교)
* [ ] Dual-Write/논리복제 **상태 모니터링**·경보(레그/에러)
* [ ] 컷오버·롤백 **되돌리기 키** 실동작 검증
* [ ] MW/Freeze/EventHub(승인) 동기화, 고객 통지(ENT 우선)
* [ ] 7일 사후 리뷰: 비용/성능/안정성 개선 폭 평가·튜닝 반영

---

4. **예시 설명 (KR 핫샤드 완화 — p95 0.73s, Lag 0, DB 지연 −28%)**

1) `logs_raw_kr_202411`에서 테넌트 편향(2.6×) 탐지 → 신규 컬렉션 생성·**Dual-Write** 시작.
2) 2시간 백필 후 **Cutover**(15분 관찰) — 검색 p95 **0.91s → 0.73s**, 캐시 히트 +14%p.
3) Kafka 파티션 2× 확장·재할당 → `lag=0` 유지, 컨슈머 스케일 1.6×.
4) 메타DB 3개 테넌트 **Rehome**(정지 22s) → DB 지연 p95 **−28%**, 복구 자동 검증 통과.
   → 결과: **무중단 리밸런싱**과 **핫샤드 가드**로 성능·안정·비용을 동시 개선, 피크/캠페인·성장 대비 체력을 확보.
